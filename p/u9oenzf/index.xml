<?xml version="1.0" encoding="utf-8" standalone="yes"?><rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom"><channel><title>AWS CDK 関連メモ on まくろぐ</title><link>https://maku.blog/p/u9oenzf/</link><description>Recent content in AWS CDK 関連メモ on まくろぐ</description><generator>Hugo</generator><language>ja-jp</language><lastBuildDate>Sun, 17 Apr 2022 00:00:00 +0900</lastBuildDate><atom:link href="https://maku.blog/p/u9oenzf/index.xml" rel="self" type="application/rss+xml"/><item><title>AWS CDK 入門: cdk コマンドのインストールから Hello World まで</title><link>https://maku.blog/p/nujyfsy/</link><pubDate>Mon, 04 Oct 2021 00:00:00 +0900</pubDate><guid>https://maku.blog/p/nujyfsy/</guid><description>&lt;h2 id="cdk-とは">CDK とは&lt;/h2>
&lt;p>&lt;a href="https://aws.amazon.com/jp/cdk/">AWS CDK (Cloud Development Kit)&lt;/a> を使うと、TypeScript や Python を使って AWS リソースの生成を自動化することができます。
大きなプロジェクトでは、CloudFormation や SAM によるスタック生成用のテンプレートが長大になりがちですが、CDK を使うことで CloudFormation テンプレートの生成処理を隠蔽し、効率的にインフラ定義を行うことができます。
&lt;strong>CDK の利点&lt;/strong> をざっと挙げると以下のような感じです。&lt;/p>
&lt;ul>
&lt;li>TypeScript、Python などのパワフルな言語機能を使ってインフラ定義を行うことができる。&lt;/li>
&lt;li>各種リソース間の参照を、オブジェクトのプロパティ参照という自然な形で表現できる。&lt;/li>
&lt;li>コンストラクト (Construct Library) という再利用可能なライブラリの提供により、様々なユースケースに対応した AWS リソース群を短いコードで定義できる。&lt;/li>
&lt;li>VS Code (TypeScript) 、PyCharm (Python) などで型情報の補完が効くため、AWS リソースに設定可能なプロパティを見つけやすい。明らかに間違った設定はコンパイル時に気付くことができる。&lt;/li>
&lt;li>Lambda 関数デプロイ時などに必要になる ZIP パッケージング、および S3 一時バケットの生成を自動で行ってくれる。&lt;/li>
&lt;/ul>
&lt;p>一方、&lt;strong>CDK の欠点&lt;/strong> としては、基本的に AWS に特化したツールであるため、Terraform や Serverless Framework のように様々なクラウド (Azure, AWS, GCP) に対応できないという点が挙げられます。
Terraform などの汎用ツールに比べて、CDK は学習コストも比較的高いです。
Azure なども同じツールで構築したいとか、それほど細かい制御は必要ないということであれば、Terraform などを使った方がいいかもしれません。
ただ、CDK を使っている限り、AWS の最新のリソースにも即対応できることが保証されますし、AWS CloudFormation に関しての知識は身につけやすいでしょう。&lt;/p>
&lt;h2 id="cdk-toolkit-のインストール">CDK Toolkit のインストール&lt;/h2>
&lt;p>CDK によるデプロイには &lt;strong>&lt;code>cdk&lt;/code>&lt;/strong> コマンドを使用します。
まずはこのコマンドを使えるようにするため、&lt;strong>&lt;code>aws-cdk&lt;/code>&lt;/strong> パッケージをインストールします（CDK 本体の実行には Node.js が必要です）。&lt;/p></description></item><item><title>AWS CDK メモ: ブートストラップ処理を実行する (cdk bootstrap)</title><link>https://maku.blog/p/q7q8p6m/</link><pubDate>Sun, 17 Apr 2022 00:00:00 +0900</pubDate><guid>https://maku.blog/p/q7q8p6m/</guid><description>&lt;p>CloudFormation のスタックを生成するときに、一時的なファイル置き場として S3 バケットが必要になることがあります。
例えば、Lambda 関数をデプロイするときに、ZIP パッケージを置くためのステージングバケットが必要になります。
このステージングバケットへの実際のアップロード処理は CDK が自動でやってくれるのですが、バケットの準備だけはあらかじめ手動で行っておく必要があります。
このためのコマンドが &lt;strong>&lt;code>cdk bootstrap&lt;/code>&lt;/strong> コマンドです。
AWS アカウント（およびリージョン）内で一度だけ実行しておけばよいので、このタイミングで実行しておきます。
実行時には次のように「アカウント番号」と「リージョン名」を指定する必要があります。&lt;/p>
&lt;pre tabindex="0">&lt;code>cdk bootstrap aws://&amp;lt;アカウント番号&amp;gt;/&amp;lt;リージョン名&amp;gt;
&lt;/code>&lt;/pre>
&lt;figure class="xCodeBlock">
&lt;figcaption class="xCodeBlock_title">実際の実行例&lt;/figcaption>
&lt;div class="xCodeBlock_code">&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-console" data-lang="console">&lt;span class="line">&lt;span class="cl">&lt;span class="gp">$&lt;/span> cdk bootstrap aws://123456789012/ap-northeast-1
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="go"> ⏳ Bootstrapping environment aws://123456789012/ap-northeast-1...
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="go">CDKToolkit: creating CloudFormation changeset...
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="go">...
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="go"> ✅ Environment aws://123456789012/ap-northeast-1 bootstrapped.
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/div>
&lt;/figure>

&lt;p>これにより、ステージング用のバケットを含む &lt;code>CDKToolkit&lt;/code> という名前のブートストラップ・スタックが生成されます。&lt;/p>
&lt;p>ちなみに、現在使用している「アカウント番号」と「リージョン名」は、AWS CLI を使って次のように確認できます。&lt;/p>

&lt;figure class="xCodeBlock">
&lt;figcaption class="xCodeBlock_title">アカウント番号の確認&lt;/figcaption>
&lt;div class="xCodeBlock_code">&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-console" data-lang="console">&lt;span class="line">&lt;span class="cl">&lt;span class="gp">$&lt;/span> aws sts get-caller-identity --output text --query Account &lt;span class="o">[&lt;/span>--profile xxxx&lt;span class="o">]&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="go">123456789012
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/div>
&lt;/figure>


&lt;figure class="xCodeBlock">
&lt;figcaption class="xCodeBlock_title">リージョン名の確認&lt;/figcaption>
&lt;div class="xCodeBlock_code">&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-console" data-lang="console">&lt;span class="line">&lt;span class="cl">&lt;span class="gp">$&lt;/span> aws configure get region &lt;span class="o">[&lt;/span>--profile xxxx&lt;span class="o">]&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="go">ap-northeast-1
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/div>
&lt;/figure></description></item><item><title>AWS CDK メモ: コンストラクトの概念を理解する</title><link>https://maku.blog/p/nqkav2m/</link><pubDate>Mon, 04 Oct 2021 00:00:00 +0900</pubDate><guid>https://maku.blog/p/nqkav2m/</guid><description>&lt;h2 id="コンストラクトツリー-construct-tree">コンストラクト・ツリー (Construct Tree)&lt;/h2>
&lt;p>AWS CDK を使って CloudFormation スタックを作成するとき、そのリソース構成は、論理的な &lt;strong>コンストラクト (construct)&lt;/strong> のツリー構造によって表現します。
下記は、典型的な CDK アプリケーションにおけるコンストラクト・ツリー構造です。&lt;/p>

&lt;figure class="xCodeBlock">

&lt;div class="xCodeBlock_code">&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-plain" data-lang="plain">&lt;span class="line">&lt;span class="cl">App
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> +-- Stack
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> | +-- Construct
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> | +-- Construct
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> | +-- ...
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> +-- Stack
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> +-- Construct
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> | +-- Construct
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> | +-- Construct
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> +-- Construct
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> +-- ...&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/div>
&lt;/figure>

&lt;p>&lt;code>App&lt;/code>、&lt;code>Stack&lt;/code>、&lt;code>Construct&lt;/code> はそれぞれ抽象度の異なるオブジェクトですが、すべて &lt;a href="https://docs.aws.amazon.com/cdk/api/latest/docs/@aws-cdk_core.IConstruct.html">IConstruct インタフェース&lt;/a> を実装したコンストラクトの一種です。
CDK アプリ―ケーションには、構成のエントリポイントとなる &lt;strong>&lt;code>App&lt;/code> コンストラクト&lt;/strong> が 1 つあり、複数の &lt;code>Stack&lt;/code> コンストラクトを含むことができます。&lt;/p>
&lt;p>&lt;strong>&lt;code>Stack&lt;/code> コンストラクト&lt;/strong> は、その名の通り CloudFormation スタックを表現するコンストラクトです。
&lt;code>App&lt;/code> が複数の &lt;code>Stack&lt;/code> から構成されている場合、&lt;code>cdk deploy&lt;/code> コマンドでデプロイを実行したときに複数の CloudFormation スタックが生成されることになります。
&lt;code>cdk deploy &amp;lt;Stack名&amp;gt;&lt;/code> とすれば、特定のスタックのみをデプロイすることも可能です。
指定可能な Stack 名の一覧を確認したいときは、&lt;code>cdk ls&lt;/code> コマンドを使います。&lt;/p></description></item><item><title>AWS CDK メモ: CDK アプリのパッケージ管理に Yarn を使う方法</title><link>https://maku.blog/p/4h3jygw/</link><pubDate>Sun, 17 Apr 2022 00:00:00 +0900</pubDate><guid>https://maku.blog/p/4h3jygw/</guid><description>&lt;p>&lt;code>cdk init app --language typescript&lt;/code> で CDK アプリのひな型を生成すると、デフォルトではパッケージマネージャーとして NPM を使う想定になっています（&lt;code>package-lock.json&lt;/code> などが作成されます）。
NPM の代わりに Yarn を使いたい場合は、次のように &lt;code>package-lock.json&lt;/code> を削除して、&lt;code>yarn.lock&lt;/code> ファイルを生成します。&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-console" data-lang="console">&lt;span class="line">&lt;span class="cl">&lt;span class="gp">$&lt;/span> git rm package-lock.json
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="gp">$&lt;/span> yarn install
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>生成された &lt;code>yarn.lock&lt;/code> は忘れずに Git へコミットしてください。&lt;/p>
&lt;p>ちなみに、&lt;code>package-lock.json&lt;/code> が残っている状態で &lt;code>yarn install&lt;/code> しようとすると、次のような感じの Warning が表示されます。&lt;/p>
&lt;blockquote>
&lt;p>warning package-lock.json found. Your project contains lock files generated by tools other than Yarn. It is advised not to mix package managers in order to avoid resolution inconsistencies caused by unsynchronized lock files. To clear this warning, remove package-lock.json.&lt;/p></description></item><item><title>AWS CDK メモ: 謎の CDKMetadata を生成しないようにする</title><link>https://maku.blog/p/2asq4k4/</link><pubDate>Mon, 04 Oct 2021 00:00:00 +0900</pubDate><guid>https://maku.blog/p/2asq4k4/</guid><description>&lt;p>AWS CDK で CloudFormation スタックを生成すると、デフォルトで &lt;code>CDKMetadata&lt;/code> というリソースが生成されます（&lt;code>cdk synth&lt;/code> コマンドで CloudFormation テンプレートを出力してみると確認できます）。&lt;/p>

&lt;figure class="xCodeBlock">

&lt;div class="xCodeBlock_code">&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-yaml" data-lang="yaml">&lt;span class="line">&lt;span class="cl">&lt;span class="nt">Resources&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">CDKMetadata&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">Type&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">AWS::CDK::Metadata&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">Properties&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">Analytics&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">v2:deflate64:IsH4AAAAAAAA/L9ZNTs....9mAAAA&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">Metadata&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">aws:cdk:path&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">CdkStack/CDKMetadata/Default&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">Condition&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">CDKMetadataAvailable&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="nt">Conditions&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">CDKMetadataAvailable&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">Fn::Or&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>- &lt;span class="nt">Fn::Or&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>- &lt;span class="nt">Fn::Equals&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>- &lt;span class="nt">Ref&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">AWS::Region&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>- &lt;span class="l">af-south-1&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>- &lt;span class="nt">Fn::Equals&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>- &lt;span class="nt">Ref&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">AWS::Region&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>- &lt;span class="l">ap-east-1&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="l">...&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/div>
&lt;/figure>

&lt;p>自分で何もリソース生成していないのにテンプレートが汚されて邪魔だなぁと思っていたら、この情報は、CDK を開発しているチームが利用状況などを把握して今後の改善のために使うようです。
下記、&lt;a href="https://docs.aws.amazon.com/ja_jp/cdk/latest/guide/hello_world.html#hello_world_tutorial_synth">CDK のドキュメント&lt;/a> より抜粋。&lt;/p>
&lt;blockquote>
&lt;p>Every generated template contains a AWS::CDK::Metadata resource by default. (We haven&amp;rsquo;t shown it here.) The AWS CDK team uses this metadata to gain insight into how the AWS CDK is used, so we can continue to improve it. For details, including how to opt out of version reporting, see Version reporting.&lt;/p></description></item><item><title>AWS CDK で TypeScript で実装した Lambda 関数をデプロイする (NodejsFunction)</title><link>https://maku.blog/p/cj9i4m3/</link><pubDate>Wed, 06 Oct 2021 00:00:00 +0900</pubDate><guid>https://maku.blog/p/cj9i4m3/</guid><description>&lt;h2 id="何をするか">何をするか？&lt;/h2>
&lt;p>ここでは、CDK アプリとして作成した CloudFormation スタック内に、&lt;strong>TypeScript で実装した Lambda 関数&lt;/strong> を追加してみます。
Lambda 関数のビルドもデプロイ時に自動で行われるようにします。&lt;/p>
&lt;p>以降の説明では、CDK プロジェクトの作成自体は済んでいるものとします。&lt;/p>
&lt;ul>
&lt;li>参考: &lt;a href="../../p/nujyfsy">AWS CDK 入門: cdk コマンドのインストールから Hello World まで&lt;/a>&lt;/li>
&lt;/ul>
&lt;h2 id="typescript-で-lambda-関数を実装する">TypeScript で Lambda 関数を実装する&lt;/h2>
&lt;p>Lambda 関数のコードは、プロジェクトのルートに &lt;code>lambda&lt;/code> ディレクトリを作成して、そこに配置していくことにします。&lt;/p>

&lt;figure class="xCodeBlock">

&lt;div class="xCodeBlock_code">&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-plain" data-lang="plain">&lt;span class="line">&lt;span class="cl">myapp/
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> +-- bin/ ... CDK の App コンストラクト (.ts)
&lt;/span>&lt;/span>&lt;span class="line hl">&lt;span class="cl"> +-- lambda/ ... ラムダ関数の実装コード (.ts) ★これを追加
&lt;/span>&lt;/span>&lt;span class="line hl">&lt;span class="cl"> | +-- index.ts
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> +-- lib/ ... CDK の Stack コンストラクトなど (.ts)
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> ...&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/div>
&lt;/figure>

&lt;p>Lambda 関数実装用の TypeScript 型情報をインストールします。&lt;/p>

&lt;figure class="xCodeBlock">

&lt;div class="xCodeBlock_code">&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-console" data-lang="console">&lt;span class="line">&lt;span class="cl">&lt;span class="gp">$&lt;/span> npm install @types/aws-lambda --save-dev &lt;span class="c1"># npm の場合&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="gp">$&lt;/span> yarn add @types/aws-lambda --dev &lt;span class="c1"># yarn の場合&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/div>
&lt;/figure>

&lt;p>最低限の Hello World 的なラムダ関数を作成します。&lt;/p></description></item><item><title>AWS CDK で Go 言語で実装した Lambda 関数をデプロイする (GoFunction)</title><link>https://maku.blog/p/38jt3cm/</link><pubDate>Sun, 17 Apr 2022 00:00:00 +0900</pubDate><guid>https://maku.blog/p/38jt3cm/</guid><description>&lt;h2 id="何をするか">何をするか？&lt;/h2>
&lt;p>ここでは、CDK アプリとして作成した CloudFormation スタック内に、&lt;strong>Go 言語で実装した Lambda 関数&lt;/strong> を追加してみます。
Lambda 関数のビルドもデプロイ時に自動で行われるようにします。&lt;/p>
&lt;p>CDK のプロジェクト自体（スタックを定義する CDK コード）は TypeScript で作成します。
以降の説明では、CDK プロジェクトの作成自体は済んでいるものとします。&lt;/p>
&lt;ul>
&lt;li>参考: &lt;a href="../../p/nujyfsy">AWS CDK 入門: cdk コマンドのインストールから Hello World まで&lt;/a>&lt;/li>
&lt;/ul>
&lt;h2 id="go-言語で-lambda-関数を実装する">Go 言語で Lambda 関数を実装する&lt;/h2>
&lt;p>Lambda 関数のコードは、プロジェクトのルートに &lt;code>lambda&lt;/code> ディレクトリを作成して、そこに配置していくことにします。&lt;/p>

&lt;figure class="xCodeBlock">

&lt;div class="xCodeBlock_code">&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-plain" data-lang="plain">&lt;span class="line">&lt;span class="cl">myapp/
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> +-- bin/ ... CDK の App コンストラクト (.ts)
&lt;/span>&lt;/span>&lt;span class="line hl">&lt;span class="cl"> +-- lambda/ ... ラムダ関数用のディレクトリ (.go)
&lt;/span>&lt;/span>&lt;span class="line hl">&lt;span class="cl"> | +-- go.mod
&lt;/span>&lt;/span>&lt;span class="line hl">&lt;span class="cl"> | +-- go.sum
&lt;/span>&lt;/span>&lt;span class="line hl">&lt;span class="cl"> | +-- main.go
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> +-- lib/ ... CDK の Stack コンストラクトなど (.ts)
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> ...&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/div>
&lt;/figure>

&lt;p>&lt;code>lambda&lt;/code> ディレクトリの下で、Go パッケージの依存情報 (&lt;code>go.mod&lt;/code>、&lt;code>go.sum&lt;/code>) を追加します。&lt;/p></description></item><item><title>AWS CDK のサンプルコード集（TypeScript 版）</title><link>https://maku.blog/p/gzkzbny/</link><pubDate>Mon, 04 Oct 2021 00:00:00 +0900</pubDate><guid>https://maku.blog/p/gzkzbny/</guid><description>&lt;p>AWS CDK を使った TypeScript サンプルコードいろいろです。&lt;/p>
&lt;h2 id="リソースにタグを付ける">リソースにタグを付ける&lt;/h2>

&lt;figure class="xCodeBlock">

&lt;div class="xCodeBlock_code">&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-ts" data-lang="ts">&lt;span class="line">&lt;span class="cl">&lt;span class="kr">import&lt;/span> &lt;span class="o">*&lt;/span> &lt;span class="kr">as&lt;/span> &lt;span class="nx">cdk&lt;/span> &lt;span class="kr">from&lt;/span> &lt;span class="s1">&amp;#39;@aws-cdk/core&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kr">import&lt;/span> &lt;span class="p">{&lt;/span> &lt;span class="nx">MyappStack&lt;/span> &lt;span class="p">}&lt;/span> &lt;span class="kr">from&lt;/span> &lt;span class="s1">&amp;#39;../lib/myapp-stack&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kr">const&lt;/span> &lt;span class="nx">app&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="k">new&lt;/span> &lt;span class="nx">cdk&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">App&lt;/span>&lt;span class="p">()&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">new&lt;/span> &lt;span class="nx">MyappStack&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">app&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s1">&amp;#39;MyappStack&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">tags&lt;/span>&lt;span class="o">:&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">Owner&lt;/span>&lt;span class="o">:&lt;/span> &lt;span class="s1">&amp;#39;TeamA&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">Purpose&lt;/span>&lt;span class="o">:&lt;/span> &lt;span class="s1">&amp;#39;Project1&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">},&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">})&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/div>
&lt;/figure>

&lt;p>AWS リソース用のコンストラクトの props パラメーターで、&lt;strong>&lt;code>tags&lt;/code>&lt;/strong> プロパティを指定することで、そのリソースにタグを設定できます。&lt;/p>
&lt;p>タグの設定方法は、どの AWS リソース用のコンストラクトでも同様です。
上記のように &lt;code>Stack&lt;/code> コンストラクトに対してタグを設定すると、その中に配置した AWS リソースにもそのタグが設定されます。&lt;/p>
&lt;h2 id="s3-バケットや-dynamodb-テーブルをスタック削除時に自動削除する">S3 バケットや DynamoDB テーブルをスタック削除時に自動削除する&lt;/h2>
&lt;h3 id="バケットが空のときだけ自動削除する">バケットが空のときだけ自動削除する&lt;/h3>

&lt;figure class="xCodeBlock">

&lt;div class="xCodeBlock_code">&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-ts" data-lang="ts">&lt;span class="line">&lt;span class="cl">&lt;span class="kr">import&lt;/span> &lt;span class="o">*&lt;/span> &lt;span class="kr">as&lt;/span> &lt;span class="nx">cdk&lt;/span> &lt;span class="kr">from&lt;/span> &lt;span class="s1">&amp;#39;@aws-cdk/core&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kr">import&lt;/span> &lt;span class="o">*&lt;/span> &lt;span class="kr">as&lt;/span> &lt;span class="nx">s3&lt;/span> &lt;span class="kr">from&lt;/span> &lt;span class="s1">&amp;#39;@aws-cdk/aws-s3&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">new&lt;/span> &lt;span class="nx">s3&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Bucket&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="k">this&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s1">&amp;#39;MyBucket&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">removalPolicy&lt;/span>: &lt;span class="kt">cdk.RemovalPolicy.DESTROY&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">})&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/div>
&lt;/figure>

&lt;p>CDK で作成した S3 バケットや DynamoDB テーブルは、デフォルトでは、（内容が空であっても）スタック削除時にそのまま残るようになっています。
つまり、スタックから独立したリソースとして S3 バケットだけが残ります。
これは、CloudFormation の DeletionPolicy のデフォルトの挙動とは逆なので注意してください。
スタックの削除 (&lt;code>cdk destroy&lt;/code>) と同時に S3 バケットや DynamoDB テーブルを削除したいときは、上記のように &lt;strong>&lt;code>removalPolicy&lt;/code>&lt;/strong> を設定します。&lt;/p>
&lt;h3 id="バケットが空じゃなくても自動削除する">バケットが空じゃなくても自動削除する&lt;/h3>

&lt;figure class="xCodeBlock">

&lt;div class="xCodeBlock_code">&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-ts" data-lang="ts">&lt;span class="line">&lt;span class="cl">&lt;span class="kr">import&lt;/span> &lt;span class="o">*&lt;/span> &lt;span class="kr">as&lt;/span> &lt;span class="nx">cdk&lt;/span> &lt;span class="kr">from&lt;/span> &lt;span class="s1">&amp;#39;@aws-cdk/core&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kr">import&lt;/span> &lt;span class="o">*&lt;/span> &lt;span class="kr">as&lt;/span> &lt;span class="nx">s3&lt;/span> &lt;span class="kr">from&lt;/span> &lt;span class="s1">&amp;#39;@aws-cdk/aws-s3&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">new&lt;/span> &lt;span class="nx">s3&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Bucket&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="k">this&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s1">&amp;#39;MyBucket&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">removalPolicy&lt;/span>: &lt;span class="kt">cdk.RemovalPolicy.DESTROY&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">autoDeleteObjects&lt;/span>: &lt;span class="kt">true&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">})&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/div>
&lt;/figure>

&lt;p>&lt;code>removalPolicy&lt;/code> を &lt;code>RemovalPolicy.DESTROY&lt;/code> に設定しても、S3 バケットにオブジェクト含まれているときは、スタック削除時に連動して自動削除してくれません。
スタック削除時に、バケット内のオブジェクトを自動削除してバケットの削除までやってしまいたいときは、&lt;code>removalPolicy&lt;/code> に加えて、&lt;strong>&lt;code>autoDeleteObjects&lt;/code>&lt;/strong> プロパティを設定します。
この設定を行うと、たとえ S3 バケットのバージョニングが有効 (&lt;code>versioned: true&lt;/code>) になっていても、問答無用で削除されるので注意してください。
&lt;code>autoDeleteObjects&lt;/code> の機能を実現するために、内部的に Lambda 関数が自動生成されるので、CDK のブートストラッピング (&lt;code>cdk bootstrap&lt;/code>) をあらかじめ実行しておく必要があります。&lt;/p></description></item><item><title>Go 言語で AWS CDK V2 を使う (1) 導入編</title><link>https://maku.blog/p/54s6es8/</link><pubDate>Wed, 13 Apr 2022 00:00:00 +0900</pubDate><guid>https://maku.blog/p/54s6es8/</guid><description>&lt;h2 id="何をするか">何をするか？&lt;/h2>
&lt;p>CDK プロジェクトでは多くのケースでは TypeScript を使ってコード記述されていると思いますが、Go 言語の勢いが出てきていることもあり、ここでは Go 言語を使った CDK プロジェクトを作成してみます。&lt;/p>
&lt;p>CDK 自体の概要については下記に簡単にまとまっています。&lt;/p>
&lt;ul>
&lt;li>参考: &lt;a href="../../p/nujyfsy">AWS CDK 入門 (1) インストールから Hello World まで&lt;/a>&lt;/li>
&lt;/ul>
&lt;p>以下、Go 言語のインストールや、AWS の認証情報の設定 (&lt;code>~/.aws/credentials&lt;/code>, &lt;code>~/.aws/config&lt;/code>) はできているものとします。&lt;/p>
&lt;ul>
&lt;li>参考: &lt;a href="../../p/xnogqgm">Go 言語で AWS SDK を使う開発環境を整える&lt;/a>&lt;/li>
&lt;/ul>
&lt;h2 id="aws-cdk-のインストール">AWS CDK のインストール&lt;/h2>
&lt;p>Go 言語で CDK のコードを記述する場合でも、AWS CDK のコマンドラインツール (&lt;code>cdk&lt;/code>) 自体は、Node.js の NPM パッケージで提供されているものを使います。&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-console" data-lang="console">&lt;span class="line">&lt;span class="cl">&lt;span class="gp">$&lt;/span> npm install -g aws-cdk
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="go">...
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="go">&lt;/span>&lt;span class="err">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="err">&lt;/span>&lt;span class="gp">$&lt;/span> cdk --version
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="go">2.20.0 (build 738ef49)
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="cdk-プロジェクトを作成する-cdk-init">CDK プロジェクトを作成する (cdk init)&lt;/h2>
&lt;p>CDK の Scaffold 機能を使って、Go 言語用の CDK プロジェクトを生成します。&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-console" data-lang="console">&lt;span class="line">&lt;span class="cl">&lt;span class="gp">$&lt;/span> mkdir cdk-with-go
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="gp">$&lt;/span> &lt;span class="nb">cd&lt;/span> cdk-with-go
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="gp">$&lt;/span> cdk init --language&lt;span class="o">=&lt;/span>go
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>&lt;code>cdk init&lt;/code> すると、次のようなファイルが生成されます。
TypeScript 用のプロジェクトと比べてとってもシンプルです！&lt;/p></description></item><item><title>AWS CDK で外部パラメーターを扱う（コンテキスト・バリューと環境変数）</title><link>https://maku.blog/p/vx5ta85/</link><pubDate>Mon, 11 Oct 2021 00:00:00 +0900</pubDate><guid>https://maku.blog/p/vx5ta85/</guid><description>&lt;h2 id="cdk-コードに外部パラメーターを与える方法">CDK コードに外部パラメーターを与える方法&lt;/h2>
&lt;p>AWS CDK による CloudFormation スタックの構築時に、外部からキー＆バリューの形でパラメーターを設定したいときは、主に次の 3 つの方法があります（クラウド上に値を保存するパラメーターストアなどは対象外とします）。&lt;/p>
&lt;ol>
&lt;li>&lt;strong>Context values&lt;/strong> （コンテキスト・バリュー）&lt;/li>
&lt;li>&lt;strong>Environment variables&lt;/strong> （環境変数）&lt;/li>
&lt;li>&lt;strong>CloudFormation parameters&lt;/strong> （CloudFormation パラメーター）&lt;/li>
&lt;/ol>
&lt;p>S3 バケットの名前をパラメーター化したり、デプロイターゲットを &lt;code>staging&lt;/code> と &lt;code>production&lt;/code> の間で切り替えたりするときに使えます。&lt;/p>
&lt;h2 id="context-valuesコンテキストバリュー">Context values（コンテキスト・バリュー）&lt;/h2>
&lt;p>コンテキスト・バリューは、CDK 特有の仕組みで、&lt;strong>&lt;code>cdk deploy&lt;/code>&lt;/strong> 実行時のコマンドライン引数や、&lt;strong>&lt;code>cdk.json&lt;/code>&lt;/strong> ファイルの中で、キー＆バリューのペアを設定することができます。
キーの型は &lt;code>string&lt;/code> で、バリューの型は JSON がサポートするデータ型のいずれかです（&lt;code>string&lt;/code>、&lt;code>number&lt;/code>、オブジェクト、およびそれらの配列）。
コンテキスト・バリューは CDK の仕組みなので、CDK コードの中からしか参照できません。
Lambda 関数の中から値を参照したい場合は、Lambda 関数のコンストラクトを生成するときに、&lt;code>environment&lt;/code> props などで間接的に渡す必要があります。&lt;/p>
&lt;h3 id="コマンドライン引数で指定する方法">コマンドライン引数で指定する方法&lt;/h3>
&lt;p>&lt;code>cdk deploy&lt;/code> コマンド（あるいは &lt;code>diff&lt;/code>、&lt;code>synth&lt;/code>）を実行するときに、&lt;strong>&lt;code>--context (-c)&lt;/code>&lt;/strong> オプションで、コンテキスト・バリューを設定できます。&lt;/p>

&lt;figure class="xCodeBlock">

&lt;div class="xCodeBlock_code">&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-plain" data-lang="plain">&lt;span class="line">&lt;span class="cl">$ cdk deploy --context key=value&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/div>
&lt;/figure>

&lt;p>複数のキー＆バリューペアを設定したいときは、単純にオプション指定を繰り返します。&lt;/p>

&lt;figure class="xCodeBlock">

&lt;div class="xCodeBlock_code">&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-plain" data-lang="plain">&lt;span class="line">&lt;span class="cl">$ cdk deploy -c key1=value1 -c key2=value2&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/div>
&lt;/figure>

&lt;p>コンテキスト・バリューは CDK アプリ内の全スタックに渡されますが、特定のスタックにのみ反映させることもできます。&lt;/p>

&lt;figure class="xCodeBlock">

&lt;div class="xCodeBlock_code">&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-plain" data-lang="plain">&lt;span class="line">&lt;span class="cl">$ cdk deploy -c Stack1:key1=value1 -c Stack2:key2=value2&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/div>
&lt;/figure>

&lt;h3 id="cdkjson-で指定する方法">cdk.json で指定する方法&lt;/h3>
&lt;p>&lt;code>cdk init app&lt;/code> コマンドで CDK アプリを生成すると、&lt;strong>&lt;code>cdk.json&lt;/code>&lt;/strong> というファイルがプロジェクトのルートに配置されます。
このファイルの中の、&lt;strong>&lt;code>context&lt;/code>&lt;/strong> プロパティで、コンテキスト・バリュー用のキー＆バリューを記述しておくことができます。
ホームディレクトリの &lt;code>~/cdk.json&lt;/code> に記述しておくこともできます。&lt;/p></description></item><item><title>AWS CDK メモ: Lambda 関数コードだけ高速デプロイする (cdk deploy --hotswap)</title><link>https://maku.blog/p/ap8p7n4/</link><pubDate>Wed, 06 Oct 2021 00:00:00 +0900</pubDate><guid>https://maku.blog/p/ap8p7n4/</guid><description>&lt;p>AWS CDK によるデプロイ (&lt;code>cdk deploy&lt;/code>) の実行には結構時間がかかりますが、Lambda 関数のコードだけ更新したいときは、&lt;strong>&lt;code>hotswap&lt;/code>&lt;/strong> オプションを付けて実行することで高速にデプロイできます。&lt;/p>

&lt;figure class="xCodeBlock">
&lt;figcaption class="xCodeBlock_title">Lambda 関数だけ高速更新&lt;/figcaption>
&lt;div class="xCodeBlock_code">&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-plain" data-lang="plain">&lt;span class="line">&lt;span class="cl">$ cdk deploy --hotswap&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/div>
&lt;/figure>

&lt;p>ただし、これは開発時のみ使うべき機能として提供されており、Production 環境においては、通常通り CDK アプリ全体のデプロイを行うことが推奨されています。&lt;/p></description></item></channel></rss>