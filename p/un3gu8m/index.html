<!doctype html><html lang=ja-jp>
<head prefix="og: http://ogp.me/ns# fb: http://ogp.me/ns/fb#">
<meta charset=utf-8>
<meta name=viewport content="width=device-width,initial-scale=1">
<title>GitHub Actions で Hugo サイトをビルドして VPS サーバーに rsync デプロイする｜まくろぐ</title>
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-63069513-4"></script>
<script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag('js',new Date),gtag('config','UA-63069513-4')</script><meta property="og:site_name" content="まくろぐ">
<meta property="og:title" content="GitHub Actions で Hugo サイトをビルドして VPS サーバーに rsync デプロイする">
<meta property="og:type" content="website">
<meta property="og:url" content="https://maku.blog/p/un3gu8m/">
<meta property="og:locale" content="ja_JP"><meta property="og:image" content="https://maku.blog/img/site-logo.png">
<meta property="og:image:width" content="1436">
<meta property="og:image:height" content="746">
<meta property="og:description" content="何をするか？ Web サイトのコンテンツを GitHub で管理し、さくらの VPS や、お名前.com の VPS で Web サーバーを運用している場合、GitHub Actions でビルドとデプロイを自動化すると便利です。 ここでは、Web サイトのビルドに Hugo、VPS サーバーへのデプロイに rsync を使う前提で、次のような手順で自動化を進めていきます。
 SSH 鍵を作成する（自動デプロイのためパスワードは設定しない） VPS 側に SSH 公開鍵を登録する GitHub Actions のシークレットとして SSH 秘密鍵を登録する GitHub Actions のワークフローを作成し、ビルド (Hugo) とデプロイ (rsync) を自動化する  Web サイトのビルドには何を使ってもよいのですが、現時点でおそらく最速の静的サイトジェネレーターである Hugo を例にして説明しています。 GitHub Actions による自動化が完了すると、GitHub の main ブランチに Web サイトコンテンツを push するだけで、Hugo によるビルドと rsync による VPS へのデプロイが自動で行われるようになります。
SSH キーペアを作成して VPS へ公開鍵を登録する rsync コマンドで使用する SSH 鍵を ssh-keygen コマンドで作成しておきます。 GitHub Actions から rsync コマンドを実行するので、SSH 秘密鍵にはパスワードを設定しないようにします。 次の例では、github-actions / github-actions.">
<meta property="fb:app_id" content="1572235596285254"><link rel=stylesheet href=../../css/main.min.6b77bf17b61a7afcad6c078321c3b838d84d6fd87320e7556ec19bbd273c2794.css>
<link rel=icon sizes="16x16 32x32 48x48 64x64" href=../../assets/favicon/favicon.ico>
<link rel=icon sizes=192x192 href=../../assets/favicon/192x192.png>
<link rel=apple-touch-icon href=../../assets/favicon/180x180.png>
<script src=https://code.jquery.com/jquery-3.5.1.slim.min.js integrity="sha256-4+XzXVhsDmqanXGHaHvgh1gMQKX40OUvDEBTu8JcmNs=" crossorigin=anonymous></script>
<style>.codoc-support{display:inline-block;margin:.5rem 0 0!important;padding:12px!important;width:210px!important;max-width:100%}.codoc-support .codoc-support-title{font-size:smaller!important;white-space:nowrap;margin-bottom:12px!important}.codoc-support .codoc-btn{width:180px!important}</style>
<script src=https://codoc.jp/js/cms.js data-css=black data-usercode=tp6ZPzTj3w defer></script>
</head>
<body>
<div id=xRoot>
<div id=xSiteHeader><a href=../../>まくろぐ</a></div>
<aside>
<div class=xBreadcrumb>
<span class=xBreadcrumb_item><a href=../../>&#x1F3E0;</a>
</span>
<span class=xBreadcrumb_item><a href=../../p/3ftx6b2/>技術系</a>
</span>
<span class=xBreadcrumb_item><a href=../../p/5q4fr3d/>GitHub</a>
</span>
<span class=xBreadcrumb_item>GitHub Actions で Hugo サイトをビルドして VPS サーバーに rsync デプロイする
</span>
</div>
</aside>
<div id=xContainer>
<nav id=xMenu aria-label=メニュー>
<div id=sidebar style=height:100%>
<div id=sidebar_notFixed>
<a href=../../><img src=https://maku.blog/img/site-logo-sidebar.png></a>
<div class=xMenu_box data-sticky>
<form action=https://cse.google.com/cse target=_blank>
<div class=xSearchBox>
<input type=hidden name=cx value=partner-pub-6317852277883092:6890083468>
<input type=hidden name=ie value=UTF-8>
<input type=search name=q placeholder=サイト内検索 size=30 autocomplete=off>
<input type=submit value=検索></input>
</div>
</form>
<div class=xMenu_box_body>
</div>
</div>
<div class=xMenu_box data-sticky>
<h3 class=xMenu_box_title><a href=../../latest/>新着</a></h3>
<div class=xMenu_box_body>
<div class=xBoxLink>
<a href=../../p/oj9nzgt/>Node.js で URL のパスを結合する (url-join)
<time>2022-06-22</time></a>
</div>
<div class=xBoxLink>
<a href=../../p/9bku4cj/>GitHub GraphQL API のクエリ例: ユーザー情報を取得する (viewer, user)
<time>2022-06-20</time></a>
</div>
<div class=xBoxLink>
<a href=../../p/3o2doyb/>GitHub GraphQL クエリ例: 組織の情報を取得する (organization)
<time>2022-06-20</time></a>
</div>
<div class=xBoxLink>
<a href=../../p/p7q7n4i/>Linuxコマンド: ip コマンドの使い方
<time>2022-06-16</time></a>
</div>
<div class=xBoxLink>
<a href=../../p/k7eoer5/>AWS CDK で API Gateway の REST API を作成する
<time>2022-06-13</time></a>
</div>
</div>
</div>
<div class=xMenu_box data-sticky>
<h3 class=xMenu_box_title><a href=../../sitemap/>フォルダ</a></h3>
<div class=xMenu_box_body>
<div class=xNavTree>
<ul>
<li><a class=xNavTree-dir href=../../p/3ftx6b2/>技術系</a>
<ul>
<li><a class=xNavTree-dir href=../../p/ujqinda/>プログラミング</a>
<li><a class=xNavTree-dir href=../../p/vrhjtds/>Azure</a>
<li><a class=xNavTree-dir href=../../p/nd3cmt3/>ネットワーク</a>
<li><a class=xNavTree-dir href=../../p/ruk3gu9/>Linux</a>
<li><a class=xNavTree-dir href=../../p/cm9nyco/>GraphQL</a>
<li><a class=xNavTree-dir href=../../p/6p3dox9/>Firebase</a>
<li><a class=xNavTree-dir href=../../p/7s7hs4e/>AWS</a>
<li><a class=xNavTree-dir href=../../p/5q4fr3d/>GitHub</a>
<ul>
<li><a class=xNavTree-dir href=../../p/ubkahpw/>GitHub GraphQL API のクエリ例</a>
</ul>
<li><a class=xNavTree-dir href=../../p/8t6hr3d/>Ansible</a>
<li><a class=xNavTree-dir href=../../p/inh3k2j/>Visual Studio Code</a>
<li><a class=xNavTree-dir href=../../p/somcgdw/>macOS</a>
<li><a class=xNavTree-dir href=../../p/y42o4hw/>Windows</a>
<li><a class=xNavTree-dir href=../../p/e58h5in/>雑多な技術メモ</a>
<li><a class=xNavTree-dir href=../../p/jto2isn/>HTML/CSS のメモ</a>
<li><a class=xNavTree-dir href=../../p/ibs96hs/>フォント/文字コード/Locale/Unicode</a>
<li><a class=xNavTree-dir href=../../p/xb5w4in/>デザインパターン/UML</a>
<li><a class=xNavTree-dir href=../../p/9xv5548/>Jekyll</a>
<li><a class=xNavTree-dir href=../../p/zbgbb5u/>PlantUML</a>
<li><a class=xNavTree-dir href=../../p/xdsom3a/>Nginx（Web サーバー）</a>
<li><a class=xNavTree-dir href=../../p/jxvi6vv/>Excel のメモ</a>
</ul>
<li><a class=xNavTree-dir href=../../p/zb9ocav/>ツール</a>
<li><a class=xNavTree-dir href=../../p/35odek9/>読書</a>
<li><a class=xNavTree-dir href=../../p/ajj5753/>遊び</a>
<li><a class=xNavTree-dir href=../../p/qb73pxx/>日記・コラム</a>
<li><a class=xNavTree-dir href=../../p/syy4ryp/>設定</a>
<li><a class=xNavTree-dir href=../../p/tsjyzrn/>雑多</a>
<li><a class=xNavTree-dir href=../../p/hnoamfo/>管理人</a>
</ul>
</div>
</div>
</div>
<div class=xMenu_box data-sticky>
<h3 class=xMenu_box_title><a href=../../tags/>タグ</a></h3>
<div class=xMenu_box_body><div class=xMenu_tag>
<a href=../../tags/%E8%AA%AD%E6%9B%B8>読書 (79)</a>
</div><div class=xMenu_tag>
<a href=../../tags/aws>aws (61)</a>
</div><div class=xMenu_tag>
<a href=../../tags/azure>azure (58)</a>
</div><div class=xMenu_tag>
<a href=../../tags/typescript>typescript (58)</a>
</div><div class=xMenu_tag>
<a href=../../tags/%E6%97%A5%E8%A8%98>日記 (53)</a>
</div><div class=xMenu_tag>
<a href=../../tags/next.js>next.js (37)</a>
</div><div class=xMenu_tag>
<a href=../../tags/chatbot>chatbot (28)</a>
</div><div class=xMenu_tag>
<a href=../../tags/react>react (28)</a>
</div><div class=xMenu_tag>
<a href=../../tags/gnuplot>gnuplot (27)</a>
</div><div class=xMenu_tag>
<a href=../../tags/aws/cdk>aws/cdk (26)</a>
</div><div class=xMenu_tag>
<a href=../../tags/github>github (23)</a>
</div><div class=xMenu_tag>
<a href=../../tags/bot-builder-sdk>bot-builder-sdk (21)</a>
</div><div class=xMenu_tag>
<a href=../../tags/aws/dynamodb>aws/dynamodb (18)</a>
</div><div class=xMenu_tag>
<a href=../../tags/graphql>graphql (18)</a>
</div><div class=xMenu_tag>
<a href=../../tags/node.js>node.js (18)</a>
</div><div class=xMenu_tag>
<a href=../../tags/aws/cloudformation>aws/cloudformation (16)</a>
</div><div class=xMenu_tag>
<a href=../../tags/electron>electron (15)</a>
</div><div class=xMenu_tag>
<a href=../../tags/linux>linux (15)</a>
</div><div class=xMenu_tag>
<a href=../../tags/vs-code>vs-code (14)</a>
</div><div class=xMenu_tag>
<a href=../../tags/javascript>javascript (13)</a>
</div><div class=xMenu_tag>
<a href=../../tags/mongodb>mongodb (13)</a>
</div><div class=xMenu_tag>
<a href=../../tags/aws/cognito>aws/cognito (12)</a>
</div><div class=xMenu_tag>
<a href=../../tags/%E3%83%97%E3%83%AD%E3%82%B0%E3%83%A9%E3%83%A0>プログラム (11)</a>
</div><div class=xMenu_tag>
<a href=../../tags/android>android (10)</a>
</div><div class=xMenu_tag>
<a href=../../tags/aws/lambda>aws/lambda (10)</a>
</div><div class=xMenu_tag>
<a href=../../tags/%E3%82%B2%E3%83%BC%E3%83%A0>ゲーム (10)</a>
</div><div class=xMenu_tag>
<a href=../../tags/%E3%83%93%E3%83%AA%E3%83%A4%E3%83%BC%E3%83%89>ビリヤード (10)</a>
</div><div class=xMenu_tag>
<a href=../../tags/java>java (9)</a>
</div><div class=xMenu_tag>
<a href=../../tags/nginx>nginx (9)</a>
</div><div class=xMenu_tag>
<a href=../../tags/python>python (9)</a>
</div><div class=xMenu_tag>
<a href=../../tags/uml>uml (9)</a>
</div><div class=xMenu_tag>
<a href=../../tags/%E3%82%BB%E3%83%9F%E3%83%8A%E3%83%BC%E8%AC%9B%E6%BC%94%E4%BC%9A>セミナー講演会 (9)</a>
</div><div class=xMenu_tag>
<a href=../../tags/%E6%95%B0%E5%AD%A6>数学 (9)</a>
</div><div class=xMenu_tag>
<a href=../../tags/3d>3d (8)</a>
</div><div class=xMenu_tag>
<a href=../../tags/aws/sam>aws/sam (8)</a>
</div><div class=xMenu_tag>
<a href=../../tags/firebase/firestore>firebase/firestore (8)</a>
</div><div class=xMenu_tag>
<a href=../../tags/unity>unity (8)</a>
</div><div class=xMenu_tag>
<a href=../../tags/webgl>webgl (8)</a>
</div><div class=xMenu_tag>
<a href=../../tags/%E3%82%A2%E3%82%A4%E3%83%87%E3%82%A2>アイデア (8)</a>
</div><div class=xMenu_tag>
<a href=../../tags/%E4%BB%95%E4%BA%8B>仕事 (8)</a>
</div><div class=xMenu_tag>
<a href=../../tags/%E6%8A%80%E8%A1%93>技術 (8)</a>
</div><div class=xMenu_tag>
<a href=../../tags/azure-cli>azure-cli (7)</a>
</div><div class=xMenu_tag>
<a href=../../tags/azure-pipelines>azure-pipelines (7)</a>
</div><div class=xMenu_tag>
<a href=../../tags/jade>jade (7)</a>
</div><div class=xMenu_tag>
<a href=../../tags/%E3%83%87%E3%82%B6%E3%82%A4%E3%83%B3%E3%83%91%E3%82%BF%E3%83%BC%E3%83%B3>デザインパターン (7)</a>
</div><div class=xMenu_tag>
<a href=../../tags/%E3%83%A9%E3%82%A4%E3%83%95%E3%83%8F%E3%83%83%E3%82%AF>ライフハック (7)</a>
</div><div class=xMenu_tag>
<a href=../../tags/apollo>apollo (6)</a>
</div><div class=xMenu_tag>
<a href=../../tags/aws/api-gateway>aws/api-gateway (6)</a>
</div><div class=xMenu_tag>
<a href=../../tags/aws/cli>aws/cli (6)</a>
</div><div class=xMenu_tag>
<a href=../../tags/azure-storage>azure-storage (6)</a>
</div><div class=xMenu_tag>
<a href=../../tags/doxygen>doxygen (6)</a>
</div><div class=xMenu_tag>
<a href=../../tags/firebase/cloudfunctions>firebase/cloudfunctions (6)</a>
</div><div class=xMenu_tag>
<a href=../../tags/%E3%83%84%E3%83%BC%E3%83%AB>ツール (6)</a>
</div><div class=xMenu_tag>
<a href=../../tags/azure-table-storage>azure-table-storage (5)</a>
</div><div class=xMenu_tag>
<a href=../../tags/luis>luis (5)</a>
</div><div class=xMenu_tag>
<a href=../../tags/material-ui>material-ui (5)</a>
</div><div class=xMenu_tag>
<a href=../../tags/qna-maker>qna-maker (5)</a>
</div><div class=xMenu_tag>
<a href=../../tags/%E3%81%8A%E7%B5%B5%E3%81%8B%E3%81%8D>お絵かき (5)</a>
</div><div class=xMenu_tag>
<a href=../../tags/%E6%8A%95%E8%B3%87>投資 (5)</a>
</div><div class=xMenu_tag>
<a href=../../tags/%E7%94%9F%E3%81%8D%E6%96%B9>生き方 (5)</a>
</div><div class=xMenu_tag>
<a href=../../tags/ansible>ansible (4)</a>
</div><div class=xMenu_tag>
<a href=../../tags/aws/ssm>aws/ssm (4)</a>
</div><div class=xMenu_tag>
<a href=../../tags/c/c++>c/c++ (4)</a>
</div><div class=xMenu_tag>
<a href=../../tags/eslint>eslint (4)</a>
</div><div class=xMenu_tag>
<a href=../../tags/firebase>firebase (4)</a>
</div><div class=xMenu_tag>
<a href=../../tags/html/css>html/css (4)</a>
</div><div class=xMenu_tag>
<a href=../../tags/sql>sql (4)</a>
</div><div class=xMenu_tag>
<a href=../../tags/windows>windows (4)</a>
</div><div class=xMenu_tag>
<a href=../../tags/%E3%82%A8%E3%83%87%E3%82%A3%E3%82%BF>エディタ (4)</a>
</div><div class=xMenu_tag>
<a href=../../tags/%E3%83%A6%E3%83%8B%E3%83%83%E3%83%88%E3%83%86%E3%82%B9%E3%83%88>ユニットテスト (4)</a>
</div><div class=xMenu_tag>
<a href=../../tags/azure-functions>azure-functions (3)</a>
</div><div class=xMenu_tag>
<a href=../../tags/cosmos-db>cosmos-db (3)</a>
</div><div class=xMenu_tag>
<a href=../../tags/github-actions>github-actions (3)</a>
</div><div class=xMenu_tag>
<a href=../../tags/github-pages>github-pages (3)</a>
</div><div class=xMenu_tag>
<a href=../../tags/jekyll>jekyll (3)</a>
</div><div class=xMenu_tag>
<a href=../../tags/kotlin>kotlin (3)</a>
</div><div class=xMenu_tag>
<a href=../../tags/lets-encrypt>lets-encrypt (3)</a>
</div><div class=xMenu_tag>
<a href=../../tags/mac>mac (3)</a>
</div><div class=xMenu_tag>
<a href=../../tags/pc%E8%A8%AD%E5%AE%9A>pc設定 (3)</a>
</div><div class=xMenu_tag>
<a href=../../tags/powershell>powershell (3)</a>
</div><div class=xMenu_tag>
<a href=../../tags/prettier>prettier (3)</a>
</div><div class=xMenu_tag>
<a href=../../tags/sqlite>sqlite (3)</a>
</div><div class=xMenu_tag>
<a href=../../tags/textlint>textlint (3)</a>
</div><div class=xMenu_tag>
<a href=../../tags/tv>tv (3)</a>
</div><div class=xMenu_tag>
<a href=../../tags/%E3%81%8A%E3%81%A7%E3%81%8B%E3%81%91>おでかけ (3)</a>
</div><div class=xMenu_tag>
<a href=../../tags/%E3%82%A2%E3%83%97%E3%83%AA>アプリ (3)</a>
</div><div class=xMenu_tag>
<a href=../../tags/%E3%82%A2%E3%83%AB%E3%82%B4%E3%83%AA%E3%82%BA%E3%83%A0>アルゴリズム (3)</a>
</div><div class=xMenu_tag>
<a href=../../tags/%E3%82%BB%E3%82%AD%E3%83%A5%E3%83%AA%E3%83%86%E3%82%A3>セキュリティ (3)</a>
</div><div class=xMenu_tag>
<a href=../../tags/%E3%83%81%E3%83%A3%E3%83%83%E3%83%88%E3%83%9C%E3%83%83%E3%83%88>チャットボット (3)</a>
</div><div class=xMenu_tag>
<a href=../../tags/%E3%83%8D%E3%83%83%E3%83%88%E3%83%AF%E3%83%BC%E3%82%AF>ネットワーク (3)</a>
</div><div class=xMenu_tag>
<a href=../../tags/%E3%83%9C%E3%83%BC%E3%83%89%E3%82%B2%E3%83%BC%E3%83%A0>ボードゲーム (3)</a>
</div><div class=xMenu_tag>
<a href=../../tags/%E5%83%8D%E3%81%8D%E6%96%B9>働き方 (3)</a>
</div><div class=xMenu_tag>
<a href=../../tags/%E7%A7%80%E4%B8%B8>秀丸 (3)</a>
</div><div class=xMenu_tag>
<a href=../../tags/%E8%87%AA%E5%88%86>自分 (3)</a>
</div><div class=xMenu_tag>
<a href=../../tags/apache>apache (2)</a>
</div><div class=xMenu_tag>
<a href=../../tags/arib>arib (2)</a>
</div><div class=xMenu_tag>
<a href=../../tags/aws/amplify>aws/amplify (2)</a>
</div><div class=xMenu_tag>
<a href=../../tags/aws/appsync>aws/appsync (2)</a>
</div><div class=xMenu_tag>
<a href=../../tags/aws/codebuild>aws/codebuild (2)</a>
</div><div class=xMenu_tag>
<a href=../../tags/aws/iam>aws/iam (2)</a>
</div><div class=xMenu_tag>
<a href=../../tags/aws/kms>aws/kms (2)</a>
</div><div class=xMenu_tag>
<a href=../../tags/aws/s3>aws/s3 (2)</a>
</div><div class=xMenu_tag>
<a href=../../tags/aws/sdk>aws/sdk (2)</a>
</div><div class=xMenu_tag>
<a href=../../tags/azure-app-service>azure-app-service (2)</a>
</div><div class=xMenu_tag>
<a href=../../tags/excel>excel (2)</a>
</div><div class=xMenu_tag>
<a href=../../tags/firebase/authentication>firebase/authentication (2)</a>
</div><div class=xMenu_tag>
<a href=../../tags/go>go (2)</a>
</div><div class=xMenu_tag>
<a href=../../tags/grpc>grpc (2)</a>
</div><div class=xMenu_tag>
<a href=../../tags/http>http (2)</a>
</div><div class=xMenu_tag>
<a href=../../tags/hugo>hugo (2)</a>
</div><div class=xMenu_tag>
<a href=../../tags/npm>npm (2)</a>
</div><div class=xMenu_tag>
<a href=../../tags/oauth>oauth (2)</a>
</div><div class=xMenu_tag>
<a href=../../tags/opengl>opengl (2)</a>
</div><div class=xMenu_tag>
<a href=../../tags/protocol-buffers>protocol-buffers (2)</a>
</div><div class=xMenu_tag>
<a href=../../tags/rsync>rsync (2)</a>
</div><div class=xMenu_tag>
<a href=../../tags/scp>scp (2)</a>
</div><div class=xMenu_tag>
<a href=../../tags/slack>slack (2)</a>
</div><div class=xMenu_tag>
<a href=../../tags/teraterm>teraterm (2)</a>
</div><div class=xMenu_tag>
<a href=../../tags/unicode>unicode (2)</a>
</div><div class=xMenu_tag>
<a href=../../tags/vercel>vercel (2)</a>
</div><div class=xMenu_tag>
<a href=../../tags/zip>zip (2)</a>
</div><div class=xMenu_tag>
<a href=../../tags/%E3%81%8A%E5%90%8D%E5%89%8D.com>お名前.com (2)</a>
</div><div class=xMenu_tag>
<a href=../../tags/%E3%82%A8%E3%83%9F%E3%83%A5%E3%83%AC%E3%83%BC%E3%82%BF%E3%83%BC>エミュレーター (2)</a>
</div><div class=xMenu_tag>
<a href=../../tags/%E3%83%95%E3%82%A9%E3%83%B3%E3%83%88>フォント (2)</a>
</div><div class=xMenu_tag>
<a href=../../tags/%E3%83%97%E3%83%AD%E3%82%B0%E3%83%A9%E3%83%9F%E3%83%B3%E3%82%B0>プログラミング (2)</a>
</div><div class=xMenu_tag>
<a href=../../tags/%E3%83%AA%E3%83%95%E3%82%A1%E3%83%AC%E3%83%B3%E3%82%B9>リファレンス (2)</a>
</div><div class=xMenu_tag>
<a href=../../tags/%E5%9C%A7%E7%B8%AE%E5%B1%95%E9%96%8B>圧縮展開 (2)</a>
</div><div class=xMenu_tag>
<a href=../../tags/%E6%96%87%E5%AD%97%E5%88%97>文字列 (2)</a>
</div><div class=xMenu_tag>
<a href=../../tags/.net>.net (1)</a>
</div><div class=xMenu_tag>
<a href=../../tags/androidstudio>androidstudio (1)</a>
</div><div class=xMenu_tag>
<a href=../../tags/apollo-server>apollo-server (1)</a>
</div><div class=xMenu_tag>
<a href=../../tags/atomic-design>atomic-design (1)</a>
</div><div class=xMenu_tag>
<a href=../../tags/blender>blender (1)</a>
</div><div class=xMenu_tag>
<a href=../../tags/bluetooth>bluetooth (1)</a>
</div><div class=xMenu_tag>
<a href=../../tags/bootstrap>bootstrap (1)</a>
</div><div class=xMenu_tag>
<a href=../../tags/bot-framework>bot-framework (1)</a>
</div><div class=xMenu_tag>
<a href=../../tags/boto3>boto3 (1)</a>
</div><div class=xMenu_tag>
<a href=../../tags/css>css (1)</a>
</div><div class=xMenu_tag>
<a href=../../tags/dns>dns (1)</a>
</div><div class=xMenu_tag>
<a href=../../tags/dvb>dvb (1)</a>
</div><div class=xMenu_tag>
<a href=../../tags/editorconfig>editorconfig (1)</a>
</div><div class=xMenu_tag>
<a href=../../tags/evernote>evernote (1)</a>
</div><div class=xMenu_tag>
<a href=../../tags/git>git (1)</a>
</div><div class=xMenu_tag>
<a href=../../tags/groovy>groovy (1)</a>
</div><div class=xMenu_tag>
<a href=../../tags/html>html (1)</a>
</div><div class=xMenu_tag>
<a href=../../tags/iso>iso (1)</a>
</div><div class=xMenu_tag>
<a href=../../tags/jest>jest (1)</a>
</div><div class=xMenu_tag>
<a href=../../tags/json>json (1)</a>
</div><div class=xMenu_tag>
<a href=../../tags/macos>macos (1)</a>
</div><div class=xMenu_tag>
<a href=../../tags/parcel>parcel (1)</a>
</div><div class=xMenu_tag>
<a href=../../tags/raspberrypi>raspberrypi (1)</a>
</div><div class=xMenu_tag>
<a href=../../tags/ssh>ssh (1)</a>
</div><div class=xMenu_tag>
<a href=../../tags/teams>teams (1)</a>
</div><div class=xMenu_tag>
<a href=../../tags/tex>tex (1)</a>
</div><div class=xMenu_tag>
<a href=../../tags/ubuntu>ubuntu (1)</a>
</div><div class=xMenu_tag>
<a href=../../tags/url>url (1)</a>
</div><div class=xMenu_tag>
<a href=../../tags/vim>vim (1)</a>
</div><div class=xMenu_tag>
<a href=../../tags/web>web (1)</a>
</div><div class=xMenu_tag>
<a href=../../tags/webpack>webpack (1)</a>
</div><div class=xMenu_tag>
<a href=../../tags/wsl>wsl (1)</a>
</div><div class=xMenu_tag>
<a href=../../tags/%E3%82%A2%E3%82%B8%E3%83%A3%E3%82%A4%E3%83%AB>アジャイル (1)</a>
</div><div class=xMenu_tag>
<a href=../../tags/%E3%83%90%E3%83%83%E3%83%81%E3%83%95%E3%82%A1%E3%82%A4%E3%83%AB>バッチファイル (1)</a>
</div><div class=xMenu_tag>
<a href=../../tags/%E3%83%97%E3%83%AD%E3%82%AD%E3%82%B7%E8%A8%AD%E5%AE%9A>プロキシ設定 (1)</a>
</div><div class=xMenu_tag>
<a href=../../tags/%E6%96%87%E5%AD%97%E3%82%B3%E3%83%BC%E3%83%89>文字コード (1)</a>
</div><div class=xMenu_tag>
<a href=../../tags/%E6%96%87%E6%88%BF%E5%85%B7>文房具 (1)</a>
</div><div class=xMenu_tag>
<a href=../../tags/%E6%96%99%E7%90%86>料理 (1)</a>
</div><div class=xMenu_tag>
<a href=../../tags/%E6%AD%A3%E8%A6%8F%E8%A1%A8%E7%8F%BE>正規表現 (1)</a>
</div><div class=xMenu_tag>
<a href=../../tags/%E7%94%BB%E5%83%8F%E5%87%A6%E7%90%86>画像処理 (1)</a>
</div><div class=xMenu_tag>
<a href=../../tags/%E8%A8%80%E8%91%89>言葉 (1)</a>
</div><div class=xMenu_tag>
<a href=../../tags/%E8%A8%AD%E5%AE%9A>設定 (1)</a>
</div><div class=xMenu_tag>
<a href=../../tags/%E8%AA%8D%E8%A8%BC>認証 (1)</a>
</div><div class=xMenu_tag>
<a href=../../tags/%E9%80%9F%E8%AA%AD>速読 (1)</a>
</div><div class=xMenu_tag>
<a href=../../tags/%E9%9F%B3%E5%A3%B0%E8%AA%8D%E8%AD%98>音声認識 (1)</a>
</div></div>
</div>
<div class=xMenu_box data-sticky><br></div>
</div>
<div id=sidebar_fixed style=position:-webkit-sticky;position:sticky;top:4rem>
</div>
</div>
</nav>
<main id=xMain>
<article class=xArticle itemscope itemtype=https://schema.org/BlogPosting>
<aside>
<div class=xPrevNextLink>
<div class=xPrevNextLink_prev>
<a href=../../p/qcp2cnx/>Apollo Client で GitHub GraphQL API を使う (Node & React)</a>
</div>
<div class=xPrevNextLink_next>
<a href=../../p/whv8it5/>GitHub GraphQL のスキーマ情報を取得する</a>
</div>
</div>
</aside>
<header class=xArticle_headerBox>
<div>
<span class=xArticle_headerBox_breadcrumb><a href=../../>&#x1F3E0;</a></span>
<span class=xArticle_headerBox_breadcrumb><a href=../../p/3ftx6b2/>技術系</a></span>
<span class=xArticle_headerBox_breadcrumb><a href=../../p/5q4fr3d/>GitHub</a></span></div>
<div style=display:flex;margin-top:.8em>
<div style=width:80px;margin-right:.5em>
<img src=../../p/5q4fr3d/_index.svg style=width:80px;height:80px>
</div>
<div style=flex:1>
<h1 itemprop=headline class=xArticle_headerBox_title><a itemprop=mainEntityOfPage href=../../p/un3gu8m/>GitHub Actions で Hugo サイトをビルドして VPS サーバーに rsync デプロイする</a></h1>
<div class=xPageTags>
<span class=xPageTags_item><a href=../../tags/github-actions>GitHub Actions</a></span>
<span class=xPageTags_item><a href=../../tags/hugo>Hugo</a></span>
<span class=xPageTags_item><a href=../../tags/rsync>rsync</a></span>
</div>
</div>
</div>
<span class=xPageDate>
更新: <time itemprop=dateModified datetime=2022-02-27>2022-02-27</time><br>
作成: <time itemprop=datePublished datetime=2022-02-27>2022-02-27</time>
</span>
</header>
<div itemprop=articleBody class=xArticle_content>
<nav id=TableOfContents>
<ul>
<li><a href=#何をするか>何をするか？</a></li>
<li><a href=#ssh-キーペアを作成して-vps-へ公開鍵を登録する>SSH キーペアを作成して VPS へ公開鍵を登録する</a></li>
<li><a href=#github-のシークレットとして-ssh-秘密鍵を登録する>GitHub のシークレットとして SSH 秘密鍵を登録する</a></li>
<li><a href=#github-actions-のワークフローを作成する>GitHub Actions のワークフローを作成する</a></li>
</ul>
</nav><h2 id=何をするか>何をするか？</h2>
<p>Web サイトのコンテンツを GitHub で管理し、さくらの VPS や、お名前.com の VPS で Web サーバーを運用している場合、GitHub Actions でビルドとデプロイを自動化すると便利です。
ここでは、Web サイトのビルドに <strong>Hugo</strong>、VPS サーバーへのデプロイに <strong>rsync</strong> を使う前提で、次のような手順で自動化を進めていきます。</p>
<ol>
<li>SSH 鍵を作成する（自動デプロイのためパスワードは設定しない）</li>
<li>VPS 側に SSH 公開鍵を登録する</li>
<li>GitHub Actions のシークレットとして SSH 秘密鍵を登録する</li>
<li>GitHub Actions のワークフローを作成し、ビルド (Hugo) とデプロイ (rsync) を自動化する</li>
</ol>
<p>Web サイトのビルドには何を使ってもよいのですが、現時点でおそらく最速の静的サイトジェネレーターである Hugo を例にして説明しています。
GitHub Actions による自動化が完了すると、GitHub の main ブランチに Web サイトコンテンツを push するだけで、Hugo によるビルドと rsync による VPS へのデプロイが自動で行われるようになります。</p>
<h2 id=ssh-キーペアを作成して-vps-へ公開鍵を登録する>SSH キーペアを作成して VPS へ公開鍵を登録する</h2>
<p><code>rsync</code> コマンドで使用する SSH 鍵を <code>ssh-keygen</code> コマンドで作成しておきます。
GitHub Actions から <code>rsync</code> コマンドを実行するので、SSH 秘密鍵にはパスワードを設定しないようにします。
次の例では、<code>github-actions</code> / <code>github-actions.pub</code> という名前のキーペアを作成しています。
ファイル名は何でも構いません。</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-console data-lang=console><span class=gp>$ </span>ssh-keygen
<span class=go>Generating public/private rsa key pair.
</span><span class=go>Enter file in which to save the key (/Users/maku/.ssh/id_rsa): github-actions
</span><span class=go>Enter passphrase (empty for no passphrase): ★そのままEnter
</span><span class=go>Enter same passphrase again: ★そのままEnter
</span></code></pre></div><p>SSH キーぺアが用意できたら、VPS（Web サーバー）へ公開鍵を登録します。
<code>ssh-id-copy</code> コマンドを使うと、簡単に <code>~/.ssh/authorized_keys</code> にエントリを追加できます。</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-console data-lang=console><span class=gp>$ </span>ssh-copy-id -i github-actions.pub user@example.com
<span class=go>...
</span><span class=go>user@example.com&#39;s password: （リモートホスト側のユーザーのパスワードを入力）
</span><span class=go>...
</span></code></pre></div><ul>
<li>参考: <a href=../../p/2mzbmw8>ssh-id-copy で SSH の公開鍵をリモートホストに登録する</a></li>
</ul>
<p><code>ssh</code> コマンドで接続できるようになっているか確認しておきます。</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-console data-lang=console><span class=gp>$ </span>ssh -i github-actions user@example.com
</code></pre></div><p>ここまでできたら、作成した SSH キーペアを安全な場所に退避しておきます。
特に秘密鍵 (<code>github-actions</code>) の方は厳重に管理してください。</p>
<h2 id=github-のシークレットとして-ssh-秘密鍵を登録する>GitHub のシークレットとして SSH 秘密鍵を登録する</h2>
<p>GitHub Actions から SSH 秘密鍵を参照する必要があるので、先に Repository secret 情報として SSH 秘密鍵の値を登録しておきます。</p>
<ol>
<li>
<p>GitHub の対象リポジトリを開き、<strong><code>Settings</code></strong> タブ → <strong><code>Secrets</code></strong> → <strong><code>Actions</code></strong> と選択します。</p>
</li>
<li>
<p><strong><code>New repository secret</code></strong> ボタンを押します。</p>
</li>
<li>
<p><code>Name</code> に <strong><code>SSH_PRIVATE_KEY</code></strong> と入力し、<code>Value</code> に秘密鍵ファイル（今回は <code>github-actions</code> ファイル）の内容を貼り付けます。</p>
<pre tabindex=0><code>-----BEGIN OPENSSH PRIVATE KEY-----
b3BlbnNzaC1rZXktdjEAAAAABG5vbmUAAAAEbm9uZQAAAAAAAAABAAABlwAAAAdzc2gtcn
NhAAAAAwEAAQAAAYEAqBOVBdo3ZL41PXEqvDY7malbuWPur0grpHLlh/sLqY4Wqm64b4W6

...（省略）...

hLY0Rl3sWcrLswb6/j5tu713d0wL+jyXwTJ2G00nVXOE86wmDEsUEQWazZ166sxGP5U7Co
RyRi5y7Tx50Z0AAAASbWFrdUBtYWt1bWFjLmxvY2FsAQ==
-----END OPENSSH PRIVATE KEY-----
</code></pre></li>
</ol>
<p>VPS の「ユーザー名」や「接続先アドレス」、「コピー先ディレクトリ」も念のため隠しておきたいので、次のようなシークレットも追加で登録しておきます。</p>
<ul>
<li>Name: <strong><code>SSH_USER</code></strong>、Value: VPSのユーザ名 （例: <code>maku</code>）</li>
<li>Name: <strong><code>SSH_HOST</code></strong>、Value: VPSのアドレス （例: <code>www9999xx.sakura.ne.jp</code>）</li>
<li>Name: <strong><code>DST_PATH</code></strong>、Value: デプロイ先のホームディレクトリからの相対パス （例: <code>webroot</code>）</li>
</ul>
<p>シークレットを 3 つ登録するのが煩わしい場合は、次のように 1 つのシークレットにまとめてしまってもいいかもしれません。</p>
<ul>
<li>Name: <strong><code>RSYNC_TARGET</code></strong>、Value: <code>maku@www9999xx.sakura.ne.jp:webroot</code>（例）</li>
</ul>
<h2 id=github-actions-のワークフローを作成する>GitHub Actions のワークフローを作成する</h2>
<p>Web サイトのコンテンツが格納されている GitHub リポジトリに、GitHub Actions のワークフローを作成します。
ワークフローでは、特定のイベントが発生したときに実行する一連のジョブを定義します。</p>
<ol>
<li><code>Actions</code> タブを開き、<strong><code>set up a workflow yourself</code></strong> を選択します。</li>
<li>後述のような内容のワークフローファイルをコミットします。デフォルトのファイル名は <code>main.yml</code> ですが、<code>.github/workflows</code> ディレクトリ以下であれば、ファイル名は何でもかまいません。</li>
</ol>
<p>これで、<code>main</code> ブランチに Web サイトのコンテンツを push（あるいはトピックブランチからのマージ）するだけで、Hugo によるビルドと rsync によるデプロイが自動で行われるようになります。</p>
<figure class=xCodeBlock>
<figcaption class=xCodeBlock_title>&lt;Repo>/.github/workflows/main.yml</figcaption>
<div class=xCodeBlock_code><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=nt>on</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>push</span><span class=p>:</span><span class=w>
</span><span class=w>    </span><span class=nt>branches</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=w> </span><span class=l>main ]</span><span class=w>
</span><span class=w>
</span><span class=w></span><span class=nt>jobs</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>build-and-deploy</span><span class=p>:</span><span class=w>
</span><span class=w>    </span><span class=nt>runs-on</span><span class=p>:</span><span class=w> </span><span class=l>ubuntu-latest</span><span class=w>
</span><span class=w>    </span><span class=nt>steps</span><span class=p>:</span><span class=w>
</span><span class=w>      </span>- <span class=nt>uses</span><span class=p>:</span><span class=w> </span><span class=l>actions/checkout@v2</span><span class=w>
</span><span class=w>        </span><span class=nt>with</span><span class=p>:</span><span class=w>
</span><span class=w>          </span><span class=nt>submodules</span><span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=w>  </span><span class=c># Fetch Hugo themes (true OR recursive)</span><span class=w>
</span><span class=w>          </span><span class=nt>fetch-depth</span><span class=p>:</span><span class=w> </span><span class=m>0</span><span class=w>    </span><span class=c># Fetch all history for .GitInfo and .Lastmod</span><span class=w>
</span><span class=w>
</span><span class=w>      </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>Setup Hugo</span><span class=w>
</span><span class=w>        </span><span class=nt>uses</span><span class=p>:</span><span class=w> </span><span class=l>peaceiris/actions-hugo@v2</span><span class=w>
</span><span class=w>        </span><span class=nt>with</span><span class=p>:</span><span class=w>
</span><span class=w>          </span><span class=nt>hugo-version</span><span class=p>:</span><span class=w> </span><span class=s1>&#39;0.92.1&#39;</span><span class=w>
</span><span class=w>          </span><span class=nt>extended</span><span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=w>  </span><span class=c># Enable scss</span><span class=w>
</span><span class=w>
</span><span class=w>      </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>Build</span><span class=w>
</span><span class=w>        </span><span class=nt>run</span><span class=p>:</span><span class=w> </span><span class=l>hugo --minify</span><span class=w>
</span><span class=w>
</span><span class=w>      </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>Generate ssh key</span><span class=w>
</span><span class=w>        </span><span class=nt>run</span><span class=p>:</span><span class=w> </span><span class=l>echo &#34;$SSH_PRIVATE_KEY&#34; &gt; ${{ runner.temp }}/key &amp;&amp; chmod 600 ${{ runner.temp }}/key</span><span class=w>
</span><span class=w>        </span><span class=nt>env</span><span class=p>:</span><span class=w>
</span><span class=w>          </span><span class=nt>SSH_PRIVATE_KEY</span><span class=p>:</span><span class=w> </span><span class=l>${{ secrets.SSH_PRIVATE_KEY }}</span><span class=w>
</span><span class=w>
</span><span class=w>      </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>Deploy with rsync</span><span class=w>
</span><span class=w>        </span><span class=nt>run</span><span class=p>:</span><span class=w> </span><span class=p>&gt;</span><span class=sd>
</span><span class=sd>          rsync -e &#39;ssh -i ${{ runner.temp }}/key -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null&#39;
</span><span class=sd>          -av --delete public/ ${SSH_USER}@${SSH_HOST}:${DST_PATH}</span><span class=w>          
</span><span class=w>        </span><span class=nt>env</span><span class=p>:</span><span class=w>
</span><span class=w>          </span><span class=nt>SSH_USER</span><span class=p>:</span><span class=w> </span><span class=l>${{ secrets.SSH_USER }}</span><span class=w>
</span><span class=w>          </span><span class=nt>SSH_HOST</span><span class=p>:</span><span class=w> </span><span class=l>${{ secrets.SSH_HOST }}</span><span class=w>
</span><span class=w>          </span><span class=nt>DST_PATH</span><span class=p>:</span><span class=w> </span><span class=l>${{ secrets.DST_PATH }}</span></code></pre></div></div>
</figure>
<p>以下、このワークフローファイルの内容について細かく見ていきます。</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=nt>on</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>push</span><span class=p>:</span><span class=w>
</span><span class=w>    </span><span class=nt>branches</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=w> </span><span class=l>main ]</span><span class=w>
</span></code></pre></div><p>まず、この <code>on</code> プロパティで、<code>main</code> ブランチへの push が行われたときに、このワークフローが実行されるように設定しています。
残りは、<code>build-and-deploy</code> ジョブの各ステップの説明になります（今回定義しているジョブは 1 つだけです）。
ジョブ内の各ステップは上から順番に実行されていき、どこかでエラーが発生すると、そこでジョブの実行は停止します。
なので、ビルドに失敗したら、後続のデプロイ処理は実行されません。</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml>- <span class=nt>uses</span><span class=p>:</span><span class=w> </span><span class=l>actions/checkout@v2</span><span class=w>
</span><span class=w>  </span><span class=nt>with</span><span class=p>:</span><span class=w>
</span><span class=w>    </span><span class=nt>submodules</span><span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=w>  </span><span class=c># Fetch Hugo themes (true OR recursive)</span><span class=w>
</span><span class=w>    </span><span class=nt>fetch-depth</span><span class=p>:</span><span class=w> </span><span class=m>0</span><span class=w>    </span><span class=c># Fetch all history for .GitInfo and .Lastmod</span><span class=w>
</span></code></pre></div><p>最初のステップでは、定番の <code>actions/checkout</code> アクションを使って、リポジトリ内のコードをワークスペースにチェックアウトします。
Hugo プロジェクトでは、通常 Git submodules で外部テーマを取り込んで使用するので、<code>submodules: true</code> オプションを指定して、サブモジュールを一緒に取得するようにしています。</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>Setup Hugo</span><span class=w>
</span><span class=w>  </span><span class=nt>uses</span><span class=p>:</span><span class=w> </span><span class=l>peaceiris/actions-hugo@v2</span><span class=w>
</span><span class=w>  </span><span class=nt>with</span><span class=p>:</span><span class=w>
</span><span class=w>    </span><span class=nt>hugo-version</span><span class=p>:</span><span class=w> </span><span class=s1>&#39;0.92.1&#39;</span><span class=w>
</span><span class=w>    </span><span class=nt>extended</span><span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=w>  </span><span class=c># Enable scss</span><span class=w>
</span></code></pre></div><p><code>peaceiris/actions-hugo</code> で Hugo をインストールしています。
Web サイトのスタイル定義に SCSS などのプリプロセッサを使っている場合は、extended バージョンの Hugo が必要になるので、<code>extended: true</code> オプションを指定しています。</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>Build</span><span class=w>
</span><span class=w>  </span><span class=nt>run</span><span class=p>:</span><span class=w> </span><span class=l>hugo --minify</span><span class=w>
</span></code></pre></div><p>Hugo による Web サイトのビルドを行います。
オプションは適宜修正します。
例えば、<code>-F</code> オプションを追加すれば、将来の日付が設定されたコンテンツをビルド対象にできます。</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>Generate ssh key</span><span class=w>
</span><span class=w>  </span><span class=nt>run</span><span class=p>:</span><span class=w> </span><span class=l>echo &#34;$SSH_PRIVATE_KEY&#34; &gt; ${{ runner.temp }}/key &amp;&amp; chmod 600 ${{ runner.temp }}/key</span><span class=w>
</span><span class=w>  </span><span class=nt>env</span><span class=p>:</span><span class=w>
</span><span class=w>    </span><span class=nt>SSH_PRIVATE_KEY</span><span class=p>:</span><span class=w> </span><span class=l>${{ secrets.SSH_PRIVATE_KEY }}</span><span class=w>
</span></code></pre></div><p>この後の <code>rsync</code> コマンド実行時に、SSH 秘密鍵の「ファイル」が必要になるので、ここで作成しています。
前述の手順で <code>SSH_PRIVATE_KEY</code> というシークレットに、SSH 秘密鍵の「値」を格納しておいたので、この値を <code>key</code> という名前の「ファイル」として出力します。
<code>${{ runner.temp }}</code> は、ビルド時にテンポラリディレクトリ名に置換されます。</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>Deploy with rsync</span><span class=w>
</span><span class=w>  </span><span class=nt>run</span><span class=p>:</span><span class=w> </span><span class=p>&gt;</span><span class=sd>
</span><span class=sd>    rsync -e &#39;ssh -i ${{ runner.temp }}/key -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null&#39;
</span><span class=sd>    -r -h --delete public/ ${SSH_USER}@${SSH_HOST}:${DST_PATH}</span><span class=w>    
</span><span class=w>  </span><span class=nt>env</span><span class=p>:</span><span class=w>
</span><span class=w>    </span><span class=nt>SSH_USER</span><span class=p>:</span><span class=w> </span><span class=l>${{ secrets.SSH_USER }}</span><span class=w>
</span><span class=w>    </span><span class=nt>SSH_HOST</span><span class=p>:</span><span class=w> </span><span class=l>${{ secrets.SSH_HOST }}</span><span class=w>
</span><span class=w>    </span><span class=nt>DST_PATH</span><span class=p>:</span><span class=w> </span><span class=l>${{ secrets.DST_PATH }}</span><span class=w>
</span></code></pre></div><p>最後は <code>rsync</code> によるデプロイ処理ですが、ここは若干複雑です。
<code>rsync</code> の <code>-e</code> オプションでは、SSH 秘密鍵ファイルの指定と、<code>known_hosts</code> 関連のエラー対策を行っています。</p>
<pre tabindex=0><code>rsync -e 'ssh -i ${{ runner.temp }}/key -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null'
</code></pre><p>SSH で新しいホストに接続しようとすると、<code>known_hosts</code> への接続先ホスト情報の書き込みが行われるのですが、この処理はデフォルトでユーザーに確認を求めるという挙動になっているので、<code>-o StrictHostKeyChecking=no</code> というオプションで、ユーザー確認なしで書き込むようにします。
さらに、<code>-o UserKnownHostsFile=/dev/null</code> という指定で、実際には <code>known_hosts</code> ファイルには出力せずに、出力を破棄するという振る舞いにしています。
これらを指定しておかないと、<code>rsync</code> コマンド実行時に、<code>Host key verification failed.</code> というエラーが出て、ジョブが停止してしまいます。
このあたりは、おまじないのように入れておけばよいと思います。</p>
<p><code>rsync</code> の残りの部分では、具体的なファイルのコピー方法などを指定しています。</p>
<pre tabindex=0><code>    -av --delete public/ ${SSH_USER}@${SSH_HOST}:${DST_PATH}
  env:
    SSH_USER: ${{ secrets.SSH_USER }}
    SSH_HOST: ${{ secrets.SSH_HOST }}
    DST_PATH: ${{ secrets.DST_PATH }}
</code></pre><p>ここも用途によって要調整ですが、大体次のような指定を行っています。</p>
<ul>
<li><code>-a</code> &mldr; アーカイブモードでコピーする（ディレクトリを再帰的に処理し、タイムスタンプやパーミッション情報を維持する）</li>
<li><code>-v</code> &mldr; ログを詳細に表示する</li>
<li><code>--delete</code> &mldr; コピー元にないファイルをコピー先から削除する</li>
<li><code>public/</code> &mldr; コピー元のディレクトリパス
<ul>
<li>Hugo のデフォルトの出力ディレクトリは <code>public</code> です。<code>public</code> ディレクトリそのものではなく、ディレクトリ内のファイルだけをコピーしたい場合は、<code>public/</code> のように末尾にスラッシュが必要なことに注意してください。</li>
</ul>
</li>
<li><code>${SSH_USER}@${SSH_HOST}:${DST_PATH}</code> &mldr; VPN のユーザー名、ホスト名、ディレクトリ名
<ul>
<li>それぞれのプレースホルダーには、GitHub の Repository secret で設定した値が入ります。コピー先のディレクトリ名は、VPN ユーザーのホームディレクトリからの相対パスで指定します。</li>
</ul>
</li>
</ul>
<p><code>rsync</code> コマンドの詳細に関しては、下記の記事を参考にしてください。</p>
<ul>
<li>参考: <a href=../../p/c3s7wyx>rsync コマンドで2つのディレクトリを同期する</a></li>
</ul>
<meta itemprop=author content="まく">
<span itemprop=publisher itemscope itemtype=https://schema.org/Organization>
<meta itemprop=name content="まく">
</span>
<h3 style="border-bottom:1px solid gray">関連記事</h3>
<ul>
<li><a href=../../p/au8ju6g/>Next.js アプリを GitHub Actions でビルドして GitHub Pages で公開する</a></li>
<li><a href=../../p/5q3eq2c/>GitHub Actions で Web サイトをビルドして GitHub Pages へ公開する</a></li>
<li><a href=../../p/xwfwdy6/>GitHub Pages は早く Jekyll から Hugo に乗り換えるべき</a></li>
<li><a href=../../p/c3s7wyx/>Linuxコマンド: rsync コマンドで2つのディレクトリを同期する</a></li>
</ul>
<div class=xPageTags>
<span class=xPageTags_item><a href=../../tags/github-actions>GitHub Actions</a></span>
<span class=xPageTags_item><a href=../../tags/hugo>Hugo</a></span>
<span class=xPageTags_item><a href=../../tags/rsync>rsync</a></span>
</div>
</div>
<div style=text-align:right>
<div id=codoc-entry-4gYwTntzzw class=codoc-entries data-without-body=1 data-support-button-text="（っ'-')╮シュッ=͟͟͞͞ 💵" data-show-like=0 data-show-about-codoc=0 data-show-powered-by=0 data-support-message=まくに投げ銭できるよ></div>
</div>
<div class=xArticle_up>
<a href=../../p/5q4fr3d/><span class=xArticle_up_label>GitHubメモ</span><br>へ戻る</a>
</div>
<aside>
<div class=xPrevNextLink>
<div class=xPrevNextLink_prev>
<a href=../../p/qcp2cnx/>Apollo Client で GitHub GraphQL API を使う (Node & React)</a>
</div>
<div class=xPrevNextLink_next>
<a href=../../p/whv8it5/>GitHub GraphQL のスキーマ情報を取得する</a>
</div>
</div>
</aside>
</article>
<script async src=//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js></script>
<ins class=adsbygoogle style=display:block;text-align:center data-ad-layout=in-article data-ad-format=fluid data-ad-client=ca-pub-6317852277883092 data-ad-slot=8636867067></ins>
<script>(adsbygoogle=window.adsbygoogle||[]).push({})</script>
</main>
</div>
<aside>
<div class=xBreadcrumb>
<span class=xBreadcrumb_item><a href=../../>&#x1F3E0;</a>
</span>
<span class=xBreadcrumb_item><a href=../../p/3ftx6b2/>技術系</a>
</span>
<span class=xBreadcrumb_item><a href=../../p/5q4fr3d/>GitHub</a>
</span>
<span class=xBreadcrumb_item>GitHub Actions で Hugo サイトをビルドして VPS サーバーに rsync デプロイする
</span>
</div>
</aside>
<div id=xSiteFooter><a href=../../>まくろぐ</a></div>
<div id=xSiteFooter2>
<a href=../../sitemap/>サイトマップ</a> ｜
<a tatget=_blank href=https://forms.gle/xdUszEv4f5CEqH947>まくへのメッセージ</a>
</div>
</div>
<script src=../../assets/js/sidebar.js></script>
<script>document.addEventListener('DOMContentLoaded',function(){const a=document.querySelectorAll('a[href^=http]');for(let c=0;c<a.length;++c){const b=a[c];b.setAttribute('target','_blank'),b.setAttribute('rel','noopener');const d=b.getElementsByTagName('img');if(d.length>0)continue;b.classList.add('xExternalLinkIcon')}})</script>
<script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"まくろぐ","item":"https://maku.blog/"},{"@type":"ListItem","position":2,"name":"技術系","item":"https://maku.blog/p/3ftx6b2/"},{"@type":"ListItem","position":3,"name":"GitHub","item":"https://maku.blog/p/5q4fr3d/"},{"@type":"ListItem","position":4,"name":"GitHub Actions で Hugo サイトをビルドして VPS サーバーに rsync デプロイする","item":"https://maku.blog/p/un3gu8m/"}]}</script>
</body>
</html>