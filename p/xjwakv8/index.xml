<?xml version="1.0" encoding="utf-8" standalone="yes"?><rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom"><channel><title>Azure Cosmos DB 関連記事 on まくろぐ</title><link>https://maku.blog/p/xjwakv8/</link><description>Recent content in Azure Cosmos DB 関連記事 on まくろぐ</description><generator>Hugo</generator><language>ja-jp</language><lastBuildDate>Sat, 12 Jun 2021 00:00:00 +0900</lastBuildDate><atom:link href="https://maku.blog/p/xjwakv8/index.xml" rel="self" type="application/rss+xml"/><item><title>Azure Cosmos DB にアカウントを作って MongoDB API でアクセスする</title><link>https://maku.blog/p/cd9bg3x/</link><pubDate>Tue, 21 May 2019 00:00:00 +0900</pubDate><guid>https://maku.blog/p/cd9bg3x/</guid><description>&lt;h2 id="azure-cosmos-db-と-mongodb-api">Azure Cosmos DB と MongoDB API&lt;/h2>
&lt;p>Azure Cosmos DB は、Microsoft の Azure 上に配置できるスケーラブルなデータベースで、&lt;strong>SQL や MongoDB API など様々なインタフェースでアクセスできる&lt;/strong>ようになっています。&lt;/p>
&lt;p>MongoDB を使った既存のアプリケーションがある場合、接続先を Azure Cosmos DB アカウントのアドレスに変更するだけで、簡単にクラウド上のデータを扱えるようになります。
ローカルの MongoDB サーバ (&lt;code>mongod&lt;/code>) に接続する代わりに、Azure Cosmos DB に接続するということです。&lt;/p>
&lt;p>ここでは、MongoDB API（MongoDB シェル）による Azure Cosmos DB へのアクセスを試してみます。
まずは、Azure 上に Cosmos DB のリソースを作成します。&lt;/p>
&lt;h2 id="azure-cosmos-db-アカウントを作成する">Azure Cosmos DB アカウントを作成する&lt;/h2>
&lt;p>&lt;a href="https://portal.azure.com/">Azure ポータル&lt;/a>へログインし、&lt;samp>Azure Cosmos DB&lt;/samp> のページを開き、&lt;samp>Azure Cosmos DB アカウントの作成&lt;/samp> をクリックします。&lt;/p>


&lt;figure class="xImage">
 &lt;img style="border: solid #ccc 2px;" width="700" height="540" src="../../p/cd9bg3x/cosmos-account-001_hu12261836377971598877.png" alt="/p/cd9bg3x/cosmos-account-001.png" />
&lt;/figure>

&lt;p>次の画面では、&lt;samp>アカウント名&lt;/samp> や &lt;samp>API&lt;/samp> の種類を設定します。&lt;/p>


&lt;figure class="xImage">
 &lt;img style="border: solid #ccc 2px;" width="500" height="492" src="../../p/cd9bg3x/cosmos-account-002_hu672509507542301180.png" alt="/p/cd9bg3x/cosmos-account-002.png" />
&lt;/figure>

&lt;p>&lt;samp>アカウント名&lt;/samp> に入力した値は、下記のように接続 URI の一部として使われます。
よって、この&lt;strong>アカウント名は世界中で一意&lt;/strong>である必要があります。&lt;/p></description></item><item><title>Azure: Cosmos DB の SQL API をプロキシ経由で使用する</title><link>https://maku.blog/p/t8rfkjn/</link><pubDate>Thu, 05 Sep 2019 00:00:00 +0900</pubDate><guid>https://maku.blog/p/t8rfkjn/</guid><description>&lt;h2 id="参照するサンプルコード">参照するサンプルコード&lt;/h2>
&lt;p>Azure の Cosmos DB を SQL API で操作するための最初の手順は下記のドキュメントに記載されています。&lt;/p>
&lt;ul>
&lt;li>&lt;a href="https://docs.microsoft.com/ja-jp/azure/cosmos-db/create-sql-api-nodejs">クイック スタート:Azure Cosmos DB SQL API アカウントを使用して Node.js アプリを構築する&lt;/a>&lt;/li>
&lt;/ul>
&lt;p>ここに Node.js 用のサンプルコードがあり、&lt;a href="https://docs.microsoft.com/ja-jp/javascript/api/@azure/cosmos/?view=azure-node-latest">@azure/cosmos&lt;/a> パッケージが提供する &lt;a href="https://docs.microsoft.com/ja-jp/javascript/api/@azure/cosmos/cosmosclient?view=azure-node-latest">CosmosClient&lt;/a> クラスを使用したコードになっています（昔のサンプルコードでは &lt;code>documentdb&lt;/code> というライブラリを使用していたりしますが、今は Microsoft が提供する &lt;code>@azure/cosmos&lt;/code> を使用すると完結なコードを記述できます）。&lt;/p>

&lt;figure class="xCodeBlock">

&lt;div class="xCodeBlock_code">&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-js" data-lang="js">&lt;span class="line">&lt;span class="cl">&lt;span class="kr">const&lt;/span> &lt;span class="nx">CosmosClient&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nx">require&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s1">&amp;#39;@azure/cosmos&amp;#39;&lt;/span>&lt;span class="p">).&lt;/span>&lt;span class="nx">CosmosClient&lt;/span>&lt;span class="p">;&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/div>
&lt;/figure>

&lt;p>基本的には、&lt;code>config.js&lt;/code> ファイルに記述されたエンドポイントとキーを下記のような感じで設定すれば実行できるようになるのですが、&lt;/p>

&lt;figure class="xCodeBlock">
&lt;figcaption class="xCodeBlock_title">config.js&lt;/figcaption>
&lt;div class="xCodeBlock_code">&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-js" data-lang="js">&lt;span class="line">&lt;span class="cl">&lt;span class="kd">var&lt;/span> &lt;span class="nx">config&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="p">{};&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nx">config&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">endpoint&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="s1">&amp;#39;https://your-cosmosdb.documents.azure.com:443/&amp;#39;&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nx">config&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">key&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="s1">&amp;#39;9Hp4WSwgvggexAuGy4dKdl...snipped...lV9Nm44Pg8WVkH==&amp;#39;&lt;/span>&lt;span class="p">;&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/div>
&lt;/figure>

&lt;p>会社などのプロキシ環境内からだとうまく接続できず、次のような感じのエラーが発生すると思います。&lt;/p>

&lt;figure class="xCodeBlock">

&lt;div class="xCodeBlock_code">&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-plain" data-lang="plain">&lt;span class="line">&lt;span class="cl">$ node app.js
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Completed with error {&amp;#34;message&amp;#34;:&amp;#34;request to https://your-cosmosdb.documents.azure.com:443/dbs/FamilyDatabase failed, reason: connect ETIMEDOUT 123.34.56.78:443&amp;#34;,&amp;#34;type&amp;#34;:&amp;#34;system&amp;#34;,&amp;#34;errno&amp;#34;:&amp;#34;ETIMEDOUT&amp;#34;, &amp;#34;code&amp;#34;:&amp;#34;ETIMEDOUT&amp;#34;,&amp;#34;headers&amp;#34;:{&amp;#34;x-ms-throttle-retry-count&amp;#34;:0,&amp;#34;x-ms-throttle-retry-wait-time-ms&amp;#34;:0}}&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/div>
&lt;/figure>

&lt;p>&lt;code>HTTPS_PROXY&lt;/code> 環境変数を設定しても同様で効果がありません。&lt;/p>
&lt;h2 id="プロキシ経由で-cosmosclient-を使用する">プロキシ経由で CosmosClient を使用する&lt;/h2>
&lt;p>&lt;code>CosmosClient&lt;/code> クラスでの Cosmos DB へのアクセスをプロキシ経由で行うには、コンストラクタのパラメータとして渡せる &lt;a href="https://docs.microsoft.com/ja-jp/javascript/api/@azure/cosmos/cosmosclientoptions?view=azure-node-latest">CosmosClientOptions&lt;/a> の &lt;code>agent&lt;/code> プロパティを設定します。
ここでは、エージェントとして &lt;a href="https://github.com/TooTallNate/node-proxy-agent">proxy-agent&lt;/a> モジュールを使用します。&lt;/p>

&lt;figure class="xCodeBlock">
&lt;figcaption class="xCodeBlock_title">proxy-agent のインストール&lt;/figcaption>
&lt;div class="xCodeBlock_code">&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-plain" data-lang="plain">&lt;span class="line">&lt;span class="cl">$ npm install --save proxy-agent&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/div>
&lt;/figure>


&lt;figure class="xCodeBlock">
&lt;figcaption class="xCodeBlock_title">sample.js&lt;/figcaption>
&lt;div class="xCodeBlock_code">&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-js" data-lang="js">&lt;span class="line">&lt;span class="cl">&lt;span class="kr">const&lt;/span> &lt;span class="p">{&lt;/span> &lt;span class="nx">CosmosClient&lt;/span> &lt;span class="p">}&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nx">require&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s1">&amp;#39;@azure/cosmos&amp;#39;&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kr">const&lt;/span> &lt;span class="nx">ProxyAgent&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nx">require&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s1">&amp;#39;proxy-agent&amp;#39;&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">// HTTP, HTTPS, or SOCKS proxy to use
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>&lt;span class="kr">const&lt;/span> &lt;span class="nx">PROXY_URI&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="s1">&amp;#39;http://proxy.example.com:3128/&amp;#39;&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kr">const&lt;/span> &lt;span class="nx">client&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="k">new&lt;/span> &lt;span class="nx">CosmosClient&lt;/span>&lt;span class="p">({&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">endpoint&lt;/span>&lt;span class="o">:&lt;/span> &lt;span class="nx">config&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">endpoint&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">key&lt;/span>&lt;span class="o">:&lt;/span> &lt;span class="nx">config&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">key&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">agent&lt;/span>&lt;span class="o">:&lt;/span> &lt;span class="k">new&lt;/span> &lt;span class="nx">ProxyAgent&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">PROXY_URI&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">});&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/div>
&lt;/figure>

&lt;p>プロキシを使用するかどうかを簡単に切り替えられるようにするには、例えば、&lt;strong>&lt;code>AZURE_PROXY&lt;/code>&lt;/strong> 環境変数に URI がセットされていたら、それをプロキシアドレスとして使用する、というように処理を分けるとよいでしょう。&lt;/p></description></item><item><title>MongoDB for VS Code で Azure Cosmos DB を操作する</title><link>https://maku.blog/p/dt3ahpw/</link><pubDate>Sat, 12 Jun 2021 00:00:00 +0900</pubDate><guid>https://maku.blog/p/dt3ahpw/</guid><description>&lt;p>Cosmos DB インスタンスを &lt;a href="../../p/cd9bg3x">MongoDB API アクセス用に作成&lt;/a> しておくと、さまざまな MongoDB 用のツールでデータベースにアクセスできるようになります。
ここでは、VS Code 用の拡張「&lt;strong>MongoDB for VS Code&lt;/strong>」を使って、Cosmos DB を操作できるようにしてみます。
TypeScript を使って Web アプリを作成しているときは、エディタとして VS Code を使っていることが多いでしょうから、同じ環境上で Cosmos DB を操作できると開発が捗ります。&lt;/p>
&lt;h2 id="mongodb-for-vs-code-のインストール">MongoDB for VS Code のインストール&lt;/h2>


&lt;figure class="xImage">
 &lt;img style="border: solid #ccc 2px;" width="2370" height="528" src="../../p/dt3ahpw/img-001.png" alt="/p/dt3ahpw/img-001.png" />
 &lt;figcaption>図: MongoDB for VS Code のインストール&lt;/figcaption>
&lt;/figure>

&lt;p>MongoDB for VS Code は、VS Code の Extesions バー (&lt;code>Cmd/Ctrl + Shift + X&lt;/code>) で &lt;strong>&lt;code>MongoDB&lt;/code>&lt;/strong> で検索すれば簡単にインストールできます。&lt;/p>
&lt;h2 id="vs-code-から-cosmos-db-mongodb-に接続する">VS Code から Cosmos DB (MongoDB) に接続する&lt;/h2>
&lt;h3 id="接続文字列で簡単接続">接続文字列で簡単接続&lt;/h3>
&lt;p>MongoDB for VS Code をインストールすると、サイドバーに &lt;strong>葉っぱのアイコン&lt;/strong> が出てくるので、ここから MongoDB サーバーに接続することができます。
ちなみに、MongoDB が葉っぱアイコンを使うのは、それを使うことが「シンプルで自然であるから」らしいです（じゃあ水でもいいじゃん、とは言いますまい）。&lt;/p></description></item></channel></rss>