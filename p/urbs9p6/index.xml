<?xml version="1.0" encoding="utf-8" standalone="yes"?><rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom"><channel><title>Ansible モジュールの使用例 on まくろぐ</title><link>https://maku.blog/p/urbs9p6/</link><description>Recent content in Ansible モジュールの使用例 on まくろぐ</description><generator>Hugo -- gohugo.io</generator><language>ja-jp</language><lastBuildDate>Mon, 29 Aug 2022 00:00:00 +0000</lastBuildDate><atom:link href="https://maku.blog/p/urbs9p6/index.xml" rel="self" type="application/rss+xml"/><item><title>Ansible タスク例: ユーザーを特定のグループに参加させる (ansible.builtin.user)</title><link>https://maku.blog/p/s2fs5gs/</link><pubDate>Mon, 29 Aug 2022 00:00:00 +0000</pubDate><guid>https://maku.blog/p/s2fs5gs/</guid><description>Ansible の ansible.builtin.user モジュール を使用すると、ターゲットノード上に指定したユーザーを作成することができます。 このモジュールは、既存のユーザーの情報を変更する場合にも使えるので、例えば、あるユーザーを指定したグループに参加させる、といったことが可能です。
次の Playbook では、ユーザー maku をグループ docker に参加させています。 ユーザーが存在しない場合は、ユーザー自体の作成も行います。
- hosts:allbecome:truetasks:- name:Append the group &amp;#39;docker&amp;#39; to the user&amp;#39;s groupsansible.builtin.user:name:makugroups:[docker]append:yes注意点としては、groups でグループ名を列挙すると同時に、append: yes と指定するところです。 この指定により、ユーザー maku がすでに存在している場合に、現在のグループ情報はそのままで、追加で docker グループに参加するという意味になります。
逆に、純粋に docker グループにしか参加していないユーザーにしたいのであれば、append: yes の指定は省略して次のように記述すれば OK です（デフォルトは append: false です）。
ansible.builtin.user:name:makugroups:[docker]ユーザー名をハードコードするのではなく、SSH 接続しているカレントユーザーを対象にしてグループ参加させたいときは、ユーザー名として &amp;quot;{{ ansible_facts.env.SUDO_USER }}&amp;quot; を指定します。 これにより、sudo 実行前のユーザー名を取得できます。
- hosts:allgather_facts:truebecome:truetasks:- name:Append the group &amp;#39;docker&amp;#39; to the current user&amp;#39;s groupsansible.builtin.user:name:&amp;#34;{{ ansible_facts.env.SUDO_USER }}&amp;#34;groups:[docker]append:yes似たような変数に {{ ansible_user_id }} がありますが、この値は sudo した結果のユーザー名である root になるので注意してください（become: true していない場合は恐らく同じ値になります）。</description></item><item><title>Ansible タスク例: 任意のコマンドを実行する (ansible.builtin.command/shell)</title><link>https://maku.blog/p/ihqz7em/</link><pubDate>Sun, 28 Aug 2022 00:00:00 +0000</pubDate><guid>https://maku.blog/p/ihqz7em/</guid><description>Ansible のターゲットノード上で任意のコマンドを実行するには、次のような組み込みモジュールを使用します。
ansible.builtin.command モジュール 任意のコマンドを実行します。 シェルを経由せず、指定したコマンドを直接実行するので、シェル特有の機能は使えません。 Windows の場合は代わりに ansible.builtin.win_command を使用します。 ansible.builtin.shell モジュール シェル (/bin/sh) で任意のコマンドを実行します。 シェルの機能（$HOSTNAME のような変数展開や * によるファイルグロブ、&amp;gt; によるリダイレクトなど）を使用することができます。 Windows の場合は代わりに ansible.builtin.win_shell を使用します。 command モジュールの基本 指定したコマンドを実行したいときは、command モジュールの cmd パラメーターでそのコマンド（と引数）を指定します。
- name:Run commandansible.builtin.command:cmd:cat /etc/hostname上記のような簡単なコマンドであれば、次のように省略して記述できます。
- name:Run commandansible.builtin.command:cat /etc/hostname実行するコマンドの引数として &amp;quot;user name&amp;quot; のようなスペースを含む値を渡したいときは、次のように argv を使ってコマンドと各引数を分割して指定します（この場合、cmd パラメーターは使用しません）。
- name:Run commandansible.builtin.command:argv:- /usr/bin/add_user_to_db.sh- user name- database nameファイルの有無で実行するかどうか制御する (creates/removes) command モジュールで指定したコマンドは、デフォルトで毎回実行されますが、creates および removes パラメーターを使用すると、特定のファイルの有無によってコマンドを実行するかしないかを制御することができます。
creates パラメーター creates パラメーターでファイル名を指定しておくと、そのファイルが存在しない場合だけタスクを実行します。 つまり、そのファイルを生成するようなコマンドを実行することを示唆します。
- name:Create an empty databaseansible.builtin.command:cmd:/usr/bin/make_database.shcreates:/path/to/databaseremoves パラメーター 逆に、特定のファイルが存在する場合だけコマンドを実行したいときは、removes パラメーターでそのファイル名を指定します。</description></item><item><title>Ansible タスク例: 空のディレクトリを作成する (ansible.builtin.file)</title><link>https://maku.blog/p/25gqyai/</link><pubDate>Sun, 28 Aug 2022 00:00:00 +0000</pubDate><guid>https://maku.blog/p/25gqyai/</guid><description>Ansible で空のディレクトリ作成するには、ansible.builtin.file モジュール の state パラメーターに directory を指定します。
空のディレクトリを作成する - hosts:allgather_facts:falsebecome:truetasks:- name:Create directoryansible.builtin.file:path:/var/cache/myappstate:directorypath パラメーターで指定したディレクトリ /var/cache/myapp を作成します。 すでにディレクトリが存在する場合は、このタスクはスキップされます。 ディレクトリは再帰的に作成されるので、深い階層のパスを指定しても大丈夫です（mkdir の -p オプションに相当）。
ディレクトリのパーミッションや所有者を指定する - hosts:allgather_facts:falsebecome:truetasks:- name:Create directoryansible.builtin.file:path:/var/cache/myappstate:directorymode:&amp;#34;0755&amp;#34;owner:myapp-usergroup:myapp-groupディレクトリ作成時のパーミッションは mode、所有ユーザーは owner、グループは group で指定することができます。 パーミッションは、0755 のような 8 進数指定の代わりに、u=rw,g=r,o=r のようなシンボリックモードでも指定可能です。</description></item><item><title>Ansible タスク例: 空のファイルを作成する (ansible.builtin.file)</title><link>https://maku.blog/p/uas9p6m/</link><pubDate>Sun, 28 Aug 2022 00:00:00 +0000</pubDate><guid>https://maku.blog/p/uas9p6m/</guid><description>Ansible で空のファイルを作成するには、ansible.builtin.file モジュール の state パラメーターに touch を指定します。 Linux の touch コマンドに相当する動きをするので、ファイルがなければ空のファイルを作成し、ファイルが存在する場合はタイムスタンプを更新する、という振る舞いになります。
空のファイルを作成する tasks:- name:Create fileansible.builtin.file:path:~/sample.txtstate:touch上記のようにすると、path で指定したファイルを作成します。 ファイルが既に存在する場合は、ファイルの中身は変更せずに、タイムスタンプを更新します。 つまり、このタスクはすでにファイルが存在する場合も実行されます（changed になる）。
タイムスタンプを更新しない - name:Create empty fileansible.builtin.file:path:~/sample.txtstate:touchaccess_time:preservemodification_time:preserveファイルがすでに存在する場合に、タイムスタンプを更新しないようにするには、access_time および modification_time パラメーターに preserve を指定します（両方とも指定する必要があります）。 この指定により、ファイルがすでに存在している場合は、このタスクはスキップされるようになります。</description></item><item><title>Ansible で SSH サーバーをセキュアにする (ansible.builtin.lineinfile, ansible.builtin.service)</title><link>https://maku.blog/p/hufvdta/</link><pubDate>Sat, 06 Aug 2022 00:00:00 +0000</pubDate><guid>https://maku.blog/p/hufvdta/</guid><description>SSH サーバーを安全に運用するには、いくつかのベストプラクティスがあります。 ここでは、root ユーザーでの SSH 接続を拒否 (PermitRootLogin no) する設定例を紹介します。
secure-sshd.yaml (Playbook) ---- hosts:allgather_facts:falsebecome:truetasks:- name:Prohibit root loginansible.builtin.lineinfile:path:/etc/ssh/sshd_configstate:presentregexp:&amp;#39;^PermitRootLogin &amp;#39;line:&amp;#39;PermitRootLogin no&amp;#39;notify:- Reload ssh daemonhandlers:- name:Reload ssh daemonansible.builtin.service:name:sshdstate:reloaded この Ansible Playbook では、次のようなことを行っています。
lineinfile モジュールで /etc/ssh/sshd_config の内容を修正する PermitRootLogin で始まる行が見つからない場合は、ファイルの末尾に PermitRootLogin no を追加する PermitRootLogin で始まる行が見つかった場合は、PermitRootLogin no に置換する（ただし、最初からその設定が記述されていたら何もしない） service モジュール で SSH デーモンに設定をリロードさせる この設定を行うと、root ユーザーでの SSH 接続ができなくなるので注意してください。 必ず、root ユーザー以外で SSH 接続できることを確認してから実行してください。</description></item><item><title>Ansible タスク例: APT パッケージをインストールする (ansible.builtin.apt)</title><link>https://maku.blog/p/efqyair/</link><pubDate>Tue, 19 Jul 2022 00:00:00 +0000</pubDate><guid>https://maku.blog/p/efqyair/</guid><description>Debian 系の Linux ディストリビューション（Ubuntu など）では、パッケージ管理に APT を使用します。 Ansible 組み込みの ansible.builtin.apt モジュールを使用して、APT パッケージのインストールを行うことができます。
APK パッケージを 1 つインストールする - name:Install Apacheansible.builtin.apt:name:apache2state:presentupdate_cache:yesstate: present の指定はデフォルトなので省略できます。 update_cache: yes を指定しておくと、事前に apt update を実行してパッケージリスト情報を更新してくれます。 さらに、cache_valid_time: 3600 のように、キャッシュの有効期間（秒）を指定しておくこともできます。
複数のパッケージをインストールする - name:Install a list of packagesansible.builtin.apt:pkg:- git- iproute2- .</description></item><item><title>Ansible タスク例: UFW でファイアウォールを設定する (community.general.ufw)</title><link>https://maku.blog/p/evdubr7/</link><pubDate>Tue, 19 Jul 2022 00:00:00 +0000</pubDate><guid>https://maku.blog/p/evdubr7/</guid><description>Ubuntu のファイアウォール（パケットフィルタ）設定には、UFW というツールが使用されています。
参考: Linux コマンド: ufw による Ubuntu のファイアウォール設定 Ansible の community.general.ufw モジュールを使用して UFW (Uncomplicated Firewall) の設定を行うことができます。 community.general コレクションは、Ansible のコミュニティパッケージをインストールした場合は標準でインストールされています。
UFW をインストールする UFW の設定は community.general.ufw モジュールで行うのですが、UFW の本体（ufw コマンド）はあらかじめ APT でインストールしておく必要があります。
- name:Install UFWansible.builtin.apt:name:ufwstate:presentupdate_cache:yesUFW を有効化する UFW をインストールしたら、有効化する必要があります。 次の例では、デフォルトポリシーを接続拒否 (deny) にして UFW を有効化しています。
- name:Enable UFWcommunity.general.ufw:state:enabledpolicy:deny特定ポートへのアクセスを許可する 次の例では、22 番ポート (SSH) と、80 番ポート (HTTP)、443 番ポート (HTTPS) へのアクセスを許可しています。
- name:UFW - Allow all access to tcp port 22 (SSH)community.general.ufw:rule:allowport:&amp;#39;22&amp;#39;proto:tcp- name:UFW - Allow all access to tcp port 80 (HTTP)community.</description></item><item><title>Ansible タスク例: Web からファイルをダウンロードする (ansible.builtin.get_url)</title><link>https://maku.blog/p/s9tctaq/</link><pubDate>Tue, 19 Jul 2022 00:00:00 +0000</pubDate><guid>https://maku.blog/p/s9tctaq/</guid><description>参考: ansible.builtin.get_url module HTTPS でファイルをダウンロードする - name:Download foo.confansible.builtin.get_url:url:https://example.com/path/file.confdest:/etc/foo.confmode:&amp;#39;0440&amp;#39; パラメーターの説明: url &amp;hellip; （必須）ダウンロードするファイルの URL dest &amp;hellip; （必須）保存先の絶対パス。ディレクトリ名かファイル名。ディレクトリ名の場合は、ダウンロード元のファイル名が使われます。 mode &amp;hellip; （オプション）作成するファイルのモード (permission) dest で指定したファイルが既に存在する場合は、ダウンロードはスキップされます。 ただし、dest で指定したパスがディレクトリの場合は、ファイルは毎回ダウンロードされてしまうので、dest ではファイルのパスを指定すべきです。 force: yes オプションを指定すると、ファイルは必ずダウンロードされます。
SSL エラーが発生する場合 Ubuntu の Docker イメージには CA 証明書がインストールされておらず、get_url モジュールで HTTPS アクセスしたときに次のように SSL 関連のエラーが出ることがあります。
Request failed: &amp;lt;urlopen error [SSL: CERTIFICATE_VERIFY_FAILED] certificate verify failed: unable to get local issuer certificate (_ssl.c:997)&amp;gt; このような場合は、get_url の validate_certs: no オプションを指定して SSL 検証をスキップしてしまうこともできますが、次のように CA 証明書をインストールするのが正しい対処方法です。</description></item><item><title>Ansible タスク例: when による Playbook の条件分岐</title><link>https://maku.blog/p/o4o7o6m/</link><pubDate>Tue, 19 Jul 2022 00:00:00 +0000</pubDate><guid>https://maku.blog/p/o4o7o6m/</guid><description>コマンドが既に存在するかどうかチェックする 次の例では、docker コマンドが存在しない場合のみ、get-docker.sh スクリプトを実行して Docker をインストールしています。
- name:Check if docker command existsansible.builtin.shell:cmd:command -v dockerregister:docker_existsignore_errors:yes- name:Install Dockerwhen:docker_exists is failedansible.builtin.shell:cmd:sh ~/get-docker.shcommand -v &amp;lt;コマンド名&amp;gt; とすると、指定したコマンドがインストールされているときのみリターンコードが 0（成功）になることを利用しています。 この振る舞いは、次のように $?（リターンコード）の値を参照することで確かめられます。
$ command -v pwd pwd $ echo $? 0 （pwd コマンドは存在するのでリターンコードは 0） $ command -v hoge $ echo $? 1 （hoge コマンドは存在しないのでリターンコードは 1）</description></item><item><title>Ansible モジュールのヘルプを表示する (ansible-doc)</title><link>https://maku.blog/p/xx7enu3/</link><pubDate>Fri, 18 Feb 2022 00:00:00 +0000</pubDate><guid>https://maku.blog/p/xx7enu3/</guid><description>ansible-doc コマンドを使うと、Ansible モジュールのドキュメントを表示することができます。
ping モジュールのドキュメントを表示 $ ansible-doc ping &amp;gt; ANSIBLE.BUILTIN.PING (/Users/maku/Library/Python/3.10/lib/python/site-packages/ansible/modules/ping.py) A trivial test module, this module always returns `pong&amp;#39; on successful contact. It does not make sense in playbooks, but it is useful from `/usr/bin/ansible&amp;#39; to verify the ability to login and that a usable Python is configured. This is NOT ICMP ping, this is just a trivial test module that requires Python on the remote-node. For Windows targets, use the [ansible.</description></item></channel></rss>