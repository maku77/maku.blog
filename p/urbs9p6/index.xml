<?xml version="1.0" encoding="utf-8" standalone="yes"?><rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom"><channel><title>Ansible モジュールの使用例 on まくろぐ</title><link>https://maku.blog/p/urbs9p6/</link><description>Recent content in Ansible モジュールの使用例 on まくろぐ</description><generator>Hugo</generator><language>ja-jp</language><lastBuildDate>Mon, 29 Aug 2022 00:00:00 +0900</lastBuildDate><atom:link href="https://maku.blog/p/urbs9p6/index.xml" rel="self" type="application/rss+xml"/><item><title>Ansible タスク例: ユーザーを特定のグループに参加させる (ansible.builtin.user)</title><link>https://maku.blog/p/s2fs5gs/</link><pubDate>Mon, 29 Aug 2022 00:00:00 +0900</pubDate><guid>https://maku.blog/p/s2fs5gs/</guid><description>&lt;p>Ansible の &lt;a href="https://docs.ansible.com/ansible/latest/collections/ansible/builtin/user_module.html">ansible.builtin.user モジュール&lt;/a> を使用すると、ターゲットノード上に指定したユーザーを作成することができます。
このモジュールは、既存のユーザーの情報を変更する場合にも使えるので、例えば、あるユーザーを指定したグループに参加させる、といったことが可能です。&lt;/p>
&lt;p>次の Playbook では、ユーザー &lt;code>maku&lt;/code> をグループ &lt;code>docker&lt;/code> に参加させています。
ユーザーが存在しない場合は、ユーザー自体の作成も行います。&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-yaml" data-lang="yaml">&lt;span class="line">&lt;span class="cl">- &lt;span class="nt">hosts&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">all&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">become&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kc">true&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">tasks&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>- &lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">Append the group &amp;#39;docker&amp;#39; to the user&amp;#39;s groups&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">ansible.builtin.user&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">maku&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">groups&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="l">docker]&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">append&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kc">yes&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>注意点としては、&lt;strong>&lt;code>groups&lt;/code>&lt;/strong> でグループ名を列挙すると同時に、&lt;strong>&lt;code>append: yes&lt;/code>&lt;/strong> と指定するところです。
この指定により、ユーザー &lt;code>maku&lt;/code> がすでに存在している場合に、現在のグループ情報はそのままで、追加で &lt;code>docker&lt;/code> グループに参加するという意味になります。&lt;/p>
&lt;p>逆に、純粋に &lt;code>docker&lt;/code> グループにしか参加していないユーザーにしたいのであれば、&lt;code>append: yes&lt;/code> の指定は省略して次のように記述すれば OK です（デフォルトは &lt;code>append: false&lt;/code> です）。&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-yaml" data-lang="yaml">&lt;span class="line">&lt;span class="cl">&lt;span class="nt">ansible.builtin.user&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">maku&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">groups&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="l">docker]&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>ユーザー名をハードコードするのではなく、SSH 接続しているカレントユーザーを対象にしてグループ参加させたいときは、ユーザー名として &lt;strong>&lt;code>&amp;quot;{{ ansible_facts.env.SUDO_USER }}&amp;quot;&lt;/code>&lt;/strong> を指定します。
これにより、&lt;code>sudo&lt;/code> 実行前のユーザー名を取得できます。&lt;/p></description></item><item><title>Ansible タスク例: 任意のコマンドを実行する (ansible.builtin.command/shell)</title><link>https://maku.blog/p/ihqz7em/</link><pubDate>Sun, 28 Aug 2022 00:00:00 +0900</pubDate><guid>https://maku.blog/p/ihqz7em/</guid><description>&lt;p>Ansible のターゲットノード上で任意のコマンドを実行するには、次のような組み込みモジュールを使用します。&lt;/p>
&lt;dl>
&lt;dt>&lt;a href="https://docs.ansible.com/ansible/latest/collections/ansible/builtin/command_module.html">ansible.builtin.command モジュール&lt;/a>&lt;/dt>
&lt;dd>任意のコマンドを実行します。
シェルを経由せず、指定したコマンドを直接実行するので、シェル特有の機能は使えません。
Windows の場合は代わりに &lt;a href="https://docs.ansible.com/ansible/latest/collections/ansible/windows/win_command_module.html">ansible.builtin.win_command&lt;/a> を使用します。&lt;/dd>
&lt;dt>&lt;a href="https://docs.ansible.com/ansible/latest/collections/ansible/builtin/shell_module.html">ansible.builtin.shell モジュール&lt;/a>&lt;/dt>
&lt;dd>シェル (&lt;code>/bin/sh&lt;/code>) で任意のコマンドを実行します。
シェルの機能（&lt;code>$HOSTNAME&lt;/code> のような変数展開や &lt;code>*&lt;/code> によるファイルグロブ、&lt;code>&amp;gt;&lt;/code> によるリダイレクトなど）を使用することができます。
Windows の場合は代わりに &lt;a href="https://docs.ansible.com/ansible/latest/collections/ansible/windows/win_shell_module.html">ansible.builtin.win_shell&lt;/a> を使用します。&lt;/dd>
&lt;/dl>
&lt;h2 id="command-モジュールの基本">command モジュールの基本&lt;/h2>
&lt;p>指定したコマンドを実行したいときは、&lt;strong>&lt;code>command&lt;/code>&lt;/strong> モジュールの &lt;strong>&lt;code>cmd&lt;/code>&lt;/strong> パラメーターでそのコマンド（と引数）を指定します。&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-yaml" data-lang="yaml">&lt;span class="line">&lt;span class="cl">- &lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">Run command&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">ansible.builtin.command&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">cmd&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">cat /etc/hostname&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>上記のような簡単なコマンドであれば、次のように省略して記述できます。&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-yaml" data-lang="yaml">&lt;span class="line">&lt;span class="cl">- &lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">Run command&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">ansible.builtin.command&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">cat /etc/hostname&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>実行するコマンドの引数として &lt;code>&amp;quot;user name&amp;quot;&lt;/code> のようなスペースを含む値を渡したいときは、次のように &lt;strong>&lt;code>argv&lt;/code>&lt;/strong> を使ってコマンドと各引数を分割して指定します（この場合、&lt;code>cmd&lt;/code> パラメーターは使用しません）。&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-yaml" data-lang="yaml">&lt;span class="line">&lt;span class="cl">- &lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">Run command&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">ansible.builtin.command&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">argv&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>- &lt;span class="l">/usr/bin/add_user_to_db.sh&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>- &lt;span class="l">user name&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>- &lt;span class="l">database name&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="ファイルの有無で実行するかどうか制御する-createsremoves">ファイルの有無で実行するかどうか制御する (creates/removes)&lt;/h2>
&lt;p>&lt;code>command&lt;/code> モジュールで指定したコマンドは、デフォルトで毎回実行されますが、&lt;strong>&lt;code>creates&lt;/code>&lt;/strong> および &lt;strong>&lt;code>removes&lt;/code>&lt;/strong> パラメーターを使用すると、特定のファイルの有無によってコマンドを実行するかしないかを制御することができます。&lt;/p></description></item><item><title>Ansible タスク例: 空のディレクトリを作成する (ansible.builtin.file)</title><link>https://maku.blog/p/25gqyai/</link><pubDate>Sun, 28 Aug 2022 00:00:00 +0900</pubDate><guid>https://maku.blog/p/25gqyai/</guid><description>&lt;p>Ansible で空のディレクトリ作成するには、&lt;a href="https://docs.ansible.com/ansible/latest/collections/ansible/builtin/file_module.html">ansible.builtin.file モジュール&lt;/a> の &lt;strong>&lt;code>state&lt;/code>&lt;/strong> パラメーターに &lt;strong>&lt;code>directory&lt;/code>&lt;/strong> を指定します。&lt;/p>
&lt;h2 id="空のディレクトリを作成する">空のディレクトリを作成する&lt;/h2>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-yaml" data-lang="yaml">&lt;span class="line">&lt;span class="cl">- &lt;span class="nt">hosts&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">all&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">gather_facts&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kc">false&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">become&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kc">true&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">tasks&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>- &lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">Create directory&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">ansible.builtin.file&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">path&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">/var/cache/myapp&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">state&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">directory&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>&lt;code>path&lt;/code> パラメーターで指定したディレクトリ &lt;code>/var/cache/myapp&lt;/code> を作成します。
すでにディレクトリが存在する場合は、このタスクはスキップされます。
ディレクトリは再帰的に作成されるので、深い階層のパスを指定しても大丈夫です（&lt;code>mkdir&lt;/code> の &lt;code>-p&lt;/code> オプションに相当）。&lt;/p>
&lt;h2 id="ディレクトリのパーミッションや所有者を指定する">ディレクトリのパーミッションや所有者を指定する&lt;/h2>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-yaml" data-lang="yaml">&lt;span class="line">&lt;span class="cl">- &lt;span class="nt">hosts&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">all&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">gather_facts&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kc">false&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">become&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kc">true&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">tasks&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>- &lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">Create directory&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">ansible.builtin.file&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">path&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">/var/cache/myapp&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">state&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">directory&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">mode&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s2">&amp;#34;0755&amp;#34;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">owner&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">myapp-user&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">group&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">myapp-group&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>ディレクトリ作成時のパーミッションは &lt;code>mode&lt;/code>、所有ユーザーは &lt;code>owner&lt;/code>、グループは &lt;code>group&lt;/code> で指定することができます。
パーミッションは、&lt;code>0755&lt;/code> のような 8 進数指定の代わりに、&lt;code>u=rw,g=r,o=r&lt;/code> のようなシンボリックモードでも指定可能です。&lt;/p></description></item><item><title>Ansible タスク例: 空のファイルを作成する (ansible.builtin.file)</title><link>https://maku.blog/p/uas9p6m/</link><pubDate>Sun, 28 Aug 2022 00:00:00 +0900</pubDate><guid>https://maku.blog/p/uas9p6m/</guid><description>&lt;p>Ansible で空のファイルを作成するには、&lt;a href="https://docs.ansible.com/ansible/latest/collections/ansible/builtin/file_module.html">ansible.builtin.file モジュール&lt;/a> の &lt;strong>&lt;code>state&lt;/code>&lt;/strong> パラメーターに &lt;strong>&lt;code>touch&lt;/code>&lt;/strong> を指定します。
Linux の &lt;code>touch&lt;/code> コマンドに相当する動きをするので、ファイルがなければ空のファイルを作成し、ファイルが存在する場合はタイムスタンプを更新する、という振る舞いになります。&lt;/p>
&lt;h2 id="空のファイルを作成する">空のファイルを作成する&lt;/h2>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-yaml" data-lang="yaml">&lt;span class="line">&lt;span class="cl">&lt;span class="nt">tasks&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>- &lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">Create file&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">ansible.builtin.file&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">path&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">~/sample.txt&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">state&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">touch&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>上記のようにすると、&lt;code>path&lt;/code> で指定したファイルを作成します。
ファイルが既に存在する場合は、ファイルの中身は変更せずに、タイムスタンプを更新します。
つまり、このタスクはすでにファイルが存在する場合も実行されます（&lt;code>changed&lt;/code> になる）。&lt;/p>
&lt;h2 id="タイムスタンプを更新しない">タイムスタンプを更新しない&lt;/h2>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-yaml" data-lang="yaml">&lt;span class="line">&lt;span class="cl">- &lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">Create empty file&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">ansible.builtin.file&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">path&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">~/sample.txt&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">state&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">touch&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">access_time&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">preserve&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">modification_time&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">preserve&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>ファイルがすでに存在する場合に、タイムスタンプを更新しないようにするには、&lt;strong>&lt;code>access_time&lt;/code>&lt;/strong> および &lt;strong>&lt;code>modification_time&lt;/code>&lt;/strong> パラメーターに &lt;strong>&lt;code>preserve&lt;/code>&lt;/strong> を指定します（両方とも指定する必要があります）。
この指定により、ファイルがすでに存在している場合は、このタスクはスキップされるようになります。&lt;/p></description></item><item><title>Ansible で SSH サーバーをセキュアにする (ansible.builtin.lineinfile, ansible.builtin.service)</title><link>https://maku.blog/p/hufvdta/</link><pubDate>Sat, 06 Aug 2022 00:00:00 +0900</pubDate><guid>https://maku.blog/p/hufvdta/</guid><description>&lt;p>SSH サーバーを安全に運用するには、&lt;a href="../../p/42cmu5d/">いくつかのベストプラクティス&lt;/a>があります。
ここでは、root ユーザーでの SSH 接続を拒否 (&lt;code>PermitRootLogin no&lt;/code>) する設定例を紹介します。&lt;/p>

&lt;figure class="xCodeBlock">
&lt;figcaption class="xCodeBlock_title">secure-sshd.yaml (Playbook)&lt;/figcaption>
&lt;div class="xCodeBlock_code">&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-yaml" data-lang="yaml">&lt;span class="line">&lt;span class="cl">&lt;span class="nn">---&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>- &lt;span class="nt">hosts&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">all&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">gather_facts&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kc">false&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">become&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kc">true&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">tasks&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>- &lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">Prohibit root login&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">ansible.builtin.lineinfile&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">path&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">/etc/ssh/sshd_config&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">state&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">present&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">regexp&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s1">&amp;#39;^PermitRootLogin &amp;#39;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">line&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s1">&amp;#39;PermitRootLogin no&amp;#39;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">notify&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>- &lt;span class="l">Reload ssh daemon&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">handlers&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>- &lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">Reload ssh daemon&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">ansible.builtin.service&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">sshd&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">state&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">reloaded&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/div>
&lt;/figure>

&lt;p>この Ansible Playbook では、次のようなことを行っています。&lt;/p>
&lt;ol>
&lt;li>&lt;a href="https://docs.ansible.com/ansible/latest/collections/ansible/builtin/lineinfile_module.html">&lt;code>lineinfile&lt;/code> モジュール&lt;/a>で &lt;code>/etc/ssh/sshd_config&lt;/code> の内容を修正する
&lt;ul>
&lt;li>&lt;code>PermitRootLogin&lt;/code> で始まる行が見つからない場合は、ファイルの末尾に &lt;code>PermitRootLogin no&lt;/code> を追加する&lt;/li>
&lt;li>&lt;code>PermitRootLogin&lt;/code> で始まる行が見つかった場合は、&lt;code>PermitRootLogin no&lt;/code> に置換する（ただし、最初からその設定が記述されていたら何もしない）&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>&lt;a href="https://docs.ansible.com/ansible/latest/collections/ansible/builtin/service_module.html">&lt;code>service&lt;/code> モジュール&lt;/a> で SSH デーモンに設定をリロードさせる&lt;/li>
&lt;/ol>
&lt;p>この設定を行うと、root ユーザーでの SSH 接続ができなくなるので注意してください。
必ず、root ユーザー以外で SSH 接続できることを確認してから実行してください。&lt;/p></description></item><item><title>Ansible タスク例: APT パッケージをインストールする (ansible.builtin.apt)</title><link>https://maku.blog/p/efqyair/</link><pubDate>Tue, 19 Jul 2022 00:00:00 +0900</pubDate><guid>https://maku.blog/p/efqyair/</guid><description>&lt;p>Debian 系の Linux ディストリビューション（Ubuntu など）では、パッケージ管理に APT を使用します。
Ansible 組み込みの &lt;a href="https://docs.ansible.com/ansible/latest/collections/ansible/builtin/apt_module.html">ansible.builtin.apt&lt;/a> モジュールを使用して、APT パッケージのインストールを行うことができます。&lt;/p>
&lt;h2 id="apk-パッケージを-1-つインストールする">APK パッケージを 1 つインストールする&lt;/h2>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-yaml" data-lang="yaml">&lt;span class="line">&lt;span class="cl">- &lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">Install Apache&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">ansible.builtin.apt&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">apache2&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">state&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">present&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">update_cache&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kc">yes&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>&lt;code>state: present&lt;/code> の指定はデフォルトなので省略できます。
&lt;strong>&lt;code>update_cache: yes&lt;/code>&lt;/strong> を指定しておくと、事前に &lt;code>apt update&lt;/code> を実行してパッケージリスト情報を更新してくれます。
さらに、&lt;code>cache_valid_time: 3600&lt;/code> のように、キャッシュの有効期間（秒）を指定しておくこともできます。&lt;/p>
&lt;h2 id="複数のパッケージをインストールする">複数のパッケージをインストールする&lt;/h2>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-yaml" data-lang="yaml">&lt;span class="line">&lt;span class="cl">- &lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">Install a list of packages&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">ansible.builtin.apt&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">pkg&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>- &lt;span class="l">git&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>- &lt;span class="l">iproute2&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>- &lt;span class="l">...&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div></description></item><item><title>Ansible タスク例: UFW でファイアウォールを設定する (community.general.ufw)</title><link>https://maku.blog/p/evdubr7/</link><pubDate>Tue, 19 Jul 2022 00:00:00 +0900</pubDate><guid>https://maku.blog/p/evdubr7/</guid><description>&lt;p>Ubuntu のファイアウォール（パケットフィルタ）設定には、UFW というツールが使用されています。&lt;/p>
&lt;ul>
&lt;li>参考: &lt;a href="../../p/drar8o4/">Linux コマンド: ufw による Ubuntu のファイアウォール設定&lt;/a>&lt;/li>
&lt;/ul>
&lt;p>Ansible の &lt;a href="https://docs.ansible.com/ansible/latest/collections/community/general/ufw_module.html">community.general.ufw&lt;/a> モジュールを使用して &lt;a href="https://help.ubuntu.com/community/UFW">UFW (Uncomplicated Firewall)&lt;/a> の設定を行うことができます。
&lt;code>community.general&lt;/code> コレクションは、Ansible のコミュニティパッケージをインストールした場合は標準でインストールされています。&lt;/p>
&lt;h2 id="ufw-をインストールする">UFW をインストールする&lt;/h2>
&lt;p>UFW の設定は &lt;code>community.general.ufw&lt;/code> モジュールで行うのですが、UFW の本体（&lt;code>ufw&lt;/code> コマンド）はあらかじめ APT でインストールしておく必要があります。&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-yaml" data-lang="yaml">&lt;span class="line">&lt;span class="cl">- &lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">Install UFW&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">ansible.builtin.apt&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">ufw&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">state&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">present&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">update_cache&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kc">yes&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="ufw-を有効化する">UFW を有効化する&lt;/h2>
&lt;p>UFW をインストールしたら、有効化する必要があります。
次の例では、デフォルトポリシーを接続拒否 (deny) にして UFW を有効化しています。&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-yaml" data-lang="yaml">&lt;span class="line">&lt;span class="cl">- &lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">Enable UFW&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">community.general.ufw&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">state&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">enabled&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">policy&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">deny&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="特定ポートへのアクセスを許可する">特定ポートへのアクセスを許可する&lt;/h2>
&lt;p>次の例では、22 番ポート (SSH) と、80 番ポート (HTTP)、443 番ポート (HTTPS) へのアクセスを許可しています。&lt;/p></description></item><item><title>Ansible タスク例: Web からファイルをダウンロードする (ansible.builtin.get_url)</title><link>https://maku.blog/p/s9tctaq/</link><pubDate>Tue, 19 Jul 2022 00:00:00 +0900</pubDate><guid>https://maku.blog/p/s9tctaq/</guid><description>&lt;ul>
&lt;li>参考: &lt;a href="https://docs.ansible.com/ansible/latest/collections/ansible/builtin/get_url_module.html">ansible.builtin.get_url module&lt;/a>&lt;/li>
&lt;/ul>
&lt;h2 id="https-でファイルをダウンロードする">HTTPS でファイルをダウンロードする&lt;/h2>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-yaml" data-lang="yaml">&lt;span class="line">&lt;span class="cl">- &lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">Download foo.conf&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">ansible.builtin.get_url&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">url&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">https://example.com/path/file.conf&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">dest&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">/etc/foo.conf&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">mode&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s1">&amp;#39;0440&amp;#39;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;ul>
&lt;li>パラメーターの説明:
&lt;ul>
&lt;li>&lt;a href="https://docs.ansible.com/ansible/latest/collections/ansible/builtin/get_url_module.html#parameter-url">&lt;strong>&lt;code>url&lt;/code>&lt;/strong>&lt;/a> &amp;hellip; （必須）ダウンロードするファイルの URL&lt;/li>
&lt;li>&lt;a href="https://docs.ansible.com/ansible/latest/collections/ansible/builtin/get_url_module.html#parameter-dest">&lt;strong>&lt;code>dest&lt;/code>&lt;/strong>&lt;/a> &amp;hellip; （必須）保存先の絶対パス。ディレクトリ名かファイル名。ディレクトリ名の場合は、ダウンロード元のファイル名が使われます。&lt;/li>
&lt;li>&lt;a href="https://docs.ansible.com/ansible/latest/collections/ansible/builtin/get_url_module.html#parameter-mode">&lt;strong>&lt;code>mode&lt;/code>&lt;/strong>&lt;/a> &amp;hellip; （オプション）作成するファイルのモード (permission)&lt;/li>
&lt;/ul>
&lt;/li>
&lt;/ul>
&lt;p>&lt;code>dest&lt;/code> で指定したファイルが既に存在する場合は、ダウンロードはスキップされます。
ただし、&lt;code>dest&lt;/code> で指定したパスがディレクトリの場合は、ファイルは毎回ダウンロードされてしまうので、&lt;code>dest&lt;/code> ではファイルのパスを指定すべきです。
&lt;code>force: yes&lt;/code> オプションを指定すると、ファイルは必ずダウンロードされます。&lt;/p>
&lt;h2 id="ssl-エラーが発生する場合">SSL エラーが発生する場合&lt;/h2>
&lt;p>Ubuntu の Docker イメージには CA 証明書がインストールされておらず、&lt;code>get_url&lt;/code> モジュールで HTTPS アクセスしたときに次のように SSL 関連のエラーが出ることがあります。&lt;/p>
&lt;pre tabindex="0">&lt;code>Request failed: &amp;lt;urlopen error [SSL: CERTIFICATE_VERIFY_FAILED]
certificate verify failed: unable to get local issuer certificate (_ssl.c:997)&amp;gt;
&lt;/code>&lt;/pre>&lt;p>このような場合は、&lt;code>get_url&lt;/code> の &lt;strong>&lt;code>validate_certs: no&lt;/code>&lt;/strong> オプションを指定して SSL 検証をスキップしてしまうこともできますが、次のように CA 証明書をインストールするのが正しい対処方法です。&lt;/p></description></item><item><title>Ansible タスク例: when による Playbook の条件分岐</title><link>https://maku.blog/p/o4o7o6m/</link><pubDate>Tue, 19 Jul 2022 00:00:00 +0900</pubDate><guid>https://maku.blog/p/o4o7o6m/</guid><description>&lt;h2 id="コマンドが既に存在するかどうかチェックする">コマンドが既に存在するかどうかチェックする&lt;/h2>
&lt;p>次の例では、&lt;code>docker&lt;/code> コマンドが存在しない場合のみ、&lt;code>get-docker.sh&lt;/code> スクリプトを実行して Docker をインストールしています。&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-yaml" data-lang="yaml">&lt;span class="line">&lt;span class="cl">- &lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">Check if docker command exists&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">ansible.builtin.shell&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">cmd&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">command -v docker&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">register&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">docker_exists&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">ignore_errors&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kc">yes&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>- &lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">Install Docker&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">when&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">docker_exists is failed&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">ansible.builtin.shell&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">cmd&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">sh ~/get-docker.sh&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>&lt;code>command -v &amp;lt;コマンド名&amp;gt;&lt;/code> とすると、指定したコマンドがインストールされているときのみリターンコードが 0（成功）になることを利用しています。
この振る舞いは、次のように &lt;code>$?&lt;/code>（リターンコード）の値を参照することで確かめられます。&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-console" data-lang="console">&lt;span class="line">&lt;span class="cl">&lt;span class="gp">$&lt;/span> &lt;span class="nb">command&lt;/span> -v &lt;span class="nb">pwd&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="go">pwd
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="go">&lt;/span>&lt;span class="gp">$&lt;/span> &lt;span class="nb">echo&lt;/span> &lt;span class="nv">$?&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="go">0 （pwd コマンドは存在するのでリターンコードは 0）
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="go">&lt;/span>&lt;span class="err">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="err">&lt;/span>&lt;span class="gp">$&lt;/span> &lt;span class="nb">command&lt;/span> -v hoge
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="gp">$&lt;/span> &lt;span class="nb">echo&lt;/span> &lt;span class="nv">$?&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="go">1 （hoge コマンドは存在しないのでリターンコードは 1）
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div></description></item><item><title>Ansible モジュールのヘルプを表示する (ansible-doc)</title><link>https://maku.blog/p/xx7enu3/</link><pubDate>Fri, 18 Feb 2022 00:00:00 +0900</pubDate><guid>https://maku.blog/p/xx7enu3/</guid><description>&lt;p>&lt;strong>&lt;code>ansible-doc&lt;/code>&lt;/strong> コマンドを使うと、Ansible モジュールのドキュメントを表示することができます。&lt;/p>

&lt;figure class="xCodeBlock">
&lt;figcaption class="xCodeBlock_title">ping モジュールのドキュメントを表示&lt;/figcaption>
&lt;div class="xCodeBlock_code">&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-console" data-lang="console">&lt;span class="line">&lt;span class="cl">&lt;span class="gp">$&lt;/span> ansible-doc ping
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="gp">&amp;gt;&lt;/span> ANSIBLE.BUILTIN.PING &lt;span class="o">(&lt;/span>/Users/maku/Library/Python/3.10/lib/python/site-packages/ansible/modules/ping.py&lt;span class="o">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="err">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="err">&lt;/span>&lt;span class="go"> A trivial test module, this module always returns `pong&amp;#39; on successful contact. It does not make sense in
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="go"> playbooks, but it is useful from `/usr/bin/ansible&amp;#39; to verify the ability to login and that a usable Python is
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="go"> configured. This is NOT ICMP ping, this is just a trivial test module that requires Python on the remote-node.
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="go"> For Windows targets, use the [ansible.windows.win_ping] module instead. For Network targets, use the
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="go"> [ansible.netcommon.net_ping] module instead.
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="go">&lt;/span>&lt;span class="err">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="err">&lt;/span>&lt;span class="go">ADDED IN: historical
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="go">&lt;/span>&lt;span class="err">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="err">&lt;/span>&lt;span class="go">OPTIONS (= is mandatory):
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="go">&lt;/span>&lt;span class="err">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="err">&lt;/span>&lt;span class="go">- data
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="go"> Data to return for the `ping&amp;#39; return value.
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="go"> If this parameter is set to `crash&amp;#39;, the module will cause an exception.
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="go"> [Default: pong]
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="go"> type: str
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="go">&lt;/span>&lt;span class="err">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="err">&lt;/span>&lt;span class="go">...（省略）...
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/div>
&lt;/figure>

&lt;p>例えば、上記のように ping モジュールのドキュメントを確認すると、&lt;code>data&lt;/code> というオプションを指定できることがわかります。
次のように &lt;code>data&lt;/code> オプションを付けて ping モジュールを実行すると、指定した値がターゲットホストからそのまま返ってきます。
モジュールのオプションは &lt;code>-a&lt;/code> に続けて入力します。&lt;/p></description></item></channel></rss>