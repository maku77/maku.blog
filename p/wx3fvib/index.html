<!doctype html><html lang=ja-jp><head prefix="og: http://ogp.me/ns# fb: http://ogp.me/ns/fb#"><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><title>Azure: Node.js アプリを App Service へデプロイする（Kudu ビルド編）｜まくろぐ</title><script async src="https://www.googletagmanager.com/gtag/js?id=G-V7PSCLD1ML"></script>
<script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-V7PSCLD1ML")</script><meta property="og:site_name" content="まくろぐ"><meta property="og:title" content="Azure: Node.js アプリを App Service へデプロイする（Kudu ビルド編）"><meta property="og:type" content="website"><meta property="og:url" content="https://maku.blog/p/wx3fvib/"><meta property="og:locale" content="ja_JP"><meta property="og:image" content="https://maku.blog/p/vrhjtds/azure-logo.jpg"><meta property="og:image:width" content="500"><meta property="og:image:height" content="281"><meta property="og:description" content="Azure App Service には、デプロイセンター という仕組みがあり、そこからソースコードのビルドからデプロイまでの自動化の設定を行うことができます。 簡単に言うと、Azure Repos や GitHub のリポジトリに最新の JavaScript コードをコミットするだけで、最新の Node.js アプリが自動で立ち上がるようになります。
ビルドの仕組みとしては、クラウド上の Azure Pipelines を使ったり、ローカルでビルドしてしまってからデプロイする方法があります。 App Service には Kudu エンジン が組み込まれており、デプロイ時に自動で実行されるスクリプトを使って簡易的なビルド処理を行うこともできます。
はじめに（用語定義） Azure ではデプロイ処理を構成するコンポーネントを下記のような名前で呼んでいます。
デプロイソース GitHub や Azure Repos など。 ソースコードが置いてある場所（リポジトリ）のこと。 Azure App Service は手軽なデプロイソースとして OneDrive や Dropbox などのフォルダ共有サービスを設定することもできますが、本格的な運用で使用することは推奨されていません。 ビルドパイプライン（ビルドプロバイダー） Azure Pipelines など。デプロイソースからソースコードを取得し、一連のビルド処理を行う仕組み。 App Service には組み込みで Kudu エンジンが搭載されており、デフォルトではデプロイ時にこの Kudu エンジンによって npm install などが実行されるようになっています。 また、デプロイ時に実行する カスタムスクリプトを .deployment ファイルで定義する こともできます。 これらの仕組みだけで十分であれば、Azure Pipelines を使う必要はありません。 デプロイメカニズム ビルドしたアプリを Azure App Service などに配置するためのアクション。Kudu エンジンや FTP (SFTP)、WebDeploy などのデプロイメカニズムが提供されています。 リポジトリの準備 (Azure Repos) ここでは、Azure Repos に Git リポジトリを作成し、そこに Node."><meta property="fb:app_id" content="1572235596285254"><link rel=stylesheet href=../../css/main.min.eadfac7aa78c756402c549dc008d43c133ad3c4ca684deb9f2bcd2ad06141128.css><link rel=icon sizes="16x16 32x32 48x48 64x64" href=../../assets/favicon/favicon.ico><link rel=icon sizes=192x192 href=../../assets/favicon/192x192.png><link rel=apple-touch-icon href=../../assets/favicon/180x180.png><script src=https://code.jquery.com/jquery-3.5.1.slim.min.js integrity="sha256-4+XzXVhsDmqanXGHaHvgh1gMQKX40OUvDEBTu8JcmNs=" crossorigin=anonymous defer></script>
<script src=../../assets/js/sidebar.js defer></script><style>.codoc-support{display:inline-block;margin:.5rem 0 0!important;padding:12px!important;width:210px!important;max-width:100%}.codoc-support .codoc-support-title{font-size:smaller!important;white-space:nowrap;margin-bottom:12px!important}.codoc-support .codoc-btn{width:180px!important}</style><script src=https://codoc.jp/js/cms.js data-css=black data-usercode=tp6ZPzTj3w defer></script></head><body><div id=xRoot><div id=xSiteHeader><a href=../../>まくろぐ</a></div><aside><div class=xBreadcrumb><span class=xBreadcrumb_item><a href=../../>&#x1F3E0;</a></span>
<span class=xBreadcrumb_item><a href=../../p/3ftx6b2/>技術系</a></span>
<span class=xBreadcrumb_item><a href=../../p/vrhjtds/>Azure</a></span>
<span class=xBreadcrumb_item><a href=../../p/3u2m6an/>Azure AppServices のメモ</a></span>
<span class=xBreadcrumb_item>Azure: Node.js アプリを App Service へデプロイする（Kudu ビルド編）</span></div></aside><div id=xContainer><nav id=xMenu aria-label=メニュー><div id=sidebar style=height:100%><div id=sidebar_notFixed><a href=../../><img src=https://maku.blog/img/site-logo-sidebar.png alt=サイトロゴ></a><div class=xMenu_box data-sticky><form action=https://cse.google.com/cse target=_blank><div class=xSearchBox><input type=hidden name=cx value=partner-pub-6317852277883092:6890083468>
<input type=hidden name=ie value=UTF-8>
<input type=search name=q placeholder=サイト内検索 size=30 autocomplete=off>
<input type=submit value=検索></input></div></form><div class=xMenu_box_body></div></div><div class=xMenu_box data-sticky><h3 class=xMenu_box_title><a href=../../latest/>新着</a></h3><div class=xMenu_box_body><div class=xBoxLink><a href=../../p/i7zokcv/>Linuxコマンド: ポートを開いているプロセスを調べる (lsof)
<time>2023-08-19</time></a></div><div class=xBoxLink><a href=../../p/qmy6cdh/>Svelte を始める (SvelteKit で Hello World）
<time>2023-08-17</time></a></div><div class=xBoxLink><a href=../../p/zays9nw/>Astro と Svelte を使ってみた所感（Web サイト作るときに何を使うか）
<time>2023-08-15</time></a></div><div class=xBoxLink><a href=../../p/a8rq9gs/>Astro アプリから D3.js を使う
<time>2023-08-14</time></a></div><div class=xBoxLink><a href=../../p/y7xwk4p/>ChatGPT でテキストアドベンチャー (TRPG) を楽しむ
<time>2023-08-05</time></a></div></div></div><div class=xMenu_box data-sticky><h3 class=xMenu_box_title><a href=../../sitemap/>フォルダ</a></h3><div class=xMenu_box_body><div class=xNavTree><ul><li><a class=xNavTree-dir href=../../p/3ftx6b2/>技術系</a><ul><li><a class=xNavTree-dir href=../../p/ujqinda/>プログラミング</a><li><a class=xNavTree-dir href=../../p/vrhjtds/>Azure</a><ul><li><a class=xNavTree-dir href=../../p/xjwakv8/>Cosmos DB</a><li><a class=xNavTree-dir href=../../p/59jt4ck/>Azure Functions</a><li><a class=xNavTree-dir href=../../p/fe7aiyp/>Azure DevOps</a><li><a class=xNavTree-dir href=../../p/um2wi2o/>Azure Storage のメモ</a><li><a class=xNavTree-dir href=../../p/3u2m6an/>Azure AppServices のメモ</a><ul></ul><li><a class=xNavTree-dir href=../../p/d8apqgw/>LUIS のメモ</a><li><a class=xNavTree-dir href=../../p/joexet9/>QnA Maker のメモ</a><li><a class=xNavTree-dir href=../../p/yya9sbm/>逆引き Azure CLI</a><li><a class=xNavTree-dir href=../../p/k43zbd8/>チャットボット</a></ul><li><a class=xNavTree-dir href=../../p/ruk3gu9/>Linux</a><li><a class=xNavTree-dir href=../../p/td962u6/>Svelte</a><li><a class=xNavTree-dir href=../../p/669r7r2/>Astro</a><li><a class=xNavTree-dir href=../../p/y29x85e/>Terraform</a><li><a class=xNavTree-dir href=../../p/jdgfe97/>セキュリティ</a><li><a class=xNavTree-dir href=../../p/7s7hs4e/>AWS</a><li><a class=xNavTree-dir href=../../p/xdsom3a/>Nginx（Web サーバー）</a><li><a class=xNavTree-dir href=../../p/c9sar9p/>Cloudflare</a><li><a class=xNavTree-dir href=../../p/inh3k2j/>Visual Studio Code</a><li><a class=xNavTree-dir href=../../p/ndbcxgb/>Meilisearch</a><li><a class=xNavTree-dir href=../../p/cm9nyco/>GraphQL</a><li><a class=xNavTree-dir href=../../p/nd3cmt3/>ネットワーク</a><li><a class=xNavTree-dir href=../../p/e58h5in/>雑多な技術メモ</a><li><a class=xNavTree-dir href=../../p/dj28oy5/>Docker 関連メモ</a><li><a class=xNavTree-dir href=../../p/8t6hr3d/>Ansible</a><li><a class=xNavTree-dir href=../../p/5q4fr3d/>GitHub</a><li><a class=xNavTree-dir href=../../p/9xv5548/>Jekyll</a><li><a class=xNavTree-dir href=../../p/6p3dox9/>Firebase</a><li><a class=xNavTree-dir href=../../p/somcgdw/>macOS</a><li><a class=xNavTree-dir href=../../p/y42o4hw/>Windows</a><li><a class=xNavTree-dir href=../../p/jto2isn/>HTML/CSS のメモ</a><li><a class=xNavTree-dir href=../../p/ibs96hs/>フォント/文字コード/Locale/Unicode</a><li><a class=xNavTree-dir href=../../p/xb5w4in/>デザインパターン/UML</a><li><a class=xNavTree-dir href=../../p/zbgbb5u/>PlantUML</a><li><a class=xNavTree-dir href=../../p/jxvi6vv/>Excel のメモ</a></ul><li><a class=xNavTree-dir href=../../p/qb73pxx/>日記・コラム</a><li><a class=xNavTree-dir href=../../p/35odek9/>読書</a><li><a class=xNavTree-dir href=../../p/zb9ocav/>ツール</a><li><a class=xNavTree-dir href=../../p/ajj5753/>遊び</a><li><a class=xNavTree-dir href=../../p/syy4ryp/>設定</a><li><a class=xNavTree-dir href=../../p/tsjyzrn/>雑多</a><li><a class=xNavTree-dir href=../../p/hnoamfo/>管理人</a></ul></div></div></div><div class=xMenu_box data-sticky><h3 class=xMenu_box_title><a href=../../tags/>タグ</a></h3><div class=xMenu_box_body><div class=xMenu_tag><a href=../../tags/%E8%AA%AD%E6%9B%B8>読書 (82)</a></div><div class=xMenu_tag><a href=../../tags/aws>aws (62)</a></div><div class=xMenu_tag><a href=../../tags/azure>azure (58)</a></div><div class=xMenu_tag><a href=../../tags/typescript>typescript (58)</a></div><div class=xMenu_tag><a href=../../tags/%E6%97%A5%E8%A8%98>日記 (54)</a></div><div class=xMenu_tag><a href=../../tags/next.js>next.js (38)</a></div><div class=xMenu_tag><a href=../../tags/graphql>graphql (35)</a></div><div class=xMenu_tag><a href=../../tags/react>react (30)</a></div><div class=xMenu_tag><a href=../../tags/chatbot>chatbot (28)</a></div><div class=xMenu_tag><a href=../../tags/gnuplot>gnuplot (27)</a></div><div class=xMenu_tag><a href=../../tags/aws/cdk>aws/cdk (26)</a></div><div class=xMenu_tag><a href=../../tags/linux>linux (26)</a></div><div class=xMenu_tag><a href=../../tags/github>github (24)</a></div><div class=xMenu_tag><a href=../../tags/ansible>ansible (21)</a></div><div class=xMenu_tag><a href=../../tags/bot-builder-sdk>bot-builder-sdk (21)</a></div><div class=xMenu_tag><a href=../../tags/node.js>node.js (19)</a></div><div class=xMenu_tag><a href=../../tags/aws/dynamodb>aws/dynamodb (18)</a></div><div class=xMenu_tag><a href=../../tags/aws/cloudformation>aws/cloudformation (16)</a></div><div class=xMenu_tag><a href=../../tags/electron>electron (15)</a></div><div class=xMenu_tag><a href=../../tags/mongodb>mongodb (15)</a></div><div class=xMenu_tag><a href=../../tags/vs-code>vs-code (15)</a></div><div class=xMenu_tag><a href=../../tags/aws/cognito>aws/cognito (14)</a></div><div class=xMenu_tag><a href=../../tags/protocol-buffers>protocol-buffers (14)</a></div><div class=xMenu_tag><a href=../../tags/javascript>javascript (13)</a></div><div class=xMenu_tag><a href=../../tags/nginx>nginx (12)</a></div><div class=xMenu_tag><a href=../../tags/%E3%83%97%E3%83%AD%E3%82%B0%E3%83%A9%E3%83%A0>プログラム (11)</a></div><div class=xMenu_tag><a href=../../tags/android>android (10)</a></div><div class=xMenu_tag><a href=../../tags/aws/lambda>aws/lambda (10)</a></div><div class=xMenu_tag><a href=../../tags/%E3%82%B2%E3%83%BC%E3%83%A0>ゲーム (10)</a></div><div class=xMenu_tag><a href=../../tags/%E3%83%93%E3%83%AA%E3%83%A4%E3%83%BC%E3%83%89>ビリヤード (10)</a></div><div class=xMenu_tag><a href=../../tags/java>java (9)</a></div><div class=xMenu_tag><a href=../../tags/python>python (9)</a></div><div class=xMenu_tag><a href=../../tags/ssh>ssh (9)</a></div><div class=xMenu_tag><a href=../../tags/uml>uml (9)</a></div><div class=xMenu_tag><a href=../../tags/%E3%82%BB%E3%83%9F%E3%83%8A%E3%83%BC%E8%AC%9B%E6%BC%94%E4%BC%9A>セミナー講演会 (9)</a></div><div class=xMenu_tag><a href=../../tags/%E6%95%B0%E5%AD%A6>数学 (9)</a></div><div class=xMenu_tag><a href=../../tags/3d>3d (8)</a></div><div class=xMenu_tag><a href=../../tags/aws/sam>aws/sam (8)</a></div><div class=xMenu_tag><a href=../../tags/docker>docker (8)</a></div><div class=xMenu_tag><a href=../../tags/firebase/firestore>firebase/firestore (8)</a></div><div class=xMenu_tag><a href=../../tags/unity>unity (8)</a></div><div class=xMenu_tag><a href=../../tags/webgl>webgl (8)</a></div><div class=xMenu_tag><a href=../../tags/%E3%82%A2%E3%82%A4%E3%83%87%E3%82%A2>アイデア (8)</a></div><div class=xMenu_tag><a href=../../tags/%E3%82%BB%E3%82%AD%E3%83%A5%E3%83%AA%E3%83%86%E3%82%A3>セキュリティ (8)</a></div><div class=xMenu_tag><a href=../../tags/%E4%BB%95%E4%BA%8B>仕事 (8)</a></div><div class=xMenu_tag><a href=../../tags/%E6%8A%80%E8%A1%93>技術 (8)</a></div><div class=xMenu_tag><a href=../../tags/apollo>apollo (7)</a></div><div class=xMenu_tag><a href=../../tags/azure-cli>azure-cli (7)</a></div><div class=xMenu_tag><a href=../../tags/azure-pipelines>azure-pipelines (7)</a></div><div class=xMenu_tag><a href=../../tags/deno>deno (7)</a></div><div class=xMenu_tag><a href=../../tags/jade>jade (7)</a></div><div class=xMenu_tag><a href=../../tags/material-ui>material-ui (7)</a></div><div class=xMenu_tag><a href=../../tags/%E3%83%87%E3%82%B6%E3%82%A4%E3%83%B3%E3%83%91%E3%82%BF%E3%83%BC%E3%83%B3>デザインパターン (7)</a></div><div class=xMenu_tag><a href=../../tags/%E3%83%8D%E3%83%83%E3%83%88%E3%83%AF%E3%83%BC%E3%82%AF>ネットワーク (7)</a></div><div class=xMenu_tag><a href=../../tags/%E3%83%A9%E3%82%A4%E3%83%95%E3%83%8F%E3%83%83%E3%82%AF>ライフハック (7)</a></div><div class=xMenu_tag><a href=../../tags/aws/api-gateway>aws/api-gateway (6)</a></div><div class=xMenu_tag><a href=../../tags/aws/cli>aws/cli (6)</a></div><div class=xMenu_tag><a href=../../tags/azure-storage>azure-storage (6)</a></div><div class=xMenu_tag><a href=../../tags/doxygen>doxygen (6)</a></div><div class=xMenu_tag><a href=../../tags/firebase/cloudfunctions>firebase/cloudfunctions (6)</a></div><div class=xMenu_tag><a href=../../tags/%E3%83%84%E3%83%BC%E3%83%AB>ツール (6)</a></div><div class=xMenu_tag><a href=../../tags/%E3%83%A6%E3%83%8B%E3%83%83%E3%83%88%E3%83%86%E3%82%B9%E3%83%88>ユニットテスト (6)</a></div><div class=xMenu_tag><a href=../../tags/azure-table-storage>azure-table-storage (5)</a></div><div class=xMenu_tag><a href=../../tags/c/c++>c/c++ (5)</a></div><div class=xMenu_tag><a href=../../tags/github-actions>github-actions (5)</a></div><div class=xMenu_tag><a href=../../tags/luis>luis (5)</a></div><div class=xMenu_tag><a href=../../tags/qna-maker>qna-maker (5)</a></div><div class=xMenu_tag><a href=../../tags/%E3%81%8A%E7%B5%B5%E3%81%8B%E3%81%8D>お絵かき (5)</a></div><div class=xMenu_tag><a href=../../tags/%E6%8A%95%E8%B3%87>投資 (5)</a></div><div class=xMenu_tag><a href=../../tags/%E7%94%9F%E3%81%8D%E6%96%B9>生き方 (5)</a></div><div class=xMenu_tag><a href=../../tags/aws/ssm>aws/ssm (4)</a></div><div class=xMenu_tag><a href=../../tags/eslint>eslint (4)</a></div><div class=xMenu_tag><a href=../../tags/firebase>firebase (4)</a></div><div class=xMenu_tag><a href=../../tags/github-pages>github-pages (4)</a></div><div class=xMenu_tag><a href=../../tags/html/css>html/css (4)</a></div><div class=xMenu_tag><a href=../../tags/jekyll>jekyll (4)</a></div><div class=xMenu_tag><a href=../../tags/lets-encrypt>lets-encrypt (4)</a></div><div class=xMenu_tag><a href=../../tags/sql>sql (4)</a></div><div class=xMenu_tag><a href=../../tags/windows>windows (4)</a></div><div class=xMenu_tag><a href=../../tags/%E3%82%A8%E3%83%87%E3%82%A3%E3%82%BF>エディタ (4)</a></div><div class=xMenu_tag><a href=../../tags/azure-functions>azure-functions (3)</a></div><div class=xMenu_tag><a href=../../tags/cosmos-db>cosmos-db (3)</a></div><div class=xMenu_tag><a href=../../tags/grpc>grpc (3)</a></div><div class=xMenu_tag><a href=../../tags/hugo>hugo (3)</a></div><div class=xMenu_tag><a href=../../tags/json>json (3)</a></div><div class=xMenu_tag><a href=../../tags/kotlin>kotlin (3)</a></div><div class=xMenu_tag><a href=../../tags/mac>mac (3)</a></div><div class=xMenu_tag><a href=../../tags/pc%E8%A8%AD%E5%AE%9A>pc設定 (3)</a></div><div class=xMenu_tag><a href=../../tags/powershell>powershell (3)</a></div><div class=xMenu_tag><a href=../../tags/prettier>prettier (3)</a></div><div class=xMenu_tag><a href=../../tags/sqlite>sqlite (3)</a></div><div class=xMenu_tag><a href=../../tags/textlint>textlint (3)</a></div><div class=xMenu_tag><a href=../../tags/tv>tv (3)</a></div><div class=xMenu_tag><a href=../../tags/%E3%81%8A%E3%81%A7%E3%81%8B%E3%81%91>おでかけ (3)</a></div><div class=xMenu_tag><a href=../../tags/%E3%82%A2%E3%83%97%E3%83%AA>アプリ (3)</a></div><div class=xMenu_tag><a href=../../tags/%E3%82%A2%E3%83%AB%E3%82%B4%E3%83%AA%E3%82%BA%E3%83%A0>アルゴリズム (3)</a></div><div class=xMenu_tag><a href=../../tags/%E3%83%81%E3%83%A3%E3%83%83%E3%83%88%E3%83%9C%E3%83%83%E3%83%88>チャットボット (3)</a></div><div class=xMenu_tag><a href=../../tags/%E3%83%9C%E3%83%BC%E3%83%89%E3%82%B2%E3%83%BC%E3%83%A0>ボードゲーム (3)</a></div><div class=xMenu_tag><a href=../../tags/%E5%83%8D%E3%81%8D%E6%96%B9>働き方 (3)</a></div><div class=xMenu_tag><a href=../../tags/%E7%A7%80%E4%B8%B8>秀丸 (3)</a></div><div class=xMenu_tag><a href=../../tags/%E8%87%AA%E5%88%86>自分 (3)</a></div><div class=xMenu_tag><a href=../../tags/apache>apache (2)</a></div><div class=xMenu_tag><a href=../../tags/arib>arib (2)</a></div><div class=xMenu_tag><a href=../../tags/astro>astro (2)</a></div><div class=xMenu_tag><a href=../../tags/aws/amplify>aws/amplify (2)</a></div><div class=xMenu_tag><a href=../../tags/aws/appsync>aws/appsync (2)</a></div><div class=xMenu_tag><a href=../../tags/aws/codebuild>aws/codebuild (2)</a></div><div class=xMenu_tag><a href=../../tags/aws/iam>aws/iam (2)</a></div><div class=xMenu_tag><a href=../../tags/aws/kms>aws/kms (2)</a></div><div class=xMenu_tag><a href=../../tags/aws/s3>aws/s3 (2)</a></div><div class=xMenu_tag><a href=../../tags/aws/sdk>aws/sdk (2)</a></div><div class=xMenu_tag><a href=../../tags/azure-app-service>azure-app-service (2)</a></div><div class=xMenu_tag><a href=../../tags/cloudflare>cloudflare (2)</a></div><div class=xMenu_tag><a href=../../tags/d3.js>d3.js (2)</a></div><div class=xMenu_tag><a href=../../tags/excel>excel (2)</a></div><div class=xMenu_tag><a href=../../tags/firebase/authentication>firebase/authentication (2)</a></div><div class=xMenu_tag><a href=../../tags/go>go (2)</a></div><div class=xMenu_tag><a href=../../tags/http>http (2)</a></div><div class=xMenu_tag><a href=../../tags/mui>mui (2)</a></div><div class=xMenu_tag><a href=../../tags/npm>npm (2)</a></div><div class=xMenu_tag><a href=../../tags/oauth>oauth (2)</a></div><div class=xMenu_tag><a href=../../tags/opengl>opengl (2)</a></div><div class=xMenu_tag><a href=../../tags/rsync>rsync (2)</a></div><div class=xMenu_tag><a href=../../tags/scp>scp (2)</a></div><div class=xMenu_tag><a href=../../tags/slack>slack (2)</a></div><div class=xMenu_tag><a href=../../tags/svelte>svelte (2)</a></div><div class=xMenu_tag><a href=../../tags/teraterm>teraterm (2)</a></div><div class=xMenu_tag><a href=../../tags/unicode>unicode (2)</a></div><div class=xMenu_tag><a href=../../tags/vercel>vercel (2)</a></div><div class=xMenu_tag><a href=../../tags/yaml>yaml (2)</a></div><div class=xMenu_tag><a href=../../tags/zip>zip (2)</a></div><div class=xMenu_tag><a href=../../tags/%E3%81%8A%E5%90%8D%E5%89%8D.com>お名前.com (2)</a></div><div class=xMenu_tag><a href=../../tags/%E3%82%A8%E3%83%9F%E3%83%A5%E3%83%AC%E3%83%BC%E3%82%BF%E3%83%BC>エミュレーター (2)</a></div><div class=xMenu_tag><a href=../../tags/%E3%83%95%E3%82%A9%E3%83%B3%E3%83%88>フォント (2)</a></div><div class=xMenu_tag><a href=../../tags/%E3%83%97%E3%83%AD%E3%82%B0%E3%83%A9%E3%83%9F%E3%83%B3%E3%82%B0>プログラミング (2)</a></div><div class=xMenu_tag><a href=../../tags/%E3%83%AA%E3%83%95%E3%82%A1%E3%83%AC%E3%83%B3%E3%82%B9>リファレンス (2)</a></div><div class=xMenu_tag><a href=../../tags/%E5%9C%A7%E7%B8%AE%E5%B1%95%E9%96%8B>圧縮展開 (2)</a></div><div class=xMenu_tag><a href=../../tags/%E6%96%87%E5%AD%97%E5%88%97>文字列 (2)</a></div><div class=xMenu_tag><a href=../../tags/.net>.net (1)</a></div><div class=xMenu_tag><a href=../../tags/androidstudio>androidstudio (1)</a></div><div class=xMenu_tag><a href=../../tags/apollo-server>apollo-server (1)</a></div><div class=xMenu_tag><a href=../../tags/atomic-design>atomic-design (1)</a></div><div class=xMenu_tag><a href=../../tags/blender>blender (1)</a></div><div class=xMenu_tag><a href=../../tags/bluetooth>bluetooth (1)</a></div><div class=xMenu_tag><a href=../../tags/bootstrap>bootstrap (1)</a></div><div class=xMenu_tag><a href=../../tags/bot-framework>bot-framework (1)</a></div><div class=xMenu_tag><a href=../../tags/boto3>boto3 (1)</a></div><div class=xMenu_tag><a href=../../tags/certbot>certbot (1)</a></div><div class=xMenu_tag><a href=../../tags/chatgpt>chatgpt (1)</a></div><div class=xMenu_tag><a href=../../tags/css>css (1)</a></div><div class=xMenu_tag><a href=../../tags/dns>dns (1)</a></div><div class=xMenu_tag><a href=../../tags/dvb>dvb (1)</a></div><div class=xMenu_tag><a href=../../tags/editorconfig>editorconfig (1)</a></div><div class=xMenu_tag><a href=../../tags/evernote>evernote (1)</a></div><div class=xMenu_tag><a href=../../tags/git>git (1)</a></div><div class=xMenu_tag><a href=../../tags/golang>golang (1)</a></div><div class=xMenu_tag><a href=../../tags/google-analytics>google-analytics (1)</a></div><div class=xMenu_tag><a href=../../tags/groovy>groovy (1)</a></div><div class=xMenu_tag><a href=../../tags/html>html (1)</a></div><div class=xMenu_tag><a href=../../tags/igdb>igdb (1)</a></div><div class=xMenu_tag><a href=../../tags/iso>iso (1)</a></div><div class=xMenu_tag><a href=../../tags/jest>jest (1)</a></div><div class=xMenu_tag><a href=../../tags/lsof>lsof (1)</a></div><div class=xMenu_tag><a href=../../tags/macos>macos (1)</a></div><div class=xMenu_tag><a href=../../tags/meilisearch>meilisearch (1)</a></div><div class=xMenu_tag><a href=../../tags/parcel>parcel (1)</a></div><div class=xMenu_tag><a href=../../tags/raspberrypi>raspberrypi (1)</a></div><div class=xMenu_tag><a href=../../tags/rclone>rclone (1)</a></div><div class=xMenu_tag><a href=../../tags/teams>teams (1)</a></div><div class=xMenu_tag><a href=../../tags/terraform>terraform (1)</a></div><div class=xMenu_tag><a href=../../tags/tex>tex (1)</a></div><div class=xMenu_tag><a href=../../tags/ubuntu>ubuntu (1)</a></div><div class=xMenu_tag><a href=../../tags/url>url (1)</a></div><div class=xMenu_tag><a href=../../tags/vim>vim (1)</a></div><div class=xMenu_tag><a href=../../tags/vps>vps (1)</a></div><div class=xMenu_tag><a href=../../tags/web>web (1)</a></div><div class=xMenu_tag><a href=../../tags/webpack>webpack (1)</a></div><div class=xMenu_tag><a href=../../tags/wsl>wsl (1)</a></div><div class=xMenu_tag><a href=../../tags/%E3%82%A2%E3%82%B8%E3%83%A3%E3%82%A4%E3%83%AB>アジャイル (1)</a></div><div class=xMenu_tag><a href=../../tags/%E3%83%90%E3%83%83%E3%83%81%E3%83%95%E3%82%A1%E3%82%A4%E3%83%AB>バッチファイル (1)</a></div><div class=xMenu_tag><a href=../../tags/%E3%83%97%E3%83%AD%E3%82%AD%E3%82%B7%E8%A8%AD%E5%AE%9A>プロキシ設定 (1)</a></div><div class=xMenu_tag><a href=../../tags/%E4%BA%BA%E7%94%9F%E7%94%9F%E3%81%8D%E6%96%B9>人生生き方 (1)</a></div><div class=xMenu_tag><a href=../../tags/%E6%96%87%E5%AD%97%E3%82%B3%E3%83%BC%E3%83%89>文字コード (1)</a></div><div class=xMenu_tag><a href=../../tags/%E6%96%87%E6%88%BF%E5%85%B7>文房具 (1)</a></div><div class=xMenu_tag><a href=../../tags/%E6%96%99%E7%90%86>料理 (1)</a></div><div class=xMenu_tag><a href=../../tags/%E6%AD%A3%E8%A6%8F%E8%A1%A8%E7%8F%BE>正規表現 (1)</a></div><div class=xMenu_tag><a href=../../tags/%E7%94%BB%E5%83%8F%E5%87%A6%E7%90%86>画像処理 (1)</a></div><div class=xMenu_tag><a href=../../tags/%E8%A8%80%E8%91%89>言葉 (1)</a></div><div class=xMenu_tag><a href=../../tags/%E8%A8%AD%E5%AE%9A>設定 (1)</a></div><div class=xMenu_tag><a href=../../tags/%E8%AA%8D%E8%A8%BC>認証 (1)</a></div><div class=xMenu_tag><a href=../../tags/%E9%80%9F%E8%AA%AD>速読 (1)</a></div><div class=xMenu_tag><a href=../../tags/%E9%9F%B3%E5%A3%B0%E8%AA%8D%E8%AD%98>音声認識 (1)</a></div></div></div><div class=xMenu_box data-sticky><br></div></div><div id=sidebar_fixed style=position:-webkit-sticky;position:sticky;top:4rem></div></div></nav><main id=xMain><div id=redirect-notification style=display:none;font-size:smaller;padding:1em>Web サイトの URL が変わりました。ブックマークの変更をお願いします。<br>変更前: <s>https://memoja.net</s><br>変更後: <a href=https://toushi.maku.blog>https://toushi.maku.blog</a><br></div><script>const url=new URL(document.location);if(url.searchParams.get("redirected_from")==="memoja.net"){const e=document.getElementById("redirect-notification");e.style.display="block",url.searchParams.delete("redirected_from"),history.replaceState({},"",url)}</script><article class=xArticle itemscope itemtype=https://schema.org/BlogPosting><aside><div class=xPrevNextLink><div class=xPrevNextLink_prev><a href=../../p/bog7iq8/>Azure: デプロイスロットでリリース時のダウンタイムをなくす（Blue-Green デプロイメント）</a></div><div class=xPrevNextLink_next><a href=../../p/3u4hj7h/>Azure: App Service の Node.js アプリのエントリポイントはどこで定義されているか？</a></div></div></aside><header class=xArticle_headerBox><div><span class=xArticle_headerBox_breadcrumb><a href=../../>&#x1F3E0;</a></span>
<span class=xArticle_headerBox_breadcrumb><a href=../../p/3ftx6b2/>技術系</a></span>
<span class=xArticle_headerBox_breadcrumb><a href=../../p/vrhjtds/>Azure</a></span>
<span class=xArticle_headerBox_breadcrumb><a href=../../p/3u2m6an/>Azure AppServices のメモ</a></span></div><div style=display:flex;margin-top:.8em><div style=width:80px;margin-right:.5em><img src=../../p/vrhjtds/azure-icon.svg style=width:80px;height:80px alt=カテゴリーアイコン></div><div style=flex:1><h1 itemprop=headline class=xArticle_headerBox_title><a itemprop=mainEntityOfPage href=../../p/wx3fvib/>Azure: Node.js アプリを App Service へデプロイする（Kudu ビルド編）</a></h1><div class=xPageTags><span class=xPageTags_item><a href=../../tags/azure>Azure</a></span>
<span class=xPageTags_item><a href=../../tags/azure-app-service>Azure App Service</a></span>
<span class=xPageTags_item><a href=../../tags/azure-pipelines>Azure Pipelines</a></span></div></div></div><span class=xPageDate>更新: <time itemprop=dateModified datetime=2019-10-09>2019-10-09</time><br>作成: <time itemprop=datePublished datetime=2019-10-09>2019-10-09</time></span></header><div itemprop=articleBody class=xArticle_content><nav id=TableOfContents><ul><li><a href=#はじめに用語定義>はじめに（用語定義）</a></li><li><a href=#リポジトリの準備-azure-repos>リポジトリの準備 (Azure Repos)</a></li><li><a href=#デプロイセンターの設定-azure-repos--kudu>デプロイセンターの設定 (Azure Repos + Kudu)</a></li><li><a href=#応用-kudu-によるビルドデプロイ処理>（応用） Kudu によるビルド／デプロイ処理</a><ul><li><a href=#カスタムデプロイスクリプト-deployment--deploycmd>カスタムデプロイスクリプト (.deployment / deploy.cmd)</a></li><li><a href=#カスタムデプロイスクリプトのテンプレート>カスタムデプロイスクリプトのテンプレート</a></li><li><a href=#カスタムデプロイスクリプトが実行されるトリガー>カスタムデプロイスクリプトが実行されるトリガー</a></li></ul></li><li><a href=#kudu-で-typescript-ビルドとかはキツい>Kudu で TypeScript ビルドとかはキツい</a></li></ul></nav><p>Azure App Service には、<strong>デプロイセンター</strong> という仕組みがあり、そこからソースコードのビルドからデプロイまでの自動化の設定を行うことができます。
簡単に言うと、Azure Repos や GitHub のリポジトリに最新の JavaScript コードをコミットするだけで、最新の Node.js アプリが自動で立ち上がるようになります。</p><p>ビルドの仕組みとしては、クラウド上の Azure Pipelines を使ったり、ローカルでビルドしてしまってからデプロイする方法があります。
App Service には <a href=https://gihub.com/projectkudu/kudu/wiki>Kudu エンジン</a> が組み込まれており、デプロイ時に自動で実行されるスクリプトを使って簡易的なビルド処理を行うこともできます。</p><h2 id=はじめに用語定義>はじめに（用語定義）</h2><p>Azure ではデプロイ処理を構成するコンポーネントを下記のような名前で呼んでいます。</p><dl><dt>デプロイソース</dt><dd>GitHub や Azure Repos など。
ソースコードが置いてある場所（リポジトリ）のこと。
Azure App Service は手軽なデプロイソースとして OneDrive や Dropbox などのフォルダ共有サービスを設定することもできますが、本格的な運用で使用することは推奨されていません。</dd><dt>ビルドパイプライン（ビルドプロバイダー）</dt><dd>Azure Pipelines など。デプロイソースからソースコードを取得し、一連のビルド処理を行う仕組み。
App Service には組み込みで Kudu エンジンが搭載されており、デフォルトではデプロイ時にこの Kudu エンジンによって <code>npm install</code> などが実行されるようになっています。
また、デプロイ時に実行する <a href=https://github.com/projectkudu/kudu/wiki/Deployment-hooks>カスタムスクリプトを .deployment ファイルで定義する</a> こともできます。
これらの仕組みだけで十分であれば、Azure Pipelines を使う必要はありません。</dd><dt>デプロイメカニズム</dt><dd>ビルドしたアプリを Azure App Service などに配置するためのアクション。Kudu エンジンや FTP (SFTP)、WebDeploy などのデプロイメカニズムが提供されています。</dd></dl><h2 id=リポジトリの準備-azure-repos>リポジトリの準備 (Azure Repos)</h2><p>ここでは、Azure Repos に Git リポジトリを作成し、そこに Node.js アプリのコードをコミットしてあると想定します。
GitHub でも大丈夫です。</p><ul><li>参考: <a href=../../p/qt5qyzu>Azure DevOps で無料のプライベート Git リポジトリ (Repos) を使用する</a></li></ul><h2 id=デプロイセンターの設定-azure-repos--kudu>デプロイセンターの設定 (Azure Repos + Kudu)</h2><p>Azure ポータルからデプロイ先の App Service を選択し、<samp>デプロイセンター</samp> を開くと、使用するリポジトリやビルドパイプラインの設定を行えます。</p><figure class=xImage><a href=../../p/wx3fvib/deploy-kudu-001.png target=_blank><img style="border:solid #ccc 2px" width=1530 height=894 src=../../p/wx3fvib/deploy-kudu-001.png alt=/p/wx3fvib/deploy-kudu-001.png></a></figure><p>まずは、使用するソースコードのリポジトリを設定します。
上記の例では、<samp>Azure Repos</samp> を選択していますが、<samp>GitHub</samp> を選択することもできます。
<samp>Local Git</samp> を選択すると、App Service 内の Git リポジトリに対して、開発者のローカル Git リポジトリから直接 push するというデプロイスタイルになります（そのためのリポジトリアドレスは後から表示されます）。
ただ、大本のソースコードは Azure Repos や GitHub で管理しておくのが望ましいでしょう。</p><figure class=xImage><a href=../../p/wx3fvib/deploy-kudu-002.png target=_blank><img style="border:solid #ccc 2px" width=600 height=388 src=../../p/wx3fvib/deploy-kudu-002_hu9b832da17d0fa02748cc7512742d25ce_27395_600x0_resize_box_3.png alt=/p/wx3fvib/deploy-kudu-002.png></a></figure><p>次に、ビルドエンジンとして App Service 組み込みの Kudu の仕組みを使用するか、Azure Pipelines を使用するかを選択します。
ここでは、Kudo を選択します。</p><figure class=xImage><a href=../../p/wx3fvib/deploy-kudu-003.png target=_blank><img style="border:solid #ccc 2px" width=600 height=437 src=../../p/wx3fvib/deploy-kudu-003_hud41357be981aa2dc531449a7d1fa2e8c_17815_600x0_resize_box_3.png alt=/p/wx3fvib/deploy-kudu-003.png></a></figure><p>あとは使用する Azure DevOps のプロジェクト名や Git リポジトリ名を選択すれば、デプロイセンターの設定は完了です。
ここでは最初のステップで Azure Repos を選択したのでこの画面が表示されていますが、GitHub を選択していれば、GitHub の organization やリポジトリ名を選択する画面が表示されます。</p><p>この設定が完了すると、自動的に最新のコミットがデプロイされます。
デプロイ先のディレクトリパスは気にする必要はありませんが、App Service 内部では <code>D:\home\site\wwwroot</code> のようなパスになっています。</p><p>Node.js アプリであれば、その後、自動的に <code>npm install</code> などが実行され、<code>index.js</code> などが起動します。
つまり、これだけの設定で、Azure Repos や GitHub のリポジトリにソースコードをデプロイするだけで、最新のコードで Node.js アプリが起動するという自動化が完了します。</p><h2 id=応用-kudu-によるビルドデプロイ処理>（応用） Kudu によるビルド／デプロイ処理</h2><p>デプロイセンターのログのリンクを辿ると、リポジトリからのコード取得後にどのような処理が行われたかのログを見ることができます。
例えば、こんな感じ。</p><figure class=xCodeBlock><div class=xCodeBlock_code><div class=highlight><pre tabindex=0 class=chroma><code class=language-plain data-lang=plain><span class=line><span class=cl>Command: deploy.cmd
</span></span><span class=line><span class=cl>Handling node.js deployment.
</span></span><span class=line><span class=cl>Creating app_offline.htm
</span></span><span class=line><span class=cl>KuduSync.NET from: &#39;D:\home\site\repository&#39; to: &#39;D:\home\site\wwwroot&#39;
</span></span><span class=line><span class=cl>Deleting file: &#39;.env&#39;
</span></span><span class=line><span class=cl>Deleting file: &#39;bot.js&#39;
</span></span><span class=line><span class=cl>Deleting file: &#39;index.js&#39;
</span></span><span class=line><span class=cl>Copying file: &#39;.eslintrc.js&#39;
</span></span><span class=line><span class=cl>Copying file: &#39;.gitignore&#39;
</span></span><span class=line><span class=cl>Copying file: &#39;iisnode.yml&#39;
</span></span><span class=line><span class=cl>Copying file: &#39;package-lock.json&#39;
</span></span><span class=line><span class=cl>Copying file: &#39;package.json&#39;
</span></span><span class=line><span class=cl>Copying file: &#39;publish.cmd&#39;
</span></span><span class=line><span class=cl>Copying file: &#39;README.md&#39;
</span></span><span class=line><span class=cl>Copying file: &#39;tsconfig.json&#39;
</span></span><span class=line><span class=cl>Deleting file: &#39;mylibs\util.js&#39;
</span></span><span class=line><span class=cl>Copying file: &#39;src\bot.js&#39;
</span></span><span class=line><span class=cl>Copying file: &#39;src\index.js&#39;
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>Deleting app_offline.htm
</span></span><span class=line><span class=cl>Start script &#34;index.js&#34; from package.json
</span></span><span class=line><span class=cl>The iisnode.yml file explicitly sets nodeProcessCommandLine. Automatic node.js version selection is turned off.
</span></span><span class=line><span class=cl>Selected npm version 6.4.1
</span></span><span class=line><span class=cl>added 1 package from 1 contributor and audited 4520 packages in 37.513s
</span></span><span class=line><span class=cl>found 62 vulnerabilities (1 low, 1 moderate, 57 high, 3 critical)
</span></span><span class=line><span class=cl>  run `npm audit fix` to fix them, or `npm audit` for details
</span></span><span class=line><span class=cl>Finished successfully.</span></span></code></pre></div></div></figure><h3 id=カスタムデプロイスクリプト-deployment--deploycmd>カスタムデプロイスクリプト (.deployment / deploy.cmd)</h3><p>Kudu は、リポジトリのルートに置かれた <code>.deployment</code> ファイルに従い、デプロイ時にカスタムスクリプトを実行します。</p><figure class=xCodeBlock><figcaption class=xCodeBlock_title>.deployment</figcaption><div class=xCodeBlock_code><div class=highlight><pre tabindex=0 class=chroma><code class=language-ini data-lang=ini><span class=line><span class=cl><span class=k>[config]</span>
</span></span><span class=line><span class=cl><span class=na>command</span> <span class=o>=</span> <span class=s>deploy.cmd</span></span></span></code></pre></div></div></figure><p>通常は、このように記述されており、<code>deploy.cmd</code> というバッチファイルが実行されるようになっています。
これらのファイルは、App Service 用のアプリをテンプレートから作成するとき、あるいは最初に <a href=https://github.com/projectkudu/kudu/wiki/Custom-Deployment-Script#easily-downloading-your-current-deployment-script>Kudu によるデプロイ処理が走るときに自動的に生成される</a> ようです。</p><p>自動生成された <code>deploy.cmd</code> の中身を見てみると、例えば下記のような感じで記述されています。</p><figure class=xCodeBlock><figcaption class=xCodeBlock_title>deploy.cmd（抜粋）</figcaption><div class=xCodeBlock_code><div class=highlight><pre tabindex=0 class=chroma><code class=language-cmd data-lang=cmd><span class=line><span class=cl><span class=p>:</span><span class=nl>Deployment</span>
</span></span><span class=line><span class=cl><span class=k>echo</span> Handling node.js deployment.
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=p>:</span><span class=c1>: 1. KuduSync</span>
</span></span><span class=line><span class=cl><span class=k>IF</span> <span class=k>/I</span> <span class=s2>&#34;</span><span class=nv>%IN_PLACE_DEPLOYMENT%</span><span class=s2>&#34;</span> <span class=ow>NEQ</span> <span class=s2>&#34;1&#34;</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>  <span class=k>call</span> <span class=p>:</span><span class=nl>ExecuteCmd</span> <span class=s2>&#34;</span><span class=nv>%KUDU_SYNC_CMD%</span><span class=s2>&#34;</span> -v 50 -f <span class=s2>&#34;</span><span class=nv>%DEPLOYMENT_SOURCE%</span><span class=s2>&#34;</span> -t <span class=s2>&#34;</span><span class=nv>%DEPLOYMENT_TARGET%</span><span class=s2>&#34;</span> -n <span class=s2>&#34;</span><span class=nv>%NEXT_MANIFEST_PATH%</span><span class=s2>&#34;</span> -p <span class=s2>&#34;</span><span class=nv>%PREVIOUS_MANIFEST_PATH%</span><span class=s2>&#34;</span> -i <span class=s2>&#34;.git;.hg;.deployment;deploy.cmd&#34;</span>
</span></span><span class=line><span class=cl>  <span class=k>IF</span> <span class=nv>!ERRORLEVEL!</span> <span class=ow>NEQ</span> 0 <span class=k>goto</span> <span class=nl>error</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=p>:</span><span class=c1>: 2. Select node version</span>
</span></span><span class=line><span class=cl><span class=k>call</span> <span class=p>:</span><span class=nl>SelectNodeVersion</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=p>:</span><span class=c1>: 3. Install npm packages</span>
</span></span><span class=line><span class=cl><span class=k>IF</span> <span class=k>EXIST</span> <span class=s2>&#34;</span><span class=nv>%DEPLOYMENT_TARGET%</span><span class=s2>\package.json&#34;</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>  <span class=k>pushd</span> <span class=s2>&#34;</span><span class=nv>%DEPLOYMENT_TARGET%</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>  <span class=k>call</span> <span class=p>:</span><span class=nl>ExecuteCmd</span> <span class=nv>!NPM_CMD!</span> install --production
</span></span><span class=line><span class=cl>  <span class=k>IF</span> <span class=nv>!ERRORLEVEL!</span> <span class=ow>NEQ</span> 0 <span class=k>goto</span> <span class=nl>error</span>
</span></span><span class=line><span class=cl>  <span class=k>popd</span>
</span></span><span class=line><span class=cl><span class=p>)</span></span></span></code></pre></div></div></figure><p>コード中に出てくる変数には、例えば下記のようなディレクトリのパスが格納されます。</p><ul><li><b>DEPLOYMENT_SOURCE</b>: リポジトリのコード (<code>D:\home\site\repository</code>)</li><li><b>DEPLOYMENT_TARGET</b>: デプロイ先のルート (<code>D:\home\site\wwwroot</code>)</li></ul><p>大まかには、リポジトリのコードをデプロイ先にコピーしておいて、<code>npm install --production</code> で必要な NPM パッケージをインストールするという流れになっています。
上記の後ろあたりに、</p><figure class=xCodeBlock><div class=xCodeBlock_code><div class=highlight><pre tabindex=0 class=chroma><code class=language-cmd data-lang=cmd><span class=line><span class=cl><span class=k>echo</span> Hellooooooooooooooooooooooo</span></span></code></pre></div></div></figure><p>のような感じで追記しておくと、デプロイ時にメッセージがログに出力されることを確認できます。</p><p>デプロイ時に TypeScript のトランスパイルの実行などを行いたい場合は、下記のように <code>npm run build</code> を実行する感じでしょうか。
この場合は <code>npm install --production</code> となっていた部分を、<code>npm install</code> に変更しておかなければいけません。
<code>tsc</code> などの開発ツールをインストールするためです。</p><figure class=xCodeBlock><figcaption class=xCodeBlock_title>deploy.cmd（抜粋）</figcaption><div class=xCodeBlock_code><div class=highlight><pre tabindex=0 class=chroma><code class=language-cmd data-lang=cmd><span class=line><span class=cl><span class=p>:</span><span class=c1>: 3. Install npm packages AND transpile TypeScript files</span>
</span></span><span class=line><span class=cl><span class=k>IF</span> <span class=k>EXIST</span> <span class=s2>&#34;</span><span class=nv>%DEPLOYMENT_TARGET%</span><span class=s2>\package.json&#34;</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>  <span class=k>pushd</span> <span class=s2>&#34;</span><span class=nv>%DEPLOYMENT_TARGET%</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=k>call</span> <span class=p>:</span><span class=nl>ExecuteCmd</span> <span class=nv>!NPM_CMD!</span> install
</span></span><span class=line><span class=cl>  <span class=k>IF</span> <span class=nv>!ERRORLEVEL!</span> <span class=ow>NEQ</span> 0 <span class=k>goto</span> <span class=nl>error</span>
</span></span><span class=line><span class=cl>  <span class=k>call</span> <span class=p>:</span><span class=nl>ExecuteCmd</span> <span class=nv>!NPM_CMD!</span> run build
</span></span><span class=line><span class=cl>  <span class=k>IF</span> <span class=nv>!ERRORLEVEL!</span> <span class=ow>NEQ</span> 0 <span class=k>goto</span> <span class=nl>error</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=k>popd</span>
</span></span><span class=line><span class=cl><span class=p>)</span></span></span></code></pre></div></div></figure><h3 id=カスタムデプロイスクリプトのテンプレート>カスタムデプロイスクリプトのテンプレート</h3><p>Kudu のカスタムデプロイスクリプト（<code>.deployment</code> と <code>deploy.cmd</code>）は、<strong><code>kuduscript</code></strong> コマンドを使って簡単に生成することができます。
下記の例では、Node.js アプリ用のデプロイスクリプトを生成しています。</p><figure class=xCodeBlock><figcaption class=xCodeBlock_title>Node.js アプリ用の Kudu デプロイスクリプトの作成</figcaption><div class=xCodeBlock_code><div class=highlight><pre tabindex=0 class=chroma><code class=language-plain data-lang=plain><span class=line><span class=cl>$ npm install -g kuduscript
</span></span><span class=line><span class=cl>$ kuduscript --node -y
</span></span><span class=line><span class=cl>Generating deployment script for node.js Web Site
</span></span><span class=line><span class=cl>Generated deployment script files</span></span></code></pre></div></div></figure><p>生成されたファイルはこちら。</p><ul><li><a href=../../p/wx3fvib/deploy-kudu-dot-deployment.txt>.deployment</a></li><li><a href=../../p/wx3fvib/deploy-kudu-deploy-cmd.txt>deploy.cmd</a></li></ul><p>これらのファイルをリポジトリのルートにコミットしておけば、App Service へのデプロイ時に自動的に実行されるようになります。</p><h3 id=カスタムデプロイスクリプトが実行されるトリガー>カスタムデプロイスクリプトが実行されるトリガー</h3><p>ちなみに、オンラインコードエディタ (App Service Editor) 上でコードを直接編集した場合は、<code>.deployment</code> によるカスタムスクリプトは呼び出されないようです。
このあたりの起動条件がはっきりしないので Microsoft さんに問い合わせたところ、下記のようなパターンで Web フックによりカスタムスクリプトがキックされるようです。</p><ul><li>App Service の <samp>デプロイセンター</samp> を設定して継続的なデプロイを有効にした状態でリポジトリに Push したとき</li><li>App Service の環境変数で <code>SCM_DO_BUILD_DURING_DEPLOYMENT</code> を <code>true</code> に設定し、ZIP デプロイを行ったとき（参考: <a href=https://docs.microsoft.com/ja-jp/azure/app-service/deploy-zip>ZIP または WAR ファイルを使用した Azure App Service へのアプリのデプロイ</a>）</li></ul><p>いずれにしても継続的デプロイの仕組みがオススメです。
Repos への Push 時にいきなりアプリが公開されてしまうのが心配なときは、App Service で <samp>デプロイスロット</samp> を設定しておけば OK です。
いわゆるブルーグリーンデプロイメントの仕組みで、ステージング環境を使って事前にテストできるようになります。</p><h2 id=kudu-で-typescript-ビルドとかはキツい>Kudu で TypeScript ビルドとかはキツい</h2><p><code>deploy.cmd</code> あたりをカスタマイズすれば、TypeScript のトランスパイル処理などもこの中でできそう！
と思いましたが、すでにバリバリ記述されているバッチファイルを編集するのは厳しそうです。</p><p>そもそもテンプレートで実行されている <code>npm install</code> は <code>--production</code> オプションが指定されており、これはデプロイ後のサーバー上で実行されることを前提としています。
TypeScript のトランスパイラを実行するのであれば、事前に開発用に <code>npm install</code> を実行してインストールしておかなければいけません。
やはり、<code>npm install</code> 以上のビルド処理を行う場合は、別の仕組み (Azure Pipeline) を利用したほうがよさそうです。</p><p>結論としては、こんな感じで使い分ければよいと思います。</p><ul><li><b>Kudu ビルド</b>: Git リポジトリに実行可能な index.js などをコミットする場合</li><li><b>Azure Pipelines ビルド</b>: Git リポジトリに TypeScript ファイルなどをコミットし、クラウド上で JavaScript に変換したい場合</li></ul><p>Kudu によるビルドは、CI/CD サービスを追加しなくて済むのである意味手軽ですが、実行環境上で初めて実行可能なアプリが生成されるため、どうしてもエイヤッ的なリリースになってしまいます。
また、その最終成果物をそのまま別のサーバーに展開するというポータビリティもありません。
なので、できればビルドとリリースを分離できる Azure Pipelines の使用をオススメするというのが Microsoft さんの見解のようです。
同様の機能を提供しようとしている GitHub Actions も気になりますね。</p><meta itemprop=author content="まく"><span itemprop=publisher itemscope itemtype=https://schema.org/Organization><meta itemprop=name content="まく"></span><h3 style="border-bottom:1px solid gray">関連記事</h3><ul><li><a href=../../p/3u4hj7h/>Azure: App Service の Node.js アプリのエントリポイントはどこで定義されているか？</a></li><li><a href=../../p/qt5qyzu/>Azure DevOps で無料のプライベート Git リポジトリ (Repos) を使用する</a></li><li><a href=../../p/t8rfkjn/>Azure: Cosmos DB の SQL API をプロキシ経由で使用する</a></li><li><a href=../../p/5zx3ozz/>Azure Speech Service を使って音声をテキストに変換する (STT)</a></li><li><a href=../../p/fn3amda/>チャットボット: 独自のミドルウェアを作成してログを記録する</a></li><li><a href=../../p/gt9g2na/>チャットボット: 独自のミドルウェアを作成して禁止ワードを拒否するようにする</a></li><li><a href=../../p/6arjar6/>チャットボット: Bot Builder SDK の Dialog で会話の流れをデザインする (2) スタック管理</a></li></ul><div class=xPageTags><span class=xPageTags_item><a href=../../tags/azure>Azure</a></span>
<span class=xPageTags_item><a href=../../tags/azure-app-service>Azure App Service</a></span>
<span class=xPageTags_item><a href=../../tags/azure-pipelines>Azure Pipelines</a></span></div></div><div style=text-align:right><div id=codoc-entry-4gYwTntzzw class=codoc-entries data-without-body=1 data-support-button-text="（っ'-')╮シュッ=͟͟͞͞ 💵" data-show-like=0 data-show-about-codoc=0 data-show-powered-by=0 data-support-message=まくに投げ銭できるよ></div></div><div class=xArticle_up><a href=../../p/3u2m6an/><span class=xArticle_up_label>Azure AppServices のメモ</span><br>へ戻る</a></div><aside><div class=xPrevNextLink><div class=xPrevNextLink_prev><a href=../../p/bog7iq8/>Azure: デプロイスロットでリリース時のダウンタイムをなくす（Blue-Green デプロイメント）</a></div><div class=xPrevNextLink_next><a href=../../p/3u4hj7h/>Azure: App Service の Node.js アプリのエントリポイントはどこで定義されているか？</a></div></div></aside></article><script async src=//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js></script>
<ins class=adsbygoogle style=display:block;text-align:center data-ad-layout=in-article data-ad-format=fluid data-ad-client=ca-pub-6317852277883092 data-ad-slot=8636867067></ins>
<script>(adsbygoogle=window.adsbygoogle||[]).push({})</script></main></div><aside><div class=xBreadcrumb><span class=xBreadcrumb_item><a href=../../>&#x1F3E0;</a></span>
<span class=xBreadcrumb_item><a href=../../p/3ftx6b2/>技術系</a></span>
<span class=xBreadcrumb_item><a href=../../p/vrhjtds/>Azure</a></span>
<span class=xBreadcrumb_item><a href=../../p/3u2m6an/>Azure AppServices のメモ</a></span>
<span class=xBreadcrumb_item>Azure: Node.js アプリを App Service へデプロイする（Kudu ビルド編）</span></div></aside><div id=xSiteFooter><a href=../../>まくろぐ</a></div><div id=xSiteFooter2><a href=../../sitemap/>サイトマップ</a> ｜
<a tatget=_blank href=https://forms.gle/xdUszEv4f5CEqH947>まくへのメッセージ</a></div></div><script>document.addEventListener("DOMContentLoaded",function(){const e=document.querySelectorAll("a[href^=http]");for(let n=0;n<e.length;++n){const t=e[n],s=t.getElementsByTagName("img");if(s.length>0)continue;const o=t.getElementsByTagName("svg");if(o.length>0)continue;t.classList.add("xExternalLinkIcon"),t.setAttribute("target","_blank"),t.setAttribute("rel","noopener")}})</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"まくろぐ","item":"https://maku.blog/"},{"@type":"ListItem","position":2,"name":"技術系","item":"https://maku.blog/p/3ftx6b2/"},{"@type":"ListItem","position":3,"name":"Azure","item":"https://maku.blog/p/vrhjtds/"},{"@type":"ListItem","position":4,"name":"Azure AppServices のメモ","item":"https://maku.blog/p/3u2m6an/"},{"@type":"ListItem","position":5,"name":"Azure: Node.js アプリを App Service へデプロイする（Kudu ビルド編）","item":"https://maku.blog/p/wx3fvib/"}]}</script></body></html>