<?xml version="1.0" encoding="utf-8" standalone="yes"?><rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom"><channel><title>Ansible 応用 on まくろぐ</title><link>https://maku.blog/p/5j4jygw/</link><description>Recent content in Ansible 応用 on まくろぐ</description><generator>Hugo -- gohugo.io</generator><language>ja-jp</language><lastBuildDate>Mon, 29 Aug 2022 00:00:00 +0000</lastBuildDate><atom:link href="https://maku.blog/p/5j4jygw/index.xml" rel="self" type="application/rss+xml"/><item><title>Ansible で facts 情報を表示する</title><link>https://maku.blog/p/zw7emu3/</link><pubDate>Mon, 29 Aug 2022 00:00:00 +0000</pubDate><guid>https://maku.blog/p/zw7emu3/</guid><description>Ansible の Playbook を実行すると、最初にリモートホストの情報 (Ansible facts) の収集が行われます。 ここには、OS の情報や IP アドレスの情報などが含まれており、タスクの中でこれらの情報を参照することができます。 実際に Ansible facts にどのような情報が含まれているかは、次のような Playbook で確認することができます。
show-facts.yml - hosts: all gather_facts: true tasks: - name: Show facts ansible.builtin.debug: var: ansible_facts 実行結果（抜粋） TASK [Show facts] ********************************* ok: [example.com] =&amp;gt; { &amp;#34;ansible_facts&amp;#34;: { &amp;#34;all_ipv4_addresses&amp;#34;: [ &amp;#34;172.xxx.xx.xx&amp;#34;, &amp;#34;160.xxx.xx.xx&amp;#34; ], &amp;#34;all_ipv6_addresses&amp;#34;: [ &amp;#34;xxxx:xxxx:xxxx:xxx:xxx:xxx:xx:xx&amp;#34;, &amp;#34;xxxx::x:xxxx:xxxx:xxxx&amp;#34; ], ... ansible_facts 変数の値がからっぽになってしまう場合は、gather_facts: false と指定していないか確認してください。
ansible_facts オブジェクトの個々のプロパティを参照するには次のようにします。
- name: Show architecture ansible.builtin.debug: msg: &amp;#34;Architecture: {{ ansible_architecture }}&amp;#34;</description></item><item><title>Ansible タスク例: Docker と Docker Compose をインストールする</title><link>https://maku.blog/p/8k4j2gw/</link><pubDate>Sun, 28 Aug 2022 00:00:00 +0000</pubDate><guid>https://maku.blog/p/8k4j2gw/</guid><description>何をするか？ 下記の Docker のインストールマニュアルに従い、Ansible で Ubuntu 22.04 に Docker の実行環境をセットアップします。
Install Docker Engine on Ubuntu | Docker Documentation Playbook の例 次の YAML ファイルは、Docker の公式サイトのインストール手順をほぼそのまま Playbook 化したものです。 この Playbook を ansible-playbook で実行することで、Docker (+ Docker Compose) のインストール、および Docker デーモンの起動まで完了します。
install-docker.yml - hosts: all gather_facts: false become: true tasks: - name: Install APT packages to use a repository over HTTPS ansible.builtin.apt: pkg: - ca-certificates - curl - gnupg - lsb-release update_cache: yes cache_valid_time: 86400 # cache for 1 day - name: Create APT&amp;#39;s keyrings directory ansible.</description></item><item><title>Docker コンテナで Ansible のテストベッド環境を用意する</title><link>https://maku.blog/p/csctaq7/</link><pubDate>Mon, 18 Jul 2022 00:00:00 +0000</pubDate><guid>https://maku.blog/p/csctaq7/</guid><description>何をするか ansible-playbook を使って何らかの Linux 環境のセットアップを自動化するとき、Playbook のテスト用に使い捨ての Docker コンテナ（テストベッド環境）があると便利です。
Ansible には、Playbook 実行後の冪等性を保つという性質がありますが、一度 Playbook を実行してしまうと元の状態に戻すことはできません。 一方通行の冪等性はあっても、可逆性はないということですね。 Playbook を試行錯誤して作っている段階では、何度も ansible-playbook を実行することになるので、本当にその Playbook がまっさらな状態の OS に対して適用できるのか不安になってきます（冪等性があるので理論的には動作するはずですが）。 異なるディストリビューションに対して実行できるのか試したくなることもあります。
ここでは、Ansible のテストベッド環境として Docker コンテナを作成し、各種 Ansible コマンド (ansible / ansible-playbook) で制御してみます。
テストベッド用のコンテナを起動する Ansible は一般的にはマネージドノードに SSH 接続して Playbook を実行しますが、実は Docker コンテナに直接接続することもできます。 つまり、テストベッド用の Docker コンテナには、sshd (OpenSSH) などのサービスをわざわざインストールする必要はありません。
ただし、Ansible マネージドノードの要件として、Python3 だけはインストールしておく必要があります。 次の Dockerfile では、Ubuntu を親イメージとして、Python3 だけ追加しています。
Dockerfile FROM ubuntu:22.04 # Python3 のインストール RUN apt update &amp;amp;&amp;amp; apt install --no-install-recommends -y python3 Dockerfile をビルドして、testbed イメージを作成します。</description></item><item><title>Docker で Ansible の実行環境用のコンテナを作成する</title><link>https://maku.blog/p/euevcs8/</link><pubDate>Sat, 02 Jul 2022 00:00:00 +0000</pubDate><guid>https://maku.blog/p/euevcs8/</guid><description>何をするか？ Ansible の実行環境は Python がインストールされている環境であれば比較的簡単にインストールできますが、Docker の実行環境があれば、ホスト環境に何もインストールせずに Ansible の実行環境を手に入れることができます（もちろんコンテナは作る必要はありますが）。
Docker Hub を見ると、Alpine Linux ベースの Ansible 実行環境用イメージ alpine/ansible があるようですが、ここでは Dockerfile を使って自分でイメージを作成することにします。
Ansible 実行環境用イメージを作成する Dockerfile で Alpine Linux ベースの Ansible 実行環境を定義します。
Dockerfile FROM alpine:3 WORKDIR /app # --no-cache を付けることで /var/cache/apk 以下にキャッシュが残るのを防ぐ # --update-cache を付けることで先に apk update するのと同じ効果になる RUN apk --no-cache --update-cache add ansible openssh sshpass APK (Alpine Package Keeper) で次のようなパッケージをインストールしています。
ansible &amp;hellip; Ansible Community パッケージ（ansible コマンドや ansible-playbook コマンドなど） openssh &amp;hellip; ssh コマンドのため sshpass &amp;hellip; ターゲットホストにパスワード認証 (--ask-pass) で接続するときのため Ansible Community パッケージ (ansible) ではなく、Ansible Core (ansible-core) を使うようにすれば、イメージサイズは 500MB 弱から 80MB 程度に削減できますが、サイズを気にしなくてよいなら Ansible Community パッケージを使っておいた方が楽です。</description></item></channel></rss>