<?xml version="1.0" encoding="utf-8" standalone="yes"?><rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom"><channel><title>Azure on まくろぐ</title><link>https://maku.blog/tags/azure/</link><description>Recent content in Azure on まくろぐ</description><generator>Hugo</generator><language>ja-jp</language><lastBuildDate>Sat, 12 Jun 2021 00:00:00 +0900</lastBuildDate><atom:link href="https://maku.blog/tags/azure/index.xml" rel="self" type="application/rss+xml"/><item><title>Azure のストレージアカウントを作成する</title><link>https://maku.blog/p/7axgzfu/</link><pubDate>Tue, 17 Mar 2020 00:00:00 +0900</pubDate><guid>https://maku.blog/p/7axgzfu/</guid><description>&lt;p>Table Storage などのストレージ系サービスを使用するには、&lt;a href="https://portal.azure.com/">Azure ポータル&lt;/a> から &lt;strong>ストレージアカウント&lt;/strong> を作成しておく必要があります。
このトレージアカウントは Table Storage 専用ではなく、様々なストレージサービス（BLOB、ファイル、キュー、テーブル）をまとめて扱うものです。&lt;/p>
&lt;p>&lt;code>ストレージアカウント&lt;/code> → &lt;code>作成&lt;/code> のような感じで進めば作成用の画面が開くので、ストレージアカウント名などを入力します。
ストレージアカウント名は、Azure 内で一意（要するに世界中で一意）な名前を付ける必要があります。&lt;/p>


&lt;figure class="xImage">
 &lt;img style="border: solid #ccc 2px;" width="450" height="420" src="../../p/7axgzfu/img-create-account_hu2672013604081069431.png" alt="/p/7axgzfu/img-create-account.png" />
&lt;/figure>

&lt;p>選択項目によっては、料金が変わってくるものがあるので、情報アイコンの説明を見ながら、安いプランを選択していきます。
例えば、Table Storage のレプリケーションの種類別価格は次のようになっています（&lt;a href="https://azure.microsoft.com/ja-jp/pricing/details/storage/tables/">こちら&lt;/a>から抜粋）。&lt;/p>


&lt;figure class="xImage">
 &lt;img style="" width="901" height="141" src="../../p/7axgzfu/img-price.png" alt="/p/7axgzfu/img-price.png" />
 &lt;figcaption>図: Table Storage の月額&lt;/figcaption>
&lt;/figure>

&lt;p>入力が終わったら、&lt;code>作成&lt;/code> のボタンを押して、しばらく待てばストレージアカウントが作成されます（1分くらいかかります）。&lt;/p></description></item><item><title>Azure DevOps で無料のプライベート Git リポジトリ (Repos) を使用する</title><link>https://maku.blog/p/qt5qyzu/</link><pubDate>Mon, 30 Sep 2019 00:00:00 +0900</pubDate><guid>https://maku.blog/p/qt5qyzu/</guid><description>&lt;h2 id="azure-devops-について">Azure DevOps について&lt;/h2>


&lt;figure class="xImage">
 &lt;img style="border: solid #ccc 2px;" width="600" height="284" src="../../p/qt5qyzu/repos-001_hu1334722932766476535.png" alt="/p/qt5qyzu/repos-001.png" />
&lt;/figure>

&lt;p>GitHub は Microsoft によって買収されましたが、&lt;strong>Azure ブランドの DevOps サービスでも Git リポジトリを扱う Repos という機能が提供されています&lt;/strong>。
GitHub は 2019 年から無制限に Private リポジトリを作成できるようになりましたが、Azure DevOps の方も無制限に Private リポジトリを作成することができ、5 ユーザーまでのコラボレーションが無料です（GitHub は 3 ユーザーまで）。
DevOps の Repos でも、GitHub のようにプルリクエストを使ったレビューを行えます。&lt;/p>
&lt;p>さらに、&lt;strong>DevOps には Pipelines という、継続的インテグレーション/継続的デリバリー (CI/CD) の機能も含まれており&lt;/strong>、こちらも毎月 1,800 分の実行まで無料で使用できます。
GitHub Actions なども同じような機能を提供する予定であり、これから Azure DevOps とどのような関係で進化していくのかわかりませんが、現状では Azure DevOps は魅力的な選択肢と言えそうです。&lt;/p>
&lt;h2 id="azure-devops-の-git-リポジトリ-repos-を使用する">Azure DevOps の Git リポジトリ (Repos) を使用する&lt;/h2>
&lt;p>DevOps で Git リポジトリを作成する場合、まずは DevOps のプロジェクトを作成し、その中に Git リポジトリを作成していくという構成になります。
1 つの DevOps プロジェクトには、いくつでも Git リポジトリを作成できます。&lt;/p></description></item><item><title>Azure Functions で簡単な関数を作ってみる</title><link>https://maku.blog/p/vgt5g7f/</link><pubDate>Sun, 16 Aug 2020 00:00:00 +0900</pubDate><guid>https://maku.blog/p/vgt5g7f/</guid><description>&lt;figure class="xImage">
 &lt;img style="" width="1752" height="576" src="../../p/vgt5g7f/img-001.png" alt="/p/vgt5g7f/img-001.png" />
&lt;/figure>

&lt;p>Azure Functions を使うと、Web API 的なものを、サーバーの存在を意識せずに作成することができます。
ここでは、最初のステップとして、HTTP リクエストで送ったメッセージをオウム返しするだけの簡単な関数を作ってみます。&lt;/p>
&lt;h2 id="functions-アプリを新規作成する">Functions アプリを新規作成する&lt;/h2>
&lt;p>新しい Functions アプリを作成するには、&lt;a href="https://portal.azure.com/#create/hub">Azure ポータルのリソースの作成画面&lt;/a> から、&lt;strong>Functions App（関数アプリ）&lt;/strong> を選択します。
Azure のアカウントがない場合は先に作成する必要があります。&lt;/p>
&lt;p>画面に従って入力していけば作成できますが、いくつかポイントがあるので説明しておきます。&lt;/p>
&lt;ul>
&lt;li>基本タブ
&lt;ul>
&lt;li>&lt;b>関数アプリ名&lt;/b>
 &amp;hellip; 任意のアプリ名を付けることができますが、&lt;code>&amp;lt;アプリ名&amp;gt;.azurewebsites.net&lt;/code> というアドレスが割り当てられるので、世界で一意な名前を指定する必要があります。&lt;/li>
&lt;li>&lt;b>ランタイムスタック&lt;/b>
 &amp;hellip; 関数の実装に使用する言語を選択します。JavaScript で記述するなら &lt;code>Node.js&lt;/code>、C# で実装するなら &lt;code>.NET Core&lt;/code> を選択しておきます。&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>ホスティングタブ
&lt;ul>
&lt;li>&lt;b>プランの種類&lt;/b>
 &amp;hellip; 今回のテストのように、ときどき実行するだけなら &lt;code>消費量（サーバーレス）&lt;/code> を選択しておきます。&lt;code>App Service プラン&lt;/code> は常時起動型の VM でホスティングするもので、ほとんど関数呼び出ししなくても月額数千円はかかってしまうので、最初は避けておくのが無難です。ただし、すでに他の Web サーバに App Service リソースを使用しているのであれば、そちらに相乗りしてホスティングすることが可能です。&lt;/li>
&lt;/ul>
&lt;/li>
&lt;/ul>
&lt;p>最後に &lt;code>作成&lt;/code> ボタンを押せば、数分で Functions のリソース作成が完了します。&lt;/p>
&lt;h2 id="functions-アプリに関数を追加する">Functions アプリに関数を追加する&lt;/h2>


&lt;figure class="xImage">
 &lt;img style="border: solid #ccc 2px;" width="1848" height="928" src="../../p/vgt5g7f/img-002.png" alt="/p/vgt5g7f/img-002.png" />
&lt;/figure>

&lt;p>Functions リソースに新しい関数を追加するには、&lt;strong>&lt;code>関数&lt;/code>&lt;/strong> → &lt;strong>&lt;code>追加&lt;/code>&lt;/strong> と選択します。
ここでは HTTP リクエストにより関数を実行するので、&lt;strong>&lt;code>HTTP trigger&lt;/code>&lt;/strong> を選択します。&lt;/p></description></item><item><title>逆引き Azure CLI: Azure CLI（az コマンド）をインストールする</title><link>https://maku.blog/p/dwsog4p/</link><pubDate>Tue, 17 Mar 2020 00:00:00 +0900</pubDate><guid>https://maku.blog/p/dwsog4p/</guid><description>&lt;p>Azure CLI をインストールすると、&lt;strong>&lt;code>az&lt;/code>&lt;/strong> コマンドを使用して、Azure の様々な機能を呼び出すことができるようになります。
&lt;a href="https://portal.azure.com/">Azure ポータル&lt;/a> 上で実行できることは、ほとんど &lt;code>az&lt;/code> コマンドでも実行できるようになっています。&lt;/p>
&lt;p>Azure CLI は下記のサイトに従ってインストールします（インストーラを実行するだけです）。&lt;/p>
&lt;ul>
&lt;li>&lt;a href="https://docs.microsoft.com/ja-jp/cli/azure/?view=azure-cli-latest">Azure コマンドラインインターフェイス (CLI)&lt;/a>&lt;/li>
&lt;/ul>
&lt;p>実際には、Azure ポータル上で実行してしまった方が手軽なことが多いのですが、スクリプトなどで処理を自動化したい場合は Azure CLI を使うことになります。&lt;/p></description></item><item><title>Azure Pipelines の使い方 (Hello World)</title><link>https://maku.blog/p/vxoctbs/</link><pubDate>Wed, 25 Mar 2020 00:00:00 +0900</pubDate><guid>https://maku.blog/p/vxoctbs/</guid><description>&lt;p>ここでは、Azure Pipelines の Hello World として、任意の GitHub リポジトリへ git push したときのビルド処理を自動化してみます。
ビルド処理は、Hello World らしく、&lt;code>echo Hello, world!&lt;/code> を実行するだけにしておきます。&lt;/p>
&lt;h2 id="devops-organization-を作成する">DevOps organization を作成する&lt;/h2>
&lt;p>Azure Pipelines は、Azure DevOps の中の 1 サービスであり、まず最初に Azure DevOps の organization（組織）を作成する必要があります。
Azure アカウント上でまだ DevOps organization を作成していない場合は、下記 URL にアクセスすることで作成することができます。&lt;/p>
&lt;ul>
&lt;li>&lt;a href="https://dev.azure.com/">https://dev.azure.com/&lt;/a>&lt;/li>
&lt;/ul>
&lt;p>DevOps organization の構成は次のようになっており、organization 以下に複数のプロジェクトを作成することができます。
各プロジェクトには、複数の Repos（Gitリポジトリ）や Pipelines (CI/CDの仕組み) を設定することができます。&lt;/p>
&lt;pre tabindex="0">&lt;code>+ Azure DevOps organization
 + Project
 - Repos (Gitリポジトリ）
 - Pipelines (CI/CDの仕組み)
 - Boards（かんばん、バックログ管理など）
 - ...
 + Project
 - Repos
 - Pipelines
 - Boards
 - ...
&lt;/code>&lt;/pre>&lt;p>DevOps organization の作成が完了すると、その organization のポータルサイトには、次のような URL でアクセスできるようになります。&lt;/p></description></item><item><title>逆引き Azure CLI: Azure にログインする (az login)</title><link>https://maku.blog/p/ejar7k8/</link><pubDate>Tue, 17 Mar 2020 00:00:00 +0900</pubDate><guid>https://maku.blog/p/ejar7k8/</guid><description>&lt;p>&lt;strong>&lt;code>az login&lt;/code>&lt;/strong> コマンドを使って Azure にログインすると、Azure アカウントに紐づいた情報（サブスクリプション情報など）を取得できるようになります。&lt;/p>
&lt;p>パラメータなしで実行してブラウザ上で認証することもできるし、コマンドラインからユーザ名とパスワードを指定することもできます。&lt;/p>

&lt;figure class="xCodeBlock">
&lt;figcaption class="xCodeBlock_title">ブラウザを起動して認証&lt;/figcaption>
&lt;div class="xCodeBlock_code">&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-plain" data-lang="plain">&lt;span class="line">&lt;span class="cl">$ az login&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/div>
&lt;/figure>


&lt;figure class="xCodeBlock">
&lt;figcaption class="xCodeBlock_title">ユーザー名をパラメータで指定&lt;/figcaption>
&lt;div class="xCodeBlock_code">&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-plain" data-lang="plain">&lt;span class="line">&lt;span class="cl">$ az login -u yourname@example.com
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Password: ********&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/div>
&lt;/figure>


&lt;figure class="xCodeBlock">
&lt;figcaption class="xCodeBlock_title">ユーザー名とパスワードをパラメータで指定&lt;/figcaption>
&lt;div class="xCodeBlock_code">&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-plain" data-lang="plain">&lt;span class="line">&lt;span class="cl">$ az login -u yourname@example.com -p yourpass&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/div>
&lt;/figure>

&lt;p>ログインが成功すると、&lt;strong>&lt;code>az account show&lt;/code>&lt;/strong> コマンドで、使用しているサブスクリプションの情報を確認できるようになります。&lt;/p>

&lt;figure class="xCodeBlock">

&lt;div class="xCodeBlock_code">&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-plain" data-lang="plain">&lt;span class="line">&lt;span class="cl">$ az account show
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">{
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &amp;#34;environmentName&amp;#34;: &amp;#34;AzureCloud&amp;#34;,
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &amp;#34;homeTenantId&amp;#34;: &amp;#34;b431a0d2-3656-ed42-9497-c0dfd20ae040&amp;#34;,
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &amp;#34;id&amp;#34;: &amp;#34;343f3fd9-1f19-1d49-7b92-5f365bbc6fd6&amp;#34;,
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &amp;#34;isDefault&amp;#34;: true,
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &amp;#34;managedByTenants&amp;#34;: [],
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &amp;#34;name&amp;#34;: &amp;#34;従量課金&amp;#34;,
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &amp;#34;state&amp;#34;: &amp;#34;Enabled&amp;#34;,
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &amp;#34;tenantId&amp;#34;: &amp;#34;b431a0d2-3656-ed42-9497-c0dfd20ae040&amp;#34;,
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &amp;#34;user&amp;#34;: {
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &amp;#34;name&amp;#34;: &amp;#34;yourname@example.com&amp;#34;,
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &amp;#34;type&amp;#34;: &amp;#34;user&amp;#34;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> }
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">}&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/div>
&lt;/figure></description></item><item><title>Azure Cosmos DB にアカウントを作って MongoDB API でアクセスする</title><link>https://maku.blog/p/cd9bg3x/</link><pubDate>Tue, 21 May 2019 00:00:00 +0900</pubDate><guid>https://maku.blog/p/cd9bg3x/</guid><description>&lt;h2 id="azure-cosmos-db-と-mongodb-api">Azure Cosmos DB と MongoDB API&lt;/h2>
&lt;p>Azure Cosmos DB は、Microsoft の Azure 上に配置できるスケーラブルなデータベースで、&lt;strong>SQL や MongoDB API など様々なインタフェースでアクセスできる&lt;/strong>ようになっています。&lt;/p>
&lt;p>MongoDB を使った既存のアプリケーションがある場合、接続先を Azure Cosmos DB アカウントのアドレスに変更するだけで、簡単にクラウド上のデータを扱えるようになります。
ローカルの MongoDB サーバ (&lt;code>mongod&lt;/code>) に接続する代わりに、Azure Cosmos DB に接続するということです。&lt;/p>
&lt;p>ここでは、MongoDB API（MongoDB シェル）による Azure Cosmos DB へのアクセスを試してみます。
まずは、Azure 上に Cosmos DB のリソースを作成します。&lt;/p>
&lt;h2 id="azure-cosmos-db-アカウントを作成する">Azure Cosmos DB アカウントを作成する&lt;/h2>
&lt;p>&lt;a href="https://portal.azure.com/">Azure ポータル&lt;/a>へログインし、&lt;samp>Azure Cosmos DB&lt;/samp> のページを開き、&lt;samp>Azure Cosmos DB アカウントの作成&lt;/samp> をクリックします。&lt;/p>


&lt;figure class="xImage">
 &lt;img style="border: solid #ccc 2px;" width="700" height="540" src="../../p/cd9bg3x/cosmos-account-001_hu12261836377971598877.png" alt="/p/cd9bg3x/cosmos-account-001.png" />
&lt;/figure>

&lt;p>次の画面では、&lt;samp>アカウント名&lt;/samp> や &lt;samp>API&lt;/samp> の種類を設定します。&lt;/p>


&lt;figure class="xImage">
 &lt;img style="border: solid #ccc 2px;" width="500" height="492" src="../../p/cd9bg3x/cosmos-account-002_hu672509507542301180.png" alt="/p/cd9bg3x/cosmos-account-002.png" />
&lt;/figure>

&lt;p>&lt;samp>アカウント名&lt;/samp> に入力した値は、下記のように接続 URI の一部として使われます。
よって、この&lt;strong>アカウント名は世界中で一意&lt;/strong>である必要があります。&lt;/p></description></item><item><title>Azure Pipelines で Hugo サイトのビルド＆デプロイ</title><link>https://maku.blog/p/kevcr7m/</link><pubDate>Mon, 30 Mar 2020 00:00:00 +0900</pubDate><guid>https://maku.blog/p/kevcr7m/</guid><description>&lt;h2 id="前提知識">前提知識&lt;/h2>
&lt;p>Azure Pipelines の基本的な使い方は下記ページを参考にしてください。&lt;/p>
&lt;ul>
&lt;li>&lt;a href="../../p/vxoctbs">Azure Pipelines の使い方 (Hello World)&lt;/a>&lt;/li>
&lt;/ul>
&lt;p>hugo deploy コマンドによる Hugo サイトのデプロイについては下記ページを参考にしてください。&lt;/p>
&lt;ul>
&lt;li>&lt;a href="https://maku77.github.io/hugo/advanced/deploy.html">hugo deploy コマンドで Azure などのクラウドサービス上にデプロイする | まくまくHugo/Goノート&lt;/a>&lt;/li>
&lt;/ul>
&lt;h2 id="事前準備">事前準備&lt;/h2>
&lt;p>ここでは、Azure Pipelines の設定の説明をしますので、下記の作成・準備は終わっているものとします。&lt;/p>
&lt;ul>
&lt;li>Hugo コンテンツ用の Git リポジトリ
&lt;ul>
&lt;li>Azure Repos や GitHub の Git リポジトリに、Hugo サイトのコンテンツをコミットしてください。&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>hugo deploy コマンドのための設定
&lt;ul>
&lt;li>Hugo の設定ファイル &lt;code>config.toml&lt;/code> に、&lt;code>deployment.targets&lt;/code> などの設定をしてください。&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>Azure Pipelines の作成
&lt;ul>
&lt;li>Azure DevOps のプロジェクト内に、上記の Git リポジトリと連携する Pipelines を作成してください。&lt;/li>
&lt;/ul>
&lt;/li>
&lt;/ul>
&lt;h2 id="hugo-自動ビルドデプロイのための-azure-pipelines-設定">Hugo 自動ビルド＆デプロイのための Azure Pipelines 設定&lt;/h2>

&lt;figure class="xCodeBlock">
&lt;figcaption class="xCodeBlock_title">azure-pipelines.yml&lt;/figcaption>
&lt;div class="xCodeBlock_code">&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-yaml" data-lang="yaml">&lt;span class="line">&lt;span class="cl">&lt;span class="nt">trigger&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>- &lt;span class="l">master&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="nt">variables&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">hugo_version&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s1">&amp;#39;0.68.3&amp;#39;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="nt">pool&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">vmImage&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s1">&amp;#39;ubuntu-latest&amp;#39;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="nt">steps&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>- &lt;span class="nt">script&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">wget -O hugo.deb https://github.com/gohugoio/hugo/releases/download/v$(hugo_version)/hugo_extended_$(hugo_version)_Linux-64bit.deb&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">displayName&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s1">&amp;#39;Download Hugo $(hugo_version)&amp;#39;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>- &lt;span class="nt">script&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">sudo dpkg -i hugo.deb&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">displayName&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s1">&amp;#39;Install Hugo $(hugo_version)&amp;#39;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>- &lt;span class="nt">script&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">hugo&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">displayName&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s1">&amp;#39;Build Hugo site&amp;#39;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>- &lt;span class="nt">script&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">hugo deploy&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">displayName&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s1">&amp;#39;Deploy Hugo site&amp;#39;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">env&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">AZURE_STORAGE_ACCOUNT&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">$(AZURE_STORAGE_ACCOUNT)&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">AZURE_STORAGE_KEY&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">$(AZURE_STORAGE_KEY)&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/div>
&lt;/figure>

&lt;p>この Pipelines 設定では、下記のことを順番にシェルスクリプトで実行しています。&lt;/p></description></item><item><title>逆引き Azure CLI: プロキシ環境下で Azure CLI (az) を使用する</title><link>https://maku.blog/p/7g9seub/</link><pubDate>Tue, 17 Mar 2020 00:00:00 +0900</pubDate><guid>https://maku.blog/p/7g9seub/</guid><description>&lt;p>会社などのプロキシ環境下において &lt;code>az&lt;/code> コマンドを実行する場合は、環境変数 &lt;code>https_proxy&lt;/code> を設定しておきます。&lt;/p>

&lt;figure class="xCodeBlock">
&lt;figcaption class="xCodeBlock_title">Windows の場合&lt;/figcaption>
&lt;div class="xCodeBlock_code">&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-plain" data-lang="plain">&lt;span class="line">&lt;span class="cl">C:\&amp;gt; set https_proxy=http://proxy.example.com:8080&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/div>
&lt;/figure>


&lt;figure class="xCodeBlock">
&lt;figcaption class="xCodeBlock_title">Linux/Mac の場合&lt;/figcaption>
&lt;div class="xCodeBlock_code">&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-plain" data-lang="plain">&lt;span class="line">&lt;span class="cl">$ export https_proxy=http://proxy.example.com:8080&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/div>
&lt;/figure></description></item><item><title>Azure: Cosmos DB の SQL API をプロキシ経由で使用する</title><link>https://maku.blog/p/t8rfkjn/</link><pubDate>Thu, 05 Sep 2019 00:00:00 +0900</pubDate><guid>https://maku.blog/p/t8rfkjn/</guid><description>&lt;h2 id="参照するサンプルコード">参照するサンプルコード&lt;/h2>
&lt;p>Azure の Cosmos DB を SQL API で操作するための最初の手順は下記のドキュメントに記載されています。&lt;/p>
&lt;ul>
&lt;li>&lt;a href="https://docs.microsoft.com/ja-jp/azure/cosmos-db/create-sql-api-nodejs">クイック スタート:Azure Cosmos DB SQL API アカウントを使用して Node.js アプリを構築する&lt;/a>&lt;/li>
&lt;/ul>
&lt;p>ここに Node.js 用のサンプルコードがあり、&lt;a href="https://docs.microsoft.com/ja-jp/javascript/api/@azure/cosmos/?view=azure-node-latest">@azure/cosmos&lt;/a> パッケージが提供する &lt;a href="https://docs.microsoft.com/ja-jp/javascript/api/@azure/cosmos/cosmosclient?view=azure-node-latest">CosmosClient&lt;/a> クラスを使用したコードになっています（昔のサンプルコードでは &lt;code>documentdb&lt;/code> というライブラリを使用していたりしますが、今は Microsoft が提供する &lt;code>@azure/cosmos&lt;/code> を使用すると完結なコードを記述できます）。&lt;/p>

&lt;figure class="xCodeBlock">

&lt;div class="xCodeBlock_code">&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-js" data-lang="js">&lt;span class="line">&lt;span class="cl">&lt;span class="kr">const&lt;/span> &lt;span class="nx">CosmosClient&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nx">require&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s1">&amp;#39;@azure/cosmos&amp;#39;&lt;/span>&lt;span class="p">).&lt;/span>&lt;span class="nx">CosmosClient&lt;/span>&lt;span class="p">;&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/div>
&lt;/figure>

&lt;p>基本的には、&lt;code>config.js&lt;/code> ファイルに記述されたエンドポイントとキーを下記のような感じで設定すれば実行できるようになるのですが、&lt;/p>

&lt;figure class="xCodeBlock">
&lt;figcaption class="xCodeBlock_title">config.js&lt;/figcaption>
&lt;div class="xCodeBlock_code">&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-js" data-lang="js">&lt;span class="line">&lt;span class="cl">&lt;span class="kd">var&lt;/span> &lt;span class="nx">config&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="p">{};&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nx">config&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">endpoint&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="s1">&amp;#39;https://your-cosmosdb.documents.azure.com:443/&amp;#39;&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nx">config&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">key&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="s1">&amp;#39;9Hp4WSwgvggexAuGy4dKdl...snipped...lV9Nm44Pg8WVkH==&amp;#39;&lt;/span>&lt;span class="p">;&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/div>
&lt;/figure>

&lt;p>会社などのプロキシ環境内からだとうまく接続できず、次のような感じのエラーが発生すると思います。&lt;/p>

&lt;figure class="xCodeBlock">

&lt;div class="xCodeBlock_code">&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-plain" data-lang="plain">&lt;span class="line">&lt;span class="cl">$ node app.js
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Completed with error {&amp;#34;message&amp;#34;:&amp;#34;request to https://your-cosmosdb.documents.azure.com:443/dbs/FamilyDatabase failed, reason: connect ETIMEDOUT 123.34.56.78:443&amp;#34;,&amp;#34;type&amp;#34;:&amp;#34;system&amp;#34;,&amp;#34;errno&amp;#34;:&amp;#34;ETIMEDOUT&amp;#34;, &amp;#34;code&amp;#34;:&amp;#34;ETIMEDOUT&amp;#34;,&amp;#34;headers&amp;#34;:{&amp;#34;x-ms-throttle-retry-count&amp;#34;:0,&amp;#34;x-ms-throttle-retry-wait-time-ms&amp;#34;:0}}&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/div>
&lt;/figure>

&lt;p>&lt;code>HTTPS_PROXY&lt;/code> 環境変数を設定しても同様で効果がありません。&lt;/p>
&lt;h2 id="プロキシ経由で-cosmosclient-を使用する">プロキシ経由で CosmosClient を使用する&lt;/h2>
&lt;p>&lt;code>CosmosClient&lt;/code> クラスでの Cosmos DB へのアクセスをプロキシ経由で行うには、コンストラクタのパラメータとして渡せる &lt;a href="https://docs.microsoft.com/ja-jp/javascript/api/@azure/cosmos/cosmosclientoptions?view=azure-node-latest">CosmosClientOptions&lt;/a> の &lt;code>agent&lt;/code> プロパティを設定します。
ここでは、エージェントとして &lt;a href="https://github.com/TooTallNate/node-proxy-agent">proxy-agent&lt;/a> モジュールを使用します。&lt;/p>

&lt;figure class="xCodeBlock">
&lt;figcaption class="xCodeBlock_title">proxy-agent のインストール&lt;/figcaption>
&lt;div class="xCodeBlock_code">&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-plain" data-lang="plain">&lt;span class="line">&lt;span class="cl">$ npm install --save proxy-agent&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/div>
&lt;/figure>


&lt;figure class="xCodeBlock">
&lt;figcaption class="xCodeBlock_title">sample.js&lt;/figcaption>
&lt;div class="xCodeBlock_code">&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-js" data-lang="js">&lt;span class="line">&lt;span class="cl">&lt;span class="kr">const&lt;/span> &lt;span class="p">{&lt;/span> &lt;span class="nx">CosmosClient&lt;/span> &lt;span class="p">}&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nx">require&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s1">&amp;#39;@azure/cosmos&amp;#39;&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kr">const&lt;/span> &lt;span class="nx">ProxyAgent&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nx">require&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s1">&amp;#39;proxy-agent&amp;#39;&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">// HTTP, HTTPS, or SOCKS proxy to use
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>&lt;span class="kr">const&lt;/span> &lt;span class="nx">PROXY_URI&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="s1">&amp;#39;http://proxy.example.com:3128/&amp;#39;&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kr">const&lt;/span> &lt;span class="nx">client&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="k">new&lt;/span> &lt;span class="nx">CosmosClient&lt;/span>&lt;span class="p">({&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">endpoint&lt;/span>&lt;span class="o">:&lt;/span> &lt;span class="nx">config&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">endpoint&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">key&lt;/span>&lt;span class="o">:&lt;/span> &lt;span class="nx">config&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">key&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">agent&lt;/span>&lt;span class="o">:&lt;/span> &lt;span class="k">new&lt;/span> &lt;span class="nx">ProxyAgent&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">PROXY_URI&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">});&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/div>
&lt;/figure>

&lt;p>プロキシを使用するかどうかを簡単に切り替えられるようにするには、例えば、&lt;strong>&lt;code>AZURE_PROXY&lt;/code>&lt;/strong> 環境変数に URI がセットされていたら、それをプロキシアドレスとして使用する、というように処理を分けるとよいでしょう。&lt;/p></description></item><item><title>Azure Pipelines の Pull Request 時の起動トリガ設定</title><link>https://maku.blog/p/i6549xd/</link><pubDate>Wed, 13 May 2020 00:00:00 +0900</pubDate><guid>https://maku.blog/p/i6549xd/</guid><description>&lt;h2 id="ビルドしない">ビルドしない&lt;/h2>

&lt;figure class="xCodeBlock">
&lt;figcaption class="xCodeBlock_title">azure-pipelines.yml&lt;/figcaption>
&lt;div class="xCodeBlock_code">&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-yaml" data-lang="yaml">&lt;span class="line">&lt;span class="cl">&lt;span class="nt">trigger&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">none &lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="c"># will disable CI builds entirely&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/div>
&lt;/figure>

&lt;p>Azure Pipelines によるビルドを起動しないようにします。&lt;/p>
&lt;p>&lt;code>trigger&lt;/code> プロパティを省略すると、デフォルトですべてのブランチへのプッシュ時にビルドが走るので、ビルドしないようにするには、上記のように明示的に &lt;strong>&lt;code>none&lt;/code>&lt;/strong> 指定が必要です。
この設定を行うと、&lt;code>pr&lt;/code> プロパティの設定（後述）も無効になります（Pull Request 時もビルドは実行されない）。&lt;/p>
&lt;h2 id="master-ブランチへのプッシュ-or-マージでビルド">master ブランチへのプッシュ or マージでビルド？&lt;/h2>

&lt;figure class="xCodeBlock">
&lt;figcaption class="xCodeBlock_title">azure-pipelines.yml&lt;/figcaption>
&lt;div class="xCodeBlock_code">&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-yaml" data-lang="yaml">&lt;span class="line">&lt;span class="cl">&lt;span class="nt">trigger&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>- &lt;span class="l">master&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/div>
&lt;/figure>

&lt;p>次のように複数のブランチをビルド対象とすることもできます。&lt;/p>

&lt;figure class="xCodeBlock">

&lt;div class="xCodeBlock_code">&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-yaml" data-lang="yaml">&lt;span class="line">&lt;span class="cl">&lt;span class="nt">trigger&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>- &lt;span class="l">master&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>- &lt;span class="l">release&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/div>
&lt;/figure>

&lt;p>このように記述すると、指定したブランチへのプッシュ or マージ時にのみ Pipelines が起動しそうに見えますが、この指定だけだと、 &lt;strong>あらゆる Pull Request の作成時に Pipelines が起動します&lt;/strong>。
&lt;code>master&lt;/code> ブランチや &lt;code>release&lt;/code> ブランチをターゲットとしない Pull Request でもビルドが走ります。
なぜなら、Pull Request トリガの設定がデフォルトで次のようになっているからです。&lt;/p>

&lt;figure class="xCodeBlock">

&lt;div class="xCodeBlock_code">&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-yaml" data-lang="yaml">&lt;span class="line">&lt;span class="cl">&lt;span class="nt">pr&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">branches&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">include&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>- &lt;span class="s1">&amp;#39;*&amp;#39;&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/div>
&lt;/figure>

&lt;p>このため、一連のステップにデプロイ処理まで組み込んでいると、レビュー用に Pull Request を上げただけでデプロイまで実行されてしまうという振る舞いになります。&lt;/p>
&lt;h2 id="pull-request-時にビルドしない">Pull Request 時にビルドしない&lt;/h2>

&lt;figure class="xCodeBlock">
&lt;figcaption class="xCodeBlock_title">azure-pipelines.yml&lt;/figcaption>
&lt;div class="xCodeBlock_code">&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-yaml" data-lang="yaml">&lt;span class="line">&lt;span class="cl">&lt;span class="nt">trigger&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>- &lt;span class="l">master&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="nt">pr&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">none &lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="c"># no PR triggers&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/div>
&lt;/figure>

&lt;p>上記のように設定しておくと、Pull Request を作成したときには Pipelines は起動しなくなります。
つまり、&lt;code>master&lt;/code> ブランチへのプッシュ or マージ時のみビルドが実行されます。&lt;/p></description></item><item><title>Azure Pipelines のビルド結果を GitHub にバッジ表示する</title><link>https://maku.blog/p/teq2cmv/</link><pubDate>Fri, 10 Apr 2020 00:00:00 +0900</pubDate><guid>https://maku.blog/p/teq2cmv/</guid><description>&lt;h2 id="ステータスバッジとは">ステータスバッジとは&lt;/h2>


&lt;figure class="xImage">
 &lt;img style="border: solid #ccc 2px;" width="1484" height="466" src="../../p/teq2cmv/img-001.png" alt="/p/teq2cmv/img-001.png" />
&lt;/figure>

&lt;p>ステータスバッジというのは、GitHub プロジェクトのトップページ (&lt;code>README.md&lt;/code>) でよく見かける上のようなアイコンのことです。
ステータスバッジを貼り付けておくことで、最新のソースコードが正しくビルドできていることを一目で確認することができますし、ちゃんと開発しているんだということをアピールすることにもなります。&lt;/p>
&lt;p>Azure Pipelines のビルド結果を示すステータスバッジは、下記のように簡単に追加することができます。&lt;/p>
&lt;h2 id="azure-pipelines-のステータスバッジを表示する">Azure Pipelines のステータスバッジを表示する&lt;/h2>
&lt;p>ステータスバッジは、画像ファイルの URL の形で提供されているので、GitHub の &lt;code>README.md&lt;/code> などにその URL を貼り付けるだけで OK です。&lt;/p>


&lt;figure class="xImage">
 &lt;img style="border: solid #ccc 2px;" width="1440" height="870" src="../../p/teq2cmv/img-002.png" alt="/p/teq2cmv/img-002.png" />
&lt;/figure>

&lt;p>ステータスバッジの画像 URL を確認するには、Azure Pipelines のページを開き、右上のメニューアイコン → &lt;code>Status badge&lt;/code> と選択します。&lt;/p>


&lt;figure class="xImage">
 &lt;img style="border: solid #ccc 2px;" width="1436" height="862" src="../../p/teq2cmv/img-003.png" alt="/p/teq2cmv/img-003.png" />
&lt;/figure>

&lt;p>画像の URL と一緒に、Markdown ファイルに記述する場合のコード (Sample markdown) も表示してくれるので、GitHub のページに貼り付ける場合はそちらを使えばよいでしょう。
右側のコピーアイコンを押してクリップボードにコピーし、GitHub の &lt;code>README.md&lt;/code> ファイルに次のような感じで貼り付ければ OK です。&lt;/p>


&lt;figure class="xImage">
 &lt;img style="border: solid #ccc 2px;" width="1604" height="548" src="../../p/teq2cmv/img-004.png" alt="/p/teq2cmv/img-004.png" />
&lt;/figure>

&lt;p>これで、GitHub プロジェクトのトップページアクセスしたときに、次のようにステータスバッジが表示されるはずです。&lt;/p>


&lt;figure class="xImage">
 &lt;img style="border: solid #ccc 2px;" width="1484" height="466" src="../../p/teq2cmv/img-001.png" alt="/p/teq2cmv/img-001.png" />
&lt;/figure>

&lt;h2 id="ステータスバッジの画像が表示されないとき">ステータスバッジの画像が表示されないとき&lt;/h2>
&lt;p>Azure DevOps にサインインしていない状態で、ステータスバッジが表示されない場合は、Pipelines の設定を確認してみてください。&lt;/p></description></item><item><title>Azure Storage で静的 Web サイトをホスティングする</title><link>https://maku.blog/p/gkardu9/</link><pubDate>Tue, 17 Mar 2020 00:00:00 +0900</pubDate><guid>https://maku.blog/p/gkardu9/</guid><description>&lt;p>（Azure Storage による静的な Web サイトのホスティング機能は &lt;a href="https://azure.microsoft.com/ja-jp/blog/static-websites-on-azure-storage-now-generally-available/">2018 年末にリリース&lt;/a> されました）&lt;/p>


&lt;figure class="xImage">
 &lt;img style="border: solid #ccc 2px;" width="462" height="148" src="../../p/gkardu9/img-003.png" alt="/p/gkardu9/img-003.png" />
&lt;/figure>

&lt;h2 id="ストレージアカウントを作成するまだ作成していない場合">ストレージアカウントを作成する（まだ作成していない場合）&lt;/h2>
&lt;p>Azure 上に静的な Web サイトをホスティングするためのストレージを作成するには、ストレージアカウントが必要です。
まだ作成していない場合は、下記の手順に従ってストレージアカウントを作成してください。
静的な Web サイトをホスティングする場合は、&lt;code>アカウントの種類 (Account kind)&lt;/code> の項目で &lt;strong>&lt;code>StorageV2（汎用v2）&lt;/code>&lt;/strong> というのを選んで作成しておく必要があります。&lt;/p>
&lt;p>→ &lt;a href="../../p/7axgzfu/">Azure のストレージアカウントを作成する&lt;/a>&lt;/p>
&lt;h2 id="静的な-web-サイトを有効にする">静的な Web サイトを有効にする&lt;/h2>
&lt;p>ストレージアカウントを作成したら、コンテンツのアップロード先である Azure ストレージコンテナーと、Web サイトの URL を生成します。
といっても、ストレージアカウントがあれば、&lt;a href="https://portal.azure.com/">Azure ポータル&lt;/a> から数秒で自動作成できます。&lt;/p>


&lt;figure class="xImage">
 &lt;img style="border: solid #ccc 2px;" width="724" height="315" src="../../p/gkardu9/img-001.png" alt="/p/gkardu9/img-001.png" />
&lt;/figure>

&lt;ol>
&lt;li>ストレージアカウントのページを開き、&lt;code>設定&lt;/code> → &lt;code>静的な Web サイト&lt;/code> を選択します。&lt;/li>
&lt;li>&lt;code>静的な Web サイト&lt;/code> のスイッチを &lt;strong>&lt;code>有効&lt;/code>&lt;/strong> に切り替えて &lt;code>保存&lt;/code> ボタンを押します。&lt;/li>
&lt;/ol>
&lt;p>これで、Web サイトをホスティングするための Azure ストレージコンテナー（BLOB を入れるコンテナー）が作成されます。
コンテナー名は自動的に &lt;strong>&lt;code>$web&lt;/code>&lt;/strong> になるようです。&lt;/p>
&lt;p>同時に、Web サイトの URL も自動的に生成されます。&lt;/p>


&lt;figure class="xImage">
 &lt;img style="border: solid #ccc 2px;" width="726" height="362" src="../../p/gkardu9/img-002.png" alt="/p/gkardu9/img-002.png" />
&lt;/figure>

&lt;p>これが Web ブラウザからサイトにアクセスするときのアドレスになります。
あとは、コンテナーに HTML ファイルをアップロードするだけです。&lt;/p></description></item><item><title>逆引き Azure CLI: ストレージアカウントのキーを確認する (storage account keys list)</title><link>https://maku.blog/p/3wk5vnw/</link><pubDate>Tue, 17 Mar 2020 00:00:00 +0900</pubDate><guid>https://maku.blog/p/3wk5vnw/</guid><description>&lt;p>Azure ストレージアカウントのキー（鍵）情報を取得するには、&lt;a href="../../p/ejar7k8">Azure にログイン&lt;/a> した状態で、以下のように実行します。&lt;/p>

&lt;figure class="xCodeBlock">

&lt;div class="xCodeBlock_code">&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-plain" data-lang="plain">&lt;span class="line">&lt;span class="cl">$ az storage account keys list --account-name ストレージアカウント名
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">[
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> {
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &amp;#34;keyName&amp;#34;: &amp;#34;key1&amp;#34;,
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &amp;#34;permissions&amp;#34;: &amp;#34;Full&amp;#34;,
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &amp;#34;value&amp;#34;: &amp;#34;7s+V+j4CcwDNHyTvx7/UXlgKN4HvFoUuIhOuzH1YLaBWgVTWQadQB2vFjRPTAv2aoGP2mpyQcMm4C+R55o3N9g==&amp;#34;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> },
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> {
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &amp;#34;keyName&amp;#34;: &amp;#34;key2&amp;#34;,
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &amp;#34;permissions&amp;#34;: &amp;#34;Full&amp;#34;,
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &amp;#34;value&amp;#34;: &amp;#34;+uzKfRt3rCP7RkNBXG93lqEqD7MLvgFQmKxudWHjYbDMUeFH0VmdMhN8V/6ChCwVANi6jaDL4ZKopfwV5RjY9g==&amp;#34;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> }
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">]&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/div>
&lt;/figure>

&lt;p>このストレージアカウントキーは、&lt;code>az storage&lt;/code> コマンドを使って Azure ストレージ上のデータを操作するときに必要になります。&lt;/p>
&lt;aside style="display: flex; border: thin dashed gray;">
&lt;div style="align-self: stretch; writing-mode: vertical-lr; text-align: center; letter-spacing: 0.2em; color: #666; border-right: thin dashed gray; padding: 0.4em 0; line-height: 1.5;">参考&lt;/div>
&lt;div style="align-self: center; padding: 0.6em 0; line-height: 1.2 !important;">&lt;ul>
&lt;li>&lt;a href="../../p/ptx36ue">BLOB ストレージにファイルをアップロードする (storage blob upload)&lt;/a>&lt;/li>
&lt;/ul>
&lt;/div>
&lt;/aside></description></item><item><title>逆引き Azure CLI: ストレージアカウントの接続文字列を確認する (storage account show-connection-string)</title><link>https://maku.blog/p/hquhjki/</link><pubDate>Tue, 17 Mar 2020 00:00:00 +0900</pubDate><guid>https://maku.blog/p/hquhjki/</guid><description>&lt;p>Azure CLI で Azure ストレージアカウントの接続文字列（アカウント名とキーがペアになったもの）を取得するには、&lt;strong>&lt;code>az storage account show-connection-string&lt;/code>&lt;/strong> コマンドを使用します。&lt;/p>
&lt;p>このコマンドを実行する前に、&lt;a href="../../p/ejar7k8">az login で Azure にログイン&lt;/a> しておく必要があります。&lt;/p>

&lt;figure class="xCodeBlock">
&lt;figcaption class="xCodeBlock_title">ストレージアカウントの接続文字列を取得&lt;/figcaption>
&lt;div class="xCodeBlock_code">&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-plain" data-lang="plain">&lt;span class="line">&lt;span class="cl">$ az storage account show-connection-string --name yourstorage
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">{
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &amp;#34;connectionString&amp;#34;: &amp;#34;DefaultEndpointsProtocol=https;EndpointSuffix=core.windows.net;AccountName=yourstorage;AccountKey=7s+V+j4CcwDNHyTvxTAv2aoGP2mpyQcMm4C+R7/UXlgKN4HvFoUuIhOuzH1YLaBWgVTWQadQB2vFjRP55o3N9g==&amp;#34;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">}&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/div>
&lt;/figure>

&lt;aside style="display: flex; border: thin dashed gray;">
&lt;div style="align-self: stretch; writing-mode: vertical-lr; text-align: center; letter-spacing: 0.2em; color: #666; border-right: thin dashed gray; padding: 0.4em 0; line-height: 1.5;">参考&lt;/div>
&lt;div style="align-self: center; padding: 0.6em 0; line-height: 1.2 !important;">&lt;ul>
&lt;li>&lt;a href="https://docs.microsoft.com/en-us/cli/azure/storage/account?view=azure-cli-latest#az-storage-account-show-connection-string">az storage account show-connection-string コマンド&lt;/a>&lt;/li>
&lt;/ul>
&lt;/div>
&lt;/aside></description></item><item><title>逆引き Azure CLI: Azure ストレージの SAS トークンを生成する (storage container generate-sas)</title><link>https://maku.blog/p/n4yqdys/</link><pubDate>Tue, 17 Mar 2020 00:00:00 +0900</pubDate><guid>https://maku.blog/p/n4yqdys/</guid><description>&lt;p>Azure ストレージの操作を行うとき、有効期限付きのアクセストークンである &lt;strong>SAS トークン&lt;/strong> が必要になることがあります。
SAS トークンは、&lt;strong>&lt;code>az storage container generate-sas&lt;/code>&lt;/strong> コマンドで生成することができます。&lt;/p>

&lt;figure class="xCodeBlock">
&lt;figcaption class="xCodeBlock_title">実際は 1 行&lt;/figcaption>
&lt;div class="xCodeBlock_code">&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-plain" data-lang="plain">&lt;span class="line">&lt;span class="cl">$ az storage container generate-sas
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> --name &amp;lt;BLOBコンテナー名&amp;gt;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> --expiry &amp;#34;2020-07-07T00:00:00Z&amp;#34;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> --permission acdlrw
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> --connection-string &amp;lt;ストレージアカウントの接続文字列&amp;gt;&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/div>
&lt;/figure>

&lt;p>&lt;a href="../../p/dofzeua/">ストレージアカウントの接続文字列&lt;/a>さえあれば、特に Azure ログインしたりせずに生成できます。
&lt;a href="../../p/hquhjki">接続文字列自体を Azure CLI で取得する&lt;/a>こともできます。&lt;/p>
&lt;p>SAS トークン生成時に指定するオプションの詳細は下記のコマンドリファレンスを参照してください。&lt;/p>
&lt;ul>
&lt;li>参考: &lt;a href="https://docs.microsoft.com/en-us/cli/azure/storage/container?view=azure-cli-latest#az-storage-container-generate-sas">az storage container generate-sas コマンド&lt;/a>&lt;/li>
&lt;/ul>
&lt;p>実行に成功すると、次のような文字列が標準出力に出力されます。
これが SAS トークンです。&lt;/p>

&lt;figure class="xCodeBlock">

&lt;div class="xCodeBlock_code">&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-plain" data-lang="plain">&lt;span class="line">&lt;span class="cl">&amp;#34;se=2020-07-07T00%3A00%3A00Z&amp;amp;sp=racwdl&amp;amp;sv=2018-11-09&amp;amp;sr=c&amp;amp;sig=c7bapOBvLkHVlebBIEQFQc2bGd%2BjmfScqKCbkLUzzoo%3D&amp;#34;&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/div>
&lt;/figure>

&lt;p>この SAS トークンは、AzCopy (&lt;code>azcopy&lt;/code>) ツールなどで、&lt;a href="../../p/gkardu9">BLOB ストレージにファイル転送&lt;/a>したりするときに必要になります。&lt;/p>
&lt;p>SAS トークンの生成には、有効期限を示す &lt;code>--expiry&lt;/code> オプションの指定が必須になっています（なくてもトークンの生成には成功しますが、使用時に認証エラーになるようです。不親切）。
ここで指定する日時のフォーマットは、少しでも間違えると出力される SAS トークンの &lt;code>se&lt;/code> パラメータが無効なものになってしまうので要注意です（こちらも生成時にはエラーになりません。不親切）。&lt;/p>
&lt;p>生成される SAS トークンの最後には、このトークン自体の署名がついています。
これにより、SAS トークン内の有効期限 (&lt;code>se&lt;/code>) などを部分的に改ざんしたりできないようになっています。&lt;/p></description></item><item><title>逆引き Azure CLI: BLOB ストレージにファイルをアップロードする (storage blob upload)</title><link>https://maku.blog/p/ptx36ue/</link><pubDate>Tue, 17 Mar 2020 00:00:00 +0900</pubDate><guid>https://maku.blog/p/ptx36ue/</guid><description>&lt;p>Azure CLI を使ってストレージアカウント上に作成された、既存の BLOB コンテナにコンテンツをアップロードするには、&lt;strong>&lt;code>az storage blob upload&lt;/code>&lt;/strong> コマンドを使用します。
Azure ポータルのサイト上でポチポチやってアップロードすることもできますが、自動化のことを考えると、コマンドラインを使った方がよいでしょう。&lt;/p>

&lt;figure class="xCodeBlock">
&lt;figcaption class="xCodeBlock_title">書式&lt;/figcaption>
&lt;div class="xCodeBlock_code">&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-plain" data-lang="plain">&lt;span class="line">&lt;span class="cl">az storage blob upload --account-name &amp;lt;ストレージアカウント名&amp;gt; --account-key &amp;lt;キー&amp;gt; -c &amp;lt;コンテナ名&amp;gt; --file &amp;lt;ローカルファイル名&amp;gt; --name &amp;lt;アップロード後のファイル名&amp;gt;&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/div>
&lt;/figure>


&lt;figure class="xCodeBlock">
&lt;figcaption class="xCodeBlock_title">実行例&lt;/figcaption>
&lt;div class="xCodeBlock_code">&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-plain" data-lang="plain">&lt;span class="line">&lt;span class="cl">$ az storage blob upload --account-name yourstorage --account-key vFjRP7s+V+j4CcwDNHyTvxT7/UXlgKN4HvFoUuIhOuzH1YLaBWgVTWQadQB2Av2aoGP2mpyQcMm4C+R55o3N9g== -c $web --file index.html --name index.html
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Finished[#############################################################] 100.0000%
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">{
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &amp;#34;etag&amp;#34;: &amp;#34;\&amp;#34;0x8D7CA465578BC90\&amp;#34;&amp;#34;,
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &amp;#34;lastModified&amp;#34;: &amp;#34;2020-03-17T07:39:32+00:00&amp;#34;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">}&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/div>
&lt;/figure>

&lt;p>アップロード時にストレージアカウントのキーを指定するので、あらかじめ &lt;code>az login&lt;/code> で Azure にログインしておく必要はありません。&lt;/p>
&lt;aside style="display: flex; border: thin dashed gray;">
&lt;div style="align-self: stretch; writing-mode: vertical-lr; text-align: center; letter-spacing: 0.2em; color: #666; border-right: thin dashed gray; padding: 0.4em 0; line-height: 1.5;">参考&lt;/div>
&lt;div style="align-self: center; padding: 0.6em 0; line-height: 1.2 !important;">&lt;ul>
&lt;li>&lt;a href="../../p/3wk5vnw">逆引き Azure CLI: ストレージアカウントのキーを確認する (storage account keys list)&lt;/a>&lt;/li>
&lt;/ul>
&lt;/div>
&lt;/aside></description></item><item><title>チャットボット (1-1) Bot Builder SDK とは</title><link>https://maku.blog/p/tzaeb9x/</link><pubDate>Mon, 04 Mar 2019 00:00:00 +0900</pubDate><guid>https://maku.blog/p/tzaeb9x/</guid><description>&lt;p>Microsoft の Azure は Chatbot サービスを作成する機能を提供しています。
Microsoft が提供している Bot Framework は、この Chatbot サービスを作成するとき、あるいは Chatbot を使用するクライアントを作成するときに使用するツール群（あるいは仕組み）やそれらを取り巻く環境の総称です。&lt;/p>


&lt;figure class="xImage">
 &lt;img style="border: solid #ccc 2px;" width="500" height="272" src="../../p/tzaeb9x/about_hu15088989431302236182.png" alt="/p/tzaeb9x/about.png" />
&lt;/figure>

&lt;ul>
&lt;li>&lt;a href="https://dev.botframework.com/">Microsoft Bot Framework&lt;/a>&lt;/li>
&lt;/ul>
&lt;p>ボットのサーバを実装するためのライブラリは、&lt;strong>Bot Builder SDK&lt;/strong> という名前で提供されています。
現状では、ボットは Node.js と .NET による開発が想定されているため、Bot Builder SDK も Node.js と .NET 用のものが提供されています（2019年3月現在、Python と Java 版が preview リリースされているようです）。&lt;/p>
&lt;ul>
&lt;li>&lt;a href="https://github.com/microsoft/botbuilder-js">Bot Builder SDK (for Node.js)&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://github.com/Microsoft/botbuilder-dotnet">Bot Builder SDK (for .Net)&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://github.com/microsoft/botbuilder-samples">Bot Builder サンプルコード集&lt;/a>&lt;/li>
&lt;/ul>
&lt;p>Node.js と .NET のどちらを使って開発するかに迷ったら、非同期処理を前提にして設計されている Node.js 版を選択するのがよいでしょう。&lt;/p>
&lt;p>Node.js の Bot Builder SDK は、NPM パッケージとして公開されているため、&lt;code>npm&lt;/code> コマンドを使って簡単にインストールすることができます。&lt;/p></description></item><item><title>チャットボット (1-2) Bot Builder SDK で Echo ボットを作成する</title><link>https://maku.blog/p/you6q5r/</link><pubDate>Mon, 04 Mar 2019 00:00:00 +0900</pubDate><guid>https://maku.blog/p/you6q5r/</guid><description>&lt;p>ここでは、Microsoft の &lt;strong>Bot Builder SDK&lt;/strong> を使ったボット作成のファーストステップとして、チャットクライアントから入力されたテキストをそのままオウム返しするだけの Echo ボットを作成します。
言語としては JavaScript (Node.js) を使用することにします。&lt;/p>
&lt;p>ここで作成するのはボットの本体（サービス側）で、クライアントとしては Microsoft が提供している &lt;strong>Bot Framework Emulator&lt;/strong> を使用します。&lt;/p>
&lt;h2 id="bot-builder-sdk-をインストールする">Bot Builder SDK をインストールする&lt;/h2>
&lt;p>Node.js 版の Bot Builder SDK（&lt;strong>&lt;code>botbuilder&lt;/code>&lt;/strong> パッケージ）は、&lt;code>npm&lt;/code> コマンドを使ってインストールすることができます。
パッケージの依存関係を管理するための &lt;code>package.json&lt;/code> ファイルも、&lt;code>npm init&lt;/code> コマンドで作成しておきます。&lt;/p>
&lt;pre tabindex="0">&lt;code>$ mkdir mybot
$ cd mybot
$ npm init -y
$ npm install --save botbuilder@4.x
&lt;/code>&lt;/pre>&lt;p>Bot Service のインタフェースは REST API として提供することが定められているのですが、Bot Builder SDK には REST API サーバを作成する機能は含まれていません。
そこで、REST API サーバを作成するための &lt;strong>&lt;code>restify&lt;/code>&lt;/strong> パッケージも一緒にインストールしておきます（&lt;code>express&lt;/code> などでも実装できると思いますが、リファレンス実装では &lt;code>restify&lt;/code> が使用されています）。&lt;/p>
&lt;pre tabindex="0">&lt;code>$ npm install --save restity
&lt;/code>&lt;/pre>&lt;h2 id="echo-ボットの作成">Echo ボットの作成&lt;/h2>
&lt;p>下記の実装は、&lt;code>http://localhost:3978/api/messages&lt;/code> というアドレスで、チャットクライアントからのメッセージを待ち受けてオウム返しで応答する最低限の実装です。&lt;/p></description></item><item><title>チャットボット (2-1) Azure でボットをホストするための Web App Bot リソースを作成する</title><link>https://maku.blog/p/tttou4o/</link><pubDate>Tue, 19 Mar 2019 00:00:00 +0900</pubDate><guid>https://maku.blog/p/tttou4o/</guid><description>&lt;h2 id="web-app-bot-リソースを作成する">Web App Bot リソースを作成する&lt;/h2>
&lt;p>作成したボットプログラムは、Azure 上の Web App Bot リソース上で動作させることができます。
このリソースのことを特にボットサービスと呼んだりします。&lt;/p>
&lt;p>&lt;a href="https://portal.azure.com/">Azure ポータル&lt;/a> にログインし、下記のように辿ることで Web App Bot リソースの作成画面を表示できます。&lt;/p>
&lt;ol>
&lt;li>&lt;samp>＋リソースの作成&lt;/samp>&lt;/li>
&lt;li>&lt;samp>AI + Machine Learning&lt;/samp>&lt;/li>
&lt;li>&lt;samp>Web App Bot&lt;/samp>&lt;/li>
&lt;/ol>


&lt;figure class="xImage">
 &lt;img style="border: solid #ccc 2px;" width="700" height="506" src="../../p/tttou4o/create-bot-resource1_hu8920387837924275930.png" alt="/p/tttou4o/create-bot-resource1.png" />
&lt;/figure>

&lt;p>下記のような Web App Bot リソースの設定画面が表示されるので、1 つずつ入力していきます。&lt;/p>


&lt;figure class="xImage">
 &lt;img style="border: solid #ccc 2px;" width="500" height="620" src="../../p/tttou4o/create-bot-resource2_hu8796468545536802169.png" alt="/p/tttou4o/create-bot-resource2.png" />
&lt;/figure>

&lt;dl>
&lt;dt>ボット名&lt;/dt>
&lt;dd>任意のボット名称。後から自由に変更することができるので、自分のわかりやすい名前を付けておけば OK です。例: &lt;code>maku-bot&lt;/code>&lt;/dd>
&lt;dt>サブスクリプション&lt;/dt>
&lt;dd>月額の請求先となるサブスクリプションを選択します。最初の Azure トライアル期間であれば、&lt;code>Free Trial&lt;/code> などを選択できるはずです。&lt;/dd>
&lt;dt>リソースグループ&lt;/dt>
&lt;dd>この Web App Bot リソースを所属させるリソースグループを選択します。存在しない場合は &lt;samp>新規作成&lt;/samp> のリンクをクリックして新しく作成します。&lt;/dd>
&lt;dt>場所&lt;/dt>
&lt;dd>リソースグループの場所を選択。ここでは、地理的に近い &lt;code>Japan East&lt;/code> を選択してます。&lt;/dd>
&lt;dt>価格レベル&lt;/dt>
&lt;dd>チャンネルに応じたメッセージ制限解除のためのプラン設定です。
スタンダードチャンネル（Skype、Cortana、Teams、Facebook、Slack などの一般的なクライアント）とのやりとりは無制限なので、&lt;strong>通常は F0 の無料プランを選択しておけば OK&lt;/strong> です。
一方で、プレミアムチャンネル（ユーザ独自のチャンネルや、Web ページ埋め込みチャットボットなど）と多くのメッセージをやりとりする予定がある場合は、有料の &lt;samp>S1&lt;/samp> プランを選択する必要があります。
無料の &lt;samp>F0&lt;/samp> だと 1 か月に 10,000 メッセージまでの制限があります。
（参考: &lt;a href="https://azure.microsoft.com/en-us/pricing/details/bot-service/">Standard channels と Premium channels について&lt;/a>）&lt;/dd>
&lt;dt>アプリ名&lt;/dt>
&lt;dd>ボットサービスのエンドポイント URL となる &lt;code>XXX.azurewebsites.net&lt;/code> の &lt;code>XXX&lt;/code> の部分を指定します。
URL なので、&lt;strong>世界中で一意&lt;/strong>である必要があります。
アプリ名は後から変更することはできません。&lt;/dd>
&lt;dt>ボットテンプレート&lt;/dt>
&lt;dd>自動生成されるボットのソースコードの種類を選択します。ベースとする SDK バージョンや、言語を指定します。
今回は、最もシンプルな構成になるように、&lt;samp>SDK v4&lt;/samp>、&lt;samp>Node.js&lt;/samp>、&lt;samp>Echo Bot&lt;/samp> と選択しています。&lt;/dd>
&lt;dt>App Service プラン&lt;/dt>
&lt;dd>&lt;strong>めっちゃ重要。&lt;/strong>
App Service プランは、ボットを稼働させるために使用するコンピューティングリソース (VM) の課金プランです。
&lt;strong>サーバ使用料&lt;/strong>と言えば分りやすいかもしれません。
上記で設定した「価格レベル」はあくまでチャットのメッセージ数制限を取り払うためのプラン設定であり、サーバの代金はこちらのプランによって変化します。
QnA Maker などで App Service プランを作成している場合は、それに乗っかる形で同じものを選択することができます。
App Service プランが存在しない場合はここから新規作成することができます。
App Service プラン名は、分かりやすいように &lt;code>maku-bot-service-plan&lt;/code> のような名前を付けておくことをオススメします。
&lt;strong>デフォルトでは有料の価格レベルである &lt;code>S1 Standard&lt;/code> で作成されます。&lt;/strong>
お試しで使うのであれば、ここは無料の &lt;code>F1&lt;/code> に変更しておいた方がよいのですが、この画面からは選択できないようなので、後から &lt;samp>App Service プラン&lt;/samp>のリソースのページから価格レベルを変更しておく必要があります（後述）。これはワナかぁ～^^;&lt;/dd>
&lt;dt>Azure Storage&lt;/dt>
&lt;dd>ボットプログラムがステータスを保持するために使用するストレージを選択します。最初は&lt;samp>新規作成&lt;/samp>を選択しておけば OK です。&lt;/dd>
&lt;dt>Application Insights&lt;/dt>
&lt;dd>アプリのトラフィックなどを分析するリソースを作成するかどうか。最初は必要ないと思ったら、余計なリソースを増やさないように&lt;samp>オフ&lt;/samp>にしておけばよいです。&lt;/dd>
&lt;dt>Microsoft アプリ ID とパスワード&lt;/dt>
&lt;dd>&lt;samp>自動作成&lt;/samp>にしておけば OK。&lt;a href="https://apps.dev.microsoft.com/">Application Registration Portal&lt;/a> で別途作成したものを設定することも可能です。ちなみに、これまでに作成したアプリの ID のリストもそのサイトで確認できます。&lt;/dd>
&lt;/dl>
&lt;h2 id="app-service-プランの価格レベルを変更する">App Service プランの価格レベルを変更する&lt;/h2>
&lt;p>上記で App Service サービスプランを新規作成した場合は、価格レベルが &lt;code>S1 Standard&lt;/code> になっているので、&lt;strong>お試しで使うのであれば、忘れずにフリーの価格レベル &lt;code>F1 Free&lt;/code> に変更しておきましょう&lt;/strong>。&lt;/p></description></item><item><title>チャットボット (2-2) Web App Bot で生成されたボットのコードを編集する</title><link>https://maku.blog/p/bpqkm2o/</link><pubDate>Wed, 20 Mar 2019 00:00:00 +0900</pubDate><guid>https://maku.blog/p/bpqkm2o/</guid><description>&lt;h2 id="チャットボットのソースコードをダウンロードする">チャットボットのソースコードをダウンロードする&lt;/h2>
&lt;p>下記のページの手順に従い、&lt;a href="https://portal.azure.com/">Azure ポータル&lt;/a>上で Web App Bot のリソースを作成すると、自動的に Echo Bot のテンプレートコードが生成されているはずです（選択したテンプレートの種類によって変わりますが、ここでは Node.js 版の Echo Bot テンプレートを指定しているとします）。&lt;/p>
&lt;ul>
&lt;li>&lt;a href="../../p/tttou4o">Azure でボットをホストするための Web App Bot リソースを作成する&lt;/a>&lt;/li>
&lt;/ul>
&lt;p>ボットプログラムを作成する場合は、基本的にはこのテンプレートコードをベースにして修正を行っていくのがよいでしょう。
自動生成されたコードは、Azure ポータルから下記のように辿ると ZIP アーカイブでダウロードすることができます。&lt;/p>
&lt;ol>
&lt;li>&lt;samp>すべてのリソース&lt;/samp> を選択&lt;/li>
&lt;li>対象の &lt;samp>Web アプリボット&lt;/samp> リソースを選択（下記の例では &lt;code>maku-bot&lt;/code>）&lt;/li>
&lt;li>&lt;samp>ボット管理&lt;/samp> の &lt;samp>ビルド&lt;/samp> を選択&lt;/li>
&lt;li>&lt;samp>ボットのソースコードをダウンロードする&lt;/samp> のボタンをクリック&lt;/li>
&lt;/ol>


&lt;figure class="xImage">
 &lt;img style="border: solid #ccc 2px;" width="700" height="312" src="../../p/bpqkm2o/edit-bot-code1_hu5450279936211555220.png" alt="/p/bpqkm2o/edit-bot-code1.png" />
 &lt;figcaption>図: ボットコードをダウンロード&lt;/figcaption>
&lt;/figure>

&lt;h2 id="bot-ファイルの復号化暗号化">bot ファイルの復号化・暗号化&lt;/h2>
&lt;h3 id="botfilesecret-とは">botFileSecret とは&lt;/h3>
&lt;p>ダウンロードした ZIP アーカイブの中には、ボットサーバの設定ファイルである &lt;code>.bot&lt;/code> ファイルが含まれています。&lt;/p>
&lt;p>このファイルは、ローカルでボットサーバを立ち上げたり、エミュレータからそのサーバに接続するときの設定ファイルとして使用するのですが、&lt;strong>自動生成された &lt;code>.bot&lt;/code> ファイルは、接続情報などの値が暗号化されています&lt;/strong>。
&lt;strong>&lt;code>.bot&lt;/code> ファイルの復号化、および暗号化に使用されているキーのことを botFileSecret と呼びます&lt;/strong>。&lt;/p>
&lt;p>ボットサーバやエミュレータを正しく起動するためには、この botFileSecret を使って &lt;code>.bot&lt;/code> ファイルをあらかじめ復号化しておくか、環境変数などでキーを設定しておく必要があります。&lt;/p>
&lt;p>&lt;code>.bot&lt;/code> ファイルを復号化した場合は、Azure 上の Web App Bot サービスにデプロイする前に、忘れずに暗号化しておく必要があります。&lt;/p></description></item><item><title>チャットボット (2-3) Azure の Web App Bot リソースにボットをデプロイする</title><link>https://maku.blog/p/gxm9shf/</link><pubDate>Wed, 20 Mar 2019 00:00:00 +0900</pubDate><guid>https://maku.blog/p/gxm9shf/</guid><description>&lt;p>まず前提として、下記の手順により、Azure 上に Web App Bot リソースが作成済みであることとします。
ここに、ローカルで作成したボットをデプロイすることになります。&lt;/p>
&lt;ul>
&lt;li>&lt;a href="../../p/tttou4o">Azure でボットをホストするための Web App Bot リソースを作成する&lt;/a>&lt;/li>
&lt;/ul>
&lt;h2 id="web-ブラウザでデプロイする方法kudu-の-zip-deploy-ui">Web ブラウザでデプロイする方法（KUDU の Zip Deploy UI）&lt;/h2>
&lt;p>プロジェクトのファイルを ZIP ファイルとしてアーカイブし、Zip Deploy UI という Web ページにドラッグ＆ドロップでデプロイする方法です。
この Web サイトには、下記のような URL でアクセスできます。
&lt;code>&amp;lt;app_name&amp;gt;&lt;/code> の部分は、自分のボットアプリ名に置き換えてください。&lt;/p>

&lt;figure class="xCodeBlock">

&lt;div class="xCodeBlock_code">&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-plain" data-lang="plain">&lt;span class="line">&lt;span class="cl">https://&amp;lt;app_name&amp;gt;.scm.azurewebsites.net/ZipDeployUI&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/div>
&lt;/figure>



&lt;figure class="xImage">
 &lt;img style="border: solid #ccc 2px;" width="700" height="338" src="../../p/gxm9shf/deploy-bot-kudu_hu8407812475071790193.png" alt="/p/gxm9shf/deploy-bot-kudu.png" />
 &lt;figcaption>図: Web App Bot の Zip Deploy UI&lt;/figcaption>
&lt;/figure>

&lt;p>左上に表示されるロゴからも分かるように、Azure の Web App サービスでは、&lt;a href="https://github.com/projectkudu/kudu/wiki/">Kudu&lt;/a> というデプロイエンジンが使われているようですね。&lt;/p>
&lt;p>この &lt;code>/wwwroot&lt;/code> ディレクトリの内容が表示されている画面で、エクスプローラ領域に ZIP ファイルをドラッグ＆ドロップすると、ZIP ファイル内のファイルがまとめて &lt;code>/wwwroot&lt;/code> にアップロードされます。&lt;/p>


&lt;figure class="xImage">
 &lt;img style="border: solid #ccc 2px;" width="700" height="332" src="../../p/gxm9shf/deploy-bot-kudu2_hu16501140039945127296.png" alt="/p/gxm9shf/deploy-bot-kudu2.png" />
 &lt;figcaption>図: ZIP ファイルのドラッグ＆ドロップでデプロイ&lt;/figcaption>
&lt;/figure>

&lt;p>ボットプログラムのエントリポイントとなる &lt;code>bot.js&lt;/code> ファイルを編集してから ZIP 化し、デプロイすることで、ボットの動作が変わることを確認できると思います。&lt;/p></description></item><item><title>チャットボット: Azure ポータルで生成されるボットのテンプレートコードを解読＆リファクタしてみる</title><link>https://maku.blog/p/iob68qa/</link><pubDate>Tue, 26 Mar 2019 00:00:00 +0900</pubDate><guid>https://maku.blog/p/iob68qa/</guid><description>&lt;h2 id="azure-が生成するテンプレートコードを理解する">Azure が生成するテンプレートコードを理解する&lt;/h2>
&lt;p>下記の手順に従って Azure ポータル上で Web App Bot リソースを作成すると、ボットプログラムのテンプレートとして &lt;code>index.js&lt;/code> や &lt;code>bot.js&lt;/code> などのコードが自動生成されます。&lt;/p>
&lt;ul>
&lt;li>&lt;a href="../../p/tttou4o">Azure でボットをホストするための Web App Bot リソースを作成する&lt;/a>&lt;/li>
&lt;/ul>
&lt;p>ボットサーバのエントリポイントとなる &lt;code>index.js&lt;/code> には、設定情報の読み取りと Web サーバの立ち上げ処理が記述されており、&lt;code>bot.js&lt;/code> の方にはボットの応答処理を記述するようになっています。&lt;/p>
&lt;p>つまり、基本的にボットの作成者は &lt;code>bot.js&lt;/code> の方にボットのコア部分を実装していけばよいのですが、LUIS や QnA Maker などのサービスと連携する場合は、それぞれの初期化処理が必要であり、結局のところ &lt;code>index.js&lt;/code> 側の実装に関してもある程度理解しておく必要があります。&lt;/p>
&lt;p>Azure ポータルで自動生成される &lt;code>index.js&lt;/code> は決して理解しやすいものではないので（少なくとも記述時点では）、ここでは &lt;strong>&lt;code>index.js&lt;/code> の内容を理解する目的と、わかりやすくリファクタする目的を兼ねて、ボットのベースとなるコードを作成&lt;/strong>していきます。&lt;/p>
&lt;p>最終的には Azure が生成するテンプレートコードと同様の振る舞いになることを想定しています（少なくとも、環境変数の名前などは合わせておいた方がよいです）。&lt;/p>
&lt;h2 id="全体の流れ">全体の流れ&lt;/h2>
&lt;p>ボットプログラムのエントリポイントとなる &lt;code>index.js&lt;/code> では、大まかに下記のような処理を行います。&lt;/p>
&lt;ol>
&lt;li>&lt;code>.env&lt;/code> ファイルを読み込み、環境変数の情報とマージする&lt;/li>
&lt;li>1 の情報を基に、&lt;code>.bot&lt;/code> ファイルを読み込む&lt;/li>
&lt;li>2 の情報を基に、ボットサーバーを立ち上げる&lt;/li>
&lt;/ol>
&lt;p>Azure ポータルで生成されるテンプレートコードでは、上記の処理をすべて &lt;code>index.js&lt;/code> の中で行っているのですが、ここでは設定の読み込み部分と、ボットサーバの立ち上げ部分を明確に分離してみます。&lt;/p>
&lt;ol>
&lt;li>&lt;strong>&lt;code>config.js&lt;/code>&lt;/strong>: 環境変数や &lt;code>.env&lt;/code> ファイルの情報を基に、&lt;code>.bot&lt;/code> ファイルの設定を読み込む。&lt;/li>
&lt;li>&lt;strong>&lt;code>index.js&lt;/code>&lt;/strong>: 上記の設定情報を基にボットサーバを立ち上げる。&lt;/li>
&lt;/ol>
&lt;p>という感じにします。&lt;/p>
&lt;h2 id="ステップ1-環境変数あるいは-env-ファイルの読み込み-configjs">ステップ(1) 環境変数あるいは .env ファイルの読み込み (config.js)&lt;/h2>
&lt;p>ボットサーバーは、&lt;code>.bot&lt;/code> ファイルに記述された設定情報に基づいて動作します。
この &lt;code>.bot&lt;/code> ファイルを読み込むための情報（ファイルパスなど）は、環境変数や &lt;code>.env&lt;/code> ファイルに記述されているため、まずはこれらを読み込まなければいけません。&lt;/p></description></item><item><title>チャットボット: MS Bot Framework の .bot ファイルで接続情報を管理する</title><link>https://maku.blog/p/8choj4w/</link><pubDate>Wed, 03 Apr 2019 00:00:00 +0900</pubDate><guid>https://maku.blog/p/8choj4w/</guid><description>&lt;h2 id="エミュレータのための-bot-ファイル">エミュレータのための .bot ファイル&lt;/h2>
&lt;p>&lt;a href="https://github.com/Microsoft/BotFramework-Emulator">Bot Framework Emulator&lt;/a> は、自分自身（チャットクライアント）が接続するボットサーバのアドレスを &lt;code>.bot&lt;/code> ファイルから取得します。&lt;/p>


&lt;figure class="xImage">
 &lt;img style="" width="600" height="400" src="../../p/8choj4w/botfile1_hu14061058004911490980.png" alt="/p/8choj4w/botfile1.png" />
&lt;/figure>

&lt;p>&lt;code>.bot&lt;/code> ファイルの中には、&lt;code>&amp;quot;type&amp;quot;: &amp;quot;endpoint&amp;quot;&lt;/code> というエンドポイント定義が 1 つ以上記述されており、ここには&lt;strong>ボットプログラムのアドレス&lt;/strong>が記述されています。
エミュレータの設定で、どのエンドポイント設定を使用するかを切り替えることで、実際に接続するボットを使い分けることができます。
典型的には、開発時にローカルホスト上で動作させたボットサーバに接続するための &lt;strong>&lt;code>development&lt;/code>&lt;/strong> と、実稼働用に Azure 上で動作させたボットサーバに接続するための &lt;strong>&lt;code>production&lt;/code>&lt;/strong> というエンドポイントを定義します。&lt;/p>


&lt;figure class="xImage">
 &lt;img style="border: solid #ccc 2px;" width="460" height="264" src="../../p/8choj4w/botfile2.png" alt="/p/8choj4w/botfile2.png" />
 &lt;figcaption>図: エミュレータ上でのエンドポイント切り替え&lt;/figcaption>
&lt;/figure>

&lt;h2 id="ボットプログラムのための-bot-ファイル">ボットプログラムのための .bot ファイル&lt;/h2>
&lt;p>&lt;code>.bot&lt;/code> ファイルは、ボットプログラムからも利用されます（こちらの方がメイン）。&lt;/p>


&lt;figure class="xImage">
 &lt;img style="" width="700" height="345" src="../../p/8choj4w/botfile3_hu7876861085142966511.png" alt="/p/8choj4w/botfile3.png" />
&lt;/figure>

&lt;p>&lt;code>.bot&lt;/code> ファイルには、&lt;strong>LUIS や QnA Maker のサービスを利用するためのエンドポイント情報&lt;/strong>（アドレスやエンドポイントキー）が定義されており、ボットプログラムはこれらの情報を使って各サービスの API を利用します。
こららの情報は、ボット自体がローカルホスト上で動作していても、Azure 上で動作していても同様に利用されます。&lt;/p>
&lt;p>また、ここでもボット自体の endpoint エントリが参照され、各種チャンネル（チャットクライアント）がボットにアクセスするときの認証処理のために使用されます。
このあたりの処理は、Bot Builder SDK を使ってボット実装を行っていれば、Adapter クラスとして抽象化されるため、特に意識せずに実装することができます。&lt;/p>
&lt;h2 id="bot-ファイルに-luis-や-qna-maker-の接続設定を記述する">.bot ファイルに LUIS や QnA Maker の接続設定を記述する&lt;/h2>
&lt;p>&lt;code>.bot&lt;/code> ファイルは XML ファイルなので、フォーマットさえ理解すればテキストエディタなどで編集してしまうことはできますが、エンドポイントキー部分の復号化・暗号化が必要だったりして面倒です。
Bot Framework Emulator には、.bot ファイルの内容を GUI で編集する機能が付いているのでこの機能を使うのがよいでしょう。&lt;/p></description></item><item><title>チャットボット: LUIS や QnA Maker サービスへの接続情報を .bot ファイルから取得する</title><link>https://maku.blog/p/o2bqajv/</link><pubDate>Mon, 15 Apr 2019 00:00:00 +0900</pubDate><guid>https://maku.blog/p/o2bqajv/</guid><description>&lt;ul>
&lt;li>参考: &lt;a href="../../p/8choj4w">MS Bot Framework の .bot ファイルで接続情報を管理する&lt;/a>&lt;/li>
&lt;/ul>
&lt;h2 id="ここで作るもの">ここで作るもの&lt;/h2>
&lt;p>&lt;a href="../../p/iob68qa">こちらの実装&lt;/a> では、最初のステップとしてボットサーバ自体 (Azure Web Apps) のエンドポイント情報を &lt;code>.bot&lt;/code> ファイルから取得する実装を行いました (&lt;code>config.js&lt;/code>)。
ここでは、さらに、LUIS サービスや QnA Maker サービスを利用することを想定し、これらの情報も &lt;code>.bot&lt;/code> ファイルから取得できるように拡張します。&lt;/p>
&lt;p>使用イメージとしては、下記のようにしてそれぞれの接続情報を簡単に読み込めるようにします。&lt;/p>

&lt;figure class="xCodeBlock">

&lt;div class="xCodeBlock_code">&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-js" data-lang="js">&lt;span class="line">&lt;span class="cl">&lt;span class="kr">const&lt;/span> &lt;span class="nx">config&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nx">require&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s1">&amp;#39;./config.js&amp;#39;&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kr">const&lt;/span> &lt;span class="nx">LUIS_APP_NAME&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="s1">&amp;#39;maku-luis-sample&amp;#39;&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kr">const&lt;/span> &lt;span class="nx">QNA_APP_NAME&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="s1">&amp;#39;maku-qna-sample&amp;#39;&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kr">const&lt;/span> &lt;span class="nx">botEndpoint&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nx">config&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">loadBotEndpoint&lt;/span>&lt;span class="p">();&lt;/span> &lt;span class="c1">// ボット自体への接続情報
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>&lt;span class="kr">const&lt;/span> &lt;span class="nx">luisEndpoint&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nx">config&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">loadLuisEndpoint&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">LUIS_APP_NAME&lt;/span>&lt;span class="p">);&lt;/span> &lt;span class="c1">// LUIS への接続情報
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>&lt;span class="kr">const&lt;/span> &lt;span class="nx">qnaEndpoint&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nx">config&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">loadQnaEndpoint&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">QNA_APP_NAME&lt;/span>&lt;span class="p">);&lt;/span> &lt;span class="c1">// QnA Maker への接続情報
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/div>
&lt;/figure>

&lt;p>単一のオブジェクトとしてまとめて取得するように実装することもできるのですが、分かりやすさのために、3 つの情報に分けて取得するようにしています。
LUIS や QnA Maker は、複数のアプリ（ナレッジベース）を同時に使用する可能性があるので、アプリ名を指定して接続情報を取得できるようにしています。&lt;/p>
&lt;p>取得した情報は、次のように BotBuilder SDK が提供するクラスへの入力として使用することを想定しています。&lt;/p>
&lt;ul>
&lt;li>&lt;code>botEndpoint&lt;/code> オブジェクトは、&lt;code>botbuilder&lt;/code> パッケージの &lt;code>BotFrameworkAdapter&lt;/code> クラスのコンストラクタに渡されます。&lt;/li>
&lt;li>&lt;code>luisEndpoint&lt;/code> オブジェクトは、&lt;code>botbuilder-ai&lt;/code> パッケージの &lt;code>LuisRecognizer&lt;/code> クラスのコンストラクタに渡されます。&lt;/li>
&lt;li>&lt;code>qnaEndpoint&lt;/code> オブジェクトは、&lt;code>botbuilder-ai&lt;/code> パッケージの &lt;code>QnAMaker&lt;/code> クラスのコンストラクタに渡されます。&lt;/li>
&lt;/ul>
&lt;p>下記は、実際に取得されるオブジェクトの内容の例です。
これらのオブジェクトは、上記のように SDK のクラスへの入力用に使用するので、各プロパティの値を直接参照することはないと思います。&lt;/p>

&lt;figure class="xCodeBlock">
&lt;figcaption class="xCodeBlock_title">上記のコードで得られる情報の例&lt;/figcaption>
&lt;div class="xCodeBlock_code">&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-js" data-lang="js">&lt;span class="line">&lt;span class="cl">&lt;span class="nx">botEndpoint&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">appId&lt;/span>&lt;span class="o">:&lt;/span> &lt;span class="s1">&amp;#39;921c6a01-1948-0f4d-9a82-75daf6a6d43c&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">appPassword&lt;/span>&lt;span class="o">:&lt;/span> &lt;span class="s1">&amp;#39;16lgoF+phvG:MPeg1eIDma*fcNU#!5jv&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">...&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nx">luisEndpoint&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">applicationId&lt;/span>&lt;span class="o">:&lt;/span> &lt;span class="s1">&amp;#39;c5514855-fa6b-8f4c-c695-9ac7d3519412&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">endpointKey&lt;/span>&lt;span class="o">:&lt;/span> &lt;span class="s1">&amp;#39;9ccff1530f4214fd8e319434a1408fa2&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">endpoint&lt;/span>&lt;span class="o">:&lt;/span> &lt;span class="s1">&amp;#39;https://westus.api.cognitive.microsoft.com&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nx">qnaEndpoint&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">knowledgeBaseId&lt;/span>&lt;span class="o">:&lt;/span> &lt;span class="s1">&amp;#39;c78ec3e7-a58d-ca44-dbb6-e7805d8130c6&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">endpointKey&lt;/span>&lt;span class="o">:&lt;/span> &lt;span class="s1">&amp;#39;c9153f6c-980c-bd41-4ba6-370392cda0e8&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">host&lt;/span>&lt;span class="o">:&lt;/span> &lt;span class="s1">&amp;#39;https://maku-qna-sample.azurewebsites.net/qnamaker&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/div>
&lt;/figure>

&lt;h2 id="botframework-config-パッケージのインストール">botframework-config パッケージのインストール&lt;/h2>
&lt;p>&lt;code>.bot&lt;/code> ファイルのロードには、Node の &lt;strong>&lt;code>botframework-config&lt;/code>&lt;/strong> パッケージが提供する &lt;code>BotConfiguration&lt;/code> クラスを使用します。
必要があれば、下記のようにインストールして、&lt;code>package.json&lt;/code> に依存関係を追記します。&lt;/p></description></item><item><title>チャットボット: 作成したチャットボットを LINE に接続する</title><link>https://maku.blog/p/asuzg7k/</link><pubDate>Fri, 19 Apr 2019 00:00:00 +0900</pubDate><guid>https://maku.blog/p/asuzg7k/</guid><description>&lt;h2 id="line-に-messaging-api-チャネルを作成する">LINE に Messaging API チャネルを作成する&lt;/h2>
&lt;p>自作したチャットボットアプリを LINE から「友だち」として見えるようにするには、まず LINE 側に「プロバイダー」を作成し、そこに「&lt;strong>Messaging API チャネル&lt;/strong>」を追加する必要があります。
この Messaging API チャネルは、LINE アプリから「友だち」として見える単位だと考えればよいでしょう。&lt;/p>
&lt;h3 id="line-に開発者として登録する">LINE に開発者として登録する&lt;/h3>
&lt;p>LINE のプロバイダー登録作業などは、下記の &lt;strong>LINE Developer Console&lt;/strong> から行うことができます。
初めてアクセスする場合は、開発者としての登録を求められるので、LINE アカウントでログインして開発者情報を入力してください。&lt;/p>
&lt;ul>
&lt;li>&lt;a href="https://developers.line.biz/console/register/messaging-api/provider/">LINE Developer Console&lt;/a>&lt;/li>
&lt;/ul>
&lt;h3 id="プロバイダーを新規作成する">プロバイダーを新規作成する&lt;/h3>
&lt;p>LINE に開発者登録できたら、&lt;samp>新規プロバイダー作成&lt;/samp> のボタンを押して、プロバイダーを作成します。&lt;/p>


&lt;figure class="xImage">
 &lt;img style="border: solid #ccc 2px;" width="700" height="452" src="../../p/asuzg7k/connect-to-line-001_hu10272047064623469357.png" alt="/p/asuzg7k/connect-to-line-001.png" />
&lt;/figure>

&lt;h3 id="messaging-api-チャネルを追加する">Messaging API チャネルを追加する&lt;/h3>
&lt;p>プロバイダーの作成が終わったら、そこに &lt;strong>Messaging API チャネル&lt;/strong> を追加します。&lt;/p>


&lt;figure class="xImage">
 &lt;img style="border: solid #ccc 2px;" width="700" height="422" src="../../p/asuzg7k/connect-to-line-002_hu7629139533632617466.png" alt="/p/asuzg7k/connect-to-line-002.png" />
&lt;/figure>

&lt;p>チャネルの作成時には、アプリアイコンやアプリ名を自由に登録することができます。
アプリ名は一度設定すると 7 日間は変更できないようなので慎重に決めましょう（アイコンは 1 時間経てば変更できます）。&lt;/p>


&lt;figure class="xImage">
 &lt;img style="border: solid #ccc 2px;" width="500" height="520" src="../../p/asuzg7k/connect-to-line-003_hu8577726236098286274.png" alt="/p/asuzg7k/connect-to-line-003.png" />
&lt;/figure>

&lt;p>下のように、プロバイダー上に Messaging API チャネルが追加されていれば OK です。&lt;/p>


&lt;figure class="xImage">
 &lt;img style="border: solid #ccc 2px;" width="500" height="342" src="../../p/asuzg7k/connect-to-line-004_hu17560519592571775238.png" alt="/p/asuzg7k/connect-to-line-004.png" />
&lt;/figure>

&lt;h3 id="スマホの-line-に友達登録する">スマホの LINE に友達登録する&lt;/h3>
&lt;p>Messaging API のチャネルを選択し、&lt;samp>チャネル基本設定&lt;/samp> タブを見ると、LINE アプリ用の QR コードが見つかります。&lt;/p></description></item><item><title>チャットボット: 作成したチャットボットを Slack に接続する</title><link>https://maku.blog/p/rtxqceq/</link><pubDate>Thu, 20 Jun 2019 00:00:00 +0900</pubDate><guid>https://maku.blog/p/rtxqceq/</guid><description>&lt;h2 id="slack-に-bot-framework-で作成したボットを接続する">Slack に Bot Framework で作成したボットを接続する&lt;/h2>


&lt;figure class="xImage">
 &lt;img style="border: solid #ccc 2px;" width="700" height="258" src="../../p/rtxqceq/connect-to-slack-001_hu7439744207728099245.png" alt="/p/rtxqceq/connect-to-slack-001.png" />
 &lt;figcaption>図: ボットとのダイレクトメッセージによる会話&lt;/figcaption>
&lt;/figure>

&lt;p>Microsoft Azure 上に作成したボットアプリを Slack に接続するには、下記の Bot Service 公式ドキュメントで説明されている手順に従ってください。&lt;/p>
&lt;ul>
&lt;li>&lt;a href="https://docs.microsoft.com/ja-jp/azure/bot-service/bot-service-channel-connect-slack?view=azure-bot-service-4.0">（日本語）ボットを Slack に接続する - Bot Service ｜ Microsoft Docs&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://docs.microsoft.com/en-us/azure/bot-service/bot-service-channel-connect-slack?view=azure-bot-service-4.0">（英語）Connect a bot to Slack - Bot Service ｜ Microsoft Docs&lt;/a>&lt;/li>
&lt;/ul>
&lt;p>接続のおおまかな手順は下記のような感じです。&lt;/p>
&lt;ol>
&lt;li>Slack アプリを作成する（何らかのワークスペースに所属させる形で作成する）&lt;/li>
&lt;li>Slack アプリにボット用のユーザーを登録する&lt;/li>
&lt;li>Azure ポータルから、Web アプリボットのチャンネルとして Slack を追加（Slack アプリ側の Client ID、Client Secret、Verification Token をコピペすれば OK）&lt;/li>
&lt;/ol>
&lt;p>この作業が終わると、ボット（アプリ）が Slack のワークスペースに参加している状態になります。
その時点ではどのチャンネルにも参加していませんが、ダイレクトメッセージを使って一対一でボットと会話することができます。&lt;/p>
&lt;p>特定のチャンネルで会話している最中に &lt;code>@ボット名&lt;/code> と話かけると、そのチャンネルにボットを招待することができます。
チャンネルにボットが参加すると、後はそのチャンネルに対してつぶやくだけでボットが反応するようになります。&lt;/p>
&lt;h2 id="わかりにくいところの補足">わかりにくいところの補足&lt;/h2>
&lt;p>図入りで説明されているので、特に迷うことはないと思いますが、Microsoft の Bot チームのドキュメント通りにはうまくいかない部分があるので若干補足しておきます。&lt;/p>
&lt;h3 id="ボットハンドル">ボットハンドル&lt;/h3>
&lt;p>「ボットのイベントをサブスクライブ」するという項目で、下記のような Request URL で&lt;a href="https://docs.microsoft.com/ja-jp/azure/bot-service/bot-service-resources-identifiers-guide?view=azure-bot-service-4.0#bot-handle">ボットハンドル (YourBotHandle)&lt;/a> を指定するところがあります。&lt;/p></description></item><item><title>チャットボット: Chatdown（.chat ファイル）を使ってボットの会話をデザインする</title><link>https://maku.blog/p/a6yzskr/</link><pubDate>Wed, 27 Mar 2019 00:00:00 +0900</pubDate><guid>https://maku.blog/p/a6yzskr/</guid><description>&lt;h2 id="chatdown-フォーマットとは">Chatdown フォーマットとは&lt;/h2>
&lt;p>&lt;a href="https://github.com/Microsoft/botbuilder-tools/tree/master/packages/Chatdown">Chatdown フォーマット&lt;/a>は、会話の設計をテキストベースで行うことを意図したフォーマットです。
拡張子は &lt;strong>&lt;code>.chat&lt;/code>&lt;/strong> で、下記のような感じで会話例を記述していきます。&lt;/p>

&lt;figure class="xCodeBlock">
&lt;figcaption class="xCodeBlock_title">sample.chat&lt;/figcaption>
&lt;div class="xCodeBlock_code">&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-plain" data-lang="plain">&lt;span class="line">&lt;span class="cl">user=Joe
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">bot=LulaBot
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">bot: Hi!
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">user: yo!
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">bot: [Typing][Delay=3000]
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Greetings!
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">What would you like to do?
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">* update - You can update your account
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">* List - You can list your data
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">* help - you can get help
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">user: I need the bot framework logo.&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/div>
&lt;/figure>

&lt;p>上記のように、チャットボットがタイプ中であることや、応答までのディレイなどもデザインすることができます。
Markdown 形式で書式設定できるようになっているのが Chatdown という名前の由来ですね。&lt;/p>
&lt;h2 id="bot-framework-emulator-で会話を再現する">Bot Framework Emulator で会話を再現する&lt;/h2>
&lt;p>&lt;a href="https://github.com/Microsoft/BotFramework-Emulator">Bot Framework Emulator&lt;/a> で会話ファイルを読み込むと、チャット UI 上で会話を再現することができます。
ただし、Emulator が読み込むことのできるファイルは &lt;code>.transcript&lt;/code> 形式のファイルなので、あらかじめ &lt;code>.chat&lt;/code> ファイルを変換して &lt;code>.transcript&lt;/code> ファイルを生成しておく必要があります。&lt;/p></description></item><item><title>チャットボット: ActivityHandler でボットのイベントハンドラ実装を簡略化する</title><link>https://maku.blog/p/mgujykj/</link><pubDate>Sun, 09 Jun 2019 00:00:00 +0900</pubDate><guid>https://maku.blog/p/mgujykj/</guid><description>&lt;p>Bot Builder SDK (Node.js) の &lt;code>botbuilder-core&lt;/code> パッケージには、&lt;a href="https://github.com/microsoft/botbuilder-js/blob/master/libraries/botbuilder-core/src/activityHandler.ts">ActivityHandler&lt;/a> という、ボットのイベントハンドラ部分の実装を簡略化するためのライブラリが含まれています。
ボットの世界では、「Activity」はひとつのメッセージの処理単位のことを示しています。
この Activity をうまくハンドルするためのクラスだから &lt;code>ActivityHandler&lt;/code> という名前が付けられているんですね。&lt;/p>
&lt;p>ここでは、独自のボットクラス (&lt;code>MyBot&lt;/code>) を、&lt;code>ActivityHandler&lt;/code> を利用せずに実装した場合と、利用して実装した場合で比較してみたいと思います。&lt;/p>
&lt;h2 id="activityhandler-を使わない場合">ActivityHandler を使わない場合&lt;/h2>
&lt;p>例えば、下記のように &lt;code>BotFrameworkAdapter&lt;/code> で受信したイベントの処理を &lt;code>MyBot.onTurn()&lt;/code> に委譲するとします。&lt;/p>

&lt;figure class="xCodeBlock">
&lt;figcaption class="xCodeBlock_title">mybot.js&lt;/figcaption>
&lt;div class="xCodeBlock_code">&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-js" data-lang="js">&lt;span class="line">&lt;span class="cl">&lt;span class="kr">const&lt;/span> &lt;span class="nx">myBot&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="k">new&lt;/span> &lt;span class="nx">MyBot&lt;/span>&lt;span class="p">();&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kr">const&lt;/span> &lt;span class="nx">adapter&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="k">new&lt;/span> &lt;span class="nx">BotFrameworkAdapter&lt;/span>&lt;span class="p">({});&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kr">const&lt;/span> &lt;span class="nx">server&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nx">require&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s1">&amp;#39;restify&amp;#39;&lt;/span>&lt;span class="p">).&lt;/span>&lt;span class="nx">createServer&lt;/span>&lt;span class="p">();&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nx">server&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">post&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s1">&amp;#39;/api/messages&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">req&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">res&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">=&amp;gt;&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">adapter&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">processActivity&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">req&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">res&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="kr">async&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">context&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">=&amp;gt;&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kr">await&lt;/span> &lt;span class="nx">myBot&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">onTurn&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">context&lt;/span>&lt;span class="p">);&lt;/span> &lt;span class="c1">// あとは MyBot に丸投げ
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="p">});&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">});&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/div>
&lt;/figure>

&lt;p>このイベントは、ユーザからメッセージを送られたときだけでなく、ユーザがチャットに参加したとき (&lt;code>ConversationUpdate&lt;/code>) などにも発生するため、&lt;code>MyBot.onTurn()&lt;/code> の実装の中でアクティビティタイプを見て分岐処理を行わなければなりません。&lt;/p>

&lt;figure class="xCodeBlock">

&lt;div class="xCodeBlock_code">&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-js" data-lang="js">&lt;span class="line">&lt;span class="cl">&lt;span class="kr">class&lt;/span> &lt;span class="nx">MyBot&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">constructor&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">// ...
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kr">async&lt;/span> &lt;span class="nx">onTurn&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">context&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">context&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">activity&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">type&lt;/span> &lt;span class="o">===&lt;/span> &lt;span class="nx">ActivityTypes&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Message&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kr">const&lt;/span> &lt;span class="nx">utterance&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nx">context&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">activity&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">text&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kr">await&lt;/span> &lt;span class="nx">context&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">sendActivity&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="sb">`You said: &lt;/span>&lt;span class="si">${&lt;/span>&lt;span class="nx">utterance&lt;/span>&lt;span class="si">}&lt;/span>&lt;span class="sb">`&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span> &lt;span class="k">else&lt;/span> &lt;span class="k">if&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">context&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">activity&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">type&lt;/span> &lt;span class="o">===&lt;/span> &lt;span class="nx">ActivityTypes&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">ConversationUpdate&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kr">await&lt;/span> &lt;span class="nx">context&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">sendActivity&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="sb">`[ConversationUpdate event detected]`&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span> &lt;span class="k">else&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kr">await&lt;/span> &lt;span class="nx">context&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">sendActivity&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="sb">`[&lt;/span>&lt;span class="si">${&lt;/span>&lt;span class="nx">turnContext&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">activity&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">type&lt;/span>&lt;span class="si">}&lt;/span>&lt;span class="sb"> event detected]`&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/div>
&lt;/figure>

&lt;p>このあたりの分岐処理を簡潔にしてくれるのが &lt;code>ActivityHandler&lt;/code> クラスです。&lt;/p>
&lt;h2 id="activityhandler-を使う場合">ActivityHandler を使う場合&lt;/h2>
&lt;p>下記は、&lt;code>ActivityHandler&lt;/code> を利用したボット実装の例です。
&lt;strong>&lt;code>onMessage()&lt;/code>&lt;/strong> メソッドを使って通常メッセージのハンドラを登録し、&lt;strong>&lt;code>onConversationUpdate()&lt;/code>&lt;/strong> メソッドを使って会話更新時のハンドラを登録します。&lt;/p></description></item><item><title>チャットボット: ユーザーの参加／離脱のイベントをハンドルする</title><link>https://maku.blog/p/onctywi/</link><pubDate>Fri, 28 Jun 2019 00:00:00 +0900</pubDate><guid>https://maku.blog/p/onctywi/</guid><description>&lt;p>Bot Builder SDK の &lt;code>ActivityHandler&lt;/code> を使って、ユーザーが会話に参加したこと、離脱したことをハンドルする方法を説明します。
&lt;code>ActivityHandler&lt;/code> を使ったボット実装の基本に関しては下記を参照してください。&lt;/p>
&lt;ul>
&lt;li>&lt;a href="../../p/mgujykj">チャットボット: ActivityHandler でボットのイベントハンドラ実装を簡略化する&lt;/a>&lt;/li>
&lt;/ul>
&lt;p>下記は、ユーザーが新しく会話に参加したときに、ボットから挨拶するように実装した例です。
ユーザー参加のイベントをハンドルするには、&lt;a href="https://docs.microsoft.com/en-us/javascript/api/botbuilder-core/activityhandler?view=botbuilder-ts-latest#onmembersadded-bothandler-">ActivityHandler#onMembersAdded()&lt;/a> で、イベントハンドラを登録します。&lt;/p>

&lt;figure class="xCodeBlock">
&lt;figcaption class="xCodeBlock_title">mybot.js&lt;/figcaption>
&lt;div class="xCodeBlock_code">&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-js" data-lang="js">&lt;span class="line">&lt;span class="cl">&lt;span class="kr">const&lt;/span> &lt;span class="p">{&lt;/span> &lt;span class="nx">ActivityHandler&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">BotFrameworkAdapter&lt;/span> &lt;span class="p">}&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nx">require&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s1">&amp;#39;botbuilder&amp;#39;&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">// ボット実装
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>&lt;span class="kr">class&lt;/span> &lt;span class="nx">MyBot&lt;/span> &lt;span class="kr">extends&lt;/span> &lt;span class="nx">ActivityHandler&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">constructor&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kr">super&lt;/span>&lt;span class="p">();&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">this&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">onMessage&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="k">this&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">handleMessage&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">this&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">onMembersAdded&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="k">this&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">handleMembersAdded&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kr">async&lt;/span> &lt;span class="nx">handleMessage&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">context&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">next&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kr">const&lt;/span> &lt;span class="nx">name&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nx">context&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">activity&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">from&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">name&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kr">const&lt;/span> &lt;span class="nx">utterance&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nx">context&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">activity&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">text&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kr">await&lt;/span> &lt;span class="nx">context&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">sendActivity&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="sb">`&lt;/span>&lt;span class="si">${&lt;/span>&lt;span class="nx">name&lt;/span>&lt;span class="si">}&lt;/span>&lt;span class="sb">さんは、&lt;/span>&lt;span class="si">${&lt;/span>&lt;span class="nx">utterance&lt;/span>&lt;span class="si">}&lt;/span>&lt;span class="sb">と言いました。`&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kr">await&lt;/span> &lt;span class="nx">next&lt;/span>&lt;span class="p">();&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kr">async&lt;/span> &lt;span class="nx">handleMembersAdded&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">context&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">next&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kr">const&lt;/span> &lt;span class="nx">members&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nx">context&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">activity&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">membersAdded&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">for&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="kd">let&lt;/span> &lt;span class="nx">i&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="nx">i&lt;/span> &lt;span class="o">&amp;lt;&lt;/span> &lt;span class="nx">members&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">length&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="o">++&lt;/span>&lt;span class="nx">i&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kr">const&lt;/span> &lt;span class="nx">m&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nx">members&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="nx">i&lt;/span>&lt;span class="p">];&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">m&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">id&lt;/span> &lt;span class="o">!==&lt;/span> &lt;span class="nx">context&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">activity&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">recipient&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">id&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">// ボット以外のユーザが参加したときにメッセージを表示
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="kr">await&lt;/span> &lt;span class="nx">context&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">sendActivity&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="sb">`&lt;/span>&lt;span class="si">${&lt;/span>&lt;span class="nx">m&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">name&lt;/span>&lt;span class="si">}&lt;/span>&lt;span class="sb">さん、こんにちは！`&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kr">await&lt;/span> &lt;span class="nx">next&lt;/span>&lt;span class="p">();&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nx">exports&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">MyBot&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nx">MyBot&lt;/span>&lt;span class="p">;&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/div>
&lt;/figure>

&lt;p>ちなみに、このイベントハンドラは、&lt;strong>ボット自身が会話に参加したときにも呼び出されます&lt;/strong>。
ボット以外のユーザーが参加したときだけメッセージを送るには、&lt;code>context.activity.recipient.id&lt;/code> と参加者の ID を比較し、通常のユーザーであることを確認します（&lt;code>recipient.id&lt;/code> にはボットの ID が入っています）。&lt;/p>
&lt;p>上記の例では、ユーザーが参加したときのイベントをハンドルしていますが、ユーザー離脱時のイベントも &lt;a href="https://docs.microsoft.com/en-us/javascript/api/botbuilder-core/activityhandler?view=botbuilder-ts-latest#onmembersremoved-bothandler-">ActivityHandler#onMembersRemoved()&lt;/a> を使って同様にハンドルすることができます。&lt;/p>
&lt;p>Bot Framework Emulator を使っている場合は、画面上部の &lt;samp>Restart conversation&lt;/samp> ボタンを押せば、ボットからのメッセージを確認することができます。&lt;/p>


&lt;figure class="xImage">
 &lt;img style="" width="544" height="302" src="../../p/onctywi/handle-members-added-001.png" alt="/p/onctywi/handle-members-added-001.png" />
&lt;/figure>

&lt;p>Slack をチャンネル（クライアント）として使用している場合は、あるチャンネルにボットを招待したときや、そのチャンネルに新しくユーザーを招待したときに &lt;code>onMembersAdded()&lt;/code> が呼び出されるようです。
なので、このイベントハンドラはそんなに頻繁に呼び出されるものではありません。&lt;/p></description></item><item><title>チャットボット: Bot Builder SDK で会話の状態を保存する (Storage)</title><link>https://maku.blog/p/3fnyk44/</link><pubDate>Tue, 11 Jun 2019 00:00:00 +0900</pubDate><guid>https://maku.blog/p/3fnyk44/</guid><description>&lt;p>ボットは基本的に&lt;strong>ステートレスで動作する&lt;/strong>ので、ユーザとの会話のコンテキストを把握するには、ステートの管理を明示的に行う必要があります。
Bot Builder SDK にはそのためのユーティリティクラスが用意されています。
ここでは、Node.js の &lt;code>botbuilder&lt;/code> パッケージを使って説明します。&lt;/p>
&lt;h2 id="storage-インタフェース">Storage インタフェース&lt;/h2>
&lt;p>&lt;code>botbuilder&lt;/code> パッケージに含まれている &lt;a href="https://github.com/microsoft/botbuilder-js/blob/master/libraries/botbuilder-core/src/storage.ts">Storage インタフェース&lt;/a>は、抽象化されたストレージに JSON オブジェクトを保存するための API を定義しています。
&lt;code>write&lt;/code>、&lt;code>read&lt;/code>、&lt;code>delete&lt;/code> の 3 つの API のみなのでとてもシンプルです。&lt;/p>
&lt;h3 id="write-メソッド">write メソッド&lt;/h3>
&lt;p>JSON オブジェクトをストレージに保存するための API です。
オブジェクトを保存するときには、名前（キー）を付けて、キー＆バリューの形のオブジェクトとして保存します。
下記の例では、保存したい &lt;code>state&lt;/code> オブジェクトに、&lt;code>botState&lt;/code> という名前を付けて保存しています。&lt;/p>

&lt;figure class="xCodeBlock">

&lt;div class="xCodeBlock_code">&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-js" data-lang="js">&lt;span class="line">&lt;span class="cl">&lt;span class="nx">state&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">topic&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="s1">&amp;#39;someTopic&amp;#39;&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kr">await&lt;/span> &lt;span class="nx">storage&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">write&lt;/span>&lt;span class="p">({&lt;/span> &lt;span class="s1">&amp;#39;botState&amp;#39;&lt;/span>&lt;span class="o">:&lt;/span> &lt;span class="nx">state&lt;/span> &lt;span class="p">});&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/div>
&lt;/figure>

&lt;h3 id="read-メソッド">read メソッド&lt;/h3>
&lt;p>ストレージに保存されたオブジェクトを読み出すための API です。
読み出したいオブジェクトの名前を配列で渡すと、オブジェクトの連想配列が返ってきます。
下記の例では、&lt;code>botState&lt;/code> という名前で保存されたオブジェクトを、&lt;code>state&lt;/code> 変数に取り出しています。&lt;/p>

&lt;figure class="xCodeBlock">

&lt;div class="xCodeBlock_code">&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-js" data-lang="js">&lt;span class="line">&lt;span class="cl">&lt;span class="kr">const&lt;/span> &lt;span class="nx">items&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="kr">await&lt;/span> &lt;span class="nx">storage&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">read&lt;/span>&lt;span class="p">([&lt;/span>&lt;span class="s1">&amp;#39;botState&amp;#39;&lt;/span>&lt;span class="p">]);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kr">const&lt;/span> &lt;span class="nx">state&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nx">items&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="s1">&amp;#39;botState&amp;#39;&lt;/span>&lt;span class="p">]&lt;/span> &lt;span class="o">||&lt;/span> &lt;span class="p">{};&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/div>
&lt;/figure>

&lt;h3 id="delete-メソッド">delete メソッド&lt;/h3>
&lt;p>ストレージに保存されたオブジェクトを削除するための API です。
削除したいオブジェクトの名前を配列で渡します。&lt;/p>

&lt;figure class="xCodeBlock">

&lt;div class="xCodeBlock_code">&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-js" data-lang="js">&lt;span class="line">&lt;span class="cl">&lt;span class="kr">await&lt;/span> &lt;span class="nx">storage&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="k">delete&lt;/span>&lt;span class="p">([&lt;/span>&lt;span class="s1">&amp;#39;botState&amp;#39;&lt;/span>&lt;span class="p">]);&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/div>
&lt;/figure>

&lt;h2 id="memorystorage-クラス">MemoryStorage クラス&lt;/h2>
&lt;p>実際にストレージを扱うには、&lt;code>Storage&lt;/code> インタフェースを実装したクラスが必要です。
&lt;a href="https://github.com/microsoft/botbuilder-js/blob/master/libraries/botbuilder-core/src/memoryStorage.ts">MemoryStorage クラス&lt;/a> はローカルテスト用のインメモリストレージで、ボットのプロセスが終了するまで情報を保持します。&lt;/p>

&lt;figure class="xCodeBlock">
&lt;figcaption class="xCodeBlock_title">MemoryStorage のインスタンス化&lt;/figcaption>
&lt;div class="xCodeBlock_code">&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-js" data-lang="js">&lt;span class="line">&lt;span class="cl">&lt;span class="kr">const&lt;/span> &lt;span class="p">{&lt;/span> &lt;span class="nx">MemoryStorage&lt;/span> &lt;span class="p">}&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nx">require&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s1">&amp;#39;botbuilder&amp;#39;&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kr">const&lt;/span> &lt;span class="nx">storage&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="k">new&lt;/span> &lt;span class="nx">MemoryStorage&lt;/span>&lt;span class="p">();&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/div>
&lt;/figure>

&lt;h3 id="テスト実装">テスト実装&lt;/h3>
&lt;p>下記はローカル環境で &lt;code>MemoryStorage&lt;/code> の振る舞いをテストするためのシンプルなボット実装です。
ユーザがメッセージを送るたびに、&lt;code>state&lt;/code> オブジェクトに保持したカウンタの値が 1 ずつ増えていきます。&lt;/p></description></item><item><title>チャットボット: Bot Builder SDK で会話の状態を保存する (BotState)</title><link>https://maku.blog/p/6wtzzq4/</link><pubDate>Fri, 28 Jun 2019 00:00:00 +0900</pubDate><guid>https://maku.blog/p/6wtzzq4/</guid><description>&lt;h2 id="botstate-クラス">BotState クラス&lt;/h2>
&lt;p>Bot Builder SDK の &lt;a href="https://github.com/microsoft/botbuilder-js/blob/master/libraries/botbuilder-core/src/botState.ts">BotState クラス&lt;/a> は、ボットとの会話内の特定のコンテキストにおける状態を保持するためのクラスです。&lt;/p>
&lt;p>というと難しいですが、簡単に言うと、&lt;strong>会話ごとの状態保存&lt;/strong>や、&lt;strong>ユーザーごとの状態保存&lt;/strong>を行うための便利クラスです。&lt;/p>
&lt;p>&lt;code>BotState&lt;/code> クラスには次のようなサブクラスが定義されています。&lt;/p>
&lt;ul>
&lt;li>&lt;a href="https://github.com/microsoft/botbuilder-js/blob/master/libraries/botbuilder-core/src/conversationState.ts">ConversationState クラス&lt;/a> &amp;hellip; 会話ごとの状態を保存する&lt;/li>
&lt;li>&lt;a href="https://github.com/microsoft/botbuilder-js/blob/master/libraries/botbuilder-core/src/userState.ts">UserState クラス&lt;/a> &amp;hellip; ユーザーごとの状態を保存する&lt;/li>
&lt;li>&lt;a href="https://github.com/microsoft/botbuilder-js/blob/master/libraries/botbuilder-core/src/privateConversationState.ts">PrivateConversationState クラス&lt;/a> &amp;hellip; 会話ごとのユーザごとの状態を保存する&lt;/li>
&lt;/ul>
&lt;p>これらのクラスは、内部で &lt;a href="../../p/3fnyk44">Storage&lt;/a> オブジェクトを利用します。&lt;/p>


&lt;figure class="xImage">
 &lt;img style="" width="" height="auto" src="../../p/6wtzzq4/state-001.svg" alt="/p/6wtzzq4/state-001.svg" />
 &lt;figcaption> &lt;span class="xImage_codeLink">≪&lt;a href="state-001.puml.txt">生成コード&amp;#x1F4D6;&lt;/a>≫&lt;/span>&lt;/figcaption>
&lt;/figure>

&lt;p>&lt;code>Storage&lt;/code> がグローバルに状態保存を行っていたのに対し、&lt;strong>&lt;code>BotState&lt;/code> はネームスペースを考慮して状態保存を行うもの&lt;/strong>だと考えることができます。
実際に、&lt;code>ConversationState&lt;/code> クラスや &lt;code>UserState&lt;/code> クラスの実装を覗いてみると、&lt;code>getStorageKey()&lt;/code> というメソッドでストレージ用の保存キーを作成しており、それぞれ次のように構成しています。&lt;/p>
&lt;ul>
&lt;li>&lt;b>ConversationState&lt;/b> が使用する保存キー
&lt;ul>
&lt;li>&lt;code>${ channelId }/conversations/${ conversationId }/${ this.namespace }&lt;/code>&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>&lt;b>UserState&lt;/b> が使用する保存キー
&lt;ul>
&lt;li>&lt;code>${ channelId }/users/${ userId }/${ this.namespace }&lt;/code>&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>&lt;b>PrivateConversationState&lt;/b> が使用するキー
&lt;ul>
&lt;li>&lt;code>${ channelId }/conversations/${ conversationId }/users/${ userId }/${ this.namespace }&lt;/code>&lt;/li>
&lt;/ul>
&lt;/li>
&lt;/ul>
&lt;p>実用的なボットの状態管理を行うには、&lt;code>Storage&lt;/code> インタフェースをそのまま使うのではなく、&lt;code>ConversationState&lt;/code> / &lt;code>UserState&lt;/code> / &lt;code>PrivateConversationState&lt;/code> などを使うことになるでしょう。&lt;/p></description></item><item><title>チャットボット: Bot Builder SDK の Dialog で会話の流れをデザインする (1) ダイアログの基本</title><link>https://maku.blog/p/w36evii/</link><pubDate>Mon, 01 Jul 2019 00:00:00 +0900</pubDate><guid>https://maku.blog/p/w36evii/</guid><description>&lt;h2 id="dialog-を使わない会話管理">Dialog を使わない会話管理&lt;/h2>
&lt;p>Bot Builder SDK の &lt;a href="../../p/6wtzzq4">UserState や ConversationState を使う&lt;/a> と、ユーザーや会話ごとの状態管理を行うことできるため、複数回のやりとりが必要な会話を実現することができます。&lt;/p>
&lt;p>例えば、下記のような会話ができるボットを実装してみます。&lt;/p>
&lt;pre tabindex="0">&lt;code>User: こんにちは
 Bot: あなたの名前は？
User: まく
 Bot: こんにちは まく さん
User: おやすみなさい
 Bot: また来てね まく さん
&lt;/code>&lt;/pre>&lt;p>次のボット実装は、&lt;code>UserState&lt;/code> クラスを使って、&lt;code>pos&lt;/code> という名前のプロパティを作成し、会話がどこまで進んでいるかを管理しています。&lt;/p>

&lt;figure class="xCodeBlock">
&lt;figcaption class="xCodeBlock_title">mybot.js&lt;/figcaption>
&lt;div class="xCodeBlock_code">&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-js" data-lang="js">&lt;span class="line">&lt;span class="cl">&lt;span class="kr">const&lt;/span> &lt;span class="p">{&lt;/span> &lt;span class="nx">ActivityHandler&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">UserState&lt;/span> &lt;span class="p">}&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nx">require&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s1">&amp;#39;botbuilder&amp;#39;&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kr">class&lt;/span> &lt;span class="nx">MyBot&lt;/span> &lt;span class="kr">extends&lt;/span> &lt;span class="nx">ActivityHandler&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">constructor&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">storage&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kr">super&lt;/span>&lt;span class="p">();&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">this&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">_createStateObjects&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">storage&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">this&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">onMessage&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="kr">async&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">context&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">next&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">=&amp;gt;&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kr">const&lt;/span> &lt;span class="nx">prop&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="kr">await&lt;/span> &lt;span class="k">this&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">nameProp&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">get&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">context&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="p">{&lt;/span> &lt;span class="nx">pos&lt;/span>&lt;span class="o">:&lt;/span> &lt;span class="s1">&amp;#39;init&amp;#39;&lt;/span> &lt;span class="p">});&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">// プロパティの &amp;#39;pos&amp;#39; により処理を分岐させる
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="k">if&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">prop&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">pos&lt;/span> &lt;span class="o">===&lt;/span> &lt;span class="s1">&amp;#39;init&amp;#39;&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">prop&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">pos&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="s1">&amp;#39;askName&amp;#39;&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kr">await&lt;/span> &lt;span class="nx">context&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">sendActivity&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s1">&amp;#39;あなたの名前は？&amp;#39;&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span> &lt;span class="k">else&lt;/span> &lt;span class="k">if&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">prop&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">pos&lt;/span> &lt;span class="o">===&lt;/span> &lt;span class="s1">&amp;#39;askName&amp;#39;&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">prop&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">pos&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="s1">&amp;#39;end&amp;#39;&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">prop&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">name&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nx">context&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">activity&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">text&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kr">await&lt;/span> &lt;span class="nx">context&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">sendActivity&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="sb">`こんにちは &lt;/span>&lt;span class="si">${&lt;/span>&lt;span class="nx">prop&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">name&lt;/span>&lt;span class="si">}&lt;/span>&lt;span class="sb"> さん`&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span> &lt;span class="k">else&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">prop&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">pos&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="s1">&amp;#39;init&amp;#39;&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kr">await&lt;/span> &lt;span class="nx">context&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">sendActivity&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="sb">`また来てね &lt;/span>&lt;span class="si">${&lt;/span>&lt;span class="nx">prop&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">name&lt;/span>&lt;span class="si">}&lt;/span>&lt;span class="sb"> さん`&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">// プロパティに保存
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="kr">await&lt;/span> &lt;span class="k">this&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">nameProp&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">set&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">context&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">prop&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kr">await&lt;/span> &lt;span class="k">this&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">userState&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">saveChanges&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">context&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">});&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">// 状態管理用のオブジェクトを作成
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="nx">_createStateObjects&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">storage&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">this&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">userState&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="k">new&lt;/span> &lt;span class="nx">UserState&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">storage&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">this&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">nameProp&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="k">this&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">userState&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">createProperty&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s1">&amp;#39;name&amp;#39;&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nx">exports&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">MyBot&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nx">MyBot&lt;/span>&lt;span class="p">;&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/div>
&lt;/figure>

&lt;p>会話の流れに従って、&lt;code>pos&lt;/code> プロパティの値は &lt;code>init&lt;/code> → &lt;code>askName&lt;/code> → &lt;code>end&lt;/code> と変化していきます（最後に &lt;code>init&lt;/code> に戻る）。
このように、&lt;code>UserState&lt;/code> を使った状態管理だけでも、会話の流れを表現することはできるのですが、こんな状態管理を各トピックごとに実装するのは非常に骨が折れます。&lt;/p></description></item><item><title>チャットボット: Bot Builder SDK の Dialog で会話の流れをデザインする (2) スタック管理</title><link>https://maku.blog/p/6arjar6/</link><pubDate>Fri, 19 Jul 2019 00:00:00 +0900</pubDate><guid>https://maku.blog/p/6arjar6/</guid><description>&lt;p>&lt;a href="../../p/w36evii">ダイアログの基本&lt;/a> で説明したように、&lt;code>Dialog&lt;/code> クラスを使用した会話フローでは、ユーザーからメッセージを受け取るたびに &lt;code>DialogContext#continueDialog()&lt;/code> を呼び出すことで、1 ステップずつ処理を進めていきます。
ダイアログには、スタック構造で会話を管理する仕組みがあり、次のようなメソッドを使って、ダイアログの起動（スタックに積む）、ダイアログの終了（スタックから降ろす）という操作を行うことが可能です。&lt;/p>
&lt;ul>
&lt;li>&lt;code>DialogContext#beginDialog(&amp;quot;ID&amp;quot;)&lt;/code> &amp;hellip; ダイアログを開始する（スタックに積む）&lt;/li>
&lt;li>&lt;code>DialogContext#endDialog()&lt;/code> &amp;hellip; アクティブなダイアログを終了する（スタックから降ろす）&lt;/li>
&lt;li>&lt;code>DialogContext#replaceDialog(&amp;quot;ID&amp;quot;)&lt;/code> &amp;hellip; アクティブなダイアログを別のダイアログに置き換える（スタックの一番上を入れ替え）&lt;/li>
&lt;li>&lt;code>DialogContext#cancelAllDialog()&lt;/code> &amp;hellip; すべてのダイアログを終了する（スタックをクリア）&lt;/li>
&lt;/ul>
&lt;p>ここでは、&lt;code>RootDialog&lt;/code> と &lt;code>GreetDialog&lt;/code> という名前の 2 つのダイアログクラス作成し、&lt;code>RootDialog&lt;/code> から &lt;code>GreetDialog&lt;/code> を起動してダイアログのスタックを積むような実装を行ってみます。&lt;/p>


&lt;figure class="xImage">
 &lt;img style="" width="500" height="183" src="../../p/6arjar6/dialog-stack-001_hu1400193414383335806.png" alt="/p/6arjar6/dialog-stack-001.png" />
 &lt;figcaption>図: ダイアログ遷移のイメージ&lt;/figcaption>
&lt;/figure>

&lt;p>下記は、実際のチャットクライアントの表示例です。
右側のバーで示すように、 最初に &lt;code>RootDialog&lt;/code> による選択肢が表示され、次に &lt;code>GreetDialog&lt;/code> の処理に遷移し、最後に &lt;code>RootDialog&lt;/code> に戻ってくるという流れです。&lt;/p>


&lt;figure class="xImage">
 &lt;img style="" width="422" height="674" src="../../p/6arjar6/dialog-stack-002.png" alt="/p/6arjar6/dialog-stack-002.png" />
 &lt;figcaption>図: チャットのイメージ&lt;/figcaption>
&lt;/figure>

&lt;p>下記は、最初に起動される &lt;code>RootDialog&lt;/code> クラスの実装です。
&lt;a href="../../p/w36evii">前回の説明&lt;/a> で使用した &lt;code>DialogBot&lt;/code> クラスを使って &lt;code>RootDialog&lt;/code> を起動することを想定しています。
ウォーターフォールダイアログの最初のステップ (&lt;code>_step1&lt;/code>) として、ユーザーに選択肢を提示し、「挨拶する」を選んだ場合に、&lt;code>GreetDialog&lt;/code> を新たに起動するようにしています。&lt;/p>

&lt;figure class="xCodeBlock">
&lt;figcaption class="xCodeBlock_title">dialogs/rootDialog.js&lt;/figcaption>
&lt;div class="xCodeBlock_code">&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-js" data-lang="js">&lt;span class="line">&lt;span class="cl">&lt;span class="kr">const&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">ChoiceFactory&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">ChoicePrompt&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">ComponentDialog&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">ListStyle&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">WaterfallDialog&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nx">require&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s1">&amp;#39;botbuilder-dialogs&amp;#39;&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kr">const&lt;/span> &lt;span class="p">{&lt;/span> &lt;span class="nx">GreetDialog&lt;/span> &lt;span class="p">}&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nx">require&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s1">&amp;#39;./greetDialog.js&amp;#39;&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="cm">/**
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="cm"> * 会話のエントリポイントとなるルートダイアログ。
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="cm"> */&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nx">exports&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">RootDialog&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="kr">class&lt;/span> &lt;span class="nx">RootDialog&lt;/span> &lt;span class="kr">extends&lt;/span> &lt;span class="nx">ComponentDialog&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">constructor&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kr">super&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s1">&amp;#39;RootDialog&amp;#39;&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">// Create dialog instances
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="k">this&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">greetDialog&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="k">new&lt;/span> &lt;span class="nx">GreetDialog&lt;/span>&lt;span class="p">();&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">this&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">choicePrompt&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="k">new&lt;/span> &lt;span class="nx">ChoicePrompt&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s1">&amp;#39;choicePrompt&amp;#39;&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">this&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">choicePrompt&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">style&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nx">ListStyle&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">heroCard&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">// Add control flow dialogs and prompts
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="k">this&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">addDialog&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="k">new&lt;/span> &lt;span class="nx">WaterfallDialog&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s1">&amp;#39;start&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="p">[&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">this&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">_step1&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">bind&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="k">this&lt;/span>&lt;span class="p">),&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">this&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">_step2&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">bind&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="k">this&lt;/span>&lt;span class="p">),&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">this&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">_step3&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">bind&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="k">this&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">]));&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">this&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">addDialog&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="k">this&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">greetDialog&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">this&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">addDialog&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="k">this&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">choicePrompt&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kr">async&lt;/span> &lt;span class="nx">_step1&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">step&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="kr">await&lt;/span> &lt;span class="nx">step&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">prompt&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="k">this&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">choicePrompt&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">id&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">prompt&lt;/span>&lt;span class="o">:&lt;/span> &lt;span class="s1">&amp;#39;やりたいことを選んでね。&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">choices&lt;/span>&lt;span class="o">:&lt;/span> &lt;span class="nx">ChoiceFactory&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">toChoices&lt;/span>&lt;span class="p">([&lt;/span>&lt;span class="s1">&amp;#39;挨拶する&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s1">&amp;#39;バイバイ&amp;#39;&lt;/span>&lt;span class="p">])&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">});&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kr">async&lt;/span> &lt;span class="nx">_step2&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">step&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kr">const&lt;/span> &lt;span class="nx">text&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nx">step&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">result&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">value&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kr">const&lt;/span> &lt;span class="nx">ctx&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nx">step&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">context&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">text&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">match&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="sr">/挨拶/&lt;/span>&lt;span class="p">))&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="kr">await&lt;/span> &lt;span class="nx">step&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">beginDialog&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="k">this&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">greetDialog&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">id&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span> &lt;span class="k">else&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kr">await&lt;/span> &lt;span class="nx">ctx&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">sendActivity&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s1">&amp;#39;さようなら&amp;#39;&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="kr">await&lt;/span> &lt;span class="nx">step&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">endDialog&lt;/span>&lt;span class="p">();&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kr">async&lt;/span> &lt;span class="nx">_step3&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">step&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kr">const&lt;/span> &lt;span class="nx">ctx&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nx">step&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">context&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kr">await&lt;/span> &lt;span class="nx">ctx&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">sendActivity&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s1">&amp;#39;また来てね&amp;#39;&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="kr">await&lt;/span> &lt;span class="nx">step&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">endDialog&lt;/span>&lt;span class="p">();&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">};&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/div>
&lt;/figure>

&lt;p>下記は、&lt;code>RootDialog&lt;/code> から起動される（スタックに積まれる） &lt;code>GreetDialog&lt;/code> の実装です。
ユーザーに名前の入力を促し、ユーザーに対して挨拶をしたらダイアログを終了します。&lt;/p></description></item><item><title>チャットボット: Bot Builder SDK で画像やリストなどのリッチなメッセージを送る (MessageFactory)</title><link>https://maku.blog/p/q7vw95i/</link><pubDate>Thu, 04 Jul 2019 00:00:00 +0900</pubDate><guid>https://maku.blog/p/q7vw95i/</guid><description>&lt;h2 id="activity-オブジェクトと-messagefactory">Activity オブジェクトと MessageFactory&lt;/h2>
&lt;p>Bot Builder SDK によるボット実装において、ユーザーにメッセージを送るには &lt;a href="https://github.com/microsoft/botbuilder-js/blob/master/libraries/botbuilder-core/src/turnContext.ts">TurnContext クラス&lt;/a> の &lt;code>sendActivity()&lt;/code> メソッドを使用します。
下記は、単純なテキストメッセージを送る例です。&lt;/p>

&lt;figure class="xCodeBlock">

&lt;div class="xCodeBlock_code">&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-js" data-lang="js">&lt;span class="line">&lt;span class="cl">&lt;span class="kr">await&lt;/span> &lt;span class="nx">context&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">sendActivity&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s1">&amp;#39;Hello!&amp;#39;&lt;/span>&lt;span class="p">);&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/div>
&lt;/figure>



&lt;figure class="xImage">
 &lt;img style="border: solid #ccc 2px;" width="316" height="192" src="../../p/q7vw95i/message-factory-001.png" alt="/p/q7vw95i/message-factory-001.png" />
&lt;/figure>

&lt;p>&lt;code>sendActivity()&lt;/code> の第一引数には、このように文字列を渡すことができますが、その名の通り &lt;strong>&lt;code>Activity&lt;/code> オブジェクトを渡すこともできる&lt;/strong>ようになっています。
&lt;code>Activity&lt;/code> オブジェクトを使うと、単純なテキストよりもリッチな形式で表示を行うことができます（どう表示されるかは各チャンネルの実装によりますが）。&lt;/p>
&lt;p>&lt;code>Activity&lt;/code> インタフェースは &lt;a href="https://github.com/microsoft/botbuilder-js/blob/master/libraries/botframework-schema/src/index.ts">botframework-schema モジュール&lt;/a> で定義されていますが、このインタフェースを意識してオブジェクトを作成することはあまりありません。
というのも、いろいろな用途の &lt;code>Activity&lt;/code> オブジェクトを生成するためのファクトリーである &lt;a href="https://github.com/microsoft/botbuilder-js/blob/master/libraries/botbuilder-core/src/messageFactory.ts">MessageFactory クラス&lt;/a> が用意されているからです。&lt;/p>
&lt;p>例えば、&lt;code>MessageFactory#text()&lt;/code> は単純なテキストメッセージを送るための &lt;code>Activity&lt;/code> オブジェクトを生成します。&lt;/p>

&lt;figure class="xCodeBlock">

&lt;div class="xCodeBlock_code">&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-js" data-lang="js">&lt;span class="line">&lt;span class="cl">&lt;span class="c1">// const { MessageFactory } = require(&amp;#39;botbuilder&amp;#39;);
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>&lt;span class="kr">const&lt;/span> &lt;span class="nx">msg&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nx">MessageFactory&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">text&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s1">&amp;#39;Hello!&amp;#39;&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kr">await&lt;/span> &lt;span class="nx">context&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">sendActivity&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">msg&lt;/span>&lt;span class="p">);&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/div>
&lt;/figure>

&lt;p>これは実は下記のようにするのと同じです。&lt;/p>

&lt;figure class="xCodeBlock">

&lt;div class="xCodeBlock_code">&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-js" data-lang="js">&lt;span class="line">&lt;span class="cl">&lt;span class="kr">await&lt;/span> &lt;span class="nx">context&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">sendActivity&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s1">&amp;#39;Hello!&amp;#39;&lt;/span>&lt;span class="p">);&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/div>
&lt;/figure>

&lt;p>&lt;code>TurnContext#sendActivity()&lt;/code> に直接文字列を渡した場合は、内部で前者のような &lt;code>MessageFactory.text()&lt;/code> による &lt;code>Activity&lt;/code> 生成が行われています。
単純なテキストを送るだけであれば、&lt;code>sendActivity('Hello')&lt;/code> としてしまうのが早いでしょう。&lt;/p>
&lt;h2 id="messagefactory-でリッチなメッセージを作成する">MessageFactory でリッチなメッセージを作成する&lt;/h2>
&lt;p>&lt;code>MessageFactory&lt;/code> が提供するファクトリメソッドを使って、リッチなメッセージを送る例をいくつか紹介します。
ここでは、Bot Framework Emulator の表示例を載せておきます。&lt;/p>
&lt;h3 id="画像動画を表示する----contenturl">画像・動画を表示する -- contentUrl()&lt;/h3>


&lt;figure class="xImage">
 &lt;img style="border: solid #ccc 2px;" width="316" height="377" src="../../p/q7vw95i/message-factory-002.png" alt="/p/q7vw95i/message-factory-002.png" />
&lt;/figure>


&lt;figure class="xCodeBlock">

&lt;div class="xCodeBlock_code">&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-js" data-lang="js">&lt;span class="line">&lt;span class="cl">&lt;span class="kr">const&lt;/span> &lt;span class="nx">msg&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nx">MessageFactory&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">contentUrl&lt;/span>&lt;span class="p">(&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="s1">&amp;#39;https://maku.blog/assets/img/site-logo.png&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="c1">// 画像や動画のURL
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="s1">&amp;#39;image/png&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="c1">// 画像や動画のMIMEタイプ
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="s1">&amp;#39;タイトル&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="c1">// タイトル（画像が見つからないときの代替テキスト）
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="s1">&amp;#39;説明文&amp;#39;&lt;/span> &lt;span class="c1">// 説明文（オプション）
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kr">await&lt;/span> &lt;span class="nx">context&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">sendActivity&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">msg&lt;/span>&lt;span class="p">);&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/div>
&lt;/figure>

&lt;p>上記の例では png 画像を表示していますが、mp4 などの動画を指定することもできます。
Youtube のアドレスをそのまま記述してもいいみたいです。&lt;/p></description></item><item><title>チャットボット: 独自のミドルウェアを作成してログを記録する</title><link>https://maku.blog/p/fn3amda/</link><pubDate>Tue, 23 Jul 2019 00:00:00 +0900</pubDate><guid>https://maku.blog/p/fn3amda/</guid><description>&lt;h2 id="ミドルウェアとは">ミドルウェアとは&lt;/h2>
&lt;p>Bot Framework において、クライアントから受信したメッセージはアダプターを介してボットに届けられますが、アダプターにミドルウェアを設定しておくことで、メッセージがボットに届く前に割り込んで処理を行うことができます。&lt;/p>
&lt;div style="text-align:center; font-weight:bold;">Adapter → Middleware1 → Middleware2 → Middleware3 → ... → YourBot&lt;/div>
&lt;p>ミドルウェアは上記のように複数登録することができ、登録された順に呼び出されていきます。
アダプターにミドルウェアを追加するには、&lt;strong>&lt;code>BotFrameworkAdapter#use()&lt;/code>&lt;/strong> メソッドを使用します。&lt;/p>

&lt;figure class="xCodeBlock">
&lt;figcaption class="xCodeBlock_title">ミドルウェアの追加&lt;/figcaption>
&lt;div class="xCodeBlock_code">&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-js" data-lang="js">&lt;span class="line">&lt;span class="cl">&lt;span class="kr">const&lt;/span> &lt;span class="p">{&lt;/span> &lt;span class="nx">BotFrameworkAdapter&lt;/span> &lt;span class="p">}&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nx">require&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s1">&amp;#39;botbuilder&amp;#39;&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kr">const&lt;/span> &lt;span class="nx">adpater&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="k">new&lt;/span> &lt;span class="nx">BotFrameworkAdapter&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">endpoint&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nx">adapter&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">use&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="k">new&lt;/span> &lt;span class="nx">Middleware1&lt;/span>&lt;span class="p">());&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nx">adapter&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">use&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="k">new&lt;/span> &lt;span class="nx">Middleware2&lt;/span>&lt;span class="p">());&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nx">adapter&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">use&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="k">new&lt;/span> &lt;span class="nx">Middleware3&lt;/span>&lt;span class="p">());&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/div>
&lt;/figure>

&lt;h2 id="ミドルウェアを実装する">ミドルウェアを実装する&lt;/h2>
&lt;p>独自のミドルウェアを作成するには、&lt;a href="https://docs.microsoft.com/ja-jp/javascript/api/botbuilder-core/middleware?view=botbuilder-ts-latest">Middleware インタフェース&lt;/a> が提供する &lt;strong>&lt;code>onTurn&lt;/code>&lt;/strong> メソッドを実装します。&lt;/p>
&lt;p>ここでは、ユーザーの入力をコンソールに出力するだけの &lt;code>ConsoleLogger&lt;/code> というミドルウェアクラスを実装してみます。&lt;/p>

&lt;figure class="xCodeBlock">
&lt;figcaption class="xCodeBlock_title">middlewares/consoleLogger.js&lt;/figcaption>
&lt;div class="xCodeBlock_code">&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-js" data-lang="js">&lt;span class="line">&lt;span class="cl">&lt;span class="nx">exports&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">ConsoleLogger&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="kr">class&lt;/span> &lt;span class="nx">ConsoleLogger&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kr">async&lt;/span> &lt;span class="nx">onTurn&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">context&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">next&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">context&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">activity&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">type&lt;/span> &lt;span class="o">===&lt;/span> &lt;span class="s2">&amp;#34;message&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">console&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">log&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">context&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">activity&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">text&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kr">await&lt;/span> &lt;span class="nx">next&lt;/span>&lt;span class="p">();&lt;/span> &lt;span class="c1">// Invoke a next middleware
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">};&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/div>
&lt;/figure>

&lt;p>とても簡単ですね。
あと、&lt;code>onTurn()&lt;/code> を抜ける前に忘れずに &lt;strong>&lt;code>next()&lt;/code>&lt;/strong> を呼び出して、後続のミドルウェアが正しく呼び出されるようにしておく必要があります。&lt;/p>
&lt;p>このミドルウェアをアダプターに登録するには次のようにします。&lt;/p>

&lt;figure class="xCodeBlock">

&lt;div class="xCodeBlock_code">&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-js" data-lang="js">&lt;span class="line">&lt;span class="cl">&lt;span class="c1">// const { ConsoleLogger } = require(&amp;#39;./middlewares/consoleLogger.js&amp;#39;);
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kr">const&lt;/span> &lt;span class="nx">adapter&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="k">new&lt;/span> &lt;span class="nx">BotFrameworkAdapter&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">botEndpoint&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nx">adapter&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">use&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="k">new&lt;/span> &lt;span class="nx">ConsoleLogger&lt;/span>&lt;span class="p">());&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/div>
&lt;/figure>

&lt;p>これで、ユーザーがチャットクライアント（チャンネル）から &lt;code>こんにちは&lt;/code> と入力すると、ボットサーバー側のコンソールに &lt;code>こんにちは&lt;/code> と出力されるようになります。&lt;/p>
&lt;p>ちなみに、上記のミドルウェアを TypeScript で実装すると下記のような感じになります。&lt;/p>

&lt;figure class="xCodeBlock">
&lt;figcaption class="xCodeBlock_title">./middlewares/consoleLogger.ts&lt;/figcaption>
&lt;div class="xCodeBlock_code">&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-typescript" data-lang="typescript">&lt;span class="line">&lt;span class="cl">&lt;span class="kr">import&lt;/span> &lt;span class="p">{&lt;/span> &lt;span class="nx">Middleware&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">TurnContext&lt;/span> &lt;span class="p">}&lt;/span> &lt;span class="kr">from&lt;/span> &lt;span class="s2">&amp;#34;botbuilder&amp;#34;&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kr">export&lt;/span> &lt;span class="kr">class&lt;/span> &lt;span class="nx">ConsoleLogger&lt;/span> &lt;span class="kr">implements&lt;/span> &lt;span class="nx">Middleware&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kr">public&lt;/span> &lt;span class="kr">async&lt;/span> &lt;span class="nx">onTurn&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">context&lt;/span>: &lt;span class="kt">TurnContext&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">next&lt;/span>&lt;span class="o">:&lt;/span> &lt;span class="p">()&lt;/span> &lt;span class="o">=&amp;gt;&lt;/span> &lt;span class="nx">Promise&lt;/span>&lt;span class="p">&amp;lt;&lt;/span>&lt;span class="nt">void&lt;/span>&lt;span class="p">&amp;gt;)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">context&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">activity&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="kr">type&lt;/span> &lt;span class="o">===&lt;/span> &lt;span class="s1">&amp;#39;message&amp;#39;&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">console&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">log&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">context&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">activity&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">text&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">await&lt;/span> &lt;span class="nx">next&lt;/span>&lt;span class="p">();&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/div>
&lt;/figure>

&lt;h2 id="botbuilder-sdk-組み込まれているロギング用ミドルウェアを使用する">BotBuilder SDK 組み込まれているロギング用ミドルウェアを使用する&lt;/h2>
&lt;h3 id="transcriptloggermiddleware-を使う">TranscriptLoggerMiddleware を使う&lt;/h3>
&lt;p>BotBuilder SDK の &lt;code>botbuilder&lt;/code> モジュールには、組み込みのロギング用ミドルウェアとして &lt;strong>&lt;code>TranscriptLoggerMiddleware&lt;/code>&lt;/strong> が含まれています。&lt;/p></description></item><item><title>チャットボット: 独自のミドルウェアを作成して禁止ワードを拒否するようにする</title><link>https://maku.blog/p/gt9g2na/</link><pubDate>Tue, 23 Jul 2019 00:00:00 +0900</pubDate><guid>https://maku.blog/p/gt9g2na/</guid><description>&lt;p>&lt;a href="../../p/fn3amda">前回の記事&lt;/a> では、チャットボットに独自のミドルウェアを追加して、ユーザー入力をログ出力できるようにしました。
今回は、ユーザーが NG ワードを入力したときに、警告を表示して処理を中断するようなミドルウェアを作成してみます。&lt;/p>
&lt;p>その名も &lt;strong>&lt;code>NgWordMiddleware&lt;/code>&lt;/strong> です！&lt;/p>

&lt;figure class="xCodeBlock">
&lt;figcaption class="xCodeBlock_title">middlewares/NgWordMiddleware.js&lt;/figcaption>
&lt;div class="xCodeBlock_code">&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-js" data-lang="js">&lt;span class="line">&lt;span class="cl">&lt;span class="kr">const&lt;/span> &lt;span class="nx">NG_WORDS&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="sr">/アホ|まぬけ|バカ/&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nx">exports&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">NgWordMiddleware&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="kr">class&lt;/span> &lt;span class="nx">NgWordMiddleware&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kr">async&lt;/span> &lt;span class="nx">onTurn&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">context&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">next&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">context&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">activity&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">type&lt;/span> &lt;span class="o">===&lt;/span> &lt;span class="s1">&amp;#39;message&amp;#39;&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kr">const&lt;/span> &lt;span class="nx">line&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nx">context&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">activity&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">text&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">NG_WORDS&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">test&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">line&lt;/span>&lt;span class="p">))&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kr">await&lt;/span> &lt;span class="nx">context&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">sendActivity&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s1">&amp;#39;そんなこと言っちゃダメ&amp;#39;&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kr">await&lt;/span> &lt;span class="nx">next&lt;/span>&lt;span class="p">();&lt;/span> &lt;span class="c1">// Invoke a next middleware
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">};&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/div>
&lt;/figure>

&lt;p>上記の例では、&lt;code>NG_WORDS&lt;/code> 定数に、禁止語句を正規表現の形で登録しています。
ユーザーが入力したテキストに、禁止語句が含まれていたら、「そんなこと言っちゃダメ」と返事して処理を進めないようにします（&lt;code>next()&lt;/code> を呼び出さないことで後続の処理を打ち切る）。&lt;/p>
&lt;p>このミドルウェアは、下記のようにアダプターに追加することで有効化できます。&lt;/p>

&lt;figure class="xCodeBlock">

&lt;div class="xCodeBlock_code">&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-js" data-lang="js">&lt;span class="line">&lt;span class="cl">&lt;span class="c1">// const { NgWordMiddleware } = require(&amp;#39;./middlewares/ngWordMiddleware.js&amp;#39;);
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kr">const&lt;/span> &lt;span class="nx">adapter&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="k">new&lt;/span> &lt;span class="nx">BotFrameworkAdapter&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">botEndpoint&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nx">adapter&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">use&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="k">new&lt;/span> &lt;span class="nx">NgWordMiddleware&lt;/span>&lt;span class="p">());&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/div>
&lt;/figure>



&lt;figure class="xImage">
 &lt;img style="" width="342" height="194" src="../../p/gt9g2na/middleware2-001.png" alt="/p/gt9g2na/middleware2-001.png" />
&lt;/figure>

&lt;p>この例では、単純に禁止語句が含まれているかだけをチェックしているので、「バカルディ」と入力した場合にも弾かれてしまいます。
このあたりは工夫して処理しなきゃですね。&lt;/p></description></item><item><title>LUIS (1) LUIS とは？</title><link>https://maku.blog/p/mkwnnsz/</link><pubDate>Wed, 13 Mar 2019 00:00:00 +0900</pubDate><guid>https://maku.blog/p/mkwnnsz/</guid><description>&lt;h2 id="luis-でできること">LUIS でできること&lt;/h2>
&lt;p>Microsoft が提供している LUIS (Language Understanding Intelligent Service) サービスを使用すると、&lt;strong>自然言語による文章（発話テキスト）を、コンピュータが理解しやすい形式に翻訳&lt;/strong>することができます。
主にチャットボットのバックエンドとして使用されることが想定されているようです。&lt;/p>


&lt;figure class="xImage">
 &lt;img style="border: solid #ccc 2px;" width="500" height="248" src="../../p/mkwnnsz/about_hu4502758311235892470.png" alt="/p/mkwnnsz/about.png" />
&lt;/figure>

&lt;ul>
&lt;li>&lt;a href="https://www.luis.ai/">LUIS (Language Understanding) - Cognitive Services - Microsoft Azure&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://westus.dev.cognitive.microsoft.com/docs/services/5819c76f40a6350ce09de1ac/operations/5819c77140a63516d81aee78">LUIS - Endpoint API&lt;/a> メインのクエリ用 REST API&lt;/li>
&lt;li>&lt;a href="https://westus.dev.cognitive.microsoft.com/docs/services/5890b47c39e2bb17b84a55ff/operations/5890b47c39e2bb052c5b9c2f">LUIS - Authoring API&lt;/a> アプリ管理用の REST API&lt;/li>
&lt;/ul>
&lt;p>LUIS は、入力した発話テキストを&lt;strong>インテントとエンティティ&lt;/strong>に分解します。&lt;/p>
&lt;ul>
&lt;li>&lt;b>インテント&lt;/b> … 意図、目的。ユーザが何をしたいのかを表す。&lt;/li>
&lt;li>&lt;b>エンティティ&lt;/b> … 文章の中のプレースホルダに当たる部分の値。求めているものや、条件などを示す部分。&lt;/li>
&lt;/ul>
&lt;p>例えば、下記のような入力テキストがあったとすると、&lt;/p>
&lt;pre tabindex="0">&lt;code>15時から4人で使える部屋はない？
&lt;/code>&lt;/pre>&lt;p>LUIS は次のようなインテント＋エンティティの情報に翻訳します。&lt;/p>
&lt;ul>
&lt;li>&lt;b>インテント&lt;/b>: SearchMeetingRoom&lt;/li>
&lt;li>&lt;b>エンティティ&lt;/b>: Time=15時、People=4人&lt;/li>
&lt;/ul>
&lt;p>チャットボットのプログラムは、この翻訳された情報を見て、「ミーティングルームを探す」処理を、パラメータ「15時」、「4人」で行えばよいことになります。
LUIS は上記のような翻訳処理を行うためのサービスなので、その先のミーティングルームの検索処理などは独自に実装する必要があります。&lt;/p>
&lt;p>LUIS の Web サイト上では、このような発話例 (Utterance) と、インテント、エンティティの情報を登録していくことで、モデルの学習を進めることができます。&lt;/p>
&lt;h2 id="luis-のモデルを公開する">LUIS のモデルを公開する&lt;/h2>
&lt;p>LUIS ポータル上で作成した自然言語解析のモデルを、Web API (REST API) の形で使用できるようにするには、下記のようなステップを踏みます（&lt;a href="../../p/2t6xrbm">QnA Maker&lt;/a> のサービスと同様の手順です）。&lt;/p></description></item><item><title>LUIS (2) LUIS のオーサリングキー、エンドポイントキーとは</title><link>https://maku.blog/p/mdyedwq/</link><pubDate>Thu, 14 Mar 2019 00:00:00 +0900</pubDate><guid>https://maku.blog/p/mdyedwq/</guid><description>&lt;p>LUIS アプリで使用するキーの種類には、&lt;strong>オーサリングキー (Authoring Key)&lt;/strong> と&lt;strong>エンドポイントキー (Endpoint Key)&lt;/strong> の 2 種類があります。&lt;/p>
&lt;h2 id="オーサリングキー-authoring-key">オーサリングキー (Authoring Key)&lt;/h2>
&lt;p>オーサリングキーは LUIS アカウントの作成時に自動的に作成される、無料のキーです。
オーサリングキーはリージョン内で共通であり、1 つだけ作成されます。
最初に作成されるので、&lt;strong>スターターキー (Starter Key)&lt;/strong>、&lt;strong>作成者キー&lt;/strong>とも呼ばれます。&lt;/p>
&lt;p>オーサリングキーは、LUIS アカウントに結び付けられているので、LUIS 右上のアカウント名をクリックし、&lt;samp>Settings&lt;/samp> を選択することで確認できるようになっています。&lt;/p>


&lt;figure class="xImage">
 &lt;img style="border: solid #ccc 2px;" width="500" height="201" src="../../p/mdyedwq/keys-authoring_hu17279724544393363218.png" alt="/p/mdyedwq/keys-authoring.png" />
&lt;/figure>

&lt;p>オーサリングキーは、&lt;strong>LUIS アプリ自体の作成や、公開、コラボレーターの管理、バージョン管理など&lt;/strong>を行うときに必要になります。
つまり、あなたが作成する LUIS アプリの管理用のキーであり、LUIS の Web サイトで行えることほぼすべてをこのキーを使ったオーサリング API 経由で行えます。&lt;/p>
&lt;p>LUIS ポータル上にログインして作業している間は、オーサリングキーの存在を意識しなくても LUIS アプリの管理を行うことができますが、&lt;strong>Web API を使って LUIS アプリの管理作業を自動化したいときなどにオーサリングキーが必要&lt;/strong>になります。&lt;/p>
&lt;p>作成した個々の LUIS アプリに対するクエリ実行のためにもオーサリングキーを使用できますが、これは実装中のテスト用途に限られます（権限の強いオーサリングキーを、公開アプリからのクエリ用途に使うのは避けるべきです）。
実運用でのクエリ実行は、後述のエンドポイントキーを使用します。&lt;/p>
&lt;p>ちなみに、オーサリングキーは Microsoft のユーザアカウントごとに割り当てられるものです。
LUIS アプリのコラボレータとして登録されたユーザは、自分のオーサリングキーを使って LUIS アプリの管理を行います。&lt;/p>
&lt;h2 id="エンドポイントキー-endpoint-key">エンドポイントキー (Endpoint Key)&lt;/h2>
&lt;p>運用環境で LUIS アプリに対するクエリ実行を行うには、Azure の LUIS リソースとして作成されたエンドポイント URL とエンドポイントキーを使用します。
&lt;a href="https://portal.azure.com/">Azure ポータル&lt;/a> にログインして、LUIS リソースを作成することでエンドポイントキーを取得できます。&lt;/p></description></item><item><title>LUIS (3) Node.js から LUIS の API を利用する</title><link>https://maku.blog/p/tewj3gs/</link><pubDate>Thu, 14 Mar 2019 00:00:00 +0900</pubDate><guid>https://maku.blog/p/tewj3gs/</guid><description>&lt;h2 id="luis-api-を呼び出すためのエンドポイント情報を調べる">LUIS API を呼び出すためのエンドポイント情報を調べる&lt;/h2>
&lt;h3 id="luis-アプリの-publish">LUIS アプリの Publish&lt;/h3>
&lt;p>REST API 経由で LUIS アプリによる発話解析を行うには、LUIS ポータル上で対象の LUIS アプリを &lt;samp>Train&lt;/samp> し、&lt;samp>Publish&lt;/samp> しておく必要があります（LUIS アプリというのは、いわゆる訓練されたモデルのことだと考えるとよいです）。&lt;/p>


&lt;figure class="xImage">
 &lt;img style="border: solid #ccc 2px;" width="600" height="277" src="../../p/tewj3gs/luis-from-nodejs_hu13038768852223937414.png" alt="/p/tewj3gs/luis-from-nodejs.png" />
&lt;/figure>

&lt;h3 id="api-実行用のエンドポイント-url-とキーを確認する">API 実行用のエンドポイント URL とキーを確認する&lt;/h3>
&lt;p>Publish 処理が完了すると、&lt;strong>エンドポイント URL&lt;/strong> と &lt;strong>エンドポイントキー (Endpoint key)&lt;/strong> を使って、LUIS アプリに対してクエリ要求を投げることができるようになります。
テスト用途であれば、LUIS ポータル上で最初に作成される &lt;strong>オーサリングキー (Authoring key)&lt;/strong> でもクエリを実行できますが、最終的なユーザ環境でのクエリ実行には Azure 上で作成したリソースに付けられたエンドポイント URL とエンドポイントキーのペアを使用する必要があります。&lt;/p>
&lt;ul>
&lt;li>参考: &lt;a href="../../p/mdyedwq">オーサリングキー、エンドポイントキーとは&lt;/a>&lt;/li>
&lt;/ul>
&lt;p>LUIS の REST API を呼び出すための URL は、下記のような情報から構成されています（下記例の ID はデタラメです）。&lt;/p>
&lt;ul>
&lt;li>Application ID: &lt;code>5c548551-f6ba-4fc8-c695-529ac194317d&lt;/code>&lt;/li>
&lt;li>Application version: &lt;code>0.1&lt;/code>&lt;/li>
&lt;li>エンドポイントキー: &lt;code>ff824a1409f929c8e2a15301ccff431d&lt;/code>&lt;/li>
&lt;/ul>
&lt;p>Application ID と Application version は、&lt;samp>MANAGE&lt;/samp> タブの &lt;samp>Application Information&lt;/samp> のページで確認することができます。&lt;/p></description></item><item><title>LUIS (4) botbuilder-ai ライブラリを使って LUIS の API を利用する</title><link>https://maku.blog/p/dtwckb9/</link><pubDate>Thu, 18 Apr 2019 00:00:00 +0900</pubDate><guid>https://maku.blog/p/dtwckb9/</guid><description>&lt;p>&lt;a href="../../p/tewj3gs">こちらの記事（Node.js から LUIS の API を利用する）&lt;/a> では、自力で LUIS の REST API を呼び出すための URL を構築していました。
ここでは、&lt;strong>&lt;code>botbuilder-ai&lt;/code>&lt;/strong> パッケージを使用して、もっと手軽に LUIS の機能を呼び出してみます。&lt;/p>
&lt;div class="xNote">
 &lt;span class="xNote_title">☝️ ワンポイント&lt;/span>
 &lt;span class="xNote_body">残念ながら &lt;code>botbuilder-ai&lt;/code> が提供している &lt;code>LuisRecognizer&lt;/code> などのクラスは、チャットボットの実装に使用する &lt;code>TurnContext&lt;/code> オブジェクトに依存した設計になっています。
そのため、単純なコンソールアプリケーションから &lt;code>botbuilder-ai&lt;/code> パッケージを使用することは難しく、チャットボットの実装でしか利用できません。&lt;/span>
&lt;/div>

&lt;h2 id="luis-のエンドポイント情報接続情報を確認しておく">LUIS のエンドポイント情報（接続情報）を確認しておく&lt;/h2>
&lt;p>LUIS API を使用するには、下記のような LUIS アプリの APP ID やエンドポイント情報が必要です。&lt;/p>
&lt;ul>
&lt;li>&lt;b>APP ID:&lt;/b> &lt;code>c39eb4df-fbcf-224f-b8b7-a0ee445d11b3&lt;/code>&lt;/li>
&lt;li>&lt;b>エンドポイント:&lt;/b> &lt;code>https://japaneast.api.cognitive.microsoft.com&lt;/code>&lt;/li>
&lt;li>&lt;b>エンドポイントキー（サブスクリプションキー）:&lt;/b> &lt;code>c9162c5c0b5edff5270feb6145618acb&lt;/code>&lt;/li>
&lt;/ul>
&lt;p>APP ID とエンドポイントキーは、&lt;a href="https://luis.ai/">LUIS ポータル&lt;/a> から対象のアプリケーションを開き、下記のように確認できます。&lt;/p>
&lt;ul>
&lt;li>&lt;b>APP ID:&lt;/b> &lt;samp>MANAGE&lt;/samp>タブ → &lt;samp>Application Information&lt;/samp>&lt;/li>
&lt;li>&lt;b>エンドポイント:&lt;/b> &lt;samp>MANAGE&lt;/samp>タブ → &lt;samp>Keys and Endpoints&lt;/samp> → &lt;samp>Endpoint&lt;/samp> カラムの URL の前半部分。&lt;/li>
&lt;li>&lt;b>エンドポイントキー:&lt;/b> &lt;samp>MANAGE&lt;/samp>タブ → &lt;samp>Keys and Endpoints&lt;/samp> → &lt;samp>Key 1&lt;/samp> カラム&lt;/li>
&lt;/ul>
&lt;p>LUIS のエンドポイントキーは、&lt;a href="https://portal.azure.com/">Azure ポータル&lt;/a> に作成した &lt;samp>LUIS リソース&lt;/samp> の &lt;samp>キー&lt;/samp> の項目に表示されるものと同じです。
念のため、同一のものが表示されているか確認しておくとよいでしょう。&lt;/p></description></item><item><title>QnA Maker (1) QnA Maker とは？</title><link>https://maku.blog/p/2t6xrbm/</link><pubDate>Thu, 28 Feb 2019 00:00:00 +0900</pubDate><guid>https://maku.blog/p/2t6xrbm/</guid><description>&lt;h2 id="qna-maker-でできること">QnA Maker でできること&lt;/h2>
&lt;p>Microsoft が提供している QnA Maker というサービスを使用すると、「質問(Q)と回答(A)」のペアデータを登録するだけで、自然言語での FAQ 検索を行うための API を使用できるようになります。
Microsoft が提供している一連の Cognitive Service のひとつとして位置づけられていて、主に FAQ 系のチャットボット (Bot) を手軽に作成するために使用されています。&lt;/p>


&lt;figure class="xImage">
 &lt;img style="border: solid #ccc 2px;" width="500" height="268" src="../../p/2t6xrbm/about_hu6783194202617189249.png" alt="/p/2t6xrbm/about.png" />
&lt;/figure>

&lt;ul>
&lt;li>&lt;a href="https://www.qnamaker.ai">QnA Maker&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://docs.microsoft.com/en-us/azure/cognitive-services/qnamaker/">QnA Maker Documentation&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://westus.dev.cognitive.microsoft.com/docs/services/5a93fcf85b4ccd136866eb37/operations/5ac266295b4ccd1554da75ff">QnA Maker REST API V4.0&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://docs.microsoft.com/en-us/javascript/api/botbuilder-ai/qnamaker?view=botbuilder-ts-latest">QnAMaker class | Microsoft Docs&lt;/a>&lt;/li>
&lt;/ul>
&lt;p>例えば、下記のような Q&amp;amp;A のペアを登録していくだけで、機械学習によって回答のモデルが自動生成されます。
QnA Maker では、このモデルのことを&lt;strong>ナレッジベース (Knowledge base)&lt;/strong> と呼んでいます。&lt;/p>
&lt;pre tabindex="0">&lt;code>Q. お店の営業時間を教えてください。
A. 営業時間は午前10時から午後6時までです。
&lt;/code>&lt;/pre>&lt;p>実際にユーザが入力する質問文章は、登録した Q&amp;amp;A データの質問文と完全に一致する必要はありません。
QnA Maker がどの質問に近いかを判別して、対応する回答文（と一致度）を返してくれます。&lt;/p>
&lt;pre tabindex="0">&lt;code>ユーザ入力: 営業時間は？
QnA Makerの回答: 営業時間は午前10時から午後6時までです。
&lt;/code>&lt;/pre>&lt;p>簡単に言ってしまえば、QnA Maker の API が提供する機能はこれだけです（データ管理用の API などもありますが）。
回答文を自動生成してくれるようなこともなく、返される文章は、Q&amp;amp;A データとして登録した回答文そのままです。
とはいえ、サクッと FAQ 系のサービスを作成するときには便利に使用できるサービスです。&lt;/p></description></item><item><title>QnA Maker (2) QnA Maker のサブスクリプションキー、エンドポイントキーとは</title><link>https://maku.blog/p/t6n6jc8/</link><pubDate>Mon, 18 Mar 2019 00:00:00 +0900</pubDate><guid>https://maku.blog/p/t6n6jc8/</guid><description>&lt;h2 id="サブスクリプションキー-subscription-key">サブスクリプションキー (Subscription Key)&lt;/h2>
&lt;p>&lt;strong>サブスクリプションキー&lt;/strong>は、QnA Maker アプリ自体の作成や編集を行うためのキーです。
後述のエンドポイントキーよりも厳重に管理しなければならないキーです。&lt;/p>
&lt;p>このキーは、&lt;a href="https://portal.azure.com/">Azure ポータル&lt;/a>上で QnA Maker のリソースを作成した際に生成されます。
QnA Maker アプリは、Azure 上にリソースを作ってからでないと作成できないため、QnA Maker アプリがすでに存在するのであれば、サブスクリプションキーも必ず存在することになります。&lt;/p>
&lt;p>Azule の QnA Maker リソースに割り当てられたサブスクリプションキーは、Azure ポータルの &lt;samp>QnA Maker&lt;/samp> リソースの &lt;samp>Keys&lt;/samp> のページで確認することができます。&lt;/p>


&lt;figure class="xImage">
 &lt;img style="border: solid #ccc 2px;" width="700" height="270" src="../../p/t6n6jc8/keys-azure_hu4122163940690173543.png" alt="/p/t6n6jc8/keys-azure.png" />
 &lt;figcaption>図: Azure ポータル上での QnA Maker のサブスクリプションキーの確認&lt;/figcaption>
&lt;/figure>

&lt;p>LUIS の場合は、アプリ管理用のキーは&lt;strong>オーサリングキー&lt;/strong>と呼んでいたりしますが、それの QnA Maker 版だと考えればよいです。
QnA Maker アプリの場合、このキーの管理は Azure ポータル上で管理されることになっており、Azure 上ではこのようなキーのことをサブスクリプションキーと呼んでいるんですね。
このあたりのチグハグ感に関しては &lt;a href="../../p/8myms6s">こちらを参照&lt;/a>。&lt;/p>
&lt;h2 id="エンドポイントキー-endpoint-key">エンドポイントキー (Endpoint Key)&lt;/h2>
&lt;p>&lt;strong>エンドポイントキー&lt;/strong>は、チャットアプリなどのユーザクライアント（Bot Framework では「チャンネル」と呼びます）が、QnA Maker に対してクエリを行うときに使用するキーです。
エンドポイントキーは、QnA Maker ポータルで対象となるナレッジベースを選択後、&lt;samp>PUBLISH&lt;/samp> タブから Publish 処理を実行したとき、あるいは &lt;samp>SETTING&lt;/samp> タブを選択することで確認することができます。&lt;/p>


&lt;figure class="xImage">
 &lt;img style="border: solid #ccc 2px;" width="700" height="312" src="../../p/t6n6jc8/keys-endpoint_hu3957920570199005946.png" alt="/p/t6n6jc8/keys-endpoint.png" />
 &lt;figcaption>図: QnA Maker ポータル上での QnA Maker のエンドポイントキーの確認&lt;/figcaption>
&lt;/figure>

&lt;p>チャットボットなどから QnA Maker を利用する場合、実運用時に設定する API アクセス用のキーは、こっちのエンドポイントキーです。&lt;/p></description></item><item><title>QnA Maker (3) Node.js から QnA Maker の API を利用する</title><link>https://maku.blog/p/rgnvp2r/</link><pubDate>Thu, 28 Feb 2019 00:00:00 +0900</pubDate><guid>https://maku.blog/p/rgnvp2r/</guid><description>&lt;h2 id="qna-maker-api-を呼び出すためのエンドポイント情報を調べる">QnA Maker API を呼び出すためのエンドポイント情報を調べる&lt;/h2>
&lt;h3 id="qna-maker-ナレッジベースの-publish">QnA Maker ナレッジベースの Publish&lt;/h3>
&lt;p>REST API を使用して QnA Maker のナレッジベースを使用するためには、&lt;a href="https://qnamaker.ai/">QnA Maker ポータル&lt;/a>上で対象のナレッジベースを Publish しておく必要があります。&lt;/p>


&lt;figure class="xImage">
 &lt;img style="border: solid #ccc 2px;" width="500" height="238" src="../../p/rgnvp2r/qna-from-nodejs_hu579909413149075782.png" alt="/p/rgnvp2r/qna-from-nodejs.png" />
&lt;/figure>

&lt;p>Publish 処理が完了すると、ナレッジベースにアクセスするための &lt;strong>Endpoint key&lt;/strong> が発行されます。&lt;/p>
&lt;h3 id="curl-での-qna-maker-api-の呼び出しテスト">curl での QnA Maker API の呼び出しテスト&lt;/h3>
&lt;p>任意の質問文に対する回答文を得るには、REST API として下記のような HTTP POST リクエストを送ります。&lt;/p>
&lt;pre tabindex="0">&lt;code>curl -X POST
 https://xxx.azurewebsites.net/qnamaker/knowledgebases/＜ナレッジベースID＞/generateAnswer
 -H &amp;#34;Authorization: EndpointKey ＜上記で発行したキー＞&amp;#34;
 -H &amp;#34;Content-type: application/json&amp;#34;
 -d &amp;#34;{&amp;#39;question&amp;#39;:&amp;#39;&amp;lt;質問文&amp;gt;&amp;#39;}&amp;#34;
&lt;/code>&lt;/pre>&lt;p>Linux の &lt;code>curl&lt;/code> コマンドを使用できる環境であれば、上記のように実行するだけで JSON 形式のレスポンスを確認することができます。&lt;/p>
&lt;h2 id="nodejs-から-qna-maker-の-rest-api-を呼び出す">Node.js から QnA Maker の REST API を呼び出す&lt;/h2>
&lt;p>Node.js から HTTP POST リクエストを送って JSON レスポンスを取得してみます。
HTTP リクエストを行うためのモジュールとして、ここでは &lt;code>request&lt;/code> モジュールを使用します。
JavaScript ファイルを作成するディレクトリと同じディレクトリ内で、下記のようにインストールしておいてください。&lt;/p></description></item><item><title>QnA Maker (4) Python から QnA Maker の API を利用する</title><link>https://maku.blog/p/fwyi2fh/</link><pubDate>Tue, 04 Jun 2019 00:00:00 +0900</pubDate><guid>https://maku.blog/p/fwyi2fh/</guid><description>&lt;p>QnA Maker は REST API を提供しているので、HTTP リクエストを発行できるプログラミング言語から簡単に制御することができます。
ここでは、Python に標準で付属している &lt;strong>&lt;code>urllib.request&lt;/code>&lt;/strong> モジュールを使って HTTP リクエストを発行し、QnA Maker にアクセスしてみます。&lt;/p>
&lt;h2 id="事前準備アクセスキーの準備">事前準備（アクセスキーの準備）&lt;/h2>
&lt;p>REST API を使用するには、HTTP リクエストのヘッダ情報としてアクセスキーを付加する必要があります。
&lt;a href="../../p/t6n6jc8">こちらの記事&lt;/a> を参考に、下記のどちらかのアクセスキーを確認しておいてください。&lt;/p>
&lt;ul>
&lt;li>サブスクリプションキー (Subscription Key) &amp;hellip; 管理用&lt;/li>
&lt;li>エンドポイントキー (Endpoint Key) &amp;hellip; クエリ用&lt;/li>
&lt;/ul>
&lt;p>アクセスキーは &lt;code>9d16b3e6345489ad4a57a0755eb4f96a&lt;/code> のような 16 進数文字列です。
QnA のクエリ実行だけであればエンドポイントキーの方を使えば大丈夫ですが、ナレッジベースの作成や更新などを行う場合は、サブスクリプションキーの方を使う必要があります。&lt;/p>
&lt;h2 id="qna-maker-の-rest-api-を呼び出す-python-ライブラリ">QnA Maker の REST API を呼び出す Python ライブラリ&lt;/h2>
&lt;p>REST API は HTTP リクエストを送るだけで使用できるので、ここでは自力で QnA Maker の API を使用するライブラリを作ってみます。&lt;/p>
&lt;p>下記の &lt;code>QnaRequest&lt;/code> クラスは、ナレッジベースの一覧を取得する &lt;code>getAllKnowledgeBases&lt;/code> メソッドと、指定したナレッジベースの情報を取得する &lt;code>getKnowledgeBase&lt;/code> メソッドを提供しています。
戻り値は JSON 形式のテキストです。&lt;/p>

&lt;figure class="xCodeBlock">
&lt;figcaption class="xCodeBlock_title">mylib/qna.py&lt;/figcaption>
&lt;div class="xCodeBlock_code">&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-python" data-lang="python">&lt;span class="line">&lt;span class="cl">&lt;span class="kn">import&lt;/span> &lt;span class="nn">urllib.request&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">class&lt;/span> &lt;span class="nc">QnaRequest&lt;/span>&lt;span class="p">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">BASE_URL&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="s1">&amp;#39;https://westus.api.cognitive.microsoft.com/qnamaker/v4.0&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">def&lt;/span> &lt;span class="fm">__init__&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="bp">self&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">subscriptionKey&lt;/span>&lt;span class="p">):&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="bp">self&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">_subscriptionKey&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">subscriptionKey&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="bp">self&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">_setup_opener&lt;/span>&lt;span class="p">()&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">def&lt;/span> &lt;span class="nf">_setup_opener&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="bp">self&lt;/span>&lt;span class="p">):&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="bp">self&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">_opener&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">urllib&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">request&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">build_opener&lt;/span>&lt;span class="p">()&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="bp">self&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">_opener&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">addheaders&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="p">[&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">(&lt;/span>&lt;span class="s1">&amp;#39;Ocp-Apim-Subscription-Key&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="bp">self&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">_subscriptionKey&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">]&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">def&lt;/span> &lt;span class="nf">_get&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="bp">self&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">path&lt;/span>&lt;span class="p">):&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">with&lt;/span> &lt;span class="bp">self&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">_opener&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">open&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">QnaRequest&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">BASE_URL&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="n">path&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="k">as&lt;/span> &lt;span class="n">res&lt;/span>&lt;span class="p">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="n">res&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">read&lt;/span>&lt;span class="p">()&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">decode&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s1">&amp;#39;utf-8&amp;#39;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">def&lt;/span> &lt;span class="nf">getAllKnowledgeBases&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="bp">self&lt;/span>&lt;span class="p">):&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="s2">&amp;#34;&amp;#34;&amp;#34;すべてのナレッジベースの情報を取得します。&amp;#34;&amp;#34;&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="bp">self&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">_get&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s1">&amp;#39;/knowledgebases/&amp;#39;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">def&lt;/span> &lt;span class="nf">getKnowledgeBase&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="bp">self&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nb">id&lt;/span>&lt;span class="p">):&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="s2">&amp;#34;&amp;#34;&amp;#34;指定したナレッジベースの情報を取得します。&amp;#34;&amp;#34;&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="bp">self&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">_get&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s1">&amp;#39;/knowledgebases/&lt;/span>&lt;span class="si">{}&lt;/span>&lt;span class="s1">&amp;#39;&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">format&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nb">id&lt;/span>&lt;span class="p">))&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/div>
&lt;/figure>

&lt;p>HTTP リクエストを送るときには、&lt;code>Ocp-Apim-Subscription-Key&lt;/code> ヘッダでアクセス用のキーを付加するようにしています。&lt;/p></description></item><item><title>LUIS と QnA Maker でキーの管理方法が異なるのはなぜか？</title><link>https://maku.blog/p/8myms6s/</link><pubDate>Mon, 18 Mar 2019 00:00:00 +0900</pubDate><guid>https://maku.blog/p/8myms6s/</guid><description>&lt;p>LUIS や QnA Maker サービスを利用するためのエンドポイントキーは、下記の 2 種類が提供されます。&lt;/p>
&lt;ul>
&lt;li>&lt;b>実運用のためのキー&lt;/b>: チャットクライアントなどからの、一般的な問い合わせを処理するためのキー。&lt;/li>
&lt;li>&lt;b>管理用のキー&lt;/b>: 各サービスの情報を取得したり、データを編集したりするためのキー。&lt;/li>
&lt;/ul>
&lt;p>LUIS も QnA Maker も便利なサービスなのですが、Azure リソースとの結びつけ方法や、キーの管理方法が異なっているため、最初はわけがわからなくなるかもしれません。
例えば、Azure ポータル上の &lt;samp>RESOURCE MANAGEMENT / Keys&lt;/samp> のページで表示されるキー（サブスクリプションキー）が、&lt;strong>LUIS の場合は実運用のためのキー&lt;/strong>であるのに対し、&lt;strong>QnA Maker の場合は管理用のキー&lt;/strong> であったりします。&lt;/p>
&lt;p>LUIS/QnA を使用する場合は、それぞれ、エンドポイントキーとしてどちらのキーを使用するかを間違えないようしなければいけません。&lt;/p>
&lt;ul>
&lt;li>&lt;b>LUIS のサブスクリプションキー（実運用のためのキー）&lt;/b>: Azure ポータルの LUIS リソースの Keys で表示されるもの&lt;/li>
&lt;li>&lt;b>LUIS のオーサリングキー（管理用のキー）&lt;/b>: LUIS ポータルの Authoring Key で表示されるもの&lt;/li>
&lt;li>&lt;b>QnA Maker のエンドポイントキー（実運用のためのキー）&lt;/b>: QnA Maker ポータルのプロファイル設定で表示されるもの&lt;/li>
&lt;li>&lt;b>QnA Maker のサブスクリプションキー（管理用のキー）&lt;/b>: Azure ポータルの QnA Maker リソースの Keys で表示されるもの&lt;/li>
&lt;/ul>
&lt;p>この時点で、キーの管理方法が QnA Maker と LUIS では完全に逆になっています。
Azure 上でのインタフェースは LUIS リソースと QnA Maker リソースで見た目が同じなので、混乱に拍車をかけています。&lt;/p></description></item><item><title>Azure 関連のアイコン集</title><link>https://maku.blog/p/bqodqji/</link><pubDate>Wed, 20 Mar 2019 00:00:00 +0900</pubDate><guid>https://maku.blog/p/bqodqji/</guid><description>&lt;h2 id="azure-関連アイコンのダウンロード">Azure 関連アイコンのダウンロード&lt;/h2>
&lt;p>Microsoft Azure 関連のアイコンは下記のサイトからダウンロードできるようになっています。
PNG 形式や SVG 形式のファイルが入っているので、Azure 関連の構成図を作成するときに便利です。&lt;/p>
&lt;ul>
&lt;li>&lt;a href="https://www.microsoft.com/en-us/download/details.aspx?id=41937">Download Microsoft Azure, Cloud and Enterprise Symbol / Icon Set&lt;/a>&lt;/li>
&lt;/ul>
&lt;p>例えばこーゆーアイコンがたくさん入っています。&lt;/p>
&lt;table>
 &lt;thead>
 &lt;tr>
 &lt;th style="text-align: center">アイコン&lt;/th>
 &lt;th>説明&lt;/th>
 &lt;/tr>
 &lt;/thead>
 &lt;tbody>
 &lt;tr>
 &lt;td style="text-align: center">
&lt;img style="width: 40px; min-width: 40px;" src="../../p/bqodqji/app-service-web-app.svg" />
&lt;/td>
 &lt;td>Azure App Service - Web App&lt;/td>
 &lt;/tr>
 &lt;tr>
 &lt;td style="text-align: center">
&lt;img style="width: 40px; min-width: 40px;" src="../../p/bqodqji/cognitive-services.svg" />
&lt;/td>
 &lt;td>Azure Cognitive Services&lt;/td>
 &lt;/tr>
 &lt;tr>
 &lt;td style="text-align: center">
&lt;img style="width: 40px; min-width: 40px;" src="../../p/bqodqji/cognitive-services-luis.svg" />
&lt;/td>
 &lt;td>Azure Cognitive Services - LUIS&lt;/td>
 &lt;/tr>
 &lt;/tbody>
&lt;/table>
&lt;h2 id="全アイコンのリスト">全アイコンのリスト&lt;/h2>
&lt;p>上記のパッケージに含まれているアイコンを一覧表示できる HTML ファイルを用意しました。&lt;/p>
&lt;ul>
&lt;li>&lt;a href="../../p/bqodqji/icons.zip">icons.zip&lt;/a>&lt;/li>
&lt;/ul>
&lt;p>アーカイブを展開して、&lt;code>azure-icons/all_icons.html&lt;/code> を開くと、下記のように全アイコンを一覧表示することができます。
ここから PowerPoint などにコピペして使うのも簡単です。&lt;/p>


&lt;figure class="xImage">
 &lt;img style="border: solid #ccc 2px;" width="629" height="609" src="../../p/bqodqji/icons.png" alt="/p/bqodqji/icons.png" />
&lt;/figure></description></item><item><title>Azure リソースのプレフィックス名（省略名）</title><link>https://maku.blog/p/rcoz9o9/</link><pubDate>Sat, 12 Jun 2021 00:00:00 +0900</pubDate><guid>https://maku.blog/p/rcoz9o9/</guid><description>&lt;p>Azure で何らかのリソースを作成するときは、&lt;strong>リソース名のプレフィックス&lt;/strong> として、リソースの種類に応じた略称（&lt;code>cosmos-&lt;/code> など）をつけることが多いのですが、この略称の指針が Microsoft Docs のサイトに書かれています。
リソース名をどうするかは意外と迷うところなので、こういった情報は地味に助かります。&lt;/p>
&lt;ul>
&lt;li>&lt;a href="https://docs.microsoft.com/ja-jp/azure/cloud-adoption-framework/ready/azure-best-practices/resource-abbreviations">Azure リソースの種類に推奨される省略形 - Cloud Adoption Framework | Microsoft Docs&lt;/a>&lt;/li>
&lt;/ul>
&lt;p>例えば次のような感じで定義されています。&lt;/p>
&lt;table>
 &lt;thead>
 &lt;tr>
 &lt;th>リソースの種類&lt;/th>
 &lt;th>プレフィックス&lt;/th>
 &lt;/tr>
 &lt;/thead>
 &lt;tbody>
 &lt;tr>
 &lt;td>リソースグループ&lt;/td>
 &lt;td>&lt;code>rg-&lt;/code>&lt;/td>
 &lt;/tr>
 &lt;tr>
 &lt;td>Cosmos DB アカウント&lt;/td>
 &lt;td>&lt;code>cosmos-&lt;/code>&lt;/td>
 &lt;/tr>
 &lt;tr>
 &lt;td>ストレージアカウント&lt;/td>
 &lt;td>&lt;code>st-&lt;/code>&lt;/td>
 &lt;/tr>
 &lt;tr>
 &lt;td>静的 Web アプリ&lt;/td>
 &lt;td>&lt;code>stapp-&lt;/code>&lt;/td>
 &lt;/tr>
 &lt;tr>
 &lt;td>関数アプリ&lt;/td>
 &lt;td>&lt;code>func-&lt;/code>&lt;/td>
 &lt;/tr>
 &lt;/tbody>
&lt;/table>
&lt;p>また、&lt;a href="https://docs.microsoft.com/ja-jp/azure/cloud-adoption-framework/ready/azure-best-practices/resource-naming">リソース名全体の構成&lt;/a>も次のような例で示されています。&lt;/p>


&lt;figure class="xImage">
 &lt;img style="" width="500" height="135" src="../../p/rcoz9o9/img-001_hu7665104810822792040.png" alt="/p/rcoz9o9/img-001.png" />
 &lt;figcaption>図: Azure リソース名の構成（Microsoft Docs より）&lt;/figcaption>
&lt;/figure>

&lt;p>この辺りは開発チームによってルールが決められているかもしれませんが、まずはこの構成で間に合うか考えてみるとよいと思います。&lt;/p></description></item><item><title>MongoDB for VS Code で Azure Cosmos DB を操作する</title><link>https://maku.blog/p/dt3ahpw/</link><pubDate>Sat, 12 Jun 2021 00:00:00 +0900</pubDate><guid>https://maku.blog/p/dt3ahpw/</guid><description>&lt;p>Cosmos DB インスタンスを &lt;a href="../../p/cd9bg3x">MongoDB API アクセス用に作成&lt;/a> しておくと、さまざまな MongoDB 用のツールでデータベースにアクセスできるようになります。
ここでは、VS Code 用の拡張「&lt;strong>MongoDB for VS Code&lt;/strong>」を使って、Cosmos DB を操作できるようにしてみます。
TypeScript を使って Web アプリを作成しているときは、エディタとして VS Code を使っていることが多いでしょうから、同じ環境上で Cosmos DB を操作できると開発が捗ります。&lt;/p>
&lt;h2 id="mongodb-for-vs-code-のインストール">MongoDB for VS Code のインストール&lt;/h2>


&lt;figure class="xImage">
 &lt;img style="border: solid #ccc 2px;" width="2370" height="528" src="../../p/dt3ahpw/img-001.png" alt="/p/dt3ahpw/img-001.png" />
 &lt;figcaption>図: MongoDB for VS Code のインストール&lt;/figcaption>
&lt;/figure>

&lt;p>MongoDB for VS Code は、VS Code の Extesions バー (&lt;code>Cmd/Ctrl + Shift + X&lt;/code>) で &lt;strong>&lt;code>MongoDB&lt;/code>&lt;/strong> で検索すれば簡単にインストールできます。&lt;/p>
&lt;h2 id="vs-code-から-cosmos-db-mongodb-に接続する">VS Code から Cosmos DB (MongoDB) に接続する&lt;/h2>
&lt;h3 id="接続文字列で簡単接続">接続文字列で簡単接続&lt;/h3>
&lt;p>MongoDB for VS Code をインストールすると、サイドバーに &lt;strong>葉っぱのアイコン&lt;/strong> が出てくるので、ここから MongoDB サーバーに接続することができます。
ちなみに、MongoDB が葉っぱアイコンを使うのは、それを使うことが「シンプルで自然であるから」らしいです（じゃあ水でもいいじゃん、とは言いますまい）。&lt;/p></description></item><item><title>Azure Functions に npm install で Node モジュールを追加する</title><link>https://maku.blog/p/9t7hs4e/</link><pubDate>Mon, 17 Aug 2020 00:00:00 +0900</pubDate><guid>https://maku.blog/p/9t7hs4e/</guid><description>&lt;h2 id="azure-functions-への-npm-install">Azure Functions への npm install&lt;/h2>
&lt;p>Azure Functions の関数を Node.js ランタイムで動かしている場合は、通常の Node.js アプリと同様に NPM パッケージを &lt;code>npm&lt;/code> コマンドでインストールして使用することができます。
簡単なのは、&lt;a href="https://portal.azure.com/">Azure ポータル&lt;/a> の Function App リソースの &lt;strong>&lt;code>コンソール&lt;/code>&lt;/strong> 画面から &lt;code>npm install&lt;/code> を実行する方法です。&lt;/p>


&lt;figure class="xImage">
 &lt;img style="border: solid #ccc 2px;" width="1584" height="672" src="../../p/9t7hs4e/img-001.png" alt="/p/9t7hs4e/img-001.png" />
&lt;/figure>

&lt;p>コンソールを開くと、Function App のルートディレクトリ（通常は &lt;code>D:\home\site\wwwroot&lt;/code>）がカレントディレクトリになってプロンプトが表示されます。
ここから次のように &lt;code>package.json&lt;/code> の作成と、Node モジュールのインストールを行うことができます。&lt;/p>

&lt;figure class="xCodeBlock">

&lt;div class="xCodeBlock_code">&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-plain" data-lang="plain">&lt;span class="line">&lt;span class="cl">D:\home\site\wwwroot&amp;gt; npm init -y
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">D:\home\site\wwwroot&amp;gt; npm install node-fetch --save&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/div>
&lt;/figure>

&lt;p>これで、この Functions プロジェクト内のすべての関数から、インストールした Node モジュールを使用できるようになります。&lt;/p>
&lt;h2 id="npm-install-を実行するディレクトリ">npm install を実行するディレクトリ&lt;/h2>
&lt;p>Functions プロジェクトのディレクトリ階層は次のように、関数ごとにディレクトリが分かれています。&lt;/p>

&lt;figure class="xCodeBlock">

&lt;div class="xCodeBlock_code">&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-plain" data-lang="plain">&lt;span class="line">&lt;span class="cl">D:\home\site\wwwroot
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> +-- host.json
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> +-- MyFunc1
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> | +-- function.json
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> | +-- index.js
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> +-- MyFunc2
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> +-- function.json
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> +-- index.js&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/div>
&lt;/figure>

&lt;p>&lt;code>npm init&lt;/code> および &lt;code>npm install&lt;/code> を実行するディレクトリは、プロジェクトのルートディレクトリ、あるいは、関数ごとのディレクトリになります。&lt;/p></description></item><item><title>Azure Static Web Apps で静的ウェブサイトを作成する</title><link>https://maku.blog/p/vgt5fqy/</link><pubDate>Sat, 15 Aug 2020 00:00:00 +0900</pubDate><guid>https://maku.blog/p/vgt5fqy/</guid><description>&lt;h2 id="azure-static-web-apps-とは">Azure Static Web Apps とは&lt;/h2>
&lt;p>2020年5月に Azure Static Web Apps のプレビュー版が公開されました。
これまでは、Azure 上で静的なウェブサイトを作成する場合は、BLOB ストレージを使って HTML/JS ファイルなどをホストする方法がとられていましたが、今後は Static Web Apps のサービスが主流になりそうです。&lt;/p>
&lt;ul>
&lt;li>参考: &lt;a href="../../p/gkardu9">Azure Storage で静的 Web サイトをホスティングする&lt;/a>&lt;/li>
&lt;/ul>
&lt;p>Azure Static Web Apps は、サイトのビルドやデプロイに GitHub Actions を使うことを前提としているため、Web サイトのコンテンツを GitHub 上で管理することが強制されます。&lt;/p>
&lt;p>GitHub Pages でも静的な Web サイトを作成できますが、Azure Static Web Apps を使うと Azure Functions などの API サービスと統合することができます。
静的 Web サイトといいつつも、より高度な Web アプリを作成することができそうです。&lt;/p>
&lt;p>Azure Static Web Apps は、ベータ版のうちは無料で使えるようです。
そのうち従量課金に切り替わると思いますが、BLOB ストレージを使った場合の利用料金はめちゃ安だったので、こちらも安価な料金が設定されることを期待しています。&lt;/p>
&lt;h2 id="github-リポジトリの準備">GitHub リポジトリの準備&lt;/h2>
&lt;p>下記のような簡単な HTML ファイルを作成して、&lt;a href="https://github.com/new">GitHub リポジトリを新規作成&lt;/a> してコミットしておきます。&lt;/p>

&lt;figure class="xCodeBlock">
&lt;figcaption class="xCodeBlock_title">index.html&lt;/figcaption>
&lt;div class="xCodeBlock_code">&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-html" data-lang="html">&lt;span class="line">&lt;span class="cl">&lt;span class="cp">&amp;lt;!DOCTYPE html&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">&amp;lt;&lt;/span>&lt;span class="nt">meta&lt;/span> &lt;span class="na">charset&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s">&amp;#34;UTF-8&amp;#34;&lt;/span>&lt;span class="p">&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">&amp;lt;&lt;/span>&lt;span class="nt">title&lt;/span>&lt;span class="p">&amp;gt;&lt;/span>My website&lt;span class="p">&amp;lt;/&lt;/span>&lt;span class="nt">title&lt;/span>&lt;span class="p">&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">&amp;lt;&lt;/span>&lt;span class="nt">p&lt;/span>&lt;span class="p">&amp;gt;&lt;/span>Hello World&lt;span class="p">&amp;lt;/&lt;/span>&lt;span class="nt">p&lt;/span>&lt;span class="p">&amp;gt;&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/div>
&lt;/figure>

&lt;h2 id="static-web-apps-リソースの作成">Static Web Apps リソースの作成&lt;/h2>


&lt;figure class="xImage">
 &lt;img style="border: solid #ccc 2px;" width="600" height="175" src="../../p/vgt5fqy/img-001_hu7920658015552422630.png" alt="/p/vgt5fqy/img-001.png" />
&lt;/figure>

&lt;p>&lt;a href="https://portal.azure.com/#create/hub">Azure Portal のリソースの作成&lt;/a> のページから、&lt;strong>Static Web App&lt;/strong> を選択してリソースを新規作成します。&lt;/p></description></item><item><title>Azure Pipelinesメモ: azure-pipelines.yml から別の Yaml をインクルードする (template)</title><link>https://maku.blog/p/36h9xj9/</link><pubDate>Tue, 28 Jul 2020 00:00:00 +0900</pubDate><guid>https://maku.blog/p/36h9xj9/</guid><description>&lt;h2 id="template-機能">Template 機能&lt;/h2>
&lt;p>Azure Pipelines の Template 機能を使用すると、別の Yaml ファイルに記述したビルド設定をインクルードすることができます。&lt;/p>
&lt;ul>
&lt;li>&lt;a href="https://docs.microsoft.com/en-us/azure/devops/pipelines/process/templates?view=azure-devops">Templates - Azure Pipelines | Microsoft Docs&lt;/a>&lt;/li>
&lt;/ul>
&lt;p>変数を渡して、部分的に内容を置き換えることができるので、「インクルード」ではなく「テンプレート」と呼んでいるみたいです。&lt;/p>
&lt;p>単純に共通の &lt;code>steps&lt;/code> を読み込んで使うこともできるし、逆にテンプレートファイルに対してパラメータで &lt;code>stepList&lt;/code> を渡すということもできます。&lt;/p>
&lt;h2 id="使用例steps-の共通化">使用例（steps の共通化）&lt;/h2>
&lt;p>例えば、別の Yaml ファイル（テンプレート）に記述した &lt;code>steps&lt;/code> 定義を、&lt;code>azure-pipelines.yml&lt;/code> から読み込むとします。
テンプレートファイルには次のような感じで、ルートに &lt;code>steps&lt;/code> 要素を記述します。&lt;/p>

&lt;figure class="xCodeBlock">
&lt;figcaption class="xCodeBlock_title">common-steps.yml（テンプレート）&lt;/figcaption>
&lt;div class="xCodeBlock_code">&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-yaml" data-lang="yaml">&lt;span class="line">&lt;span class="cl">&lt;span class="nt">steps&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>- &lt;span class="nt">task&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">NodeTool@0&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">inputs&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">versionSpec&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s1">&amp;#39;10.x&amp;#39;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">displayName&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s1">&amp;#39;Install Node.js&amp;#39;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>- &lt;span class="nt">task&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">Npm@1&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">inputs&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">command&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s1">&amp;#39;ci&amp;#39;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">displayName&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s1">&amp;#39;npm ci&amp;#39;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>- &lt;span class="nt">task&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">Npm@1&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">inputs&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">command&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s1">&amp;#39;custom&amp;#39;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">customCommand&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s1">&amp;#39;run lint&amp;#39;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">displayName&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s1">&amp;#39;npm run lint&amp;#39;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="c"># ...&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/div>
&lt;/figure>

&lt;p>&lt;code>azure-pipelines.yml&lt;/code> の &lt;code>steps&lt;/code> 以下で、上記のテンプレートファイルを読み込むには、&lt;strong>&lt;code>template&lt;/code>&lt;/strong> というキーワードを使用します。&lt;/p></description></item><item><title>Azure Pipelines トラブル: npm タスクを実行できないとき</title><link>https://maku.blog/p/7c2kdub/</link><pubDate>Wed, 22 Jul 2020 00:00:00 +0900</pubDate><guid>https://maku.blog/p/7c2kdub/</guid><description>&lt;p>Azure Pipelines の設定で、次のような感じで Npm タスクを追加したとき、&lt;/p>

&lt;figure class="xCodeBlock">
&lt;figcaption class="xCodeBlock_title">azure-pipelines.yml&lt;/figcaption>
&lt;div class="xCodeBlock_code">&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-yaml" data-lang="yaml">&lt;span class="line">&lt;span class="cl">&lt;span class="nt">steps&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>- &lt;span class="nt">task&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">Npm@1&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">inputs&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">command&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s1">&amp;#39;ci&amp;#39;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">displayName&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s1">&amp;#39;npm ci&amp;#39;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>- &lt;span class="nt">task&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">Npm@1&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">inputs&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">command&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s1">&amp;#39;custom&amp;#39;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">customCommand&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s1">&amp;#39;run lint&amp;#39;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">displayName&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s1">&amp;#39;npm run lint&amp;#39;&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/div>
&lt;/figure>

&lt;p>Node.js 系のコマンドが認識されていないと、エラーが出て Npm タスクを実行できません。&lt;/p>

&lt;figure class="xCodeBlock">

&lt;div class="xCodeBlock_code">&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-plain" data-lang="plain">&lt;span class="line">&lt;span class="cl">No agent found in pool Default which satisfies the specified demands: npm, Agent.Version -gtVersion 2.163.1&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/div>
&lt;/figure>

&lt;p>そのような場合は、&lt;code>steps&lt;/code> の先頭で、次のように &lt;strong>NodeTool&lt;/strong> (Node.js Tool Installer) タスクを実行しておくと、うまく動作するようになります 。&lt;/p>

&lt;figure class="xCodeBlock">
&lt;figcaption class="xCodeBlock_title">azure-pipelines.yml&lt;/figcaption>
&lt;div class="xCodeBlock_code">&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-yaml" data-lang="yaml">&lt;span class="line">&lt;span class="cl">&lt;span class="nt">steps&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="c"># これで npm コマンドを認識するようになる&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>- &lt;span class="nt">task&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">NodeTool@0&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">inputs&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">versionSpec&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s1">&amp;#39;10.x&amp;#39;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">displayName&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s1">&amp;#39;Install Node.js&amp;#39;&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/div>
&lt;/figure>

&lt;aside style="display: flex; border: thin dashed gray;">
&lt;div style="align-self: stretch; writing-mode: vertical-lr; text-align: center; letter-spacing: 0.2em; color: #666; border-right: thin dashed gray; padding: 0.4em 0; line-height: 1.5;">参考&lt;/div>
&lt;div style="align-self: center; padding: 0.6em 0; line-height: 1.2 !important;">&lt;ul>
&lt;li>&lt;a href="https://docs.microsoft.com/ja-jp/azure/devops/pipelines/tasks/tool/node-js?view=azure-devops">Node.js Tool Installer task - Azure Pipelines | Microsoft Docs&lt;/a>&lt;/li>
&lt;/ul>
&lt;/div>
&lt;/aside>
&lt;p>NodeTool タスクは実行のたびに Node.js をダウンロード＆インストールするわけではなく、VM 上に存在するキャッシュなどを使って Node.js の環境をセットアップするため、通常は数秒で実行が完了します。&lt;/p></description></item><item><title>Bot Framework: Web チャットの表示をカスタマイズする</title><link>https://maku.blog/p/oitn3a3/</link><pubDate>Wed, 19 Feb 2020 00:00:00 +0900</pubDate><guid>https://maku.blog/p/oitn3a3/</guid><description>&lt;p>Microsoft Bot Framework を使ってウェブサイト上にチャットボットを配置したときの表示のカスタマイズ方法です。
次のように、ボットやユーザーのアイコンを設定することができます。&lt;/p>


&lt;figure class="xImage">
 &lt;img style="border: solid #ccc 2px;" width="502" height="247" src="../../p/oitn3a3/img-001.png" alt="/p/oitn3a3/img-001.png" />
&lt;/figure>

&lt;p>このようなカスタマイズ表示を行うには、Azure portal 上の Web App Bot リソースの &lt;code>Channels&lt;/code> タブから選択できる、&lt;strong>&lt;code>Direct Line&lt;/code>&lt;/strong> チャネルを使う必要があります。
&lt;code>Web Chat&lt;/code> というチャネルを使うと、&lt;code>iframe&lt;/code> タグで簡単にチャットウィンドウを埋め込むことができるのですが、そちらではあまりカスタマイズができないようです。&lt;/p>


&lt;figure class="xImage">
 &lt;img style="border: solid #ccc 2px;" width="981" height="549" src="../../p/oitn3a3/img-002.png" alt="/p/oitn3a3/img-002.png" />
 &lt;figcaption>図: Direct Line チャネルのキーを確認&lt;/figcaption>
&lt;/figure>

&lt;p>下記はチャットウィンドウをカスタマイズして表示するサンプルコードです。
Bot Framework が提供している &lt;code>WebChat.renderWebChat()&lt;/code> 関数を呼び出すと、実際にチャットウィンドウが表示されるのですが、このときに &lt;strong>&lt;code>styleOptions&lt;/code>&lt;/strong> パラメータを指定することで表示方法をカスタマイズすることができます。&lt;/p>

&lt;figure class="xCodeBlock">
&lt;figcaption class="xCodeBlock_title">index.html&lt;/figcaption>
&lt;div class="xCodeBlock_code">&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-html" data-lang="html">&lt;span class="line">&lt;span class="cl">&lt;span class="cp">&amp;lt;!DOCTYPE html&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">&amp;lt;&lt;/span>&lt;span class="nt">html&lt;/span>&lt;span class="p">&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">&amp;lt;&lt;/span>&lt;span class="nt">head&lt;/span>&lt;span class="p">&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">&amp;lt;&lt;/span>&lt;span class="nt">script&lt;/span> &lt;span class="na">src&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s">&amp;#34;https://cdn.botframework.com/botframework-webchat/latest/webchat.js&amp;#34;&lt;/span>&lt;span class="p">&amp;gt;&amp;lt;/&lt;/span>&lt;span class="nt">script&lt;/span>&lt;span class="p">&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">&amp;lt;&lt;/span>&lt;span class="nt">style&lt;/span>&lt;span class="p">&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">*&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">margin&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">#&lt;/span>&lt;span class="nn">webchat&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">height&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="mi">100&lt;/span>&lt;span class="kt">vh&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">width&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="mi">100&lt;/span>&lt;span class="kt">vw&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">background&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="kc">gray&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">border&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="kc">solid&lt;/span> &lt;span class="mi">5&lt;/span>&lt;span class="kt">px&lt;/span> &lt;span class="mh">#f37&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">box-sizing&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="kc">border-box&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">&amp;lt;/&lt;/span>&lt;span class="nt">style&lt;/span>&lt;span class="p">&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">&amp;lt;/&lt;/span>&lt;span class="nt">head&lt;/span>&lt;span class="p">&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">&amp;lt;&lt;/span>&lt;span class="nt">body&lt;/span>&lt;span class="p">&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">&amp;lt;&lt;/span>&lt;span class="nt">div&lt;/span> &lt;span class="na">id&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s">&amp;#34;webchat&amp;#34;&lt;/span> &lt;span class="na">role&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s">&amp;#34;main&amp;#34;&lt;/span>&lt;span class="p">&amp;gt;&amp;lt;/&lt;/span>&lt;span class="nt">div&lt;/span>&lt;span class="p">&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">&amp;lt;&lt;/span>&lt;span class="nt">script&lt;/span>&lt;span class="p">&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kr">const&lt;/span> &lt;span class="nx">TOKEN&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="s1">&amp;#39;HpJB2ofxzsA.h7...省略...&amp;#39;&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">WebChat&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">renderWebChat&lt;/span>&lt;span class="p">({&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">directLine&lt;/span>&lt;span class="o">:&lt;/span> &lt;span class="nx">WebChat&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">createDirectLine&lt;/span>&lt;span class="p">({&lt;/span> &lt;span class="nx">token&lt;/span>&lt;span class="o">:&lt;/span> &lt;span class="nx">TOKEN&lt;/span> &lt;span class="p">}),&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">styleOptions&lt;/span>&lt;span class="o">:&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">// ボットのアイコン
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="nx">botAvatarImage&lt;/span>&lt;span class="o">:&lt;/span> &lt;span class="s1">&amp;#39;/assets/img/bot-avatar.png&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">// ボットのイニシャル（アイコンが使えない場合に表示）
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="c1">//botAvatarInitials: &amp;#39;Bot&amp;#39;,
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="c1">// ユーザーのアイコン
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="c1">//userAvatarImage: &amp;#39;/assets/img/user-avator.png&amp;#39;,
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="c1">// ユーザーのイニシャル（アイコンが使えない場合に表示）
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="nx">userAvatarInitials&lt;/span>&lt;span class="o">:&lt;/span> &lt;span class="s1">&amp;#39;You&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">// アイコンのサイズ
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="nx">avatarSize&lt;/span>&lt;span class="o">:&lt;/span> &lt;span class="mi">50&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">// Upload file のボタンを非表示
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="nx">hideUploadButton&lt;/span>&lt;span class="o">:&lt;/span> &lt;span class="kc">true&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">},&lt;/span> &lt;span class="nb">document&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">getElementById&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s1">&amp;#39;webchat&amp;#39;&lt;/span>&lt;span class="p">));&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">&amp;lt;/&lt;/span>&lt;span class="nt">script&lt;/span>&lt;span class="p">&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">&amp;lt;/&lt;/span>&lt;span class="nt">body&lt;/span>&lt;span class="p">&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">&amp;lt;/&lt;/span>&lt;span class="nt">html&lt;/span>&lt;span class="p">&amp;gt;&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/div>
&lt;/figure>

&lt;aside style="display: flex; border: thin dashed gray;">
&lt;div style="align-self: stretch; writing-mode: vertical-lr; text-align: center; letter-spacing: 0.2em; color: #666; border-right: thin dashed gray; padding: 0.4em 0; line-height: 1.5;">参考&lt;/div>
&lt;div style="align-self: center; padding: 0.6em 0; line-height: 1.2 !important;">&lt;ul>
&lt;li>&lt;a href="https://github.com/microsoft/BotFramework-WebChat/blob/master/README.md">GitHub: microsoft/BotFramework-WebChat&lt;/a>&lt;/li>
&lt;/ul>
&lt;/div>
&lt;/aside></description></item><item><title>Azure: デプロイスロットでリリース時のダウンタイムをなくす（Blue-Green デプロイメント）</title><link>https://maku.blog/p/bog7iq8/</link><pubDate>Wed, 12 Feb 2020 00:00:00 +0900</pubDate><guid>https://maku.blog/p/bog7iq8/</guid><description>&lt;h2 id="なぜデプロイスロットが必要か">なぜデプロイスロットが必要か？&lt;/h2>
&lt;p>App Service を作成すると、デフォルトでは運用スロット (production slot) がひとつだけ作成され、Azure Repos や GitHub からのアプリケーションのデプロイ先として使用されます。&lt;/p>
&lt;p>アクセスの少ないアプリケーションであればこれでも問題ありませんが、デプロイ後にサーバー上でのビルド処理（ウォームアップ）が走るようなケースでは、少なからずダウンタイムが発生してしまいます。&lt;/p>
&lt;p>このようなダウンタイムの発生を防ぐために、ステージング用のスロット (staging slot) を用意し、そこでのウォームアップが完了した後で運用スロット (production slot) と入れ替えるという方法を取ります。&lt;/p>

&lt;figure class="xCodeBlock">

&lt;div class="xCodeBlock_code">&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-plain" data-lang="plain">&lt;span class="line">&lt;span class="cl">GitHub or
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">AzureRepos ─デプロイ→ staging スロット
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> ↑
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> (スワップ)
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> ↓
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> production スロット&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/div>
&lt;/figure>

&lt;p>このようにサーバーインスタンス（ここではスロット）を 2 つ用意して、内容をスワップ（実際はアドレスをスワップ）することで運用環境を瞬間的に入れ替える手法を &lt;strong>Blue-Green デプロイメント&lt;/strong> とか、A/B アップデートと呼びます。&lt;/p>
&lt;p>Azure の App Service は、 &lt;strong>デプロイスロット (Deployment slots)&lt;/strong> という機能名で、Blue-Green デプロイメントをサポートしています。&lt;/p>


&lt;figure class="xImage">
 &lt;img style="border: solid #ccc 2px;" width="400" height="344" src="../../p/bog7iq8/img-001_hu13106140891720566047.png" alt="/p/bog7iq8/img-001.png" />
 &lt;figcaption>図: App Service の Deployments slots 設定&lt;/figcaption>
&lt;/figure>

&lt;p>デプロイスロットを使ったスワップ運用には次のような利点があります。&lt;/p>
&lt;ol>
&lt;li>ステージング環境 (staging slot) で事前に動作検証できる&lt;/li>
&lt;li>運用環境 (production slot) のダウンタイムをほぼゼロにできる&lt;/li>
&lt;li>運用環境 (production slot) で問題が発生したら、再度スワップして前のバージョンに戻すことができる&lt;/li>
&lt;/ol>
&lt;h2 id="app-service-にステージング環境用のデプロイスロットを追加する">App Service にステージング環境用のデプロイスロットを追加する&lt;/h2>
&lt;h3 id="デプロイスロットの作成">デプロイスロットの作成&lt;/h3>
&lt;p>まず、App Service に新しくステージング環境用のデプロイスロット (&lt;strong>Deployment slots&lt;/strong>) を作成します。
対象となる App Service のリソースを選択し、次のように選択するとデプロイスロットの追加ダイアログが開きます。&lt;/p></description></item><item><title>Azure: Node.js アプリを App Service へデプロイする（Kudu ビルド編）</title><link>https://maku.blog/p/wx3fvib/</link><pubDate>Wed, 09 Oct 2019 00:00:00 +0900</pubDate><guid>https://maku.blog/p/wx3fvib/</guid><description>&lt;p>Azure App Service には、&lt;strong>デプロイセンター&lt;/strong> という仕組みがあり、そこからソースコードのビルドからデプロイまでの自動化の設定を行うことができます。
簡単に言うと、Azure Repos や GitHub のリポジトリに最新の JavaScript コードをコミットするだけで、最新の Node.js アプリが自動で立ち上がるようになります。&lt;/p>
&lt;p>ビルドの仕組みとしては、クラウド上の Azure Pipelines を使ったり、ローカルでビルドしてしまってからデプロイする方法があります。
App Service には &lt;a href="https://gihub.com/projectkudu/kudu/wiki">Kudu エンジン&lt;/a> が組み込まれており、デプロイ時に自動で実行されるスクリプトを使って簡易的なビルド処理を行うこともできます。&lt;/p>
&lt;h2 id="はじめに用語定義">はじめに（用語定義）&lt;/h2>
&lt;p>Azure ではデプロイ処理を構成するコンポーネントを下記のような名前で呼んでいます。&lt;/p>
&lt;dl>
&lt;dt>デプロイソース&lt;/dt>
&lt;dd>GitHub や Azure Repos など。
ソースコードが置いてある場所（リポジトリ）のこと。
Azure App Service は手軽なデプロイソースとして OneDrive や Dropbox などのフォルダ共有サービスを設定することもできますが、本格的な運用で使用することは推奨されていません。&lt;/dd>
&lt;dt>ビルドパイプライン（ビルドプロバイダー）&lt;/dt>
&lt;dd>Azure Pipelines など。デプロイソースからソースコードを取得し、一連のビルド処理を行う仕組み。
App Service には組み込みで Kudu エンジンが搭載されており、デフォルトではデプロイ時にこの Kudu エンジンによって &lt;code>npm install&lt;/code> などが実行されるようになっています。
また、デプロイ時に実行する &lt;a href="https://github.com/projectkudu/kudu/wiki/Deployment-hooks">カスタムスクリプトを .deployment ファイルで定義する&lt;/a> こともできます。
これらの仕組みだけで十分であれば、Azure Pipelines を使う必要はありません。&lt;/dd>
&lt;dt>デプロイメカニズム&lt;/dt>
&lt;dd>ビルドしたアプリを Azure App Service などに配置するためのアクション。Kudu エンジンや FTP (SFTP)、WebDeploy などのデプロイメカニズムが提供されています。&lt;/dd>
&lt;/dl>
&lt;h2 id="リポジトリの準備-azure-repos">リポジトリの準備 (Azure Repos)&lt;/h2>
&lt;p>ここでは、Azure Repos に Git リポジトリを作成し、そこに Node.js アプリのコードをコミットしてあると想定します。
GitHub でも大丈夫です。&lt;/p></description></item><item><title>Azure: App Service の Node.js アプリのエントリポイントはどこで定義されているか？</title><link>https://maku.blog/p/3u4hj7h/</link><pubDate>Tue, 08 Oct 2019 00:00:00 +0900</pubDate><guid>https://maku.blog/p/3u4hj7h/</guid><description>&lt;h2 id="nodejs-アプリのエントリポイントの指定">Node.js アプリのエントリポイントの指定&lt;/h2>
&lt;p>Azure App Service で Node.js アプリをテンプレートから作成すると、うまいことルートに配置された &lt;code>index.js&lt;/code> が起動してくれます。
この仕組みがブラックボックスな感じで気持ち悪いので調べてみたところ、この&lt;strong>エントリポイントの指定は &lt;code>web.config&lt;/code> ファイルにある&lt;/strong>ようです。&lt;/p>

&lt;figure class="xCodeBlock">
&lt;figcaption class="xCodeBlock_title">web.config（抜粋）&lt;/figcaption>
&lt;div class="xCodeBlock_code">&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-xml" data-lang="xml">&lt;span class="line">&lt;span class="cl">&lt;span class="nt">&amp;lt;add&lt;/span> &lt;span class="na">name=&lt;/span>&lt;span class="s">&amp;#34;iisnode&amp;#34;&lt;/span> &lt;span class="na">path=&lt;/span>&lt;span class="s">&amp;#34;index.js&amp;#34;&lt;/span> &lt;span class="na">verb=&lt;/span>&lt;span class="s">&amp;#34;*&amp;#34;&lt;/span> &lt;span class="na">modules=&lt;/span>&lt;span class="s">&amp;#34;iisnode&amp;#34;&lt;/span>&lt;span class="nt">/&amp;gt;&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/div>
&lt;/figure>

&lt;p>Windows ベースの App Service で Node.js アプリを動作させる場合、Windows の Web サーバーである IIS 上で動作する &lt;a href="https://github.com/Azure/iisnode">iisnode&lt;/a> という Node.js 実装が使用されます。
IIS が起動するときに設定ファイルである &lt;code>web.config&lt;/code> が読み込まれ、上記の設定により &lt;code>iisnode&lt;/code> がエントリポイント &lt;code>index.js&lt;/code> を使って起動するという流れになります。
なので、作成している Node.js アプリのエントリポイント（メインの JS ファイル）が変わった場合は、この &lt;code>web.config&lt;/code> ファイルを修正する必要があります。&lt;/p>
&lt;p>あと、このような仕組みのため、&lt;code>web.config&lt;/code> ファイルは必ずアプリを構成する JS ファイルと一緒にデプロイしないといけないということも分かります。
上記の設定のままであれば、デプロイ先のルートディレクトリに、少なくとも下記の 2 ファイルが配置されていなければいけません。&lt;/p>
&lt;ul>
&lt;li>web.config （IIS の設定ファイル）&lt;/li>
&lt;li>index.js （上記ファイルで指定されたエントリポイント）&lt;/li>
&lt;/ul>
&lt;h2 id="なぜ紛らわしいのか">なぜ紛らわしいのか？&lt;/h2>
&lt;p>Node.js アプリを開発するとき、通常は &lt;code>package.json&lt;/code> の &lt;code>start&lt;/code> スクリプトとしてエントリポイントを指定します。&lt;/p>

&lt;figure class="xCodeBlock">
&lt;figcaption class="xCodeBlock_title">package.json（抜粋）&lt;/figcaption>
&lt;div class="xCodeBlock_code">&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-json" data-lang="json">&lt;span class="line">&lt;span class="cl">&lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;scripts&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;start&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;node index.js&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/div>
&lt;/figure>

&lt;p>こうすることで、&lt;code>npm start&lt;/code> と実行するだけで、&lt;code>index.js&lt;/code> をエントリポイントとして Node.js アプリが起動するようになっています。&lt;/p></description></item><item><title>Azure Speech Service を使って音声をテキストに変換する (STT)</title><link>https://maku.blog/p/5zx3ozz/</link><pubDate>Wed, 24 Jul 2019 00:00:00 +0900</pubDate><guid>https://maku.blog/p/5zx3ozz/</guid><description>&lt;p>Microsoft の Cognitive Services のひとつとして提供されている &lt;a href="https://azure.microsoft.com/ja-jp/services/cognitive-services/speech-services/">Speech Service&lt;/a> を使用すると、音声をテキストに変換したり、逆にテキストを音声に変換したりすることができます。&lt;/p>
&lt;p>ここでは、Python から Speech Service の機能を利用してみます（Windows 10 で動作確認済）。
実行するにはマイクのついた PC が必要です
マイクのついていない PC で実行すると &lt;code>SPXERR_MIC_NOT_AVAILABLE&lt;/code> エラーが発生します。&lt;/p>
&lt;h2 id="準備">準備&lt;/h2>
&lt;h3 id="speech-service-の準備">Speech Service の準備&lt;/h3>
&lt;p>&lt;a href="https://portal.azure.com/">Azure Portal&lt;/a> から &lt;samp>Speech&lt;/samp> のリソースを作成し、Subscription Key を取得しておいてください。&lt;/p>
&lt;h3 id="speech-sdk-のインストール">Speech SDK のインストール&lt;/h3>
&lt;p>Python の &lt;code>azure-cognitiveservices-speech&lt;/code> パッケージをインストールします。&lt;/p>
&lt;pre tabindex="0">&lt;code>$ pip install azure-cognitiveservices-speech
&lt;/code>&lt;/pre>&lt;h3 id="visual-studio-c-redistributable-のインストール">Visual Studio C++ Redistributable のインストール&lt;/h3>
&lt;p>必要があれば、Visual Studio C++ の再頒布可能パッケージをインストールします。&lt;/p>
&lt;ul>
&lt;li>&lt;a href="https://support.microsoft.com/ja-jp/help/2977003/the-latest-supported-visual-c-downloads">Visual C++ 再頒布可能パッケージ&lt;/a> (&lt;a href="https://aka.ms/vs/16/release/vc_redist.x64.exe">vc_redist.x64.exe&lt;/a>)&lt;/li>
&lt;/ul>
&lt;h2 id="python-コード">Python コード&lt;/h2>
&lt;h3 id="一回だけ変換して終わるバージョン">一回だけ変換して終わるバージョン&lt;/h3>

&lt;figure class="xCodeBlock">
&lt;figcaption class="xCodeBlock_title">stt.py&lt;/figcaption>
&lt;div class="xCodeBlock_code">&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-python" data-lang="python">&lt;span class="line">&lt;span class="cl">&lt;span class="kn">import&lt;/span> &lt;span class="nn">azure.cognitiveservices.speech&lt;/span> &lt;span class="k">as&lt;/span> &lt;span class="nn">speechsdk&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># この設定は適宜変更してください&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">subscription&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="s2">&amp;#34;e1b5f0964ab743133b7de4f892741c7a&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">region&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="s2">&amp;#34;japaneast&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">language&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="s2">&amp;#34;ja-JP&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># proxy = (&amp;#34;proxy.example.com&amp;#34;, 8888, &amp;#34;&amp;#34;, &amp;#34;&amp;#34;)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># SpeechConfig オブジェクトを生成します&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">speech_config&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">speechsdk&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">SpeechConfig&lt;/span>&lt;span class="p">(&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">subscription&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="n">subscription&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">region&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="n">region&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">speech_recognition_language&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="n">language&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">if&lt;/span> &lt;span class="s1">&amp;#39;proxy&amp;#39;&lt;/span> &lt;span class="ow">in&lt;/span> &lt;span class="nb">locals&lt;/span>&lt;span class="p">():&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">speech_config&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">set_proxy&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="o">*&lt;/span>&lt;span class="n">proxy&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># SpeechRecognizer インスタンスを生成します&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">recognizer&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">speechsdk&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">SpeechRecognizer&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">speech_config&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="n">speech_config&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">print&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s2">&amp;#34;何かしゃべってください&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">result&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">recognizer&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">recognize_once&lt;/span>&lt;span class="p">()&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">if&lt;/span> &lt;span class="n">result&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">reason&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="n">speechsdk&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">ResultReason&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">RecognizedSpeech&lt;/span>&lt;span class="p">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nb">print&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s2">&amp;#34;「&lt;/span>&lt;span class="si">{}&lt;/span>&lt;span class="s2">」&amp;#34;&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">format&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">result&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">text&lt;/span>&lt;span class="p">))&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">elif&lt;/span> &lt;span class="n">result&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">reason&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="n">speechsdk&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">ResultReason&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">NoMatch&lt;/span>&lt;span class="p">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nb">print&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s2">&amp;#34;No speech could be recognized: &lt;/span>&lt;span class="si">{}&lt;/span>&lt;span class="s2">&amp;#34;&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">format&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">result&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">no_match_details&lt;/span>&lt;span class="p">))&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">elif&lt;/span> &lt;span class="n">result&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">reason&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="n">speechsdk&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">ResultReason&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">Canceled&lt;/span>&lt;span class="p">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">cancellation_details&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">result&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">cancellation_details&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nb">print&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s2">&amp;#34;Speech Recognition canceled: &lt;/span>&lt;span class="si">{}&lt;/span>&lt;span class="s2">&amp;#34;&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">format&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">cancellation_details&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">reason&lt;/span>&lt;span class="p">))&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="n">cancellation_details&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">reason&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="n">speechsdk&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">CancellationReason&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">Error&lt;/span>&lt;span class="p">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nb">print&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s2">&amp;#34;Error details: &lt;/span>&lt;span class="si">{}&lt;/span>&lt;span class="s2">&amp;#34;&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">format&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">cancellation_details&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">error_details&lt;/span>&lt;span class="p">))&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/div>
&lt;/figure>

&lt;h3 id="繰り返し入力を受け付けるバージョン">繰り返し入力を受け付けるバージョン&lt;/h3>
&lt;p>こちらのバージョンは、&lt;kbd>Ctrl+C&lt;/kbd> でプログラムを停止するまで、繰り返しユーザーの入力（発話）を受け付けます。&lt;/p></description></item></channel></rss>