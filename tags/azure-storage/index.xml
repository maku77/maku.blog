<?xml version="1.0" encoding="utf-8" standalone="yes"?><rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom"><channel><title>Azure Storage on まくろぐ</title><link>https://maku.blog/tags/azure-storage/</link><description>Recent content in Azure Storage on まくろぐ</description><generator>Hugo</generator><language>ja-jp</language><lastBuildDate>Tue, 17 Mar 2020 00:00:00 +0900</lastBuildDate><atom:link href="https://maku.blog/tags/azure-storage/index.xml" rel="self" type="application/rss+xml"/><item><title>Azure のストレージアカウントを作成する</title><link>https://maku.blog/p/7axgzfu/</link><pubDate>Tue, 17 Mar 2020 00:00:00 +0900</pubDate><guid>https://maku.blog/p/7axgzfu/</guid><description>&lt;p>Table Storage などのストレージ系サービスを使用するには、&lt;a href="https://portal.azure.com/">Azure ポータル&lt;/a> から &lt;strong>ストレージアカウント&lt;/strong> を作成しておく必要があります。
このトレージアカウントは Table Storage 専用ではなく、様々なストレージサービス（BLOB、ファイル、キュー、テーブル）をまとめて扱うものです。&lt;/p>
&lt;p>&lt;code>ストレージアカウント&lt;/code> → &lt;code>作成&lt;/code> のような感じで進めば作成用の画面が開くので、ストレージアカウント名などを入力します。
ストレージアカウント名は、Azure 内で一意（要するに世界中で一意）な名前を付ける必要があります。&lt;/p>


&lt;figure class="xImage">
 &lt;img style="border: solid #ccc 2px;" width="450" height="420" src="../../p/7axgzfu/img-create-account_hu2672013604081069431.png" alt="/p/7axgzfu/img-create-account.png" />
&lt;/figure>

&lt;p>選択項目によっては、料金が変わってくるものがあるので、情報アイコンの説明を見ながら、安いプランを選択していきます。
例えば、Table Storage のレプリケーションの種類別価格は次のようになっています（&lt;a href="https://azure.microsoft.com/ja-jp/pricing/details/storage/tables/">こちら&lt;/a>から抜粋）。&lt;/p>


&lt;figure class="xImage">
 &lt;img style="" width="901" height="141" src="../../p/7axgzfu/img-price.png" alt="/p/7axgzfu/img-price.png" />
 &lt;figcaption>図: Table Storage の月額&lt;/figcaption>
&lt;/figure>

&lt;p>入力が終わったら、&lt;code>作成&lt;/code> のボタンを押して、しばらく待てばストレージアカウントが作成されます（1分くらいかかります）。&lt;/p></description></item><item><title>Azure Storage で静的 Web サイトをホスティングする</title><link>https://maku.blog/p/gkardu9/</link><pubDate>Tue, 17 Mar 2020 00:00:00 +0900</pubDate><guid>https://maku.blog/p/gkardu9/</guid><description>&lt;p>（Azure Storage による静的な Web サイトのホスティング機能は &lt;a href="https://azure.microsoft.com/ja-jp/blog/static-websites-on-azure-storage-now-generally-available/">2018 年末にリリース&lt;/a> されました）&lt;/p>


&lt;figure class="xImage">
 &lt;img style="border: solid #ccc 2px;" width="462" height="148" src="../../p/gkardu9/img-003.png" alt="/p/gkardu9/img-003.png" />
&lt;/figure>

&lt;h2 id="ストレージアカウントを作成するまだ作成していない場合">ストレージアカウントを作成する（まだ作成していない場合）&lt;/h2>
&lt;p>Azure 上に静的な Web サイトをホスティングするためのストレージを作成するには、ストレージアカウントが必要です。
まだ作成していない場合は、下記の手順に従ってストレージアカウントを作成してください。
静的な Web サイトをホスティングする場合は、&lt;code>アカウントの種類 (Account kind)&lt;/code> の項目で &lt;strong>&lt;code>StorageV2（汎用v2）&lt;/code>&lt;/strong> というのを選んで作成しておく必要があります。&lt;/p>
&lt;p>→ &lt;a href="../../p/7axgzfu/">Azure のストレージアカウントを作成する&lt;/a>&lt;/p>
&lt;h2 id="静的な-web-サイトを有効にする">静的な Web サイトを有効にする&lt;/h2>
&lt;p>ストレージアカウントを作成したら、コンテンツのアップロード先である Azure ストレージコンテナーと、Web サイトの URL を生成します。
といっても、ストレージアカウントがあれば、&lt;a href="https://portal.azure.com/">Azure ポータル&lt;/a> から数秒で自動作成できます。&lt;/p>


&lt;figure class="xImage">
 &lt;img style="border: solid #ccc 2px;" width="724" height="315" src="../../p/gkardu9/img-001.png" alt="/p/gkardu9/img-001.png" />
&lt;/figure>

&lt;ol>
&lt;li>ストレージアカウントのページを開き、&lt;code>設定&lt;/code> → &lt;code>静的な Web サイト&lt;/code> を選択します。&lt;/li>
&lt;li>&lt;code>静的な Web サイト&lt;/code> のスイッチを &lt;strong>&lt;code>有効&lt;/code>&lt;/strong> に切り替えて &lt;code>保存&lt;/code> ボタンを押します。&lt;/li>
&lt;/ol>
&lt;p>これで、Web サイトをホスティングするための Azure ストレージコンテナー（BLOB を入れるコンテナー）が作成されます。
コンテナー名は自動的に &lt;strong>&lt;code>$web&lt;/code>&lt;/strong> になるようです。&lt;/p>
&lt;p>同時に、Web サイトの URL も自動的に生成されます。&lt;/p>


&lt;figure class="xImage">
 &lt;img style="border: solid #ccc 2px;" width="726" height="362" src="../../p/gkardu9/img-002.png" alt="/p/gkardu9/img-002.png" />
&lt;/figure>

&lt;p>これが Web ブラウザからサイトにアクセスするときのアドレスになります。
あとは、コンテナーに HTML ファイルをアップロードするだけです。&lt;/p></description></item><item><title>逆引き Azure CLI: ストレージアカウントのキーを確認する (storage account keys list)</title><link>https://maku.blog/p/3wk5vnw/</link><pubDate>Tue, 17 Mar 2020 00:00:00 +0900</pubDate><guid>https://maku.blog/p/3wk5vnw/</guid><description>&lt;p>Azure ストレージアカウントのキー（鍵）情報を取得するには、&lt;a href="../../p/ejar7k8">Azure にログイン&lt;/a> した状態で、以下のように実行します。&lt;/p>

&lt;figure class="xCodeBlock">

&lt;div class="xCodeBlock_code">&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-plain" data-lang="plain">&lt;span class="line">&lt;span class="cl">$ az storage account keys list --account-name ストレージアカウント名
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">[
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> {
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &amp;#34;keyName&amp;#34;: &amp;#34;key1&amp;#34;,
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &amp;#34;permissions&amp;#34;: &amp;#34;Full&amp;#34;,
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &amp;#34;value&amp;#34;: &amp;#34;7s+V+j4CcwDNHyTvx7/UXlgKN4HvFoUuIhOuzH1YLaBWgVTWQadQB2vFjRPTAv2aoGP2mpyQcMm4C+R55o3N9g==&amp;#34;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> },
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> {
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &amp;#34;keyName&amp;#34;: &amp;#34;key2&amp;#34;,
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &amp;#34;permissions&amp;#34;: &amp;#34;Full&amp;#34;,
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &amp;#34;value&amp;#34;: &amp;#34;+uzKfRt3rCP7RkNBXG93lqEqD7MLvgFQmKxudWHjYbDMUeFH0VmdMhN8V/6ChCwVANi6jaDL4ZKopfwV5RjY9g==&amp;#34;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> }
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">]&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/div>
&lt;/figure>

&lt;p>このストレージアカウントキーは、&lt;code>az storage&lt;/code> コマンドを使って Azure ストレージ上のデータを操作するときに必要になります。&lt;/p>
&lt;aside style="display: flex; border: thin dashed gray;">
&lt;div style="align-self: stretch; writing-mode: vertical-lr; text-align: center; letter-spacing: 0.2em; color: #666; border-right: thin dashed gray; padding: 0.4em 0; line-height: 1.5;">参考&lt;/div>
&lt;div style="align-self: center; padding: 0.6em 0; line-height: 1.2 !important;">&lt;ul>
&lt;li>&lt;a href="../../p/ptx36ue">BLOB ストレージにファイルをアップロードする (storage blob upload)&lt;/a>&lt;/li>
&lt;/ul>
&lt;/div>
&lt;/aside></description></item><item><title>逆引き Azure CLI: ストレージアカウントの接続文字列を確認する (storage account show-connection-string)</title><link>https://maku.blog/p/hquhjki/</link><pubDate>Tue, 17 Mar 2020 00:00:00 +0900</pubDate><guid>https://maku.blog/p/hquhjki/</guid><description>&lt;p>Azure CLI で Azure ストレージアカウントの接続文字列（アカウント名とキーがペアになったもの）を取得するには、&lt;strong>&lt;code>az storage account show-connection-string&lt;/code>&lt;/strong> コマンドを使用します。&lt;/p>
&lt;p>このコマンドを実行する前に、&lt;a href="../../p/ejar7k8">az login で Azure にログイン&lt;/a> しておく必要があります。&lt;/p>

&lt;figure class="xCodeBlock">
&lt;figcaption class="xCodeBlock_title">ストレージアカウントの接続文字列を取得&lt;/figcaption>
&lt;div class="xCodeBlock_code">&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-plain" data-lang="plain">&lt;span class="line">&lt;span class="cl">$ az storage account show-connection-string --name yourstorage
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">{
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &amp;#34;connectionString&amp;#34;: &amp;#34;DefaultEndpointsProtocol=https;EndpointSuffix=core.windows.net;AccountName=yourstorage;AccountKey=7s+V+j4CcwDNHyTvxTAv2aoGP2mpyQcMm4C+R7/UXlgKN4HvFoUuIhOuzH1YLaBWgVTWQadQB2vFjRP55o3N9g==&amp;#34;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">}&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/div>
&lt;/figure>

&lt;aside style="display: flex; border: thin dashed gray;">
&lt;div style="align-self: stretch; writing-mode: vertical-lr; text-align: center; letter-spacing: 0.2em; color: #666; border-right: thin dashed gray; padding: 0.4em 0; line-height: 1.5;">参考&lt;/div>
&lt;div style="align-self: center; padding: 0.6em 0; line-height: 1.2 !important;">&lt;ul>
&lt;li>&lt;a href="https://docs.microsoft.com/en-us/cli/azure/storage/account?view=azure-cli-latest#az-storage-account-show-connection-string">az storage account show-connection-string コマンド&lt;/a>&lt;/li>
&lt;/ul>
&lt;/div>
&lt;/aside></description></item><item><title>逆引き Azure CLI: Azure ストレージの SAS トークンを生成する (storage container generate-sas)</title><link>https://maku.blog/p/n4yqdys/</link><pubDate>Tue, 17 Mar 2020 00:00:00 +0900</pubDate><guid>https://maku.blog/p/n4yqdys/</guid><description>&lt;p>Azure ストレージの操作を行うとき、有効期限付きのアクセストークンである &lt;strong>SAS トークン&lt;/strong> が必要になることがあります。
SAS トークンは、&lt;strong>&lt;code>az storage container generate-sas&lt;/code>&lt;/strong> コマンドで生成することができます。&lt;/p>

&lt;figure class="xCodeBlock">
&lt;figcaption class="xCodeBlock_title">実際は 1 行&lt;/figcaption>
&lt;div class="xCodeBlock_code">&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-plain" data-lang="plain">&lt;span class="line">&lt;span class="cl">$ az storage container generate-sas
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> --name &amp;lt;BLOBコンテナー名&amp;gt;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> --expiry &amp;#34;2020-07-07T00:00:00Z&amp;#34;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> --permission acdlrw
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> --connection-string &amp;lt;ストレージアカウントの接続文字列&amp;gt;&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/div>
&lt;/figure>

&lt;p>&lt;a href="../../p/dofzeua/">ストレージアカウントの接続文字列&lt;/a>さえあれば、特に Azure ログインしたりせずに生成できます。
&lt;a href="../../p/hquhjki">接続文字列自体を Azure CLI で取得する&lt;/a>こともできます。&lt;/p>
&lt;p>SAS トークン生成時に指定するオプションの詳細は下記のコマンドリファレンスを参照してください。&lt;/p>
&lt;ul>
&lt;li>参考: &lt;a href="https://docs.microsoft.com/en-us/cli/azure/storage/container?view=azure-cli-latest#az-storage-container-generate-sas">az storage container generate-sas コマンド&lt;/a>&lt;/li>
&lt;/ul>
&lt;p>実行に成功すると、次のような文字列が標準出力に出力されます。
これが SAS トークンです。&lt;/p>

&lt;figure class="xCodeBlock">

&lt;div class="xCodeBlock_code">&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-plain" data-lang="plain">&lt;span class="line">&lt;span class="cl">&amp;#34;se=2020-07-07T00%3A00%3A00Z&amp;amp;sp=racwdl&amp;amp;sv=2018-11-09&amp;amp;sr=c&amp;amp;sig=c7bapOBvLkHVlebBIEQFQc2bGd%2BjmfScqKCbkLUzzoo%3D&amp;#34;&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/div>
&lt;/figure>

&lt;p>この SAS トークンは、AzCopy (&lt;code>azcopy&lt;/code>) ツールなどで、&lt;a href="../../p/gkardu9">BLOB ストレージにファイル転送&lt;/a>したりするときに必要になります。&lt;/p>
&lt;p>SAS トークンの生成には、有効期限を示す &lt;code>--expiry&lt;/code> オプションの指定が必須になっています（なくてもトークンの生成には成功しますが、使用時に認証エラーになるようです。不親切）。
ここで指定する日時のフォーマットは、少しでも間違えると出力される SAS トークンの &lt;code>se&lt;/code> パラメータが無効なものになってしまうので要注意です（こちらも生成時にはエラーになりません。不親切）。&lt;/p>
&lt;p>生成される SAS トークンの最後には、このトークン自体の署名がついています。
これにより、SAS トークン内の有効期限 (&lt;code>se&lt;/code>) などを部分的に改ざんしたりできないようになっています。&lt;/p></description></item><item><title>逆引き Azure CLI: BLOB ストレージにファイルをアップロードする (storage blob upload)</title><link>https://maku.blog/p/ptx36ue/</link><pubDate>Tue, 17 Mar 2020 00:00:00 +0900</pubDate><guid>https://maku.blog/p/ptx36ue/</guid><description>&lt;p>Azure CLI を使ってストレージアカウント上に作成された、既存の BLOB コンテナにコンテンツをアップロードするには、&lt;strong>&lt;code>az storage blob upload&lt;/code>&lt;/strong> コマンドを使用します。
Azure ポータルのサイト上でポチポチやってアップロードすることもできますが、自動化のことを考えると、コマンドラインを使った方がよいでしょう。&lt;/p>

&lt;figure class="xCodeBlock">
&lt;figcaption class="xCodeBlock_title">書式&lt;/figcaption>
&lt;div class="xCodeBlock_code">&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-plain" data-lang="plain">&lt;span class="line">&lt;span class="cl">az storage blob upload --account-name &amp;lt;ストレージアカウント名&amp;gt; --account-key &amp;lt;キー&amp;gt; -c &amp;lt;コンテナ名&amp;gt; --file &amp;lt;ローカルファイル名&amp;gt; --name &amp;lt;アップロード後のファイル名&amp;gt;&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/div>
&lt;/figure>


&lt;figure class="xCodeBlock">
&lt;figcaption class="xCodeBlock_title">実行例&lt;/figcaption>
&lt;div class="xCodeBlock_code">&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-plain" data-lang="plain">&lt;span class="line">&lt;span class="cl">$ az storage blob upload --account-name yourstorage --account-key vFjRP7s+V+j4CcwDNHyTvxT7/UXlgKN4HvFoUuIhOuzH1YLaBWgVTWQadQB2Av2aoGP2mpyQcMm4C+R55o3N9g== -c $web --file index.html --name index.html
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Finished[#############################################################] 100.0000%
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">{
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &amp;#34;etag&amp;#34;: &amp;#34;\&amp;#34;0x8D7CA465578BC90\&amp;#34;&amp;#34;,
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &amp;#34;lastModified&amp;#34;: &amp;#34;2020-03-17T07:39:32+00:00&amp;#34;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">}&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/div>
&lt;/figure>

&lt;p>アップロード時にストレージアカウントのキーを指定するので、あらかじめ &lt;code>az login&lt;/code> で Azure にログインしておく必要はありません。&lt;/p>
&lt;aside style="display: flex; border: thin dashed gray;">
&lt;div style="align-self: stretch; writing-mode: vertical-lr; text-align: center; letter-spacing: 0.2em; color: #666; border-right: thin dashed gray; padding: 0.4em 0; line-height: 1.5;">参考&lt;/div>
&lt;div style="align-self: center; padding: 0.6em 0; line-height: 1.2 !important;">&lt;ul>
&lt;li>&lt;a href="../../p/3wk5vnw">逆引き Azure CLI: ストレージアカウントのキーを確認する (storage account keys list)&lt;/a>&lt;/li>
&lt;/ul>
&lt;/div>
&lt;/aside></description></item></channel></rss>