<?xml version="1.0" encoding="utf-8" standalone="yes"?><rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom"><channel><title>Azure CLI on まくろぐ</title><link>https://maku.blog/tags/azure-cli/</link><description>Recent content in Azure CLI on まくろぐ</description><generator>Hugo</generator><language>ja-jp</language><lastBuildDate>Tue, 17 Mar 2020 00:00:00 +0900</lastBuildDate><atom:link href="https://maku.blog/tags/azure-cli/index.xml" rel="self" type="application/rss+xml"/><item><title>逆引き Azure CLI: Azure CLI（az コマンド）をインストールする</title><link>https://maku.blog/p/dwsog4p/</link><pubDate>Tue, 17 Mar 2020 00:00:00 +0900</pubDate><guid>https://maku.blog/p/dwsog4p/</guid><description>&lt;p>Azure CLI をインストールすると、&lt;strong>&lt;code>az&lt;/code>&lt;/strong> コマンドを使用して、Azure の様々な機能を呼び出すことができるようになります。
&lt;a href="https://portal.azure.com/">Azure ポータル&lt;/a> 上で実行できることは、ほとんど &lt;code>az&lt;/code> コマンドでも実行できるようになっています。&lt;/p>
&lt;p>Azure CLI は下記のサイトに従ってインストールします（インストーラを実行するだけです）。&lt;/p>
&lt;ul>
&lt;li>&lt;a href="https://docs.microsoft.com/ja-jp/cli/azure/?view=azure-cli-latest">Azure コマンドラインインターフェイス (CLI)&lt;/a>&lt;/li>
&lt;/ul>
&lt;p>実際には、Azure ポータル上で実行してしまった方が手軽なことが多いのですが、スクリプトなどで処理を自動化したい場合は Azure CLI を使うことになります。&lt;/p></description></item><item><title>逆引き Azure CLI: Azure にログインする (az login)</title><link>https://maku.blog/p/ejar7k8/</link><pubDate>Tue, 17 Mar 2020 00:00:00 +0900</pubDate><guid>https://maku.blog/p/ejar7k8/</guid><description>&lt;p>&lt;strong>&lt;code>az login&lt;/code>&lt;/strong> コマンドを使って Azure にログインすると、Azure アカウントに紐づいた情報（サブスクリプション情報など）を取得できるようになります。&lt;/p>
&lt;p>パラメータなしで実行してブラウザ上で認証することもできるし、コマンドラインからユーザ名とパスワードを指定することもできます。&lt;/p>

&lt;figure class="xCodeBlock">
&lt;figcaption class="xCodeBlock_title">ブラウザを起動して認証&lt;/figcaption>
&lt;div class="xCodeBlock_code">&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-plain" data-lang="plain">&lt;span class="line">&lt;span class="cl">$ az login&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/div>
&lt;/figure>


&lt;figure class="xCodeBlock">
&lt;figcaption class="xCodeBlock_title">ユーザー名をパラメータで指定&lt;/figcaption>
&lt;div class="xCodeBlock_code">&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-plain" data-lang="plain">&lt;span class="line">&lt;span class="cl">$ az login -u yourname@example.com
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Password: ********&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/div>
&lt;/figure>


&lt;figure class="xCodeBlock">
&lt;figcaption class="xCodeBlock_title">ユーザー名とパスワードをパラメータで指定&lt;/figcaption>
&lt;div class="xCodeBlock_code">&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-plain" data-lang="plain">&lt;span class="line">&lt;span class="cl">$ az login -u yourname@example.com -p yourpass&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/div>
&lt;/figure>

&lt;p>ログインが成功すると、&lt;strong>&lt;code>az account show&lt;/code>&lt;/strong> コマンドで、使用しているサブスクリプションの情報を確認できるようになります。&lt;/p>

&lt;figure class="xCodeBlock">

&lt;div class="xCodeBlock_code">&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-plain" data-lang="plain">&lt;span class="line">&lt;span class="cl">$ az account show
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">{
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &amp;#34;environmentName&amp;#34;: &amp;#34;AzureCloud&amp;#34;,
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &amp;#34;homeTenantId&amp;#34;: &amp;#34;b431a0d2-3656-ed42-9497-c0dfd20ae040&amp;#34;,
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &amp;#34;id&amp;#34;: &amp;#34;343f3fd9-1f19-1d49-7b92-5f365bbc6fd6&amp;#34;,
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &amp;#34;isDefault&amp;#34;: true,
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &amp;#34;managedByTenants&amp;#34;: [],
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &amp;#34;name&amp;#34;: &amp;#34;従量課金&amp;#34;,
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &amp;#34;state&amp;#34;: &amp;#34;Enabled&amp;#34;,
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &amp;#34;tenantId&amp;#34;: &amp;#34;b431a0d2-3656-ed42-9497-c0dfd20ae040&amp;#34;,
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &amp;#34;user&amp;#34;: {
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &amp;#34;name&amp;#34;: &amp;#34;yourname@example.com&amp;#34;,
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &amp;#34;type&amp;#34;: &amp;#34;user&amp;#34;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> }
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">}&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/div>
&lt;/figure></description></item><item><title>逆引き Azure CLI: プロキシ環境下で Azure CLI (az) を使用する</title><link>https://maku.blog/p/7g9seub/</link><pubDate>Tue, 17 Mar 2020 00:00:00 +0900</pubDate><guid>https://maku.blog/p/7g9seub/</guid><description>&lt;p>会社などのプロキシ環境下において &lt;code>az&lt;/code> コマンドを実行する場合は、環境変数 &lt;code>https_proxy&lt;/code> を設定しておきます。&lt;/p>

&lt;figure class="xCodeBlock">
&lt;figcaption class="xCodeBlock_title">Windows の場合&lt;/figcaption>
&lt;div class="xCodeBlock_code">&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-plain" data-lang="plain">&lt;span class="line">&lt;span class="cl">C:\&amp;gt; set https_proxy=http://proxy.example.com:8080&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/div>
&lt;/figure>


&lt;figure class="xCodeBlock">
&lt;figcaption class="xCodeBlock_title">Linux/Mac の場合&lt;/figcaption>
&lt;div class="xCodeBlock_code">&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-plain" data-lang="plain">&lt;span class="line">&lt;span class="cl">$ export https_proxy=http://proxy.example.com:8080&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/div>
&lt;/figure></description></item><item><title>逆引き Azure CLI: ストレージアカウントのキーを確認する (storage account keys list)</title><link>https://maku.blog/p/3wk5vnw/</link><pubDate>Tue, 17 Mar 2020 00:00:00 +0900</pubDate><guid>https://maku.blog/p/3wk5vnw/</guid><description>&lt;p>Azure ストレージアカウントのキー（鍵）情報を取得するには、&lt;a href="../../p/ejar7k8">Azure にログイン&lt;/a> した状態で、以下のように実行します。&lt;/p>

&lt;figure class="xCodeBlock">

&lt;div class="xCodeBlock_code">&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-plain" data-lang="plain">&lt;span class="line">&lt;span class="cl">$ az storage account keys list --account-name ストレージアカウント名
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">[
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> {
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &amp;#34;keyName&amp;#34;: &amp;#34;key1&amp;#34;,
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &amp;#34;permissions&amp;#34;: &amp;#34;Full&amp;#34;,
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &amp;#34;value&amp;#34;: &amp;#34;7s+V+j4CcwDNHyTvx7/UXlgKN4HvFoUuIhOuzH1YLaBWgVTWQadQB2vFjRPTAv2aoGP2mpyQcMm4C+R55o3N9g==&amp;#34;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> },
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> {
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &amp;#34;keyName&amp;#34;: &amp;#34;key2&amp;#34;,
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &amp;#34;permissions&amp;#34;: &amp;#34;Full&amp;#34;,
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &amp;#34;value&amp;#34;: &amp;#34;+uzKfRt3rCP7RkNBXG93lqEqD7MLvgFQmKxudWHjYbDMUeFH0VmdMhN8V/6ChCwVANi6jaDL4ZKopfwV5RjY9g==&amp;#34;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> }
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">]&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/div>
&lt;/figure>

&lt;p>このストレージアカウントキーは、&lt;code>az storage&lt;/code> コマンドを使って Azure ストレージ上のデータを操作するときに必要になります。&lt;/p>
&lt;aside style="display: flex; border: thin dashed gray;">
&lt;div style="align-self: stretch; writing-mode: vertical-lr; text-align: center; letter-spacing: 0.2em; color: #666; border-right: thin dashed gray; padding: 0.4em 0; line-height: 1.5;">参考&lt;/div>
&lt;div style="align-self: center; padding: 0.6em 0; line-height: 1.2 !important;">&lt;ul>
&lt;li>&lt;a href="../../p/ptx36ue">BLOB ストレージにファイルをアップロードする (storage blob upload)&lt;/a>&lt;/li>
&lt;/ul>
&lt;/div>
&lt;/aside></description></item><item><title>逆引き Azure CLI: ストレージアカウントの接続文字列を確認する (storage account show-connection-string)</title><link>https://maku.blog/p/hquhjki/</link><pubDate>Tue, 17 Mar 2020 00:00:00 +0900</pubDate><guid>https://maku.blog/p/hquhjki/</guid><description>&lt;p>Azure CLI で Azure ストレージアカウントの接続文字列（アカウント名とキーがペアになったもの）を取得するには、&lt;strong>&lt;code>az storage account show-connection-string&lt;/code>&lt;/strong> コマンドを使用します。&lt;/p>
&lt;p>このコマンドを実行する前に、&lt;a href="../../p/ejar7k8">az login で Azure にログイン&lt;/a> しておく必要があります。&lt;/p>

&lt;figure class="xCodeBlock">
&lt;figcaption class="xCodeBlock_title">ストレージアカウントの接続文字列を取得&lt;/figcaption>
&lt;div class="xCodeBlock_code">&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-plain" data-lang="plain">&lt;span class="line">&lt;span class="cl">$ az storage account show-connection-string --name yourstorage
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">{
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &amp;#34;connectionString&amp;#34;: &amp;#34;DefaultEndpointsProtocol=https;EndpointSuffix=core.windows.net;AccountName=yourstorage;AccountKey=7s+V+j4CcwDNHyTvxTAv2aoGP2mpyQcMm4C+R7/UXlgKN4HvFoUuIhOuzH1YLaBWgVTWQadQB2vFjRP55o3N9g==&amp;#34;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">}&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/div>
&lt;/figure>

&lt;aside style="display: flex; border: thin dashed gray;">
&lt;div style="align-self: stretch; writing-mode: vertical-lr; text-align: center; letter-spacing: 0.2em; color: #666; border-right: thin dashed gray; padding: 0.4em 0; line-height: 1.5;">参考&lt;/div>
&lt;div style="align-self: center; padding: 0.6em 0; line-height: 1.2 !important;">&lt;ul>
&lt;li>&lt;a href="https://docs.microsoft.com/en-us/cli/azure/storage/account?view=azure-cli-latest#az-storage-account-show-connection-string">az storage account show-connection-string コマンド&lt;/a>&lt;/li>
&lt;/ul>
&lt;/div>
&lt;/aside></description></item><item><title>逆引き Azure CLI: Azure ストレージの SAS トークンを生成する (storage container generate-sas)</title><link>https://maku.blog/p/n4yqdys/</link><pubDate>Tue, 17 Mar 2020 00:00:00 +0900</pubDate><guid>https://maku.blog/p/n4yqdys/</guid><description>&lt;p>Azure ストレージの操作を行うとき、有効期限付きのアクセストークンである &lt;strong>SAS トークン&lt;/strong> が必要になることがあります。
SAS トークンは、&lt;strong>&lt;code>az storage container generate-sas&lt;/code>&lt;/strong> コマンドで生成することができます。&lt;/p>

&lt;figure class="xCodeBlock">
&lt;figcaption class="xCodeBlock_title">実際は 1 行&lt;/figcaption>
&lt;div class="xCodeBlock_code">&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-plain" data-lang="plain">&lt;span class="line">&lt;span class="cl">$ az storage container generate-sas
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> --name &amp;lt;BLOBコンテナー名&amp;gt;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> --expiry &amp;#34;2020-07-07T00:00:00Z&amp;#34;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> --permission acdlrw
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> --connection-string &amp;lt;ストレージアカウントの接続文字列&amp;gt;&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/div>
&lt;/figure>

&lt;p>&lt;a href="../../p/dofzeua/">ストレージアカウントの接続文字列&lt;/a>さえあれば、特に Azure ログインしたりせずに生成できます。
&lt;a href="../../p/hquhjki">接続文字列自体を Azure CLI で取得する&lt;/a>こともできます。&lt;/p>
&lt;p>SAS トークン生成時に指定するオプションの詳細は下記のコマンドリファレンスを参照してください。&lt;/p>
&lt;ul>
&lt;li>参考: &lt;a href="https://docs.microsoft.com/en-us/cli/azure/storage/container?view=azure-cli-latest#az-storage-container-generate-sas">az storage container generate-sas コマンド&lt;/a>&lt;/li>
&lt;/ul>
&lt;p>実行に成功すると、次のような文字列が標準出力に出力されます。
これが SAS トークンです。&lt;/p>

&lt;figure class="xCodeBlock">

&lt;div class="xCodeBlock_code">&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-plain" data-lang="plain">&lt;span class="line">&lt;span class="cl">&amp;#34;se=2020-07-07T00%3A00%3A00Z&amp;amp;sp=racwdl&amp;amp;sv=2018-11-09&amp;amp;sr=c&amp;amp;sig=c7bapOBvLkHVlebBIEQFQc2bGd%2BjmfScqKCbkLUzzoo%3D&amp;#34;&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/div>
&lt;/figure>

&lt;p>この SAS トークンは、AzCopy (&lt;code>azcopy&lt;/code>) ツールなどで、&lt;a href="../../p/gkardu9">BLOB ストレージにファイル転送&lt;/a>したりするときに必要になります。&lt;/p>
&lt;p>SAS トークンの生成には、有効期限を示す &lt;code>--expiry&lt;/code> オプションの指定が必須になっています（なくてもトークンの生成には成功しますが、使用時に認証エラーになるようです。不親切）。
ここで指定する日時のフォーマットは、少しでも間違えると出力される SAS トークンの &lt;code>se&lt;/code> パラメータが無効なものになってしまうので要注意です（こちらも生成時にはエラーになりません。不親切）。&lt;/p>
&lt;p>生成される SAS トークンの最後には、このトークン自体の署名がついています。
これにより、SAS トークン内の有効期限 (&lt;code>se&lt;/code>) などを部分的に改ざんしたりできないようになっています。&lt;/p></description></item><item><title>逆引き Azure CLI: BLOB ストレージにファイルをアップロードする (storage blob upload)</title><link>https://maku.blog/p/ptx36ue/</link><pubDate>Tue, 17 Mar 2020 00:00:00 +0900</pubDate><guid>https://maku.blog/p/ptx36ue/</guid><description>&lt;p>Azure CLI を使ってストレージアカウント上に作成された、既存の BLOB コンテナにコンテンツをアップロードするには、&lt;strong>&lt;code>az storage blob upload&lt;/code>&lt;/strong> コマンドを使用します。
Azure ポータルのサイト上でポチポチやってアップロードすることもできますが、自動化のことを考えると、コマンドラインを使った方がよいでしょう。&lt;/p>

&lt;figure class="xCodeBlock">
&lt;figcaption class="xCodeBlock_title">書式&lt;/figcaption>
&lt;div class="xCodeBlock_code">&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-plain" data-lang="plain">&lt;span class="line">&lt;span class="cl">az storage blob upload --account-name &amp;lt;ストレージアカウント名&amp;gt; --account-key &amp;lt;キー&amp;gt; -c &amp;lt;コンテナ名&amp;gt; --file &amp;lt;ローカルファイル名&amp;gt; --name &amp;lt;アップロード後のファイル名&amp;gt;&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/div>
&lt;/figure>


&lt;figure class="xCodeBlock">
&lt;figcaption class="xCodeBlock_title">実行例&lt;/figcaption>
&lt;div class="xCodeBlock_code">&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-plain" data-lang="plain">&lt;span class="line">&lt;span class="cl">$ az storage blob upload --account-name yourstorage --account-key vFjRP7s+V+j4CcwDNHyTvxT7/UXlgKN4HvFoUuIhOuzH1YLaBWgVTWQadQB2Av2aoGP2mpyQcMm4C+R55o3N9g== -c $web --file index.html --name index.html
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Finished[#############################################################] 100.0000%
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">{
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &amp;#34;etag&amp;#34;: &amp;#34;\&amp;#34;0x8D7CA465578BC90\&amp;#34;&amp;#34;,
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &amp;#34;lastModified&amp;#34;: &amp;#34;2020-03-17T07:39:32+00:00&amp;#34;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">}&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/div>
&lt;/figure>

&lt;p>アップロード時にストレージアカウントのキーを指定するので、あらかじめ &lt;code>az login&lt;/code> で Azure にログインしておく必要はありません。&lt;/p>
&lt;aside style="display: flex; border: thin dashed gray;">
&lt;div style="align-self: stretch; writing-mode: vertical-lr; text-align: center; letter-spacing: 0.2em; color: #666; border-right: thin dashed gray; padding: 0.4em 0; line-height: 1.5;">参考&lt;/div>
&lt;div style="align-self: center; padding: 0.6em 0; line-height: 1.2 !important;">&lt;ul>
&lt;li>&lt;a href="../../p/3wk5vnw">逆引き Azure CLI: ストレージアカウントのキーを確認する (storage account keys list)&lt;/a>&lt;/li>
&lt;/ul>
&lt;/div>
&lt;/aside></description></item></channel></rss>