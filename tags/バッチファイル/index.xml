<?xml version="1.0" encoding="utf-8" standalone="yes"?><rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom"><channel><title>バッチファイル on まくろぐ</title><link>https://maku.blog/tags/%E3%83%90%E3%83%83%E3%83%81%E3%83%95%E3%82%A1%E3%82%A4%E3%83%AB/</link><description>Recent content in バッチファイル on まくろぐ</description><generator>Hugo</generator><language>ja-jp</language><lastBuildDate>Wed, 18 Mar 2020 00:00:00 +0900</lastBuildDate><atom:link href="https://maku.blog/tags/%E3%83%90%E3%83%83%E3%83%81%E3%83%95%E3%82%A1%E3%82%A4%E3%83%AB/index.xml" rel="self" type="application/rss+xml"/><item><title>PowerShell: バッチファイルから PowerShell を呼び出して結果を変数に格納する</title><link>https://maku.blog/p/372dx46/</link><pubDate>Wed, 18 Mar 2020 00:00:00 +0900</pubDate><guid>https://maku.blog/p/372dx46/</guid><description>&lt;p>Linux や mac では、外部コマンドをバッククォート (&lt;code>) で囲んでやるだけで実行結果を取得できますが、バッチファイルで同じようなことをするには &lt;/code>FOR /F` コマンドを使用します。
本来は、コマンドの出力結果を一行ずつ処理するためのコマンドですが、次のようにすれば、コマンドの実行結果を一行だけ変数に格納できます。&lt;/p>

&lt;figure class="xCodeBlock">

&lt;div class="xCodeBlock_code">&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-batch" data-lang="batch">&lt;span class="line">&lt;span class="cl">&lt;span class="k">FOR&lt;/span> &lt;span class="k">/F&lt;/span> &lt;span class="s2">&amp;#34;usebackq delims=&amp;#34;&lt;/span> &lt;span class="se">%%&lt;/span>A &lt;span class="k">IN&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="sb">`外部コマンド`&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="k">DO&lt;/span> &lt;span class="k">set&lt;/span> &lt;span class="nv">変数名&lt;/span>&lt;span class="p">=&lt;/span>&lt;span class="se">%%&lt;/span>A&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/div>
&lt;/figure>

&lt;ul>
&lt;li>FOR ループのパラメータの意味
&lt;ul>
&lt;li>&lt;code>/F&lt;/code>: コマンドの出力結果をループ処理する&lt;/li>
&lt;li>&lt;code>usebackq&lt;/code>: バッククォートで囲まれた文字列全体を外部コマンドとみなす&lt;/li>
&lt;li>&lt;code>delims=&lt;/code>: コマンド実行結果にスペースが含まれていても分割せずに取得（ここではデリミタ文字をなくしている）&lt;/li>
&lt;/ul>
&lt;/li>
&lt;/ul>
&lt;p>上記の &lt;code>外部コマンド&lt;/code> のところで、&lt;strong>&lt;code>powershell&lt;/code>&lt;/strong> コマンドを実行すれば、PowerShell で実行した結果をバッチファイル内の変数で受け取ることができます。&lt;/p>
&lt;p>例えば、次のバッチファイル (&lt;code>next-month.bat&lt;/code>) では、1か月後の日時を PowerShell で求めて、その結果をバッチファイル内の &lt;code>next_month&lt;/code> 変数に取得しています。&lt;/p>

&lt;figure class="xCodeBlock">
&lt;figcaption class="xCodeBlock_title">next-month.bat&lt;/figcaption>
&lt;div class="xCodeBlock_code">&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-batch" data-lang="batch">&lt;span class="line">&lt;span class="cl">&lt;span class="p">@&lt;/span>&lt;span class="k">echo&lt;/span> off
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">setlocal&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">FOR&lt;/span> &lt;span class="k">/F&lt;/span> &lt;span class="s2">&amp;#34;usebackq delims=&amp;#34;&lt;/span> &lt;span class="se">%%&lt;/span>A &lt;span class="k">IN&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="sb">`powershell &amp;#34;(Get-Date).AddMonths(1).ToString(&amp;#39;yyyy-MM-dd&amp;#39;)&amp;#34;`&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="k">DO&lt;/span> &lt;span class="k">set&lt;/span> &lt;span class="nv">next_month&lt;/span>&lt;span class="p">=&lt;/span>&lt;span class="se">%%&lt;/span>A
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">echo&lt;/span> &lt;span class="nv">%next_month%&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/div>
&lt;/figure>

&lt;p>次のように PowerShell で実行するコマンドを分離しておくと見やすいかもしれません。
&lt;code>ps_command&lt;/code> 変数の内容を置き換えるだけで、別のコマンドに対応できます。&lt;/p>

&lt;figure class="xCodeBlock">

&lt;div class="xCodeBlock_code">&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-batch" data-lang="batch">&lt;span class="line">&lt;span class="cl">&lt;span class="k">set&lt;/span> &lt;span class="nv">ps_command&lt;/span>&lt;span class="p">=&lt;/span>`powershell &lt;span class="s2">&amp;#34;(Get-Date).AddMonths(1).ToString(&amp;#39;yyyy-MM-dd&amp;#39;)&amp;#34;&lt;/span>`
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">FOR&lt;/span> &lt;span class="k">/F&lt;/span> &lt;span class="s2">&amp;#34;usebackq delims=&amp;#34;&lt;/span> &lt;span class="se">%%&lt;/span>A &lt;span class="k">IN&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nv">%ps_command%&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="k">DO&lt;/span> &lt;span class="k">set&lt;/span> &lt;span class="nv">result&lt;/span>&lt;span class="p">=&lt;/span>&lt;span class="se">%%&lt;/span>A
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">echo&lt;/span> &lt;span class="nv">%result%&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/div>
&lt;/figure>


&lt;figure class="xCodeBlock">
&lt;figcaption class="xCodeBlock_title">実行結果&lt;/figcaption>
&lt;div class="xCodeBlock_code">&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-plain" data-lang="plain">&lt;span class="line">&lt;span class="cl">C:\&amp;gt; next-month
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">2020-04-19&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/div>
&lt;/figure></description></item></channel></rss>