<?xml version="1.0" encoding="utf-8" standalone="yes"?><rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom"><channel><title>Azure Table Storage on まくろぐ</title><link>https://maku.blog/tags/azure-table-storage/</link><description>Recent content in Azure Table Storage on まくろぐ</description><generator>Hugo</generator><language>ja-jp</language><lastBuildDate>Thu, 04 Jun 2020 00:00:00 +0900</lastBuildDate><atom:link href="https://maku.blog/tags/azure-table-storage/index.xml" rel="self" type="application/rss+xml"/><item><title>Azure Table Strage を使ってみる (1) テーブルの作成</title><link>https://maku.blog/p/xyzwod2/</link><pubDate>Tue, 28 Jan 2020 00:00:00 +0900</pubDate><guid>https://maku.blog/p/xyzwod2/</guid><description>&lt;h2 id="ストレージアカウントを作成する">ストレージアカウントを作成する&lt;/h2>
&lt;p>Table Storage や BLOB Storage などの個々のストレージ系サービスは、ストレージアカウントに紐づく形で管理されます。
まずは、ストレージアカウントを作成しておく必要があります。&lt;/p>
&lt;ul>
&lt;li>&lt;a href="../../p/7axgzfu">Azure のストレージアカウントを作成する&lt;/a>&lt;/li>
&lt;/ul>
&lt;h2 id="table-storage-にテーブルを作ってみる">Table Storage にテーブルを作ってみる&lt;/h2>
&lt;h3 id="テーブルの作成">テーブルの作成&lt;/h3>
&lt;p>上記で作成したストレージアカウントを選択し、&lt;code>Table Service&lt;/code> → &lt;code>テーブル&lt;/code> を選択し、&lt;code>作成&lt;/code> ボタンを押すと、Table Service 上に新しいテーブルを作成することができます。&lt;/p>


&lt;figure class="xImage">
 &lt;img style="border: solid #ccc 2px;" width="600" height="292" src="../../p/xyzwod2/img-create-table_hu9213061141229059925.png" alt="/p/xyzwod2/img-create-table.png" />
&lt;/figure>

&lt;p>ここでは、書籍を管理するための、&lt;code>books&lt;/code> テーブルを作成してみました。&lt;/p>
&lt;h3 id="エンティティの追加">エンティティの追加&lt;/h3>
&lt;p>テーブルができたら、そこに適当にデータを追加していきます。
Table Strorage では、テーブル内の個々のデータのことを「&lt;strong>エンティティ&lt;/strong>」と呼びます（RDB でいうレコードです）。&lt;/p>
&lt;p>ストレージアカウントのメニューにある、「Storage Explorer」を使ってエンティティを追加できます。&lt;/p>


&lt;figure class="xImage">
 &lt;img style="border: solid #ccc 2px;" width="734" height="388" src="../../p/xyzwod2/img-create-entity.png" alt="/p/xyzwod2/img-create-entity.png" />
&lt;/figure>

&lt;p>「エンティティの追加」ダイアログが表示されるので、ここでエンティティの情報を入力していきます。
デフォルトでは、&lt;code>PartitionKey&lt;/code> と &lt;code>RowKey&lt;/code> という&lt;strong>プロパティ&lt;/strong>（RDB でいうフィールド）が定義されていますが、本の情報を入力するために、タイトル (&lt;code>Title&lt;/code>) と著者 (&lt;code>Author&lt;/code>) のプロパティを追加しておきます。
プロパティ名は、C# の慣例に従って、単語の先頭を大文字で始める &lt;strong>CamelCase で定義&lt;/strong> しておくのがよいようです（C# から使うとは限らないのですが^^;）。&lt;/p>


&lt;figure class="xImage">
 &lt;img style="border: solid #ccc 2px;" width="547" height="318" src="../../p/xyzwod2/img-create-entity2.png" alt="/p/xyzwod2/img-create-entity2.png" />
&lt;/figure>

&lt;p>最初のデータとして次のように入力してます。&lt;/p>
&lt;ul>
&lt;li>&lt;b>PartitionKey&lt;/b>
: book&lt;/li>
&lt;li>&lt;b>RowKey&lt;/b>
: 1&lt;/li>
&lt;li>&lt;b>Title&lt;/b>
: まくの秘密&lt;/li>
&lt;li>&lt;b>Author&lt;/b>
: まく&lt;/li>
&lt;/ul>
&lt;p>&lt;code>PartitionKey&lt;/code> と &lt;code>RowKey&lt;/code> は、Table Storage がデフォルトで用意する文字列型プロパティで、これらを組み合わせたものがテーブル内でデータを一意に特定する情報になります（RDB のプライマリキーのようなもの）。
詳しくは後述しますが、ここでは単純に &lt;code>book&lt;/code> というパーティション名を付けています。&lt;/p></description></item><item><title>Azure Table Strage を使ってみる (2) 接続情報（キー）を確認する</title><link>https://maku.blog/p/dofzeua/</link><pubDate>Fri, 31 Jan 2020 00:00:00 +0900</pubDate><guid>https://maku.blog/p/dofzeua/</guid><description>&lt;p>Table Storage サービスの &lt;a href="../../p/xyzwod2">ストレージアカウントを作成&lt;/a> すると、各種プログラムから Table Storage にアクセスするための接続情報（キー）を取得することができます。&lt;/p>
&lt;p>Table Storage の接続情報は、&lt;a href="https://portal.azure.com/">Azure ポータル&lt;/a> からストレージアカウントのリソースを開き、&lt;strong>&lt;code>設定&lt;/code>&lt;/strong> → &lt;strong>&lt;code>アクセスキー&lt;/code>&lt;/strong> と辿ると確認することができます。&lt;/p>


&lt;figure class="xImage">
 &lt;img style="border: solid #ccc 2px;" width="696" height="391" src="../../p/dofzeua/img-key-info.png" alt="/p/dofzeua/img-key-info.png" />
&lt;/figure>

&lt;p>Python や Node.js などのプログラムから Azure Storage に接続するには、上の図の中の、&lt;/p>
&lt;ul>
&lt;li>&lt;strong>ストレージアカウント名&lt;/strong> と &lt;strong>キー&lt;/strong> のペア&lt;/li>
&lt;li>&lt;strong>接続文字列&lt;/strong>&lt;/li>
&lt;/ul>
&lt;p>のいずれかの情報が必要です。&lt;/p></description></item><item><title>Azure Table Strage を使ってみる (3) Python からテーブル操作してみる</title><link>https://maku.blog/p/o8ufwct/</link><pubDate>Wed, 29 Jan 2020 00:00:00 +0900</pubDate><guid>https://maku.blog/p/o8ufwct/</guid><description>&lt;h2 id="azure-cosmosdb-table-パッケージのインストール">azure-cosmosdb-table パッケージのインストール&lt;/h2>
&lt;p>Python から Azure Table Storage を操作するには、&lt;a href="https://pypi.org/project/azure-cosmosdb-table/">&lt;code>azure-cosmosdb-table&lt;/code>&lt;/a> というライブラリを使用します。&lt;/p>

&lt;figure class="xCodeBlock">
&lt;figcaption class="xCodeBlock_title">azure-cosmosdb-table のインストール&lt;/figcaption>
&lt;div class="xCodeBlock_code">&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-plain" data-lang="plain">&lt;span class="line">&lt;span class="cl">$ pip install azure-cosmosdb-table&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/div>
&lt;/figure>

&lt;div class="xNote">
 &lt;span class="xNote_title">☝️ ワンポイント&lt;/span>
 &lt;span class="xNote_body">&lt;p>Cosmos DB をまったく使わない場合でも cosmosdb と名前のついたライブラリを使わせようとするのは、 &lt;del>Microsoft の策略&lt;/del> Cosmos DB に力を入れているという意思表示でしょう。
正直なところ Cosmos DB はお金がかかりすぎて個人の趣味レベルでは使えないのですが。。。&lt;/p>
&lt;p>（追記: 2021年）CosmosDB に無料枠ができて少しずつ個人利用もできそうな感じになってきました。&lt;/p>
&lt;/span>
&lt;/div>
&lt;h2 id="tableservice-オブジェクトの生成">TableService オブジェクトの生成&lt;/h2>
&lt;p>Azure Storage にアクセスするには、接続情報（ストレージアカウント名とキー）が必要になるので、&lt;a href="https://portal.azure.com/">Azure ポータル&lt;/a> で確認しておいてください。&lt;/p>
&lt;ul>
&lt;li>参考: &lt;a href="../../p/dofzeua">Azure Storage の接続情報（キー）を確認する&lt;/a>&lt;/li>
&lt;/ul>
&lt;p>Table Storage にアクセスしてごにょごにょするには、&lt;a href="https://docs.microsoft.com/ja-jp/python/api/azure-cosmosdb-table/azure.cosmosdb.table.tableservice.tableservice?view=azure-python">TableService クラス&lt;/a> のメソッドを使用します。
&lt;code>TableService&lt;/code> のコンストラクタには、ストレージアカウント名とキーを渡します。&lt;/p>

&lt;figure class="xCodeBlock">

&lt;div class="xCodeBlock_code">&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-python" data-lang="python">&lt;span class="line">&lt;span class="cl">&lt;span class="kn">from&lt;/span> &lt;span class="nn">azure.cosmosdb.table.tableservice&lt;/span> &lt;span class="kn">import&lt;/span> &lt;span class="n">TableService&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">STORAGE_NAME&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="s1">&amp;#39;maku77storage&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">STORAGE_KEY&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="s1">&amp;#39;XlgKN4Hv...(省略)...F55o3N9g==&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">table_service&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">TableService&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">account_name&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="n">STORAGE_NAME&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">account_key&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="n">STORAGE_KEY&lt;/span>&lt;span class="p">)&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/div>
&lt;/figure>

&lt;div class="xNote">
 &lt;span class="xNote_title">☝️ URL の指定は必要ない？&lt;/span>
 &lt;span class="xNote_body">接続先アドレス (URL) の構築は &lt;code>TableService&lt;/code> クラスがよろしくやってくれるので、実装コードがとてもスッキリします。
ストレージアカウント名は Azure 内（世界中）で一意になっているので、ストレージアカウント名さえ指定すれば、Web API の URL も自動的に決まるということですね。&lt;/span>
&lt;/div>

&lt;h3 id="ストレージアカウントのキーを環境変数から取得する">ストレージアカウントのキーを環境変数から取得する&lt;/h3>
&lt;p>ストレージアカウントにアクセスするためのキー情報をスクリプト内にハードコーディングするのは望ましくないので、環境変数などから取得するようにしておくとよいでしょう。&lt;/p>

&lt;figure class="xCodeBlock">
&lt;figcaption class="xCodeBlock_title">環境変数から Azure Storage のアクセスキーを取得&lt;/figcaption>
&lt;div class="xCodeBlock_code">&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-python" data-lang="python">&lt;span class="line">&lt;span class="cl">&lt;span class="kn">import&lt;/span> &lt;span class="nn">os&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kn">import&lt;/span> &lt;span class="nn">sys&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">if&lt;/span> &lt;span class="s1">&amp;#39;AZURE_STORAGE_KEY&amp;#39;&lt;/span> &lt;span class="ow">not&lt;/span> &lt;span class="ow">in&lt;/span> &lt;span class="n">os&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">environ&lt;/span>&lt;span class="p">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nb">print&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s1">&amp;#39;Error: AZURE_STORAGE_KEY not found&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">file&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="n">sys&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">stderr&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">sys&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">exit&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">storage_key&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">os&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">getenv&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s1">&amp;#39;AZURE_STORAGE_KEY&amp;#39;&lt;/span>&lt;span class="p">)&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/div>
&lt;/figure>

&lt;h3 id="プロキシ環境からアクセスする場合">プロキシ環境からアクセスする場合&lt;/h3>
&lt;p>&lt;code>TableService&lt;/code> クラスをプロキシ環境内で使用する場合は、OS の &lt;strong>&lt;code>https_proxy&lt;/code>&lt;/strong> 環境変数で設定してしまうのが簡単です。
OS の &lt;code>https_proxy&lt;/code> 環境変数を設定するのを避けたいときは、Python スクリプトの中からプロキシを設定してしまうこともできます。&lt;/p></description></item><item><title>Azure Table Strage を使ってみる (4) Node.js からテーブル操作してみる</title><link>https://maku.blog/p/ccoonon/</link><pubDate>Fri, 31 Jan 2020 00:00:00 +0900</pubDate><guid>https://maku.blog/p/ccoonon/</guid><description>&lt;h2 id="azure-storage-パッケージのインストール">azure-storage パッケージのインストール&lt;/h2>
&lt;p>Node.js から Azure Table Storage を操作するには、&lt;a href="https://www.npmjs.com/package/azure-storage">&lt;code>azure-storage&lt;/code>&lt;/a> というライブラリを使用します。
&lt;code>npm&lt;/code> コマンドで簡単にインストールすることができます。&lt;/p>

&lt;figure class="xCodeBlock">
&lt;figcaption class="xCodeBlock_title">azure-storage のインストール&lt;/figcaption>
&lt;div class="xCodeBlock_code">&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-plain" data-lang="plain">&lt;span class="line">&lt;span class="cl">$ npm install --save azure-storage&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/div>
&lt;/figure>

&lt;ul>
&lt;li>参考: &lt;a href="https://maku77.github.io/nodejs/npm/install-package.html">npm によるパッケージのインストール | Node.js ノート&lt;/a>&lt;/li>
&lt;/ul>
&lt;h2 id="tableservice-オブジェクトの生成">TableService オブジェクトの生成&lt;/h2>
&lt;p>Azure Storage にアクセスするには、接続情報（ストレージアカウント名とキー）が必要になるので、&lt;a href="https://portal.azure.com/">Azure ポータル&lt;/a> で確認しておいてください。&lt;/p>
&lt;ul>
&lt;li>参考: &lt;a href="../../p/dofzeua">Azure Storage の接続情報（キー）を確認する&lt;/a>&lt;/li>
&lt;/ul>
&lt;h3 id="接続情報としてデフォルトの環境変数を使用する">接続情報としてデフォルトの環境変数を使用する&lt;/h3>
&lt;p>Node.js から Table Storage を扱うには、&lt;code>azure-storage&lt;/code> モジュールが提供する &lt;a href="https://azure.github.io/azure-storage-node/TableService.html">TableService クラス&lt;/a> を使用します。
&lt;code>TableService&lt;/code> のインスタンスは下記のように生成することができます。&lt;/p>

&lt;figure class="xCodeBlock">

&lt;div class="xCodeBlock_code">&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-js" data-lang="js">&lt;span class="line">&lt;span class="cl">&lt;span class="kr">const&lt;/span> &lt;span class="nx">azure&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nx">require&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s1">&amp;#39;azure-storage&amp;#39;&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kr">const&lt;/span> &lt;span class="nx">tableService&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="k">new&lt;/span> &lt;span class="nx">azure&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">TableService&lt;/span>&lt;span class="p">();&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/div>
&lt;/figure>

&lt;p>上記のように、&lt;code>TableService&lt;/code> のコンストラクのパラメータを何も指定しないと、接続のために下記のような環境変数が参照されます。&lt;/p>
&lt;ol>
&lt;li>&lt;b>AZURE_STORAGE_ACCOUNT&lt;/b>
 &amp;hellip; Azure Storage の「ストレージアカウント名」&lt;/li>
&lt;li>&lt;b>AZURE_STORAGE_ACCESS_KEY&lt;/b>
 &amp;hellip; Azure Storage の「キー」&lt;/li>
&lt;li>&lt;b>AZURE_STORAGE_CONNECTION_STRING&lt;/b>
 &amp;hellip; Azure Storage の「接続文字列」&lt;/li>
&lt;/ol>
&lt;p>1 と 2 を両方とも設定するか、3 を設定しておけば Azure Storage にアクセスできるようになります。&lt;/p></description></item><item><title>Azure Table Stroage を使ってみる: TableService を Promise 化して使いやすくする</title><link>https://maku.blog/p/4m96s2r/</link><pubDate>Thu, 04 Jun 2020 00:00:00 +0900</pubDate><guid>https://maku.blog/p/4m96s2r/</guid><description>&lt;h2 id="promisetableservice-クラスの概要">PromiseTableService クラスの概要&lt;/h2>
&lt;p>Node.js から Azure Table Storage を操作する場合は、&lt;code>azure-storage&lt;/code> パッケージの &lt;a href="https://azure.github.io/azure-storage-node/TableService.html">TableService クラス&lt;/a> を使用するのですが、このクラスは残念ながら &lt;a href="https://maku77.github.io/js/async/promise.html">Promise 対応&lt;/a> 対応されておらず、旧式のコールバック形式での呼び出しが強制されます。&lt;/p>
&lt;p>下記の &lt;code>azure-table-promise&lt;/code> パッケージが提供している &lt;strong>&lt;code>PromiseTableService&lt;/code>&lt;/strong> クラスを使用すると、&lt;code>TableService&lt;/code> を &lt;code>Promise&lt;/code> 化して使用することができます。&lt;/p>
&lt;ul>
&lt;li>&lt;a href="https://www.npmjs.com/package/azure-table-promise">azure-table-promise - npm パッケージ&lt;/a>&lt;/li>
&lt;/ul>
&lt;p>ちなみに、下記の Issue で公式パッケージの &lt;code>Promise&lt;/code> 化の議論がされているのですが、&lt;code>TableService&lt;/code> クラスはいまだに対応されてませんね（2020年6月現在）。&lt;/p>
&lt;ul>
&lt;li>参考: &lt;a href="https://github.com/azure/azure-storage-node/issues/110">Promise support · Issue #110 · Azure/azure-storage-node&lt;/a>&lt;/li>
&lt;/ul>
&lt;p>こういった対応は本家の方でサクッとやってくれれば 3rd パーティライブラリの乱立が防げるんですけどね。。。&lt;/p>
&lt;h2 id="promisetableservice-を使ってみる">PromiseTableService を使ってみる&lt;/h2>
&lt;p>まず必要なモジュールをインストールします。
&lt;code>azure-storage&lt;/code> は本家 Microsoft の &lt;code>TableService&lt;/code> クラスを使うためのモジュールで、&lt;code>azure-table-promise&lt;/code> がそれを &lt;code>Promise&lt;/code> ラップするためのモジュールです。
ここでは TypeScript を使うので、Node.js 型定義もインストールしておきます。&lt;/p>

&lt;figure class="xCodeBlock">
&lt;figcaption class="xCodeBlock_title">npm モジュールのインストール&lt;/figcaption>
&lt;div class="xCodeBlock_code">&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-plain" data-lang="plain">&lt;span class="line">&lt;span class="cl">$ npm install --save-dev @types/node
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">$ npm install --save azure-storage
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">$ npm install --save azure-table-promise&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/div>
&lt;/figure>

&lt;p>次の &lt;code>MyTableStorage&lt;/code> クラスは、&lt;code>PromiseTableService&lt;/code> を使って TableStroage から情報を取得するサンプルです。
コンストラクタで &lt;code>PromiseTableService&lt;/code> インスタンスを生成し、&lt;code>getRandomMessage()&lt;/code> メソッドで、&lt;code>randommessage&lt;/code> テーブルの値をランダムに取得しています。&lt;/p></description></item></channel></rss>