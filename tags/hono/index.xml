<?xml version="1.0" encoding="utf-8" standalone="yes"?><rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom"><channel><title>Hono on まくろぐ</title><link>https://maku.blog/tags/hono/</link><description>Recent content in Hono on まくろぐ</description><generator>Hugo</generator><language>ja-jp</language><lastBuildDate>Sun, 19 Jan 2025 00:00:00 +0900</lastBuildDate><atom:link href="https://maku.blog/tags/hono/index.xml" rel="self" type="application/rss+xml"/><item><title>Cloudflare Workers の KV ストレージでアクセストークンをキャッシュする</title><link>https://maku.blog/p/q896mzu/</link><pubDate>Sun, 19 Jan 2025 00:00:00 +0900</pubDate><guid>https://maku.blog/p/q896mzu/</guid><description>&lt;h2 id="何をするか">何をするか&lt;/h2>
&lt;p>ここでは、Cloudflare Worker から KV ストレージを使用する例として、サードパーティ製 API のアクセストークンなど、&lt;strong>有効期限のある情報をキャッシュする方法&lt;/strong> を紹介します。&lt;/p>
&lt;p>サードパーティ API としてアクセストークン（あるいはリフレッシュトークン）を要求する API が定義されている場合、取得したトークンは有効期限内は再利用することが想定されています。
しかし、呼び出しごとに独立したコンテキストで動作する Cloudflare Workers の環境では、呼び出しのたびにトークンを取得することになってしまいます。
このようなケースでは、取得したトークンを KV ストレージにキャッシュしておくことで、次回のアクセス時に再利用することができます。&lt;/p>
&lt;p>KV では、キーと値のペアを保存するときにオプション情報として TTL (Time To Live) を指定することができるので、こういった有効期限のある情報をキャッシュするのに適しています。
KV ストレージの基本的な使い方は下記を参照してください。&lt;/p>
&lt;ul>
&lt;li>参考: &lt;a href="../../p/xb5cpr6/">Cloudflare Workers の KV ストレージの使い方&lt;/a>&lt;/li>
&lt;/ul>
&lt;h2 id="プロジェクトと-kv-namespace-を作成する">プロジェクトと KV namespace を作成する&lt;/h2>
&lt;p>Cloudflare Worker のプロジェクトをまだ作成していない場合は先に作成しておきます。
ここでは、&lt;a href="../../p/33cc7jy/">Hono フレームワークを使用する&lt;/a>プロジェクトの雛形を作成します。&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-console" data-lang="console">&lt;span class="line">&lt;span class="cl">&lt;span class="gp">$&lt;/span> pnpm create hono@latest hello-hono
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="gp">$&lt;/span> &lt;span class="nb">cd&lt;/span> hello-hono
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>次に、&lt;code>wrangler kv&lt;/code> コマンドを使って KV namespace を作成します。
名前は単純に &lt;code>KV&lt;/code> としておきます。&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-console" data-lang="console">&lt;span class="line">&lt;span class="cl">&lt;span class="gp">$&lt;/span> wrangler kv namespace create KV
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>KV namespace が作成できたら、コマンドの出力を参考に、&lt;code>wrangler.toml&lt;/code>（あるいは &lt;code>wrangler.json&lt;/code>）に KV namespace のバインド設定を追加します。&lt;/p></description></item><item><title>Cloudflare Workers の KV ストレージの使い方</title><link>https://maku.blog/p/xb5cpr6/</link><pubDate>Sun, 19 Jan 2025 00:00:00 +0900</pubDate><guid>https://maku.blog/p/xb5cpr6/</guid><description>&lt;h2 id="cloudflare-workers-kv-とは">Cloudflare Workers KV とは&lt;/h2>
&lt;p>Cloudflare Workers は基本的にステートレスなサーバーレスプラットフォームですが、&lt;a href="https://developers.cloudflare.com/kv/">KV&lt;/a> というデータストアを使うことで、複数のアクセス間でデータを共有することができます。
KV という名前の通り、キー (key) と値 (value) のペアを保存することができ、Worker のコードから簡単にアクセスできるようになっています。&lt;/p>
&lt;p>Cloudflare Workers の基本的な使い方は&lt;a href="../../p/rn7p7n5/">こちらを参照&lt;/a>してください。
下記作業では、すでに Cloudflare Workers のプロジェクト (&lt;code>hello-worker&lt;/code>) が作成されていることを前提としています。
まだプロジェクトが作成されていない場合は、下記のように &lt;code>wrangler&lt;/code> コマンドでプロジェクトを作成してください。&lt;/p>

&lt;figure class="xCodeBlock">
&lt;figcaption class="xCodeBlock_title">Cloudflare Workers プロジェクトの作成&lt;/figcaption>
&lt;div class="xCodeBlock_code">&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-console" data-lang="console">&lt;span class="line">&lt;span class="cl">&lt;span class="gp">$&lt;/span> wrangler init hello-worker
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="gp">$&lt;/span> &lt;span class="nb">cd&lt;/span> hello-worker
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/div>
&lt;/figure>

&lt;h2 id="kv-namespace-の作成">KV namespace の作成&lt;/h2>
&lt;p>KV にデータを保存するためには、まずは key &amp;amp; value の入れ物である &lt;strong>KV namespace&lt;/strong> を作成する必要があります。
アカウント内に KV namespace を作成するには、&lt;strong>&lt;code>wrangler kv namespace create&lt;/code>&lt;/strong> コマンドを使います。
ここでは、単純に &lt;code>KV&lt;/code> という名前の KV namespace を作成してみます。&lt;/p>

&lt;figure class="xCodeBlock">
&lt;figcaption class="xCodeBlock_title">KV namespace の作成&lt;/figcaption>
&lt;div class="xCodeBlock_code">&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-console" data-lang="console">&lt;span class="line">&lt;span class="cl">&lt;span class="gp">$&lt;/span> wrangler kv namespace create KV
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="go">...
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="go">✨ Success!
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="go">Add the following to your configuration file in your kv_namespaces array:
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="go">[[kv_namespaces]]
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="go">binding = &amp;#34;KV&amp;#34;
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="go">id = &amp;#34;2161175c318445cfa3d1dac2f20ee660&amp;#34;
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/div>
&lt;/figure>

&lt;p>KV namespace の作成に成功すると、上記のように一意な ID が割り当てられます。
この ID は、Worker のコード内で使用する変数名と、実際の KV namespace を紐付けるために使われます。
上記コマンドの出力には、そのための &lt;code>wrangler.toml&lt;/code> での設定方法が示されています。
&lt;a href="https://dash.cloudflare.com/">Cloudflare のダッシュボード&lt;/a>上でも、KV namespace が作成されていることを確認できます。&lt;/p></description></item><item><title>Cloudflare Workers で作成した Web API に API キーによるアクセス制限をかける</title><link>https://maku.blog/p/u6w6fq4/</link><pubDate>Mon, 13 Jan 2025 00:00:00 +0900</pubDate><guid>https://maku.blog/p/u6w6fq4/</guid><description>&lt;p>Cloudflare Worker で作成した Web API を公開するときに、固定の API キーによるアクセス制限をかける方法です。
独自サービス用のバックエンド API など、一般公開しない API の実装で使うことを想定しています。&lt;/p>
&lt;h2 id="準備">準備&lt;/h2>
&lt;h3 id="プロジェクトの作成">プロジェクトの作成&lt;/h3>
&lt;p>Cloudflare Workers のプロジェクトをまだ作っていないときは、&lt;a href="../../p/rn7p7n5/">wrangler を使って作成&lt;/a> しておきます。&lt;/p>

&lt;figure class="xCodeBlock">
&lt;figcaption class="xCodeBlock_title">プロジェクトを作成&lt;/figcaption>
&lt;div class="xCodeBlock_code">&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-console" data-lang="console">&lt;span class="line">&lt;span class="cl">&lt;span class="gp">$&lt;/span> wrangler init hello-api
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="gp">$&lt;/span> &lt;span class="nb">cd&lt;/span> hello-api
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/div>
&lt;/figure>

&lt;h3 id="api-キーを生成して登録する">API キーを生成して登録する&lt;/h3>
&lt;p>アクセス制御用の独自の API キーを用意して、それを Workers に登録して使います。
次のように、ランダムな文字列を生成して API キーにしてしまえばよいです。
自分で考えた文字列でも構いませんが、第三者が想像しにくい文字列にしてください。&lt;/p>

&lt;figure class="xCodeBlock">
&lt;figcaption class="xCodeBlock_title">ランダムな API キーを生成&lt;/figcaption>
&lt;div class="xCodeBlock_code">&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-console" data-lang="console">&lt;span class="line">&lt;span class="cl">&lt;span class="gp">$&lt;/span> openssl rand -base64 &lt;span class="m">32&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="go">mmdkR+mMvBUnYeu2sn1kMqlXjK9Q4A0Os3I4M4aiMQs=
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/div>
&lt;/figure>

&lt;p>用意した API キーは、サーバー側の &lt;strong>&lt;code>API_KEY&lt;/code>&lt;/strong> という環境変数にセットすることにします。
開発サーバー用の環境変数は &lt;strong>&lt;code>.dev.vars&lt;/code>&lt;/strong> ファイル、本番環境用の環境変数は &lt;strong>&lt;code>wrangler secret&lt;/code>&lt;/strong> コマンドで設定します。&lt;/p>

&lt;figure class="xCodeBlock">
&lt;figcaption class="xCodeBlock_title">.dev.vars（ローカル環境用のシークレット設定）&lt;/figcaption>
&lt;div class="xCodeBlock_code">&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-ini" data-lang="ini">&lt;span class="line">&lt;span class="cl">&lt;span class="na">API_KEY&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s">&amp;#34;mmdkR+mMvBUnYeu2sn1kMqlXjK9Q4A0Os3I4M4aiMQs=&amp;#34;&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/div>
&lt;/figure>


&lt;figure class="xCodeBlock">
&lt;figcaption class="xCodeBlock_title">Cloudflare Workers 用のシークレット設定&lt;/figcaption>
&lt;div class="xCodeBlock_code">&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-console" data-lang="console">&lt;span class="line">&lt;span class="cl">&lt;span class="gp">$&lt;/span> wrangler secret put API_KEY
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="go">Enter a secret value: **********************
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/div>
&lt;/figure>

&lt;p>これらの値は、Workers のプログラム内で &lt;strong>&lt;code>env.API_KEY&lt;/code>&lt;/strong> で参照することができます。&lt;/p></description></item><item><title>Cloudflare Workers と Hono で軽量な Web API を作る</title><link>https://maku.blog/p/33cc7jy/</link><pubDate>Sat, 11 Jan 2025 00:00:00 +0900</pubDate><guid>https://maku.blog/p/33cc7jy/</guid><description>&lt;ul>
&lt;li>参考: &lt;a href="../../p/rn7p7n5/">Cloudflare Workers をはじめる (wrangler)&lt;/a>&lt;/li>
&lt;/ul>
&lt;h2 id="hono-とは">Hono とは&lt;/h2>
&lt;p>&lt;a href="https://hono.dev/">Hono&lt;/a> は、Cloudflare Workers で使える Web アプリ用のフレームワークで、軽量な Web API を実装するときに便利です。
Node.js の Express に似た API を提供しており、ルーティングやミドルウェアを少ないコードで実装することができます。
&lt;a href="https://developers.cloudflare.com/workers/runtime-apis/">Cloudflare Workers の Runtime API&lt;/a> だけでも Web API を実装できますが、Hono を使うとよりシンプルなコードで実装できます。&lt;/p>
&lt;div class="xNote">
 &lt;span class="xNote_title">☝️ Cloudflare Workers ≠ Node.js&lt;/span>
 &lt;span class="xNote_body">JavaScript のランタイム環境としては Node.js が有名ですが、Cloudflare Workers は V8 エンジンをベースとした &lt;strong>独自の Workers ランタイム環境&lt;/strong> です。
ローカルでの開発中には Node.js のツール群を使ったりするので余計に混乱しますが、デプロイするコードは Cloudflare Workers 上で動作することを意識して実装する必要があります。
具体的には、&lt;a href="https://nodejs.org/docs/latest/api/">Node.js の Runtime API&lt;/a> は使えず、Cloudflare Workers の Runtime API を使う必要があります（参考: &lt;a href="https://developers.cloudflare.com/workers/runtime-apis/nodejs/">Workers - Node.js compatibility&lt;/a>）。
Hono はもともと Cloudflare Workers 上で動作させることを考えて作られているので安心して使えます。
Web 標準機能を使った実装をウリにしており、Deno Deploy、AWS Lambda など他の環境でも動かすことができます。&lt;/span>
&lt;/div>
&lt;h2 id="hono-で-hello-world">Hono で Hello World&lt;/h2>
&lt;h3 id="hono-プロジェクトの作成">Hono プロジェクトの作成&lt;/h3>
&lt;p>Hono 用のプロジェクトは &lt;strong>&lt;code>npm create&lt;/code>&lt;/strong> で作れるようになっているので、基本的にはこれを使ってサクッと作ります（参考: &lt;a href="https://hono.dev/docs/getting-started/basic">Hono - Getting Started&lt;/a>）。&lt;/p></description></item></channel></rss>