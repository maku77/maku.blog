<?xml version="1.0" encoding="utf-8" standalone="yes"?><rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom"><channel><title>Rsync on まくろぐ</title><link>https://maku.blog/tags/rsync/</link><description>Recent content in Rsync on まくろぐ</description><generator>Hugo</generator><language>ja-jp</language><lastBuildDate>Sun, 27 Feb 2022 00:00:00 +0900</lastBuildDate><atom:link href="https://maku.blog/tags/rsync/index.xml" rel="self" type="application/rss+xml"/><item><title>GitHub Actions で Hugo サイトをビルドして VPS サーバーに rsync デプロイする</title><link>https://maku.blog/p/un3gu8m/</link><pubDate>Sun, 27 Feb 2022 00:00:00 +0900</pubDate><guid>https://maku.blog/p/un3gu8m/</guid><description>&lt;h2 id="何をするか">何をするか？&lt;/h2>
&lt;p>Web サイトのコンテンツを GitHub で管理し、&lt;a href="https://px.a8.net/svt/ejp?a8mat=3NCT8K+4T95TE+D8Y+C9YHU" rel="nofollow">さくらの VPS&lt;/a>
&lt;img border="0" width="1" height="1" src="https://www10.a8.net/0.gif?a8mat=3NCT8K+4T95TE+D8Y+C9YHU" alt="">
 や、&lt;a href="https://px.a8.net/svt/ejp?a8mat=3NCT8K+3X3R5E+50+35KFN6" rel="nofollow">お名前.com の VPS&lt;/a>
&lt;img border="0" width="1" height="1" src="https://www12.a8.net/0.gif?a8mat=3NCT8K+3X3R5E+50+35KFN6" alt="">
 で Web サーバーを運用している場合、GitHub Actions でビルドとデプロイを自動化すると便利です。
ここでは、Web サイトのビルドに &lt;strong>Hugo&lt;/strong>、VPS サーバーへのデプロイに &lt;strong>rsync&lt;/strong> を使う前提で、次のような手順で自動化を進めていきます。&lt;/p>
&lt;ol>
&lt;li>SSH 鍵を作成する（自動デプロイのためパスワードは設定しない）&lt;/li>
&lt;li>VPS 側に SSH 公開鍵を登録する&lt;/li>
&lt;li>GitHub Actions のシークレットとして SSH 秘密鍵を登録する&lt;/li>
&lt;li>GitHub Actions のワークフローを作成し、ビルド (Hugo) とデプロイ (rsync) を自動化する&lt;/li>
&lt;/ol>
&lt;p>Web サイトのビルドには何を使ってもよいのですが、現時点でおそらく最速の静的サイトジェネレーターである Hugo を例にして説明しています。
GitHub Actions による自動化が完了すると、GitHub の main ブランチに Web サイトコンテンツを push するだけで、Hugo によるビルドと rsync による VPS へのデプロイが自動で行われるようになります。&lt;/p>
&lt;h2 id="ssh-キーペアを作成して-vps-へ公開鍵を登録する">SSH キーペアを作成して VPS へ公開鍵を登録する&lt;/h2>
&lt;p>&lt;code>rsync&lt;/code> コマンドで使用する SSH 鍵を &lt;code>ssh-keygen&lt;/code> コマンドで作成しておきます。
GitHub Actions から &lt;code>rsync&lt;/code> コマンドを実行するので、SSH 秘密鍵にはパスワードを設定しないようにします。
次の例では、&lt;code>github-actions&lt;/code> / &lt;code>github-actions.pub&lt;/code> という名前のキーペアを作成しています。
ファイル名は何でも構いません。&lt;/p></description></item><item><title>Linuxコマンド: rsync コマンドで2つのディレクトリを同期する</title><link>https://maku.blog/p/c3s7wyx/</link><pubDate>Sun, 01 Dec 2013 00:00:00 +0900</pubDate><guid>https://maku.blog/p/c3s7wyx/</guid><description>&lt;p>（Windows の場合は、&lt;a href="../../p/eqrmt6x">WinSCP をコマンドラインで利用する&lt;/a>と同じようなことを実現できます）。&lt;/p>
&lt;h2 id="rsync-でディレクトリごとコピーする">rsync でディレクトリごとコピーする&lt;/h2>
&lt;p>&lt;code>rsync&lt;/code> コマンドを使って、&lt;code>src&lt;/code> ディレクトリの内容を &lt;code>dst&lt;/code> ディレクトリにコピーするには下記のように実行します。&lt;/p>

&lt;figure class="xCodeBlock">
&lt;figcaption class="xCodeBlock_title">例: src ディレクトリを dst ディレクトリにコピー&lt;/figcaption>
&lt;div class="xCodeBlock_code">&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-plain" data-lang="plain">&lt;span class="line">&lt;span class="cl">$ rsync -av src/ dst # src ディレクトリの「中身」を dst ディレクトリ内へコピー
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">$ rsync -av src dst # src ディレクトリを dst ディレクトリ内へコピー&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/div>
&lt;/figure>

&lt;p>&lt;strong>&lt;code>-a&lt;/code>&lt;/strong> オプションは、パーミッションやタイムスタンプなどの情報を維持しつつ、ディレクトリを再帰的にコピーする指定をまとめて行うための archive オプションです。
&lt;strong>&lt;code>-v&lt;/code>&lt;/strong> オプションは転送情報などを出力する verbose オプションです。&lt;/p>
&lt;p>上記例のように、ソースディレクトリの &lt;strong>最後にスラッシュをつけるかつけないかで意味が変わってくる&lt;/strong> ので注意してください。
2番目のように実行すると、結果として &lt;code>./dst/src&lt;/code> というディレクトリが作成されることになります。&lt;/p>
&lt;h3 id="コピー元にないファイルを削除する---delete">コピー元にないファイルを削除する (--delete)&lt;/h3>
&lt;p>&lt;code>rsync&lt;/code> コマンドはデフォルトでは、コピー先ディレクトリのファイルを削除することはありません。
コピー元 (&lt;code>src&lt;/code>) に存在しないファイルを、コピー先 (&lt;code>dst&lt;/code>) から削除したいときは、明示的に &lt;strong>&lt;code>--delete&lt;/code>&lt;/strong> オプションを付けて実行します。
つまり、2つのディレクトリを同じ内容にしたい（同期したい）のであれば、&lt;code>--delete&lt;/code> オプションを付けて実行する必要があります。&lt;/p>

&lt;figure class="xCodeBlock">
&lt;figcaption class="xCodeBlock_title">例: src の内容を dst に同期させる（src に存在しないファイルは dst から削除する）&lt;/figcaption>
&lt;div class="xCodeBlock_code">&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-plain" data-lang="plain">&lt;span class="line">&lt;span class="cl">$ rsync -av --delete src/ dst&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/div>
&lt;/figure>

&lt;h3 id="指定した拡張子のファイルだけコピーする---include">指定した拡張子のファイルだけコピーする (--include)&lt;/h3>
&lt;p>特定の種類のファイル（png ファイルなど）だけをコピーしたいときは、&lt;strong>&lt;code>--include&lt;/code>&lt;/strong> オプションと &lt;strong>&lt;code>--exclude&lt;/code>&lt;/strong> を組み合わせて以下のような感じで指定します。&lt;/p></description></item></channel></rss>