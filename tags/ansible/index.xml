<?xml version="1.0" encoding="utf-8" standalone="yes"?><rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom"><channel><title>Ansible on まくろぐ</title><link>https://maku.blog/tags/ansible/</link><description>Recent content in Ansible on まくろぐ</description><generator>Hugo</generator><language>ja-jp</language><lastBuildDate>Mon, 29 Aug 2022 00:00:00 +0900</lastBuildDate><atom:link href="https://maku.blog/tags/ansible/index.xml" rel="self" type="application/rss+xml"/><item><title>Ansible とは？ Ansible をインストールする</title><link>https://maku.blog/p/m7ju6fq/</link><pubDate>Sat, 22 Oct 2016 00:00:00 +0900</pubDate><guid>https://maku.blog/p/m7ju6fq/</guid><description>&lt;h2 id="ansible-とは">Ansible とは？&lt;/h2>
&lt;p>Ansible は、2012 年に Michael DeHaan 氏によって公開されたコンフィギュレーションツールです。
Ansible を実行するホスト自身の構成を行うこともできるし、複数のホストに対して一括して設定することもできます。
Chef や Puppet に比べて、導入や設定が容易という特徴があります。&lt;/p>
&lt;h3 id="類似ツールの比較">類似ツールの比較&lt;/h3>
&lt;table>
 &lt;thead>
 &lt;tr>
 &lt;th>ツール名&lt;/th>
 &lt;th>公開日&lt;/th>
 &lt;th>作者&lt;/th>
 &lt;th>作成言語&lt;/th>
 &lt;th>構成管理ファイル&lt;/th>
 &lt;/tr>
 &lt;/thead>
 &lt;tbody>
 &lt;tr>
 &lt;td>&lt;strong>Ansible&lt;/strong>&lt;/td>
 &lt;td>2012 年&lt;/td>
 &lt;td>Michael DeHaan 氏&lt;/td>
 &lt;td>Python 製&lt;/td>
 &lt;td>Playbook&lt;/td>
 &lt;/tr>
 &lt;tr>
 &lt;td>Chef&lt;/td>
 &lt;td>2009 年&lt;/td>
 &lt;td>Adam Jacob 氏&lt;/td>
 &lt;td>Ruby + Erlang 製&lt;/td>
 &lt;td>クックブック&lt;/td>
 &lt;/tr>
 &lt;tr>
 &lt;td>Puppet&lt;/td>
 &lt;td>2005 年&lt;/td>
 &lt;td>Luke Kanies 氏&lt;/td>
 &lt;td>Ruby 製&lt;/td>
 &lt;td>マニフェスト&lt;/td>
 &lt;/tr>
 &lt;/tbody>
&lt;/table>
&lt;h3 id="ansible-の特徴">Ansible の特徴&lt;/h3>
&lt;ul>
&lt;li>ツール自体は Python で記述されています。&lt;/li>
&lt;li>コントロールされる側のホスト（マネージドノード）には、&lt;strong>Python と SSH さえ入っていればよく&lt;/strong>、導入が非常に容易です。コントロールする側のホスト（コントロールノード）から、SSH で Python スクリプトを流し込んで実行するという手法です。&lt;/li>
&lt;li>複数のホストをプッシュ型でコントロールするので、大量のホスト（数千）の制御も問題なく行えます（複数のホストで並列にコンフィギュレーションが実行される）。ansible-pull というツールを導入すれば、プル型で動作させることも可能です（リモートホストがプロキシ環境内にある場合など）。&lt;/li>
&lt;li>&lt;strong>設定・構成情報は YAML 形式のテキストファイル (Playbook)&lt;/strong> で記述します。&lt;/li>
&lt;li>Playbook で定義する各種処理（タスク）はモジュールによって提供されており、&lt;strong>モジュール自身は様々な言語で実装することが可能&lt;/strong> です（200 を超える組み込みモジュールは Python で記述されています）。&lt;/li>
&lt;li>実行後の状態に関して冪等性（べきとうせい）が保証されており、何度実行しても同じ状態になるようになっています。Playbook には、「期待する状態」を「宣言的」に記載します。処理手順ではなく、目指すべき姿を定義するということです。&lt;/li>
&lt;li>どのような環境でも実行可能な汎用的な Playbook を記述するというよりは、自分たちの組織用にカスタマイズされた Playbook を作成するという用途に向いています。たとえば、apt と yum のどっちのパッケージ管理ツールが使えるのかなどは意識して記述する必要があります。&lt;/li>
&lt;/ul>
&lt;h2 id="ansible-の要件">Ansible の要件&lt;/h2>


&lt;figure class="xImage">
 &lt;img style="" width="250" height="auto" src="../../p/m7ju6fq/img-001.drawio.svg" alt="/p/m7ju6fq/img-001.drawio.svg" />
&lt;/figure>

&lt;p>VPS などのリモートサーバーを Ansible で制御できるようにするには、少なくとも対象のサーバー（マネージドノード）に SSH 接続できるようになっていて、Python がインストールされている必要があります。
これは、Ansible が SSH で Python スクリプトを流し込んで、ターゲット上で実行するという仕組みになっているからです。&lt;/p></description></item><item><title>Ansible で Hello World</title><link>https://maku.blog/p/uhu7hs4/</link><pubDate>Thu, 17 Feb 2022 00:00:00 +0900</pubDate><guid>https://maku.blog/p/uhu7hs4/</guid><description>&lt;h2 id="インベントリーファイルを作る">インベントリーファイルを作る&lt;/h2>
&lt;p>Ansible で制御したいホストは、&lt;strong>インベントリーファイル (inventory file)&lt;/strong> に列挙しておく必要があります。
これは、想定外のホストを操作してしまうのを防ぐための安全策です。
デフォルトでは、インベントーリファイルとして &lt;strong>&lt;code>/etc/ansible/hosts&lt;/code>&lt;/strong> というファイルが読み込まれます。
コマンドラインオプション (&lt;code>-i&lt;/code>) などで、&lt;a href="../../p/eycnx9i">読み込むファイルを指定する&lt;/a> こともできます。&lt;/p>

&lt;figure class="xCodeBlock">
&lt;figcaption class="xCodeBlock_title">/etc/ansible/hosts（記述例）&lt;/figcaption>
&lt;div class="xCodeBlock_code">&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-ini" data-lang="ini">&lt;span class="line">&lt;span class="cl">&lt;span class="na">localhost&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="na">192.168.1.20&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="na">host.example.com&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/div>
&lt;/figure>

&lt;p>インベントリーファイル内では、上記のように「ホスト名」や「IP アドレス」で制御対象のホスト (managed node) を列挙します。
ここでは、3 つのホストを Ansible のコマンド（&lt;code>ansible&lt;/code> や &lt;code>ansible-playbook&lt;/code>）で制御できるようにしています。
&lt;code>localhost&lt;/code> 以外のホストは、SSH で接続できる状態になっている必要があります（参考: &lt;a href="../../p/gwnatcs/">SSH 関連記事&lt;/a>）。&lt;/p>
&lt;h2 id="ansible-コマンドで-ping-モジュールを実行してみる">ansible コマンドで ping モジュールを実行してみる&lt;/h2>
&lt;p>最初のステップとして、&lt;code>ansible&lt;/code> コマンドで &lt;strong>&lt;code>ping&lt;/code>&lt;/strong> モジュールを実行してみます。
&lt;code>ping&lt;/code> モジュールは Ansible の組み込みモジュールとして提供されており、ターゲットホストへの接続確認のために使われます。
いわゆる Linux の &lt;code>ping&lt;/code> コマンド (ICMP ping) ではないことに注意してください。&lt;/p>
&lt;p>準備として、次のようなインベントリーファイル (&lt;code>hosts.ini&lt;/code>) をカレントディレクトリに作成しておきます。&lt;/p>

&lt;figure class="xCodeBlock">
&lt;figcaption class="xCodeBlock_title">hosts.ini（インベントリーファイル）&lt;/figcaption>
&lt;div class="xCodeBlock_code">&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-ini" data-lang="ini">&lt;span class="line">&lt;span class="cl">&lt;span class="na">localhost&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="na">192.168.1.20&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/div>
&lt;/figure>

&lt;h3 id="ローカルホストを制御する">ローカルホストを制御する&lt;/h3>
&lt;p>まずは、&lt;code>localhost&lt;/code> に対して（自分自身を制御対象として）、&lt;code>ping&lt;/code> モジュールを実行してみます。
&lt;code>ansible&lt;/code> コマンドを実行するときは、第 1 パラメータで制御対象とするホスト名を指定します。
前述の通り、指定するホスト名はインベントリーファイル内に列挙されているものの中から選びます。
次のように実行して SUCCESS 表示が出れば成功です（&lt;code>python&lt;/code> コマンドのパスに関する警告が出るかもしれませんが、ひとまず無視しておいて大丈夫です）。&lt;/p></description></item><item><title>Ansible で VPS を設定するための準備</title><link>https://maku.blog/p/2yahqx6/</link><pubDate>Sun, 07 Aug 2022 00:00:00 +0900</pubDate><guid>https://maku.blog/p/2yahqx6/</guid><description>&lt;h2 id="何をするか">何をするか？&lt;/h2>
&lt;p>&lt;a href="https://px.a8.net/svt/ejp?a8mat=3NCT8C+FN831U+50+4YR6O2" rel="nofollow">ConoHa VPS&lt;/a>
&lt;img border="0" width="1" height="1" src="https://www11.a8.net/0.gif?a8mat=3NCT8C+FN831U+50+4YR6O2" alt="">
 などの VPS を借りてサーバーをセットアップしようとすると、多くの手順が必要になります。
そんなとき、最初から Ansible で環境構築するようにしておけば、セットアップ手順を Ansible Playbook でドキュメント化することができ、サーバーの再構築が容易になります。&lt;/p>
&lt;p>ここでは、初期状態の VPS サーバー（&lt;code>root&lt;/code> 接続のみ可能な状態）に、&lt;code>ansible&lt;/code> というユーザーを追加し、Ansible で VPS を制御するための環境を整えます。&lt;/p>
&lt;h3 id="前提条件">前提条件&lt;/h3>
&lt;ul>
&lt;li>コントロールノード側（手元の PC）には、あらかじめ Ansible の実行環境がインストールされているものとします（参考: &lt;a href="../../p/m7ju6fq/">Ansible をインストールする&lt;/a>）。&lt;/li>
&lt;li>マネージドノード側（VPS サーバー）にはパスワードで SSH 接続することが可能で、Python3 の実行環境がインストールされているものとします。最新の Ubuntu であれば、これらのソフトウェアは最初から使えるはずです。&lt;/li>
&lt;/ul>
&lt;p>多くの場合、VPS を使い始めた直後は、root ユーザーで直接 SSH 接続できるようになっていると思います。
今回の手順で、Ansible による接続ができるようになった後は、SSH デーモンの設定を変更して、root ユーザーでの直接接続を禁止するようにしておくと安全です。
もちろん、この設定には Ansible を使うことができます。&lt;/p>
&lt;h3 id="セットアップの流れ">セットアップの流れ&lt;/h3>
&lt;p>ここでは、VPS に &lt;code>ansible&lt;/code> というユーザーを作成し、Ansible で制御できるようにセットアップします。&lt;/p>
&lt;ol>
&lt;li>VPS に &lt;code>ansible&lt;/code> ユーザーを作成する&lt;/li>
&lt;li>&lt;code>ansible&lt;/code> ユーザーを sudoers に登録する&lt;/li>
&lt;li>VPS に &lt;code>ansible&lt;/code> ユーザーで SSH 接続できるようにする&lt;/li>
&lt;li>（おまけ）Ansible で SSH デーモンの設定を変更しておく&lt;/li>
&lt;/ol>
&lt;p>&lt;code>root&lt;/code> ユーザーで直接 SSH 接続すれば専用のユーザーを作成する必要はないのですが、それは &lt;a href="../../p/42cmu5d/">sshd の運用上望ましくない&lt;/a> ので却下とします。&lt;/p></description></item><item><title>Ansible 関連用語</title><link>https://maku.blog/p/a9twaog/</link><pubDate>Wed, 13 Jul 2022 00:00:00 +0900</pubDate><guid>https://maku.blog/p/a9twaog/</guid><description>&lt;dl>
&lt;dt>モジュール&lt;/dt>
&lt;dd>Ansible で使う機能の単位。例えば、&lt;code>ansible.builtin.systemd&lt;/code> など。
プレイブック中の各プレイで指定するタスクリストは、モジュールを指定して定義していきます。&lt;/dd>
&lt;dt>インベントリ&lt;/dt>
&lt;dd>コントロール対象とするマネージドノードの一覧ファイル。
INI 形式、あるいは YAML 形式で記述します。
シンプルに記述したければ INI 形式、階層構造を明確にしたければ YAML 形式を使います。&lt;/dd>
&lt;dt>ホスト変数&lt;/dt>
&lt;dd>インベントリで定義したホストに対して設定する変数。
インベントリファイルから分離して、&lt;code>host_vars&lt;/code> ディレクトリ内の YAML ファイルに記述することもできます。&lt;/dd>
&lt;dt>グループ変数&lt;/dt>
&lt;dd>インベントリで定義したグループに対して設定する変数。
インベントリファイルから分離して、&lt;code>group_vars&lt;/code> ディレクトリ内の YAML ファイルに記述することもできます。&lt;/dd>
&lt;dt>インベントリプラグイン (inventory plugins)&lt;/dt>
&lt;dd>Ansible 本体にインベントリの機能を提供しているプラグイン。
INI ファイル用の &lt;code>ansible.builtin.ini&lt;/code> や、YAML ファイル用の &lt;code>ansible.builtin.yaml&lt;/code> などがあります。
他にも動的にインベントリを生成するものもあります。
参考: &lt;a href="https://docs.ansible.com/ansible/latest/collections/index_inventory.html">Index of all Inventory Plugins — Ansible Documentation&lt;/a>&lt;/dd>
&lt;dt>プレイブック (playbook)&lt;/dt>
&lt;dd>マネージドノードに対する処理内容を YAML 形式で定義したもの。
プレイブックは、複数のプレイ (Play) で構成されており、プレイは複数のタスクで構成されています (Playbook ◇─ Play ◇─ Task)。&lt;/dd>
&lt;dt>プラグイン&lt;/dt>
&lt;dd>Ansible 本体に対して機能を追加する仕組み。
参考: &lt;a href="https://docs.ansible.com/ansible/latest/collections/all_plugins.html">Indexes of all modules and plugins — Ansible Documentation&lt;/a>&lt;/dd>
&lt;dt>コントロールノード (control node)、コントローラーノード (controller node)&lt;/dt>
&lt;dd>&lt;code>ansible&lt;/code> コマンドや &lt;code>ansible-playbook&lt;/code> コマンドを実行するホスト、つまり Ansible を使って対象のシステムの制御を行うマシンを指します。&lt;/dd>
&lt;dt>管理対象ノード (managed node)、ターゲットホスト (target host)&lt;/dt>
&lt;dd>Ansible のコントロール対象となるホストのこと。コントロールノード側で Inventory として管理されます。&lt;/dd>
&lt;dt>ansible.cfg&lt;/dt>
&lt;dd>Ansible 本体に対する設定ファイルで、INI 形式で記述します。
デフォルトで参照するインベントリファイル名や、SSH 接続時のホスト名登録の省略、といった設定を行えます。
参考: [/p/pamv6gq/](ansible.cfg ファイルの検索順序)&lt;/dd>
&lt;dt>コレクション&lt;/dt>
&lt;dd>Ansible コンテンツの配布形式で、プラグインやモジュール、Playbook などをまとめたもの。
ドット (&lt;code>.&lt;/code>) で区切られた名前が付けられています（例: &lt;code>ansible.utils&lt;/code>）。
Ansible 本体 (ansible-core) に内蔵されているコレクションには、&lt;code>ansible.builtin&lt;/code> という名前が付けられています。
モジュールはさらにドットを付けた名前で表現されます。
例えば、&lt;code>ansible.builtin&lt;/code> コレクションには、&lt;code>ansible.builtin.systemd&lt;/code> モジュールが含まれています。&lt;/dd>
&lt;dt>Ansible Galaxy&lt;/dt>
&lt;dd>コミュニティがコレクションを配布しているところ。
参考: &lt;a href="https://galaxy.ansible.com/">https://galaxy.ansible.com/&lt;/a>&lt;/dd>
&lt;dt>FQCN (Fully Qualified Collection Name)&lt;/dt>
&lt;dd>モジュールやプラグインの名前を、コレクション名を含む完全な名前で表現したもの。
例えば、&lt;code>ansible.windows&lt;/code> コレクションの &lt;code>win_command&lt;/code> モジュールの FQCN は &lt;code>ansible.windows.win_command&lt;/code> になります。&lt;/dd>
&lt;dt>アドホックモード&lt;/dt>
&lt;dd>Playbook を使わず、コマンドラインから直接モジュールを呼び出す方法。&lt;/dd>
&lt;dt>チェックモード&lt;/dt>
&lt;dd>このモードで Ansible を実行すると、実際にはホストに変更を加えず、どのような結果になるかを確認できます（一般に dry run と呼ばれるものです）。&lt;/dd>
&lt;dt>ハンドラー&lt;/dt>
&lt;dd>システムに変更が加えられたときに実行される処理。&lt;/dd>
&lt;dt>Ansible ロール&lt;/dt>
&lt;dd>自己完結型の特殊な Playbook で、複雑なオーケストレーションを完了するために必要なタスク、変数、構成テンプレート、およびその他のサポートファイルとともに移動させることができます。
コレクションには複数のロールを含むことができます。&lt;/dd>
&lt;/dl></description></item><item><title>Ansible で facts 情報を表示する</title><link>https://maku.blog/p/zw7emu3/</link><pubDate>Mon, 29 Aug 2022 00:00:00 +0900</pubDate><guid>https://maku.blog/p/zw7emu3/</guid><description>&lt;p>Ansible の Playbook を実行すると、最初にリモートホストの情報 (&lt;a href="https://docs.ansible.com/ansible/latest/user_guide/playbooks_vars_facts.html#vars-and-facts">Ansible facts&lt;/a>) の収集が行われます。
ここには、OS の情報や IP アドレスの情報などが含まれており、タスクの中でこれらの情報を参照することができます。
実際に Ansible facts にどのような情報が含まれているかは、次のような Playbook で確認することができます。&lt;/p>

&lt;figure class="xCodeBlock">
&lt;figcaption class="xCodeBlock_title">show-facts.yml&lt;/figcaption>
&lt;div class="xCodeBlock_code">&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-yaml" data-lang="yaml">&lt;span class="line">&lt;span class="cl">- &lt;span class="nt">hosts&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">all&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">gather_facts&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kc">true&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">tasks&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>- &lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">Show facts&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">ansible.builtin.debug&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">var&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">ansible_facts&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/div>
&lt;/figure>


&lt;figure class="xCodeBlock">
&lt;figcaption class="xCodeBlock_title">実行結果（抜粋）&lt;/figcaption>
&lt;div class="xCodeBlock_code">&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-plain" data-lang="plain">&lt;span class="line">&lt;span class="cl">TASK [Show facts] *********************************
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">ok: [example.com] =&amp;gt; {
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &amp;#34;ansible_facts&amp;#34;: {
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &amp;#34;all_ipv4_addresses&amp;#34;: [
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &amp;#34;172.xxx.xx.xx&amp;#34;,
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &amp;#34;160.xxx.xx.xx&amp;#34;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> ],
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &amp;#34;all_ipv6_addresses&amp;#34;: [
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &amp;#34;xxxx:xxxx:xxxx:xxx:xxx:xxx:xx:xx&amp;#34;,
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &amp;#34;xxxx::x:xxxx:xxxx:xxxx&amp;#34;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> ],
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> ...&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/div>
&lt;/figure>

&lt;p>&lt;code>ansible_facts&lt;/code> 変数の値がからっぽになってしまう場合は、&lt;code>gather_facts: false&lt;/code> と指定していないか確認してください。&lt;/p>
&lt;p>&lt;code>ansible_facts&lt;/code> オブジェクトの個々のプロパティを参照するには次のようにします。&lt;/p></description></item><item><title>Ansible タスク例: ユーザーを特定のグループに参加させる (ansible.builtin.user)</title><link>https://maku.blog/p/s2fs5gs/</link><pubDate>Mon, 29 Aug 2022 00:00:00 +0900</pubDate><guid>https://maku.blog/p/s2fs5gs/</guid><description>&lt;p>Ansible の &lt;a href="https://docs.ansible.com/ansible/latest/collections/ansible/builtin/user_module.html">ansible.builtin.user モジュール&lt;/a> を使用すると、ターゲットノード上に指定したユーザーを作成することができます。
このモジュールは、既存のユーザーの情報を変更する場合にも使えるので、例えば、あるユーザーを指定したグループに参加させる、といったことが可能です。&lt;/p>
&lt;p>次の Playbook では、ユーザー &lt;code>maku&lt;/code> をグループ &lt;code>docker&lt;/code> に参加させています。
ユーザーが存在しない場合は、ユーザー自体の作成も行います。&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-yaml" data-lang="yaml">&lt;span class="line">&lt;span class="cl">- &lt;span class="nt">hosts&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">all&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">become&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kc">true&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">tasks&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>- &lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">Append the group &amp;#39;docker&amp;#39; to the user&amp;#39;s groups&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">ansible.builtin.user&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">maku&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">groups&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="l">docker]&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">append&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kc">yes&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>注意点としては、&lt;strong>&lt;code>groups&lt;/code>&lt;/strong> でグループ名を列挙すると同時に、&lt;strong>&lt;code>append: yes&lt;/code>&lt;/strong> と指定するところです。
この指定により、ユーザー &lt;code>maku&lt;/code> がすでに存在している場合に、現在のグループ情報はそのままで、追加で &lt;code>docker&lt;/code> グループに参加するという意味になります。&lt;/p>
&lt;p>逆に、純粋に &lt;code>docker&lt;/code> グループにしか参加していないユーザーにしたいのであれば、&lt;code>append: yes&lt;/code> の指定は省略して次のように記述すれば OK です（デフォルトは &lt;code>append: false&lt;/code> です）。&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-yaml" data-lang="yaml">&lt;span class="line">&lt;span class="cl">&lt;span class="nt">ansible.builtin.user&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">maku&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">groups&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="l">docker]&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>ユーザー名をハードコードするのではなく、SSH 接続しているカレントユーザーを対象にしてグループ参加させたいときは、ユーザー名として &lt;strong>&lt;code>&amp;quot;{{ ansible_facts.env.SUDO_USER }}&amp;quot;&lt;/code>&lt;/strong> を指定します。
これにより、&lt;code>sudo&lt;/code> 実行前のユーザー名を取得できます。&lt;/p></description></item><item><title>Ansible タスク例: Docker と Docker Compose をインストールする</title><link>https://maku.blog/p/8k4j2gw/</link><pubDate>Sun, 28 Aug 2022 00:00:00 +0900</pubDate><guid>https://maku.blog/p/8k4j2gw/</guid><description>&lt;h2 id="何をするか">何をするか？&lt;/h2>
&lt;p>下記の Docker のインストールマニュアルに従い、Ansible で Ubuntu 22.04 に Docker の実行環境をセットアップします。&lt;/p>
&lt;ul>
&lt;li>&lt;a href="https://docs.docker.com/engine/install/ubuntu/">Install Docker Engine on Ubuntu | Docker Documentation&lt;/a>&lt;/li>
&lt;/ul>
&lt;h2 id="playbook-の例">Playbook の例&lt;/h2>
&lt;p>次の YAML ファイルは、Docker の公式サイトのインストール手順をほぼそのまま Playbook 化したものです。
この Playbook を &lt;code>ansible-playbook&lt;/code> で実行することで、Docker (+ Docker Compose) のインストール、および Docker デーモンの起動まで完了します。&lt;/p>

&lt;figure class="xCodeBlock">
&lt;figcaption class="xCodeBlock_title">install-docker.yml&lt;/figcaption>
&lt;div class="xCodeBlock_code">&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-yaml" data-lang="yaml">&lt;span class="line">&lt;span class="cl">- &lt;span class="nt">hosts&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">all&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">gather_facts&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kc">false&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">become&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kc">true&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">tasks&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>- &lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">Install APT packages to use a repository over HTTPS&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">ansible.builtin.apt&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">pkg&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>- &lt;span class="l">ca-certificates&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>- &lt;span class="l">curl&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>- &lt;span class="l">gnupg&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>- &lt;span class="l">lsb-release&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">update_cache&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kc">yes&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">cache_valid_time&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="m">86400&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="c"># cache for 1 day&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>- &lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">Create APT&amp;#39;s keyrings directory&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">ansible.builtin.file&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">path&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">/etc/apt/keyrings&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">state&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">directory&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>- &lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">Add Docker&amp;#39;s official GPG key&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">ansible.builtin.shell&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">cmd&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo gpg --dearmor -o /etc/apt/keyrings/docker.gpg&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">creates&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">/etc/apt/keyrings/docker.gpg&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>- &lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">Setup the repository&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">ansible.builtin.shell&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">cmd&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">&amp;gt;&lt;/span>&lt;span class="sd">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="sd"> echo &amp;#34;deb [arch=$(dpkg --print-architecture) signed-by=/etc/apt/keyrings/docker.gpg] https://download.docker.com/linux/ubuntu $(lsb_release -cs) stable&amp;#34;
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="sd"> | sudo tee /etc/apt/sources.list.d/docker.list &amp;gt; /dev/null&lt;/span>&lt;span class="w"> 
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">creates&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">/etc/apt/sources.list.d/docker.list&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>- &lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">Install Docker&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">ansible.builtin.apt&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">pkg&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>- &lt;span class="l">docker-ce&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>- &lt;span class="l">docker-ce-cli&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>- &lt;span class="l">containerd.io&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>- &lt;span class="l">docker-compose-plugin&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">update_cache&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kc">yes&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>- &lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">Start Docker&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">ansible.builtin.service&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">docker&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">state&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">started&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/div>
&lt;/figure>

&lt;p>本質的にやりたいことは、最後の方のステップの &lt;code>Install Docker&lt;/code> と &lt;code>Start Docker&lt;/code> だけなのですが、その前に APT 用の GPG キーの取得などを行うので若干長くなっています。&lt;/p></description></item><item><title>Ansible タスク例: 任意のコマンドを実行する (ansible.builtin.command/shell)</title><link>https://maku.blog/p/ihqz7em/</link><pubDate>Sun, 28 Aug 2022 00:00:00 +0900</pubDate><guid>https://maku.blog/p/ihqz7em/</guid><description>&lt;p>Ansible のターゲットノード上で任意のコマンドを実行するには、次のような組み込みモジュールを使用します。&lt;/p>
&lt;dl>
&lt;dt>&lt;a href="https://docs.ansible.com/ansible/latest/collections/ansible/builtin/command_module.html">ansible.builtin.command モジュール&lt;/a>&lt;/dt>
&lt;dd>任意のコマンドを実行します。
シェルを経由せず、指定したコマンドを直接実行するので、シェル特有の機能は使えません。
Windows の場合は代わりに &lt;a href="https://docs.ansible.com/ansible/latest/collections/ansible/windows/win_command_module.html">ansible.builtin.win_command&lt;/a> を使用します。&lt;/dd>
&lt;dt>&lt;a href="https://docs.ansible.com/ansible/latest/collections/ansible/builtin/shell_module.html">ansible.builtin.shell モジュール&lt;/a>&lt;/dt>
&lt;dd>シェル (&lt;code>/bin/sh&lt;/code>) で任意のコマンドを実行します。
シェルの機能（&lt;code>$HOSTNAME&lt;/code> のような変数展開や &lt;code>*&lt;/code> によるファイルグロブ、&lt;code>&amp;gt;&lt;/code> によるリダイレクトなど）を使用することができます。
Windows の場合は代わりに &lt;a href="https://docs.ansible.com/ansible/latest/collections/ansible/windows/win_shell_module.html">ansible.builtin.win_shell&lt;/a> を使用します。&lt;/dd>
&lt;/dl>
&lt;h2 id="command-モジュールの基本">command モジュールの基本&lt;/h2>
&lt;p>指定したコマンドを実行したいときは、&lt;strong>&lt;code>command&lt;/code>&lt;/strong> モジュールの &lt;strong>&lt;code>cmd&lt;/code>&lt;/strong> パラメーターでそのコマンド（と引数）を指定します。&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-yaml" data-lang="yaml">&lt;span class="line">&lt;span class="cl">- &lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">Run command&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">ansible.builtin.command&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">cmd&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">cat /etc/hostname&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>上記のような簡単なコマンドであれば、次のように省略して記述できます。&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-yaml" data-lang="yaml">&lt;span class="line">&lt;span class="cl">- &lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">Run command&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">ansible.builtin.command&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">cat /etc/hostname&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>実行するコマンドの引数として &lt;code>&amp;quot;user name&amp;quot;&lt;/code> のようなスペースを含む値を渡したいときは、次のように &lt;strong>&lt;code>argv&lt;/code>&lt;/strong> を使ってコマンドと各引数を分割して指定します（この場合、&lt;code>cmd&lt;/code> パラメーターは使用しません）。&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-yaml" data-lang="yaml">&lt;span class="line">&lt;span class="cl">- &lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">Run command&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">ansible.builtin.command&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">argv&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>- &lt;span class="l">/usr/bin/add_user_to_db.sh&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>- &lt;span class="l">user name&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>- &lt;span class="l">database name&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="ファイルの有無で実行するかどうか制御する-createsremoves">ファイルの有無で実行するかどうか制御する (creates/removes)&lt;/h2>
&lt;p>&lt;code>command&lt;/code> モジュールで指定したコマンドは、デフォルトで毎回実行されますが、&lt;strong>&lt;code>creates&lt;/code>&lt;/strong> および &lt;strong>&lt;code>removes&lt;/code>&lt;/strong> パラメーターを使用すると、特定のファイルの有無によってコマンドを実行するかしないかを制御することができます。&lt;/p></description></item><item><title>Ansible タスク例: 空のディレクトリを作成する (ansible.builtin.file)</title><link>https://maku.blog/p/25gqyai/</link><pubDate>Sun, 28 Aug 2022 00:00:00 +0900</pubDate><guid>https://maku.blog/p/25gqyai/</guid><description>&lt;p>Ansible で空のディレクトリ作成するには、&lt;a href="https://docs.ansible.com/ansible/latest/collections/ansible/builtin/file_module.html">ansible.builtin.file モジュール&lt;/a> の &lt;strong>&lt;code>state&lt;/code>&lt;/strong> パラメーターに &lt;strong>&lt;code>directory&lt;/code>&lt;/strong> を指定します。&lt;/p>
&lt;h2 id="空のディレクトリを作成する">空のディレクトリを作成する&lt;/h2>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-yaml" data-lang="yaml">&lt;span class="line">&lt;span class="cl">- &lt;span class="nt">hosts&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">all&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">gather_facts&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kc">false&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">become&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kc">true&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">tasks&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>- &lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">Create directory&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">ansible.builtin.file&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">path&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">/var/cache/myapp&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">state&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">directory&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>&lt;code>path&lt;/code> パラメーターで指定したディレクトリ &lt;code>/var/cache/myapp&lt;/code> を作成します。
すでにディレクトリが存在する場合は、このタスクはスキップされます。
ディレクトリは再帰的に作成されるので、深い階層のパスを指定しても大丈夫です（&lt;code>mkdir&lt;/code> の &lt;code>-p&lt;/code> オプションに相当）。&lt;/p>
&lt;h2 id="ディレクトリのパーミッションや所有者を指定する">ディレクトリのパーミッションや所有者を指定する&lt;/h2>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-yaml" data-lang="yaml">&lt;span class="line">&lt;span class="cl">- &lt;span class="nt">hosts&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">all&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">gather_facts&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kc">false&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">become&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kc">true&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">tasks&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>- &lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">Create directory&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">ansible.builtin.file&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">path&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">/var/cache/myapp&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">state&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">directory&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">mode&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s2">&amp;#34;0755&amp;#34;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">owner&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">myapp-user&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">group&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">myapp-group&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>ディレクトリ作成時のパーミッションは &lt;code>mode&lt;/code>、所有ユーザーは &lt;code>owner&lt;/code>、グループは &lt;code>group&lt;/code> で指定することができます。
パーミッションは、&lt;code>0755&lt;/code> のような 8 進数指定の代わりに、&lt;code>u=rw,g=r,o=r&lt;/code> のようなシンボリックモードでも指定可能です。&lt;/p></description></item><item><title>Ansible タスク例: 空のファイルを作成する (ansible.builtin.file)</title><link>https://maku.blog/p/uas9p6m/</link><pubDate>Sun, 28 Aug 2022 00:00:00 +0900</pubDate><guid>https://maku.blog/p/uas9p6m/</guid><description>&lt;p>Ansible で空のファイルを作成するには、&lt;a href="https://docs.ansible.com/ansible/latest/collections/ansible/builtin/file_module.html">ansible.builtin.file モジュール&lt;/a> の &lt;strong>&lt;code>state&lt;/code>&lt;/strong> パラメーターに &lt;strong>&lt;code>touch&lt;/code>&lt;/strong> を指定します。
Linux の &lt;code>touch&lt;/code> コマンドに相当する動きをするので、ファイルがなければ空のファイルを作成し、ファイルが存在する場合はタイムスタンプを更新する、という振る舞いになります。&lt;/p>
&lt;h2 id="空のファイルを作成する">空のファイルを作成する&lt;/h2>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-yaml" data-lang="yaml">&lt;span class="line">&lt;span class="cl">&lt;span class="nt">tasks&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>- &lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">Create file&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">ansible.builtin.file&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">path&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">~/sample.txt&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">state&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">touch&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>上記のようにすると、&lt;code>path&lt;/code> で指定したファイルを作成します。
ファイルが既に存在する場合は、ファイルの中身は変更せずに、タイムスタンプを更新します。
つまり、このタスクはすでにファイルが存在する場合も実行されます（&lt;code>changed&lt;/code> になる）。&lt;/p>
&lt;h2 id="タイムスタンプを更新しない">タイムスタンプを更新しない&lt;/h2>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-yaml" data-lang="yaml">&lt;span class="line">&lt;span class="cl">- &lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">Create empty file&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">ansible.builtin.file&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">path&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">~/sample.txt&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">state&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">touch&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">access_time&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">preserve&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">modification_time&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">preserve&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>ファイルがすでに存在する場合に、タイムスタンプを更新しないようにするには、&lt;strong>&lt;code>access_time&lt;/code>&lt;/strong> および &lt;strong>&lt;code>modification_time&lt;/code>&lt;/strong> パラメーターに &lt;strong>&lt;code>preserve&lt;/code>&lt;/strong> を指定します（両方とも指定する必要があります）。
この指定により、ファイルがすでに存在している場合は、このタスクはスキップされるようになります。&lt;/p></description></item><item><title>Ansible で SSH サーバーをセキュアにする (ansible.builtin.lineinfile, ansible.builtin.service)</title><link>https://maku.blog/p/hufvdta/</link><pubDate>Sat, 06 Aug 2022 00:00:00 +0900</pubDate><guid>https://maku.blog/p/hufvdta/</guid><description>&lt;p>SSH サーバーを安全に運用するには、&lt;a href="../../p/42cmu5d/">いくつかのベストプラクティス&lt;/a>があります。
ここでは、root ユーザーでの SSH 接続を拒否 (&lt;code>PermitRootLogin no&lt;/code>) する設定例を紹介します。&lt;/p>

&lt;figure class="xCodeBlock">
&lt;figcaption class="xCodeBlock_title">secure-sshd.yaml (Playbook)&lt;/figcaption>
&lt;div class="xCodeBlock_code">&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-yaml" data-lang="yaml">&lt;span class="line">&lt;span class="cl">&lt;span class="nn">---&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>- &lt;span class="nt">hosts&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">all&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">gather_facts&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kc">false&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">become&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kc">true&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">tasks&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>- &lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">Prohibit root login&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">ansible.builtin.lineinfile&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">path&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">/etc/ssh/sshd_config&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">state&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">present&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">regexp&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s1">&amp;#39;^PermitRootLogin &amp;#39;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">line&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s1">&amp;#39;PermitRootLogin no&amp;#39;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">notify&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>- &lt;span class="l">Reload ssh daemon&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">handlers&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>- &lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">Reload ssh daemon&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">ansible.builtin.service&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">sshd&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">state&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">reloaded&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/div>
&lt;/figure>

&lt;p>この Ansible Playbook では、次のようなことを行っています。&lt;/p>
&lt;ol>
&lt;li>&lt;a href="https://docs.ansible.com/ansible/latest/collections/ansible/builtin/lineinfile_module.html">&lt;code>lineinfile&lt;/code> モジュール&lt;/a>で &lt;code>/etc/ssh/sshd_config&lt;/code> の内容を修正する
&lt;ul>
&lt;li>&lt;code>PermitRootLogin&lt;/code> で始まる行が見つからない場合は、ファイルの末尾に &lt;code>PermitRootLogin no&lt;/code> を追加する&lt;/li>
&lt;li>&lt;code>PermitRootLogin&lt;/code> で始まる行が見つかった場合は、&lt;code>PermitRootLogin no&lt;/code> に置換する（ただし、最初からその設定が記述されていたら何もしない）&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>&lt;a href="https://docs.ansible.com/ansible/latest/collections/ansible/builtin/service_module.html">&lt;code>service&lt;/code> モジュール&lt;/a> で SSH デーモンに設定をリロードさせる&lt;/li>
&lt;/ol>
&lt;p>この設定を行うと、root ユーザーでの SSH 接続ができなくなるので注意してください。
必ず、root ユーザー以外で SSH 接続できることを確認してから実行してください。&lt;/p></description></item><item><title>Ansible タスク例: APT パッケージをインストールする (ansible.builtin.apt)</title><link>https://maku.blog/p/efqyair/</link><pubDate>Tue, 19 Jul 2022 00:00:00 +0900</pubDate><guid>https://maku.blog/p/efqyair/</guid><description>&lt;p>Debian 系の Linux ディストリビューション（Ubuntu など）では、パッケージ管理に APT を使用します。
Ansible 組み込みの &lt;a href="https://docs.ansible.com/ansible/latest/collections/ansible/builtin/apt_module.html">ansible.builtin.apt&lt;/a> モジュールを使用して、APT パッケージのインストールを行うことができます。&lt;/p>
&lt;h2 id="apk-パッケージを-1-つインストールする">APK パッケージを 1 つインストールする&lt;/h2>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-yaml" data-lang="yaml">&lt;span class="line">&lt;span class="cl">- &lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">Install Apache&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">ansible.builtin.apt&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">apache2&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">state&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">present&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">update_cache&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kc">yes&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>&lt;code>state: present&lt;/code> の指定はデフォルトなので省略できます。
&lt;strong>&lt;code>update_cache: yes&lt;/code>&lt;/strong> を指定しておくと、事前に &lt;code>apt update&lt;/code> を実行してパッケージリスト情報を更新してくれます。
さらに、&lt;code>cache_valid_time: 3600&lt;/code> のように、キャッシュの有効期間（秒）を指定しておくこともできます。&lt;/p>
&lt;h2 id="複数のパッケージをインストールする">複数のパッケージをインストールする&lt;/h2>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-yaml" data-lang="yaml">&lt;span class="line">&lt;span class="cl">- &lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">Install a list of packages&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">ansible.builtin.apt&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">pkg&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>- &lt;span class="l">git&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>- &lt;span class="l">iproute2&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>- &lt;span class="l">...&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div></description></item><item><title>Ansible タスク例: UFW でファイアウォールを設定する (community.general.ufw)</title><link>https://maku.blog/p/evdubr7/</link><pubDate>Tue, 19 Jul 2022 00:00:00 +0900</pubDate><guid>https://maku.blog/p/evdubr7/</guid><description>&lt;p>Ubuntu のファイアウォール（パケットフィルタ）設定には、UFW というツールが使用されています。&lt;/p>
&lt;ul>
&lt;li>参考: &lt;a href="../../p/drar8o4/">Linux コマンド: ufw による Ubuntu のファイアウォール設定&lt;/a>&lt;/li>
&lt;/ul>
&lt;p>Ansible の &lt;a href="https://docs.ansible.com/ansible/latest/collections/community/general/ufw_module.html">community.general.ufw&lt;/a> モジュールを使用して &lt;a href="https://help.ubuntu.com/community/UFW">UFW (Uncomplicated Firewall)&lt;/a> の設定を行うことができます。
&lt;code>community.general&lt;/code> コレクションは、Ansible のコミュニティパッケージをインストールした場合は標準でインストールされています。&lt;/p>
&lt;h2 id="ufw-をインストールする">UFW をインストールする&lt;/h2>
&lt;p>UFW の設定は &lt;code>community.general.ufw&lt;/code> モジュールで行うのですが、UFW の本体（&lt;code>ufw&lt;/code> コマンド）はあらかじめ APT でインストールしておく必要があります。&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-yaml" data-lang="yaml">&lt;span class="line">&lt;span class="cl">- &lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">Install UFW&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">ansible.builtin.apt&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">ufw&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">state&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">present&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">update_cache&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kc">yes&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="ufw-を有効化する">UFW を有効化する&lt;/h2>
&lt;p>UFW をインストールしたら、有効化する必要があります。
次の例では、デフォルトポリシーを接続拒否 (deny) にして UFW を有効化しています。&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-yaml" data-lang="yaml">&lt;span class="line">&lt;span class="cl">- &lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">Enable UFW&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">community.general.ufw&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">state&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">enabled&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">policy&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">deny&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="特定ポートへのアクセスを許可する">特定ポートへのアクセスを許可する&lt;/h2>
&lt;p>次の例では、22 番ポート (SSH) と、80 番ポート (HTTP)、443 番ポート (HTTPS) へのアクセスを許可しています。&lt;/p></description></item><item><title>Ansible タスク例: Web からファイルをダウンロードする (ansible.builtin.get_url)</title><link>https://maku.blog/p/s9tctaq/</link><pubDate>Tue, 19 Jul 2022 00:00:00 +0900</pubDate><guid>https://maku.blog/p/s9tctaq/</guid><description>&lt;ul>
&lt;li>参考: &lt;a href="https://docs.ansible.com/ansible/latest/collections/ansible/builtin/get_url_module.html">ansible.builtin.get_url module&lt;/a>&lt;/li>
&lt;/ul>
&lt;h2 id="https-でファイルをダウンロードする">HTTPS でファイルをダウンロードする&lt;/h2>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-yaml" data-lang="yaml">&lt;span class="line">&lt;span class="cl">- &lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">Download foo.conf&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">ansible.builtin.get_url&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">url&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">https://example.com/path/file.conf&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">dest&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">/etc/foo.conf&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">mode&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s1">&amp;#39;0440&amp;#39;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;ul>
&lt;li>パラメーターの説明:
&lt;ul>
&lt;li>&lt;a href="https://docs.ansible.com/ansible/latest/collections/ansible/builtin/get_url_module.html#parameter-url">&lt;strong>&lt;code>url&lt;/code>&lt;/strong>&lt;/a> &amp;hellip; （必須）ダウンロードするファイルの URL&lt;/li>
&lt;li>&lt;a href="https://docs.ansible.com/ansible/latest/collections/ansible/builtin/get_url_module.html#parameter-dest">&lt;strong>&lt;code>dest&lt;/code>&lt;/strong>&lt;/a> &amp;hellip; （必須）保存先の絶対パス。ディレクトリ名かファイル名。ディレクトリ名の場合は、ダウンロード元のファイル名が使われます。&lt;/li>
&lt;li>&lt;a href="https://docs.ansible.com/ansible/latest/collections/ansible/builtin/get_url_module.html#parameter-mode">&lt;strong>&lt;code>mode&lt;/code>&lt;/strong>&lt;/a> &amp;hellip; （オプション）作成するファイルのモード (permission)&lt;/li>
&lt;/ul>
&lt;/li>
&lt;/ul>
&lt;p>&lt;code>dest&lt;/code> で指定したファイルが既に存在する場合は、ダウンロードはスキップされます。
ただし、&lt;code>dest&lt;/code> で指定したパスがディレクトリの場合は、ファイルは毎回ダウンロードされてしまうので、&lt;code>dest&lt;/code> ではファイルのパスを指定すべきです。
&lt;code>force: yes&lt;/code> オプションを指定すると、ファイルは必ずダウンロードされます。&lt;/p>
&lt;h2 id="ssl-エラーが発生する場合">SSL エラーが発生する場合&lt;/h2>
&lt;p>Ubuntu の Docker イメージには CA 証明書がインストールされておらず、&lt;code>get_url&lt;/code> モジュールで HTTPS アクセスしたときに次のように SSL 関連のエラーが出ることがあります。&lt;/p>
&lt;pre tabindex="0">&lt;code>Request failed: &amp;lt;urlopen error [SSL: CERTIFICATE_VERIFY_FAILED]
certificate verify failed: unable to get local issuer certificate (_ssl.c:997)&amp;gt;
&lt;/code>&lt;/pre>&lt;p>このような場合は、&lt;code>get_url&lt;/code> の &lt;strong>&lt;code>validate_certs: no&lt;/code>&lt;/strong> オプションを指定して SSL 検証をスキップしてしまうこともできますが、次のように CA 証明書をインストールするのが正しい対処方法です。&lt;/p></description></item><item><title>Ansible タスク例: when による Playbook の条件分岐</title><link>https://maku.blog/p/o4o7o6m/</link><pubDate>Tue, 19 Jul 2022 00:00:00 +0900</pubDate><guid>https://maku.blog/p/o4o7o6m/</guid><description>&lt;h2 id="コマンドが既に存在するかどうかチェックする">コマンドが既に存在するかどうかチェックする&lt;/h2>
&lt;p>次の例では、&lt;code>docker&lt;/code> コマンドが存在しない場合のみ、&lt;code>get-docker.sh&lt;/code> スクリプトを実行して Docker をインストールしています。&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-yaml" data-lang="yaml">&lt;span class="line">&lt;span class="cl">- &lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">Check if docker command exists&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">ansible.builtin.shell&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">cmd&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">command -v docker&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">register&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">docker_exists&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">ignore_errors&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kc">yes&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>- &lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">Install Docker&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">when&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">docker_exists is failed&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">ansible.builtin.shell&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">cmd&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">sh ~/get-docker.sh&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>&lt;code>command -v &amp;lt;コマンド名&amp;gt;&lt;/code> とすると、指定したコマンドがインストールされているときのみリターンコードが 0（成功）になることを利用しています。
この振る舞いは、次のように &lt;code>$?&lt;/code>（リターンコード）の値を参照することで確かめられます。&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-console" data-lang="console">&lt;span class="line">&lt;span class="cl">&lt;span class="gp">$&lt;/span> &lt;span class="nb">command&lt;/span> -v &lt;span class="nb">pwd&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="go">pwd
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="go">&lt;/span>&lt;span class="gp">$&lt;/span> &lt;span class="nb">echo&lt;/span> &lt;span class="nv">$?&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="go">0 （pwd コマンドは存在するのでリターンコードは 0）
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="go">&lt;/span>&lt;span class="err">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="err">&lt;/span>&lt;span class="gp">$&lt;/span> &lt;span class="nb">command&lt;/span> -v hoge
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="gp">$&lt;/span> &lt;span class="nb">echo&lt;/span> &lt;span class="nv">$?&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="go">1 （hoge コマンドは存在しないのでリターンコードは 1）
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div></description></item><item><title>Ansible の SSH 接続で使用するユーザーと秘密鍵を指定する</title><link>https://maku.blog/p/n3jygwd/</link><pubDate>Mon, 18 Jul 2022 00:00:00 +0900</pubDate><guid>https://maku.blog/p/n3jygwd/</guid><description>&lt;p>Ansible コマンド（&lt;code>ansible&lt;/code> や &lt;code>ansible-playbook&lt;/code>）でマネージドノードを制御するとき、デフォルトでは SSH ユーザーとしてコントロールノードのカレントユーザーが使用されます。
異なる SSH ユーザー（と秘密鍵）で接続したい場合は、コマンドライン引数やインベントリファイルで指定することができます。&lt;/p>
&lt;ul>
&lt;li>&lt;a href="#cmd-line">コマンドライン引数で指定する方法&lt;/a>&lt;/li>
&lt;li>&lt;a href="#inventory">インベントリファイルで指定する方法&lt;/a>&lt;/li>
&lt;li>&lt;code>ansible.cfg&lt;/code> でデフォルトユーザーを指定する方法&lt;/li>
&lt;li>&lt;a href="#ssh-config">&lt;code>~/.ssh/config&lt;/code> で接続先ごとにユーザーを指定する方法&lt;/a>&lt;/li>
&lt;/ul>
&lt;h2 id="cmd-line">コマンドライン引数で SSH ユーザーを指定する方法&lt;/h2>
&lt;p>&lt;code>ansible-playbook&lt;/code> コマンドの、&lt;strong>&lt;code>-u (--user)&lt;/code>&lt;/strong> オプションで SSH 接続に使用するユーザー名、&lt;strong>&lt;code>--private-key&lt;/code>&lt;/strong> オプションで秘密鍵を指定することができます。&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-console" data-lang="console">&lt;span class="line">&lt;span class="cl">&lt;span class="gp">$&lt;/span> ansible-playbook -i hosts.ini site.yml -u maku --private-key ~/.ssh/maku/id_rsa
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="inventory">インベントリファイルで SSH ユーザーを指定する方法&lt;/h2>
&lt;p>インベントリファイルで指定する場合は、&lt;strong>&lt;code>ansible_user&lt;/code>&lt;/strong> 変数と &lt;strong>&lt;code>ansible_ssh_private_key&lt;/code>&lt;/strong> 変数を使います。&lt;/p>

&lt;figure class="xCodeBlock">
&lt;figcaption class="xCodeBlock_title">hosts.ini（ホストごとに指定する場合）&lt;/figcaption>
&lt;div class="xCodeBlock_code">&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-ini" data-lang="ini">&lt;span class="line">&lt;span class="cl">&lt;span class="k">[servers]&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="na">www1.example.com ansible_user&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s">maku ansible_ssh_private_key_file=~/.ssh/maku/id_rsa&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="na">www2.example.com ansible_user&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s">maku ansible_ssh_private_key_file=~/.ssh/maku/id_rsa&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/div>
&lt;/figure>


&lt;figure class="xCodeBlock">
&lt;figcaption class="xCodeBlock_title">hosts.ini（グループ単位で指定する場合）&lt;/figcaption>
&lt;div class="xCodeBlock_code">&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-ini" data-lang="ini">&lt;span class="line">&lt;span class="cl">&lt;span class="k">[servers]&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="na">www1.example.com&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="na">www2.example.com&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">[servers:vars]&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="na">ansible_user&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s">maku&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="na">ansible_ssh_private_key_file&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s">~/.ssh/maku/id_rsa&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/div>
&lt;/figure>

&lt;p>YAML 形式でインベントリファイルを記述する場合も、同様の変数で設定できます。&lt;/p>

&lt;figure class="xCodeBlock">
&lt;figcaption class="xCodeBlock_title">hosts.yml&lt;/figcaption>
&lt;div class="xCodeBlock_code">&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-yaml" data-lang="yaml">&lt;span class="line">&lt;span class="cl">&lt;span class="nt">all&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">hosts&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">www1.example.com&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">www2.example.com&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">vars&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">ansible_user&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">maku&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">ansible_ssh_private_key_file&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">~/.ssh/maku/id_rsa&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/div>
&lt;/figure>

&lt;h2 id="ssh-config">~/.ssh/config で接続先ごとにユーザーを指定する方法&lt;/h2>
&lt;p>インベントリファイルに SSH のユーザー名や秘密鍵のパスを記述するのが煩わしいときは、SSH クライアントの設定ファイル (&lt;code>~/.ssh/config&lt;/code>) で、接続先ごとに使用する SSH ユーザーや秘密鍵を定義してしまう方法があります。
次の例では、&lt;code>example.com-maku&lt;/code> という名前で、SSH 接続設定を定義しています（この名前は何でもよいですが、ここでは、&lt;code>example.com&lt;/code> というホストに &lt;code>maku&lt;/code> というユーザー名で接続するという意味でこう付けています）。&lt;/p></description></item><item><title>Docker コンテナで Ansible のテストベッド環境を用意する</title><link>https://maku.blog/p/csctaq7/</link><pubDate>Mon, 18 Jul 2022 00:00:00 +0900</pubDate><guid>https://maku.blog/p/csctaq7/</guid><description>&lt;h2 id="何をするか">何をするか&lt;/h2>
&lt;p>&lt;code>ansible-playbook&lt;/code> を使って何らかの Linux 環境のセットアップを自動化するとき、Playbook のテスト用に使い捨ての Docker コンテナ（テストベッド環境）があると便利です。&lt;/p>


&lt;figure class="xImage">
 &lt;img style="" width="" height="auto" src="../../p/csctaq7/img-001.drawio.svg" alt="/p/csctaq7/img-001.drawio.svg" />
&lt;/figure>

&lt;p>Ansible には、Playbook 実行後の冪等性を保つという性質がありますが、一度 Playbook を実行してしまうと元の状態に戻すことはできません。
一方通行の冪等性はあっても、可逆性はないということですね。
Playbook を試行錯誤して作っている段階では、何度も &lt;code>ansible-playbook&lt;/code> を実行することになるので、本当にその Playbook がまっさらな状態の OS に対して適用できるのか不安になってきます（冪等性があるので理論的には動作するはずですが）。
異なるディストリビューションに対して実行できるのか試したくなることもあります。&lt;/p>
&lt;p>ここでは、Ansible のテストベッド環境として Docker コンテナを作成し、各種 Ansible コマンド (&lt;code>ansible&lt;/code> / &lt;code>ansible-playbook&lt;/code>) で制御してみます。&lt;/p>
&lt;h2 id="テストベッド用のコンテナを起動する">テストベッド用のコンテナを起動する&lt;/h2>
&lt;p>Ansible は一般的にはマネージドノードに SSH 接続して Playbook を実行しますが、実は Docker コンテナに直接接続することもできます。
つまり、テストベッド用の Docker コンテナには、sshd (OpenSSH) などのサービスをわざわざインストールする必要はありません。&lt;/p>
&lt;p>ただし、Ansible マネージドノードの要件として、Python3 だけはインストールしておく必要があります。
次の &lt;code>Dockerfile&lt;/code> では、Ubuntu を親イメージとして、Python3 だけ追加しています。&lt;/p>

&lt;figure class="xCodeBlock">
&lt;figcaption class="xCodeBlock_title">Dockerfile&lt;/figcaption>
&lt;div class="xCodeBlock_code">&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-docker" data-lang="docker">&lt;span class="line">&lt;span class="cl">&lt;span class="k">FROM&lt;/span>&lt;span class="s"> ubuntu:22.04&lt;/span>&lt;span class="err">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="err">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="err">&lt;/span>&lt;span class="c"># Python3 のインストール&lt;/span>&lt;span class="err">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="err">&lt;/span>&lt;span class="k">RUN&lt;/span> apt update &lt;span class="o">&amp;amp;&amp;amp;&lt;/span> apt install --no-install-recommends -y python3&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/div>
&lt;/figure>

&lt;p>&lt;code>Dockerfile&lt;/code> をビルドして、&lt;code>testbed&lt;/code> イメージを作成します。&lt;/p></description></item><item><title>Docker で Ansible の実行環境用のコンテナを作成する</title><link>https://maku.blog/p/euevcs8/</link><pubDate>Sat, 02 Jul 2022 00:00:00 +0900</pubDate><guid>https://maku.blog/p/euevcs8/</guid><description>&lt;h2 id="何をするか">何をするか？&lt;/h2>
&lt;p>Ansible の実行環境は Python がインストールされている環境であれば比較的簡単にインストールできますが、Docker の実行環境があれば、ホスト環境に何もインストールせずに Ansible の実行環境を手に入れることができます（もちろんコンテナは作る必要はありますが）。&lt;/p>
&lt;p>Docker Hub を見ると、Alpine Linux ベースの Ansible 実行環境用イメージ &lt;a href="https://hub.docker.com/r/alpine/ansible">alpine/ansible&lt;/a> があるようですが、ここでは &lt;code>Dockerfile&lt;/code> を使って自分でイメージを作成することにします。&lt;/p>
&lt;h2 id="ansible-実行環境用イメージを作成する">Ansible 実行環境用イメージを作成する&lt;/h2>
&lt;p>&lt;code>Dockerfile&lt;/code> で Alpine Linux ベースの Ansible 実行環境を定義します。&lt;/p>

&lt;figure class="xCodeBlock">
&lt;figcaption class="xCodeBlock_title">Dockerfile&lt;/figcaption>
&lt;div class="xCodeBlock_code">&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-docker" data-lang="docker">&lt;span class="line">&lt;span class="cl">&lt;span class="k">FROM&lt;/span>&lt;span class="s"> alpine:3&lt;/span>&lt;span class="err">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="err">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="err">&lt;/span>&lt;span class="k">WORKDIR&lt;/span>&lt;span class="s"> /app&lt;/span>&lt;span class="err">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="err">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="err">&lt;/span>&lt;span class="c"># --no-cache を付けることで /var/cache/apk 以下にキャッシュが残るのを防ぐ&lt;/span>&lt;span class="err">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="err">&lt;/span>&lt;span class="c"># --update-cache を付けることで先に apk update するのと同じ効果になる&lt;/span>&lt;span class="err">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="err">&lt;/span>&lt;span class="k">RUN&lt;/span> apk --no-cache --update-cache add ansible openssh sshpass&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/div>
&lt;/figure>

&lt;p>APK (Alpine Package Keeper) で次のようなパッケージをインストールしています。&lt;/p>
&lt;ul>
&lt;li>&lt;code>ansible&lt;/code> &amp;hellip; Ansible Community パッケージ（&lt;code>ansible&lt;/code> コマンドや &lt;code>ansible-playbook&lt;/code> コマンドなど）&lt;/li>
&lt;li>&lt;code>openssh&lt;/code> &amp;hellip; &lt;code>ssh&lt;/code> コマンドのため&lt;/li>
&lt;li>&lt;code>sshpass&lt;/code> &amp;hellip; ターゲットホストにパスワード認証 (&lt;code>--ask-pass&lt;/code>) で接続するときのため&lt;/li>
&lt;/ul>
&lt;p>Ansible Community パッケージ (&lt;code>ansible&lt;/code>) ではなく、Ansible Core (&lt;code>ansible-core&lt;/code>) を使うようにすれば、イメージサイズは 500MB 弱から 80MB 程度に削減できますが、サイズを気にしなくてよいなら Ansible Community パッケージを使っておいた方が楽です。&lt;/p></description></item><item><title>Ansible モジュールのヘルプを表示する (ansible-doc)</title><link>https://maku.blog/p/xx7enu3/</link><pubDate>Fri, 18 Feb 2022 00:00:00 +0900</pubDate><guid>https://maku.blog/p/xx7enu3/</guid><description>&lt;p>&lt;strong>&lt;code>ansible-doc&lt;/code>&lt;/strong> コマンドを使うと、Ansible モジュールのドキュメントを表示することができます。&lt;/p>

&lt;figure class="xCodeBlock">
&lt;figcaption class="xCodeBlock_title">ping モジュールのドキュメントを表示&lt;/figcaption>
&lt;div class="xCodeBlock_code">&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-console" data-lang="console">&lt;span class="line">&lt;span class="cl">&lt;span class="gp">$&lt;/span> ansible-doc ping
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="gp">&amp;gt;&lt;/span> ANSIBLE.BUILTIN.PING &lt;span class="o">(&lt;/span>/Users/maku/Library/Python/3.10/lib/python/site-packages/ansible/modules/ping.py&lt;span class="o">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="err">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="err">&lt;/span>&lt;span class="go"> A trivial test module, this module always returns `pong&amp;#39; on successful contact. It does not make sense in
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="go"> playbooks, but it is useful from `/usr/bin/ansible&amp;#39; to verify the ability to login and that a usable Python is
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="go"> configured. This is NOT ICMP ping, this is just a trivial test module that requires Python on the remote-node.
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="go"> For Windows targets, use the [ansible.windows.win_ping] module instead. For Network targets, use the
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="go"> [ansible.netcommon.net_ping] module instead.
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="go">&lt;/span>&lt;span class="err">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="err">&lt;/span>&lt;span class="go">ADDED IN: historical
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="go">&lt;/span>&lt;span class="err">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="err">&lt;/span>&lt;span class="go">OPTIONS (= is mandatory):
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="go">&lt;/span>&lt;span class="err">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="err">&lt;/span>&lt;span class="go">- data
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="go"> Data to return for the `ping&amp;#39; return value.
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="go"> If this parameter is set to `crash&amp;#39;, the module will cause an exception.
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="go"> [Default: pong]
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="go"> type: str
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="go">&lt;/span>&lt;span class="err">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="err">&lt;/span>&lt;span class="go">...（省略）...
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/div>
&lt;/figure>

&lt;p>例えば、上記のように ping モジュールのドキュメントを確認すると、&lt;code>data&lt;/code> というオプションを指定できることがわかります。
次のように &lt;code>data&lt;/code> オプションを付けて ping モジュールを実行すると、指定した値がターゲットホストからそのまま返ってきます。
モジュールのオプションは &lt;code>-a&lt;/code> に続けて入力します。&lt;/p></description></item><item><title>Ansible の ansible.cfg ファイルの検索順序</title><link>https://maku.blog/p/pamv6gq/</link><pubDate>Sun, 23 Oct 2016 00:00:00 +0900</pubDate><guid>https://maku.blog/p/pamv6gq/</guid><description>&lt;p>Ansible の実行環境が参照する設定ファイル (&lt;strong>&lt;code>ansible.cfg&lt;/code>&lt;/strong>) は、下記のようなパスから検索されます。&lt;/p>
&lt;ol>
&lt;li>環境変数 &lt;code>ANSIBLE_CONFIG&lt;/code> で指定されたファイル&lt;/li>
&lt;li>&lt;code>ansible.cfg&lt;/code>（カレントディレクトリ以下のファイル）&lt;/li>
&lt;li>&lt;code>~/.ansible.cfg&lt;/code>（ホームディレクトリ以下のファイル）&lt;/li>
&lt;li>&lt;code>/etc/ansible/ansible.cfg&lt;/code>&lt;/li>
&lt;/ol>
&lt;p>Git などで管理する場合は、Playbook の近くに一緒に入れておくとわかりやすいです（上記の 2 番目の方法）。&lt;/p></description></item><item><title>Ansible でインベントリーファイルの場所を指定する</title><link>https://maku.blog/p/eycnx9i/</link><pubDate>Sat, 22 Oct 2016 00:00:00 +0900</pubDate><guid>https://maku.blog/p/eycnx9i/</guid><description>&lt;p>Ansible のコマンド（&lt;code>ansible&lt;/code> や &lt;code>ansible-playbook&lt;/code>）を実行すると、下記の順でインベントリーファイルが検索されます。&lt;/p>
&lt;ol>
&lt;li>コマンドラインオプション &lt;strong>&lt;code>-i&lt;/code>&lt;/strong> で指定したファイル&lt;/li>
&lt;li>コンフィグファイル &lt;strong>&lt;code>ansible.cfg&lt;/code>&lt;/strong> 内の &lt;strong>&lt;code>hostfile&lt;/code>&lt;/strong> で指定したファイル（参考: &lt;a href="../../p/pamv6gq">ansible.cfg ファイルの検索パス&lt;/a>）&lt;/li>
&lt;li>&lt;strong>&lt;code>/etc/ansible/inventry&lt;/code>&lt;/strong>&lt;/li>
&lt;/ol>
&lt;p>以下の例は、いずれもカレントディレクトリ内の &lt;code>hosts&lt;/code> というファイルをインベントリファイルとして使用するように指定しています。&lt;/p>

&lt;figure class="xCodeBlock">
&lt;figcaption class="xCodeBlock_title">例: コマンドラインオプション (-i) で指定する方法&lt;/figcaption>
&lt;div class="xCodeBlock_code">&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-console" data-lang="console">&lt;span class="line">&lt;span class="cl">&lt;span class="gp">$&lt;/span> ansible myserver -i hosts -m ping
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/div>
&lt;/figure>


&lt;figure class="xCodeBlock">
&lt;figcaption class="xCodeBlock_title">例: コンフィグファイル (ansible.cfg) で指定する方法&lt;/figcaption>
&lt;div class="xCodeBlock_code">&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-ini" data-lang="ini">&lt;span class="line">&lt;span class="cl">&lt;span class="k">[defaults]&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="na">hostfile&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="s">hosts&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/div>
&lt;/figure></description></item></channel></rss>